<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<script src="jquerymin.js"></script>

<script type="text/javascript">

function returnTransCanvas(imageId){
  var sourceRef=document.getElementById(imageId);
  dbuga(sourceRef.width+" "+sourceRef.height);
  var transCanvas=document.createElement("canvas");
  transCanvas.width = sourceRef.width;
  transCanvas.height = sourceRef.height;
  document.body.appendChild(transCanvas);
  var transCtx = transCanvas.getContext("2d");

  transCtx.drawImage(sourceRef, 0, 0);
  var image = transCtx.getImageData(0, 0, sourceRef.width, sourceRef.height);
  var imageData = image.data
  var length = imageData.length;
  var mostSatPixel=-1;
  var mostSatFrac=0;
  var mostSatAvg=0;
  var leastSatPixel=-1;
  var leastSatFrac=1;
  var leastSatAvg=0;

  for(var i=0; i < length; i+=4){
    var r=imageData[i];
    var g=imageData[i+1];
    var b=imageData[i+2];
    var a=imageData[i+3];
    var avg=(r+g+b)/3;
    var rg=Math.abs(r-g);
    var gb=Math.abs(g-b);
    var br=Math.abs(b-r);
    var sat=(rg+gb+br)/510; // 0-1
    if(sat>mostSatFrac){
      mostSatPixel=i;
      mostSatFrac=sat;
      mostSatAvg=avg;
    }
    if(sat<leastSatFrac){
      leastSatPixel=i;
      leastSatFrac=sat;
      leastSatAvg=avg;
    }
  }

  for(var i=0; i < length; i+=4){
    var r=imageData[i];
    var g=imageData[i+1];
    var b=imageData[i+2];
    var a=imageData[i+3];
    var avg=(r+g+b)/3;
    var rg=Math.abs(r-g);
    var gb=Math.abs(g-b);
    var br=Math.abs(b-r);
    var sat=(rg+gb+br)/510; // 0-1

    var alpha=a-((sat)*(255));
    if(alpha<0){alpha=0;}
    avg=Math.floor((avg+0)/1);
    imageData[i]=avg;
    imageData[i+1]=avg;
    imageData[i+2]=avg;
    imageData[i+3]=Math.floor(alpha);

  }
  image.data = imageData;
  transCtx.putImageData(image, 0, 0);


  return transCanvas;
}
function init(){
  carTick();



  var bears = document.getElementById("bearsImage");

  //var sideTrans=returnTransCanvas("sideImage");
/*
  var sideCanv = document.createElement("canvas");
  sideCanv.width = sideTrans.width;
  sideCanv.height = sideTrans.height;
  document.body.appendChild(sideCanv);
  var sideCtx = sideCanv.getContext("2d");
  sideCtx.drawImage(bears, 20,20, 480,120);
  sideCtx.globalCompositeOperation = "overlay";
  sideCtx.drawImage(sideTrans, 0, 0);
*/

  //var topTrans=returnTransCanvas("topImage");
  //var topCanv=returnColorizedCanvas(topTrans, 255,255,0);
  //document.body.appendChild(topCanv);
  //endTrans=returnTransCanvas("endImage");
  
}
var endTrans;
var carRefs=[];
var transRefs=[];
function saveCanvas(canvasRef, name){
  var data = canvasRef.toDataURL();
  $.post("upload.php", {
    imageData : data,
    fileName : name
    }, function(data) {
  dbuga('ok');
  carTick();
  });
}
function carTick(){
  if(atImage<imageIdArray.length){
    var imageId=imageIdArray[atImage];
    var newTrans=returnTransCanvas(imageId);
    transRefs.push(newTrans);
    saveCanvas(newTrans, imageId);
  }
  
  atImage++;
  
  //window.setTimeout('carTick()',100);
}
var atImage=0;

var imageIdArray=["boxside","boxtop","boxend", "enginefloor", "engineroof", "enginenose", "enginecab", "enginestarinner", "enginestarouter", "engineportinner", "engineportouter"];
var rgbArray=[[63,179,160],[60,116,107],[118,197,240],[0,91,161],[241,163,52],[218,37,28],[100,100,100],[40,40,40]];

function dbuga(theString){
  document.getElementById('debugDiv').style.display="block";
  document.getElementById('debugDiv').innerHTML+="<br />"+theString;
}

function dbug(theString){
  document.getElementById('debugDiv').style.display="block";
  document.getElementById('debugDiv').innerHTML=theString;
}

</script>
</head>
<body onload="init();" style="background-color:#ccc;">
<!--
<img src="bears.jpg" id="bearsImage" width=480 height=120  style="display:none;" />
-->
<img src="source/boxside.png" id="boxside"  style="display:none;" />
<img src="source/boxend.png" id="boxend"  style="display:none;" />
<img src="source/boxtop.png" id="boxtop" style="display:none;" />
<img src="source/engineportinner.png" id="engineportinner" style="display:none;" />
<img src="source/engineportouter.png" id="engineportouter" style="display:none;" />
<img src="source/enginestarinner.png" id="enginestarinner" style="display:none;" />
<img src="source/enginestarouter.png" id="enginestarouter" style="display:none;" />
<img src="source/enginefloor.png" id="enginefloor" style="display:none;" />
<img src="source/engineroof.png" id="engineroof" style="display:none;" />
<img src="source/enginenose.png" id="enginenose" style="display:none;" />
<img src="source/enginecab.png" id="enginecab" style="display:none;" />
<div id="debugDiv"></div>
</body>
</html>
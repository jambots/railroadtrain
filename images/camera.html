<!DOCTYPE HTML>
<html>
<head>
<title>css dolly</title>
<meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="viewport" content="width=768; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" type="text/css" href="reset-min.css">

<script type="text/javascript">
var canvasWidth=768;
var canvasHeight=820;
var camera;
var zoom;
var table;
var surface;
var canv;
var ctx;
var prevTouchX=-1;
var prevTouchY=-1;
var touchInterval;




var xTargetPercent=50;
var yTargetPercent=50;
var xTargetSpeed=0*-(5+rnd(6))/30;
var yTargetSpeed=0*-(5+rnd(6))/30;
//xTargetSpeed=0;
//yTargetSpeed=0;

var cameraRotationDegreesAuto=.5;
var combinedZoomAuto=.1;
function touchTick(){
  //cameraRotationDegrees+=cameraRotationDegreesAuto;
  /*
  combinedZoom+=combinedZoomAuto;
  if(combinedZoom>100){
    combinedZoom=100;
    combinedZoomAuto=-.5;
    }
  if(combinedZoom<0){
    combinedZoom=0;
    combinedZoomAuto=.5;
    }
  */
    cameraDistancePercent=100-combinedZoom;
    cameraAngle=90*(combinedZoom/100);

  //cameraRotationDegrees+=.5;
  xTargetPercent+=xTargetSpeed;  
  yTargetPercent+=yTargetSpeed;  
  if((xTargetPercent<0)||(xTargetPercent>98)){xTargetSpeed*=-1;}
  if((yTargetPercent<0)||(yTargetPercent>98)){yTargetSpeed*=-1;}
  cameraXpercent=100-xTargetPercent;
  cameraYpercent=100-yTargetPercent;
  locateCamera();
  //document.getElementById('mid').style.left=(xTargetPercent-1)+"%";
  //document.getElementById('mid').style.top=(yTargetPercent-1)+"%";
  }

function rnd(range){
  return Math.floor(Math.random()*range);
  }
function dbug(theString){
  if(theString=="clear"){
    document.getElementById('debugDiv').innerHTML="";
    }
  else{
    document.getElementById('debugDiv').innerHTML+=theString+"<br />";
    }
  }


//////// touchy feely

function xRatioFromTouch(theTouch){
  return Math.floor(theTouch.pageX/canvasWidth);
  }
function yRatioFromTouch(theTouch){
  return Math.floor(theTouch.pageY/canvasWidth);
  }
function handleEvent(e){
  if(e.touches.length>0){
    t=e.touches[0];
    }
  else{return false;}
  if(e.type=="touchstart"){
    }
  if(e.type=="touchmove"){
    deltaX=prevTouchX-t.pageX;
    deltaY=prevTouchY-t.pageY;
    combinedZoom+=deltaY/5;
    //if(combinedZoom>97){document.getElementById('mid').style.opacity="0";}
    //else{document.getElementById('mid').style.opacity="1";}
    if(t.pageY>(canvasWidth/2)){cameraRotationDegrees+=deltaX/5;}
    else{cameraRotationDegrees-=deltaX/15;}
    if(combinedZoom<0){combinedZoom=0;}
    if(combinedZoom>100){combinedZoom=100;}
    /* moved to touchTick
    cameraDistancePercent=100-combinedZoom;
    cameraAngle=90*(combinedZoom/100);
    */
    //dbug('clear');
    //dbug(combinedZoom+" "+deltaY);
    }
  prevTouchX=t.pageX;
  prevTouchY=t.pageY;
  }

function touchCancel(event){
  event.preventDefault(); 
  }
function touchStart(event){
  event.preventDefault(); 
  handleEvent(event);
  }
function touchMove(event){
  event.preventDefault();
  handleEvent(event);
  }
function touchEnd(event){
  event.preventDefault();
  handleEvent(event);
  }
var atRotation=0;


function screenLayout(){
  canvasHeight=window.innerHeight;
  canvasWidth=window.innerWidth;

  ////canv.height=canvasWidth;
  ////canv.width=canvasWidth;
  camera.style.width=canvasWidth+"px";
  camera.style.height=canvasWidth+"px";
  zoom.style.width=canvasWidth+"px";
  zoom.style.height=canvasWidth+"px";
  table.style.width=canvasWidth+"px";
  table.style.height=canvasWidth+"px";
  surface.style.width=canvasWidth+"px";
  surface.style.height=canvasWidth+"px";
  document.getElementById('debugDiv').style.height=canvasHeight+"px";
  document.getElementById('debugDiv').style.width=canvasWidth+"px";
  }

function init(){
  camera=document.getElementById("cameraDiv");
  table=document.getElementById("tableDiv");
  zoom=document.getElementById("zoomDiv");
  ////canv=document.getElementById("canv");
  surface=document.getElementById("surfaceDiv");
  ////ctx=canv.getContext("2d");
  screenLayout();
  //labelCanvas();
  placeTestUnits();
  touchInterval=window.setInterval('touchTick()', 20);
  }

var combinedZoom=75;
var cameraXpercent=50;
var cameraYpercent=50;
var cameraDistancePercent=25;
var cameraRotationDegrees=0;
var cameraAngle=45;

function locateCamera(){
  centerAmount=0;
  if(combinedZoom<50){
    centerAmount=(100-combinedZoom*2)/100;
    }
  xDif=cameraXpercent-50;
  yDif=cameraYpercent-50;
  xMod=xDif*centerAmount;
  yMod=yDif*centerAmount;
  useX=cameraXpercent-xMod;
  useY=cameraYpercent-yMod;

  //table rotates, tilts and moves xy under camera centerline
  transformString='';
  //transformString+='translateZ('+(20*canvasWidth/100)+'px) ';
  transformString+='rotateX('+cameraAngle+'deg) ';
  transformString+='rotateZ('+cameraRotationDegrees+'deg)';
  transformString+='translateX('+(canvasWidth*(useX-50)/100)+'px) ';
  transformString+='translateY('+(canvasWidth*(useY-50)/100)+'px) ';
  //transformString+='translateX(0) ';
  //transformString+='translateY(0) ';
  //dbug(transformString);
  table.style.webkitTransform=transformString;
  
  
  transformString='translateZ('+((100-cameraDistancePercent)*canvasWidth/100)+'px) translateY('+(1*canvasWidth/100)+'px)';
  //dbug(transformString);
  zoom.style.webkitTransform=transformString;
  //dbug('clear');
  //dbug("combinedZoom="+combinedZoom);
  //dbug("centerAmount="+centerAmount);
  //dbug("xDif="+xDif);
  
  }


function labelCanvas(){
  //dbug('labelCanvas()');
  ctx.lineWidth=1;
  ctx.fillStyle="#ffff00";
  ctx.font="24px sans-serif";
  ctx.fillText("N", (canvasWidth*.5), (canvasWidth*.05));
  ctx.fillText("S", (canvasWidth*.5), (canvasWidth*.95));
  ctx.fillText("W", (canvasWidth*.05), (canvasWidth*.5));
  ctx.fillText("E", (canvasWidth*.95), (canvasWidth*.5));
  }
function placeTestUnits(){
  qpx=canvasWidth*.25;
  grad="-webkit-gradient(linear, left top, right bottom, color-stop(0%,#919191), color-stop(24%,#5c5c5c), color-stop(50%,#5c5c5c), color-stop(50%,#5c5c5c), color-stop(79%,#272727), color-stop(100%,#000000))";
  //placeBox("nw", 0, 0, 22, 14, 12, grad);
  //placeBox("ne", 95, 0, 5, 6, 22, grad);
  //placeBox("sw", 0, 93, 8, 7, 3, grad);
  //placeBox("se", 90, 70, 10, 30, 5, grad);
  //placeTube("mid", 49, 49, 2, 2, 2, "rgba(255,0,0,1)");
  //testframe
  //placeBox("nw", 44, 48.5, 12, 3, 6, "rgba(255,255,0,.1)");

  carCount=0;
  colors=["blue", "red", "white", "green"];
  for (b=2; b<8; b++){
    s=1+rnd(3);
    e=8-rnd(2);
    w=12;
    h=3;
    for (i=s; i<e; i++){
      if(i==s){
        carColor=colors[rnd(2)];
        //{"id":"", "left":"", "top":"", "width":"", "height":"", "tall":"", "color"}

        placeEngine({"id":"engine"+b+i,  "left":i*12.571,  b*10, 12, 3, 6, carColor);
        }
      else{
        carColor='freight'+colors[rnd(4)];
        placeCar("freight"+b+i, i*12.571, b*10, w, h, 3, carColor, 1);
        carCount++;
        }
      }
    }
  //dbug(carCount);

  camera.style.webkitPerspective=canvasWidth+"px";
  locateCamera();
  }
function placeEngine(theObj){
  tz=t*canvasWidth/100;
  htmlString='<div id="'+theObj.id+'" style="left:'+theObj.left+'; top:'+theObj.top+'; width:'+theObj.width+'; height:'+theObj.height+'; -webkit-transform-style: preserve-3d;">';
  var engineBuildList=["base", "hood", "nose", "windshield", "outernorth", "outersouth", "innernorth", "innersouth", "tail", "cab", "roof"]; 
  for (w=0; w<engineBuildList.length; w++){
    htmlString+=returnEngineWall(theObj, engineBuildList[w]);
    }
  htmlString+='</div>';
  surface.innerHTML+=htmlString;  
  }
function returnEngineWall(confObj, panel){
  ww=0;
  hh=0;
  rx=0;
  ry=0;
  rz=0;
  tx=0;
  ty=0;
  tz=0;
  tight=canvasWidth/1000;

  img="cars/"+confObj.color+"top.png";
  if(panel=="nose"){
    img="cars/engine/nose"+confObj.color+".png";
    hh=confObj.tall*canvasWidth/100;
    ww=confObj.height*canvasWidth/100;
    rx=00;
    ry=90;
    rz=-90;
    tx=0-ww;
    ty=-ww/2;
    tz=.92*(confObj.width*canvasWidth/100-(ww/2));
    bv="hidden";
    }
  if(panel=="windshield"){
    img="cars/engine/windshield"+confObj.color+".png";
    hh=confObj.tall*canvasWidth/100;
    ww=confObj.height*canvasWidth/100;
    rx=00;
    ry=90;
    rz=-90;
    tx=0-ww;
    ty=-ww/2;
    tz=.80*(confObj.width*canvasWidth/100-(ww/2));
    bv="hidden";
    }

  if(panel=="hood"){
    img="cars/engine/hood"+confObj.color+".png";
    ww=confObj.width*canvasWidth/100;
    hh=confObj.height*canvasWidth/100;
    rx=0;
    ry=0;
    rz=180;
    tx=0;
    ty=0;
    tz=(confObj.tall*.55)*canvasWidth/100;
    bv="hidden";
    }
  if(panel=="roof"){
    img="cars/engine/roof"+confObj.color+".png";
    ww=confObj.width*canvasWidth/100;
    hh=confObj.height*canvasWidth/100;
    rx=0;
    ry=0;
    rz=180;
    tx=0;
    ty=0;
    tz=(confObj.tall*.75)*canvasWidth/100;
    tz-=tight;
    bv="hidden";
    }
  if(panel=="base"){
    img="cars/engine/base"+confObj.color+".png";
    ww=confObj.width*canvasWidth/100;
    hh=confObj.height*canvasWidth/100;
    rx=0;
    ry=0;
    rz=0;
    tx=0;
    ty=0;
    tz=(t/3.7)*canvasWidth/100;
    bv="hidden";
    }
  if(panel=="innernorth"){
    img="cars/engine/innernorth"+confObj.color+".png";
    ww=confObj.width*canvasWidth/100;
    hh=confObj.tall*canvasWidth/100;
    rx=90;
    ry=0;
    rz=180;
    tx=0;
    ty=.5*confObj.tall*canvasWidth/100;
    tz=hh/2;
    tz-=(.65*canvasWidth/100);
    bv="hidden";
    }
  if(panel=="innersouth"){
    img="cars/engine/innersouth"+confObj.color+".png?1";
    ww=confObj.width*canvasWidth/100;
    hh=confObj.tall*canvasWidth/100;
    rx=-90;
    ry=0;
    rz=0;
    tx=0;
    ty=-0.5*confObj.tall*canvasWidth/100;
    tz=(-hh/2+confObj.height*canvasWidth/100);
    tz-=(.65*canvasWidth/100);
    bv="hidden";
    }
  if(panel=="outernorth"){
    img="cars/engine/outernorth"+confObj.color+".png";
    ww=confObj.width*canvasWidth/100;
    hh=confObj.tall*canvasWidth/100;
    rx=90;
    ry=0;
    rz=180;
    tx=0;
    ty=.5*confObj.tall*canvasWidth/100;
    tz=hh/2;
    bv="visible";
    }
  if(panel=="outersouth"){
    img="cars/engine/outersouth"+confObj.color+".png?1";
    ww=confObj.width*canvasWidth/100;
    hh=confObj.tall*canvasWidth/100;
    rx=-90;
    ry=0;
    rz=0;
    tx=0;
    ty=-0.5*confObj.tall*canvasWidth/100;
    tz=(-hh/2+confObj.height*canvasWidth/100);
    //tz-=tight;
    bv="visible";
    }

  if(panel=="tail"){
    img="cars/engine/tail"+confObj.color+".png";
    hh=confObj.tall*canvasWidth/100;
    ww=confObj.height*canvasWidth/100;
    rx=00;
    ry=-90;
    rz=90;
    tx=.5*confObj.tall*canvasWidth/100;
    ty=-ww/2;
    tz=.05*confObj.width*canvasWidth/100;
    bv="hidden";
    }
  if(panel=="cab"){
    img="cars/engine/cab"+confObj.color+".png";
    hh=confObj.tall*canvasWidth/100;
    ww=confObj.height*canvasWidth/100;
    rx=00;
    ry=-90;
    rz=90;
    tx=.5*confObj.tall*canvasWidth/100;
    ty=-ww/2;
    tz=-.475*confObj.width*canvasWidth/100;
    bv="hidden";
    }

  return '<div style="width:'+ww+'px; height:'+hh+'px; background-size:contain; background-image:url('+img+'); -webkit-transform:rotateX('+rx+'deg) rotateY('+ry+'deg) translateX('+tx+'px) translateY('+ty+'px) translateZ('+tz+'px) rotateZ('+rz+'deg); -webkit-backface-visibility:'+bv+'; "></div>';
  }

function placeCar(i,x,y,w,h,t,c){
  tz=t*canvasWidth/100;
  htmlString='<div id="'+i+'" style="-webkit-backface-visibility:hidden; left:'+x+'%; top:'+y+'%; width:'+w+'%; height:'+h+'%; Zbackground-color:rgba(0,0,0,.1); -webkit-transform:translateZ(0px) rotateZ('+(rnd(0)*90)+'deg); -webkit-transform-style: preserve-3d;  Z-webkit-animation: spin 15s infinite linear alternate; ">';
  htmlString+=returnImgWall(w, h, t, c, 4);
  htmlString+=returnImgWall(w, h, t, c, 0);
  htmlString+=returnImgWall(w, h, t, c, 1);
  htmlString+=returnImgWall(w, h, t, c, 2);
  htmlString+=returnImgWall(w, h, t, c, 3);
  htmlString+='</div>';
  surface.innerHTML+=htmlString;  
  }
function returnImgWall(w, h, t, c, d){
  ww=0;
  hh=0;
  rx=0;
  ry=0;
  rz=0;
  tx=0;
  ty=0;
  tz=0;
  tight=canvasWidth/1000;

  img="cars/"+c+"top.png";

  if(d==4){//lid
    ww=w*canvasWidth/100;
    hh=h*canvasWidth/100;
    rx=0;
    ry=0;
    rz=0;
    tx=0;
    ty=0;
    tz=t*canvasWidth/100;
    tz-=tight;
    bv="hidden";
    }
  if(d==0){//north
    img="cars/"+c+"side.png";
    ww=w*canvasWidth/100;
    hh=t*canvasWidth/100;
    rx=90;
    ry=0;
    rz=180;
    tx=0;
    ty=.5*t*canvasWidth/100;
    tz=hh/2;
    bv="visible";
    }
  if(d==1){//east
    img="cars/"+c+"front.png";
    ww=t*canvasWidth/100;
    hh=h*canvasWidth/100;
    rx=00;
    ry=90;
    rz=-90;
    tx=0-ww/2;
    ty=0;
    tz=(w*canvasWidth/100-(ww/2));
    tz-=tight*2;
    bv="hidden";
    }
  if(d==2){//south
    img="cars/"+c+"side.png";
    ww=w*canvasWidth/100;
    hh=t*canvasWidth/100;
    rx=-90;
    ry=0;
    rz=0;
    tx=0;
    ty=-0.5*t*canvasWidth/100;
    tz=(-hh/2+h*canvasWidth/100);
    bv="visible";
    }
  if(d==3){//west
    img="cars/"+c+"front.png";
    ww=t*canvasWidth/100;
    hh=h*canvasWidth/100;
    rx=00;
    ry=-90;
    rz=90;
    tx=.5*t*canvasWidth/100;
    ty=0;
    tz=.5*t*canvasWidth/100;
    tz-=tight*2;
    bv="hidden";
    }

  return '<div style="width:'+ww+'px; height:'+hh+'px; background-size:contain; background-image:url('+img+'); -webkit-transform:rotateX('+rx+'deg) rotateY('+ry+'deg) translateX('+tx+'px) translateY('+ty+'px) translateZ('+tz+'px) rotateZ('+rz+'deg); -webkit-backface-visibility:'+bv+'; "></div>';
  }




</script>
<style type="text/css">

@-webkit-keyframes spin {
	0%   { -webkit-transform: rotate(0deg) translateX(200px); }
	100% { -webkit-transform: rotate(90deg) translateX(0px); }
}

div, canvas{
  position:absolute;
  -webkit-backface-visibility:hidden;
  }
#cameraDiv{
  //-webkit-perspective: 1000;
  ////-webkit-perspective: 0px;

  -webkit-transform-style: preserve-3d;
  background-image:url('images/grid_white.png');
  //-webkit-perspective-origin: 50% 50% 50%;
  -webkit-backface-visibility:hidden;
  }
#tableDiv{
  //-webkit-perspective: 1000;
  background-image:url('images/grid_red.png');
  //background-color:rgba(128,128,128,1); 
  -webkit-transform-style: preserve-3d;
  -webkit-backface-visibility:hidden;
  }
#zoomDiv{position:absolute; top:0; left:0;
  background-image:url('images/grid_blue.png');
  //-webkit-perspective: 1000;
  -webkit-transform-style: preserve-3d;
  -webkit-backface-visibility:hidden;
  }
#surfaceDiv{
  //-webkit-perspective: 1000;
  background-image:url('images/grid_yellow.png');
  //background-color:rgba(255,255,255,.5);
  -webkit-transform-style: preserve-3d;
  -webkit-backface-visibility:hidden;
  }
body{background-color:black;}

</style>
</head>
<body onMouseDown="//xyPos();" onload="init();" ontouchstart="touchStart(event);" ontouchmove="touchMove(event);" ontouchend="touchEnd(event);" ontouchcancel="touchCancel(event);">
<div id="cameraDiv">
  <div id="zoomDiv">
    <div id="tableDiv">
      <!--<canvas class="" id="canv" width="768" height="870"></canvas> -->
      <div id="surfaceDiv"></div>
    </div>
  </div>
</div>
<div id="debugDiv" style="display:none; position:absolute; top:0px; left:0px; width:200px; height:200px; border:1px white; color:white;"></div>

</body>
</html>
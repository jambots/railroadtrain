<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name = "apple-mobile-web-app-capable" content = "yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script type="text/javascript" src="done.js?18"></script>
<link rel="stylesheet" type="text/css" href="reset-min.css">
<link rel="stylesheet" type="text/css" href="interface.css?1">
<link rel="stylesheet" type="text/css" href="nav.css">
<script src="phonegap.js"></script>
<script src="howler.min.js"></script>

<style>


@font-face {
    font-family: akziLight;
    src: url(ttf/akzidenzgrotesklight.ttf);
}
@font-face {
    font-family: akzi;
    src: url(ttf/akzidenzgroteskregular.ttf);
}
@font-face {
    font-family: akziBold;
    src: url(ttf/akzidenzgroteskbold.ttf);
}
.cubeFace{
  background-color:rgba(128,128,128,0);
  display: block;
  position: absolute;
  -webkit-backface-visibility: hidden;
  opacity: 1; 
  -webkit-transform-style: preserve-3d;
  -webkit-transform-origin: 0 0 0;

}

.cube{
  -webkit-backface-visibility: hidden;

  position:relative;
  -webkit-transform-style: preserve-3d;
  -webkit-transform-origin: 0px 0 0px;
}

.background{position:absolute; top:-64px; left:-64px;}


div{image-rendering: -webkit-optimize-speed; user-select: none;}
canvas{
user-select: none;
image-rendering: -webkit-optimize-speed;
-webkit-backface-visibility: hidden;
}
img{image-rendering: -webkit-optimize-speed;}
#preload{
display:none;
position:absolute;
top:798px;
width:768px;
}

#preload{display:none;}
#cameraDiv{
  background-repeat:no-repeat;
  background-position:50% 50%;
  -webkit-perspective-origin: 50% 50% 50%;
  -webkit-perspective: 786;
  display:block;
  -webkit-transform-style: preserve-3d;
  -webkit-backface-visibility:hidden;
  }
#zoomDiv{
  background-repeat:no-repeat;
  background-position:50% 50%;

  display:block;
  -webkit-transform-style: preserve-3d;
  -webkit-backface-visibility:hidden;
  }
#tableDiv{
  display:block;
  -webkit-transform-style: preserve-3d;
  -webkit-backface-visibility:hidden;
  }
#trainHolder{
  background-repeat:no-repeat;
  background-position:50% 50%;

  -webkit-transform-style: preserve-3d;
}
#wrapper{
  -webkit-transform-style: preserve-3d;
  background-color:#fff;
  zbackground-image:url(images/grid_white.png);
}
</style>

<script type="text/javascript" charset="utf-8">

document.addEventListener("deviceready", onDeviceReady, false);

function saveImageData(key, data){
  if(web){
    saveImageDataLocalStorage(key, data);
    }
  else{
    saveImageDataPhonegap(key, data);
    }
  }
function saveImageDataLocalStorage(key, data){
  //dbuga("saveImageDataLocalStorage <br>"+key);
  
  var purged=0;
  var nameStack=JSON.parse(localStorage.getItem("nameStack"));
  var currentName="not set";
  if(setKeys.length>1){currentName=setKeys[1];}
  var favorites=sets["9999_Favorites"];
  var favStack=[];
  var normStack=[];
  var currentStack=[];
  for (var n=0; n<nameStack.length; n++){
    var thisName=nameStack[n];
    var isFav=false;
    for (var f=0; f<favorites.length; f++){
      var favName=favorites[f].largeUrl;
      if(thisName.indexOf(favName)>-1){isFav=true;}
      }
    if(isFav){
      favStack.push(thisName);
      }
    else{
      if(thisName.indexOf(currentName)>-1){
        currentStack.push(thisName);
        }
      else{
        normStack.push(thisName);
        }
      }
    }
  nameStack=normStack.concat(currentStack, favStack);

  
  var saved=true;
  
  try{
    localStorage.setItem(key, data);
    } catch(e) {
    //dbuga(e);
    saved=false;
    }
  while((saved==false)&&(nameStack.length>0)){
    var delKey=nameStack.shift();
    localStorage.setItem(delKey, "");
    //dbuga(' -  purge '+delKey);
    purged++;
    saved=true;
    try{
      localStorage.setItem(key, data);
      } catch(e) {
      //dbuga(e);
      saved=false;
      }
    }

  if(saved){
    nameStack.push(key);
    //dbuga(' saved: '+nameStack.length+" "+key);
    purged=0;
    }
  else{
    //dbuga('failed '+key);
    }
  localStorage.setItem("nameStack", JSON.stringify(nameStack));
  }

function saveImageDataPhonegap(key, data){
  //dbuga("<br>saveImageDataPhonegap "+key);
  var nameStack=JSON.parse(localStorage.getItem("nameStack"));
  nameStack.push(key);
  var temp=key.split("/");
  var fname=temp.pop();
  //dbuga(fname +" save to db" );
  localStorage.setItem("nameStack", JSON.stringify(nameStack));
  db.transaction(function(tx) {
    tx.executeSql("INSERT INTO test_table (image_url, image_data) VALUES (?,?)", [key, data], function(tx, res){
      //dbuga("inserted");
      }, function(e) {
        //dbuga("not inserted ERROR: " + e.message);
      });
    });

  }


var comQueue=new Array();

var cellSize=96;
var cellSizeHalf=48;
var cellsAcross=8;
var cellsDown=8;
var shrink=.95;
//shrink=1
var colorsUp=true;
var cubeSize=cellSize;
var faceData={};
function setupFaceData(){
  //dbuga("setupFaceData() cubeSize="+cubeSize);
  var s=cubeSize;
  faceData={
  "tank":[
    {"img":"tanktop", "width":1, "height":6/24, "trans":'translateZ('+ -s*18/48+'px) translateY('+ -s*6/48+'px) translateX('+ -s*24/48+'px)'},
    {"img":"tanktop", "width":1, "height":6/24, "trans":'translateZ('+ -s*22/48+'px) translateY('+ -s*6/48+'px) translateX('+ -s*24/48+'px)'},
    {"img":"tankside", "width":1, "height":8/24, "trans":'rotateX(-90deg) translateZ('+s*0/48+'px) translateY('+s*8/48+'px) translateX('+-s*24/48+'px)'},
    {"img":"tankend", "width":6/24, "height":8/24, "trans":'rotateX(-90deg)  rotateY(-90deg) translateZ('+s*20/48+'px) translateY('+s*8/48+'px) translateX('+-s*6/48+'px)'},
    {"img":"tankend", "width":6/24, "height":8/24, "trans":'rotateX(-90deg)  rotateY(-270deg) translateZ('+s*20/48+'px) translateY('+s*8/48+'px) translateX('+-s*6/48+'px)'}
  ],
  "box":[
    {"img":"boxtop", "width":1, "height":6/24, "trans":'translateZ('+ -s*10/48+'px) translateY('+ -s*6/48+'px) translateX('+ -s*24/48+'px)'},
    {"img":"boxside", "width":1, "height":8/24, "trans":'rotateX(-90deg) translateZ('+cubeSize*5/48+'px) translateY('+s*8/48+'px) translateX('+-s*24/48+'px)'},
    {"img":"boxside", "width":1, "height":8/24, "trans":'rotateX(-90deg) rotateY(180deg) translateZ('+s*5/48+'px) translateY('+s*8/48+'px) translateX('+-s*24/48+'px)'},
    {"img":"boxend", "width":6/24, "height":8/24, "trans":'rotateX(-90deg)  rotateY(-90deg) translateZ('+s*22/48+'px) translateY('+s*8/48+'px) translateX('+-s*6/48+'px)'},
    {"img":"boxend", "width":6/24, "height":8/24, "trans":'rotateX(-90deg)  rotateY(-270deg) translateZ('+s*22/48+'px) translateY('+s*8/48+'px) translateX('+-s*6/48+'px)'}
  ],
  "engine":[
    {"img":"enginefloor", "width":1, "height":6/24, "trans":'rotateZ(180deg) translateZ('+-s*19/44+'px) translateY('+-s*6/44+'px) translateX('+-s*22/44+'px)'},
    {"img":"engineroof", "width":1, "height":12/44, "trans":'rotateZ(180deg) translateZ('+-s*10/44+'px) translateY('+-s*6/44+'px) translateX('+-s*22/44+'px)'},
    {"img":"enginestarouter", "width":1, "height":15/44, "trans":'rotateX(-90deg) translateZ('+s*4/44+'px) translateY('+s*7/44+'px) translateX('+-s*22/44+'px)'},
    {"img":"enginestarinner", "width":1, "height":15/44, "trans":'rotateX(-90deg) translateZ('+s*2.5/44+'px) translateY('+s*7/44+'px) translateX('+-s*22/44+'px)'},
    {"img":"engineportouter", "width":1, "height":15/44, "trans":'rotateX(-90deg) rotateY(180deg) translateZ('+s*4/44+'px) translateY('+s*7/44+'px) translateX('+-s*22/44+'px)'},
    {"img":"engineportinner", "width":1, "height":15/44, "trans":'rotateX(-90deg) rotateY(180deg) translateZ('+s*2.5/44+'px) translateY('+s*7/44+'px) translateX('+-s*22/44+'px)'},
    {"img":"enginenose", "width":12/44, "height":15/44, "trans":'rotateX(-90deg)  rotateY(-90deg) translateZ('+s*18.5/44+'px) translateY('+s*7/44+'px) translateX('+-s*6/44+'px)'},
    {"img":"enginenose", "width":12/44, "height":15/44, "trans":'rotateX(-90deg)  rotateY(-270deg) translateZ('+s*18/44+'px) translateY('+s*7/44+'px) translateX('+-s*6/44+'px)'},
    {"img":"enginecab", "width":12/44, "height":15/44, "trans":'rotateX(-90deg)  rotateY(-90deg) translateZ('+-s*7/44+'px) translateY('+s*7/44+'px) translateX('+-s*6/44+'px)'},
    {"img":"enginecab", "width":12/44, "height":15/44, "trans":'rotateX(-90deg)  rotateY(-270deg) translateZ('+s*12/44+'px) translateY('+s*7/44+'px) translateX('+-s*6/44+'px)'}
  ]

};
}




////var musicOn=true;
////var sfxOn=true;




function comTick(){
  return false;
  if(comQueue.length >0){
    thisCom=comQueue.join('&');
    comQueue=new Array();
    pea=rnd(10000);
    window.location.hash="#"+thisCom+"&unique="+pea;
    displCom=thisCom.replace(/\&/g, "<br>");
    }
  comGlom="";
  comQueue=new Array();
  }

function genericDefault(itemName, defaultValue){
  if(platform=="android"){
    if (localStorage.getItem(itemName) === null) {
      localStorage.setItem(itemName, defaultValue);
      }
    }
  }
function genericSet(itemName, newValue){
  if(platform=="android"){
    localStorage.setItem(itemName, newValue);
    }
  }
function genericGet(itemName){
  var value="notSet";
  if(platform=="android"){
    value=localStorage.getItem(itemName);
    }
  return value;
  }


function rnd(range){
  return Math.floor(Math.random()*range);
  }
var paused=true;
function pauseGame(){
  //dbuga("pauseGame()");
  paused=true;
  ////loopStop("measure_loop_inst");
  // called by shell
  return true;
  }
function resumeGame(){
  // called by shell
  //requestPersistenceData();
  //dbuga("resumeGame()");
  paused=false;
  transmitBgMusicState();
  return true;
  }


function transmitBgMusicState(){
  return false;////
  //dbuga("transmitBgMusicState()");
  debugStorage();
  if(settingsObject.Music.value == "On"){
    loopStart("On/measure_loop_inst");
    loopStop("Classic/measure_loop_inst");
    }
  else if(settingsObject.Music.value == "Classic"){
    loopStop("On/measure_loop_inst");
    loopStart("Classic/measure_loop_inst");
    }
  else{
    loopStop("On/measure_loop_inst");
    loopStop("Classic/measure_loop_inst");
    }
  
  
  }
var soundCount=0;
var soundRefByName={};
function oneShot(soundName){
  //dbuga("oneShot("+soundName+")");
  soundName=settingsObject.Sounds.value+"/"+soundName;
  if(settingsObject.Sounds.value != "Off"){
    if(platform=="android"){
      if(soundRefByName.hasOwnProperty(soundName)){
        //dbuga(' - extant '+soundName);
        //soundRefByName[soundName].stop();
        soundRefByName[soundName].play();
        //dbuga(' - played');
        }
      else{
        var newSound = new Media(filePath+"/"+soundName+".mp3");
        soundRefByName[soundName]=newSound;
        //dbuga('new Media '+soundName);
        }
      }
    if((platform=="web")||(platform=="local")){
      if(soundRefByName.hasOwnProperty(soundName)){
        //dbuga('oneShot - extant '+soundName);
        //soundRefByName[soundName].stop();
        soundRefByName[soundName].play();
        //dbuga(' - played');
        }
      else{
        var newSound = new Howl({
          urls: [filePath+"/"+soundName+".mp3"],
          autoplay: true,
          loop: false,
          volume: 0.5,
          onend: function() {
            //alert('Finished!');
            }
          });
        soundRefByName[soundName]=newSound;
        //dbuga('new howl in oneShot '+soundName);
 
        }  
      }  
    }  
  }
function loopStart(soundName){// soundName like "Classic/measure_loop_inst"
  //dbuga("loopStart("+soundName+") "+platform);
  if(persistenceObject.music=="on"){
    if(platform=="android"){
      //dbuga('BOOYA!');
      if(soundRefByName.hasOwnProperty(soundName)){
        soundRefByName[soundName].play();
        }
      }
    if((platform=="web")||(platform=="local")){
      if(soundRefByName.hasOwnProperty(soundName)){
        //dbuga('openedWithStupidLoop: '+ openedWithStupidLoop);
        if(openedWithStupidLoop==false){
          //dbuga(' - extant '+soundName);
          soundRefByName[soundName].stop();
          soundRefByName[soundName].play();
          //dbuga(' - played');
          }
        }
      else{
        var newSound = new Howl({
          urls: [filePath+"/"+soundName+".mp3"],
          autoplay: true,
          loop: true,
          volume: 0.5,
          onend: function() {
            //alert('Finished!');
            }
          });
        soundRefByName[soundName]=newSound;
        //dbuga('loop new howl '+soundName);
 
        }  
      }  
    }  
  }

function statusCallback(theStatus){
  var statusArray=['MEDIA_NONE', 'MEDIA_STARTING', 'MEDIA_RUNNING', 'MEDIA_PAUSED', 'MEDIA_STOPPED'];
  //dbuga('media status '+statusArray[theStatus]);
  if(soundRefByName.hasOwnProperty("musicloop")){
    var loopRef=soundRefByName["musicloop"];
    loopRef.getCurrentPosition(
        // success callback
        function (position) {
            if (position > -1) {
                //dbuga((position) + " sec");
            if((ladCount>0)&&(theStatus==4)&&(position<.01)){loopStart("musicloop");}//loop hack for bullshit media
            }
        },
        // error callback
        function (e) {
            //dbuga("Error getting pos=" + e);
        }
    );
    }
  }
function errorCallback(er){
  //dbuga("media error "+JSON.stringify(er))
  }
function successCallback(evt){
  //dbuga("HEY ": + JSON.stringify(evt));
  //singMedia.play();
  }


function oneShotLoad(soundName){
  if(platform=="android"){
    var newSound = new Media(filePath+"/"+soundName+".mp3");
    soundRefByName[soundName]=newSound;
    //dbuga('new Media '+soundName);
    }
  if((platform=="web")||(platform=="local")){
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga('extant');
      }
    else{
      //dbuga('oneShotLoad new howl');
      var newSound = new Howl({
        urls: [filePath+"/"+soundName+".mp3"],
        autoplay: false,
        loop: false,
        volume: 0.5,
        onend: function() {
          //alert('Finished!');
          }
        });
      soundRefByName[soundName]=newSound;
      }  
    }  
  }
function loopStop(soundName){
  if(platform=="android"){
    //dbuga('ANDROID loopStop');
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga('extant '+soundName);
      //dbuga('stop andriod');
      soundRefByName[soundName].stop();
      }  
    }
  if((platform=="web")||(platform=="local")){
    openedWithStupidLoop=false;
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga('extant '+soundName+' stop howl');
      soundRefByName[soundName].stop();
      }  
    else{
      //dbuga('non-extant '+soundName);
      }
    }  
  }
var persistenceObject={"music":"on", "sfx":"on"};
function loopLoad(soundName){
  if(platform=="android"){
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga(' - extant '+soundName);
      //soundRefByName[soundName].stop();
      soundRefByName[soundName].play();
      //dbuga(' - played');
      }
    else{
      var newSound = new Media(filePath+"/"+soundName+".mp3", successCallback, errorCallback, statusCallback);
      soundRefByName[soundName]=newSound;
      //dbuga('new Media '+soundName);
      }
    }
  if((platform=="web")||(platform=="local")){
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga(' - extant: '+ soundName);
      }
    else{
      var shallAutoplay=false;
      if(settingsObject.Music. value != "Off"){
        shallAutoplay=true;
        openedWithStupidLoop=true;
        }
      //dbuga('loopLoad - new Howl: '+ soundName);
      var newSound = new Howl({
        urls: [filePath+"/"+soundName+".mp3"],
        autoplay: shallAutoplay,
        loop: true,
        volume: 0.5,
        onend: function() {
          //alert('Finished!');
          }
        });
      soundRefByName[soundName]=newSound;
      }  
    }  
  }


function playSound(theSound){
  return false;
  if((settingsObject["Sounds"].value != "Off")&&(paused==false)){
    oneShot(theSound);
    }
  }

function resetResetLabel(){
  for (var n=0; n<navButtons.length; n++){
    if(navButtons[n].label=="reset"){navButtons[n].selected=false;}
    }
  updateNavCanv();
  }
function resetUndoLabel(){
  for (var n=0; n<navButtons.length; n++){
    if(navButtons[n].label=="undo"){navButtons[n].selected=false;}
    }
  updateNavCanv();
  }
function undo(){
  lastItemType=buildSequence[buildSequence.length-1].type;
  if((lastItemType != "source")&&(lastItemType != "dest")&&(lastItemType != "train")){
    trash=buildSequence.pop();
    }
  //dbugBuildSequence();
  //resetBoardTimersObjects();
  rebuildTracks();
  }

function handleEventNav(e){// fubar but still in
  if(e.type=="touchstart"){
    firstRun=false;
    var target="";
    var buttNum=-1;
    for (var n=0; n<navButtons.length; n++){
      if (xyInTrbl(e.touches[0].pageX, e.touches[0].pageY, navButtons[n])){
        target=navButtons[n].label;
        buttNum=n;
        }
      }
    if(target == "levels"){
      if(levelsUp){
        closeModals();
        minFramesPerSecond=-4;
        navButtons[buttNum].selected=false;
        }
      else{
        openModal("levels");
        navButtons[buttNum].selected=true;
        }
      }
    if(target == "settings"){
      if(settingsUp){
        closeModals();
        minFramesPerSecond=-4;
        navButtons[buttNum].selected=false;
        }
      else{
        openModal("settings");
        navButtons[buttNum].selected=true;
        }
      }
    if (target == "undo"){
      undo();
      navButtons[buttNum].selected=true;
      window.setTimeout('resetUndoLabel()', 400);
      }
    if (target == "reset"){
      resetBoardTimersObjects();
      removeAllTracks();
      rebuildSequence();
      navButtons[buttNum].selected=true;
      window.setTimeout('resetResetLabel()', 400);
      }
    }
  if(target != ""){
    updateNavCanv();
    }
  }

function removeAllTracks(){
  //dbug('');
  var tempSequence=buildSequence;
  buildSequence=new Array();
  for (var i in tempSequence){
    if(tempSequence[i].type!="track"){
      buildSequence.push(tempSequence[i]);
      }
    }
  }
function dbugBuildSequence(){
  //dbug('');
  for (var i in buildSequence){
    item=buildSequence[i];
    //dbuga("x="+item.x+" y="+item.y+" type="+item.type+"<br>");
    }
  }
function rebuildSequence(){
  console.log('rebuildSequence()');
  //dbugaObject(destData);
  for (var i in buildSequence){
    item=buildSequence[i];
    type=item.type;
    if(type=="dest"){
      //dbugaObject(item);
      var newDest=destObject(item.color, item.dir, item.x, item.y);
      //dbugaObject(newDest);
      destData.push(newDest);
      }
    if(type=="train"){
      var t=trainObject(item.color, item.x, item.y, item.dir);
      trainData.push(t);
      }
    if(type=="source"){
      sourceData.push(sourceObject(item.color, item.dir, item.x, item.y, item.barrels));
      displayBarrels("grid_"+item.x+"_"+item.y, item.barrels); 
      }
    if(type=="track"){
      createTrack(item.dir, "grid_"+item.x+"_"+item.y);
      createCanvasTrack(item.dir, item.x, item.y);
      }
    }
  //dbuga(JSON.stringify(tilesByGridXY));
  

  restartIntervals();



  }

function rebuildTracks(){
  //dbuga('rebuildTracks()');
  trackContext.clearRect(0, 0, boardWidth, boardHeight)
  document.getElementById("trackCanvas").width=boardWidth;
  //eraseGridData
  tilesByGridXY={};
  for (x=0; x<cellsAcross; x++){
    for (y=0; y<cellsDown; y++){
      gridXY="grid_"+x+"_"+y;
      tilesByGridXY[gridXY]=new Array();
      }
    }
  for (var i in buildSequence){
    item=buildSequence[i];
    type=item.type;
    var targetCell="";
    if(type=="dest"){
      targetCell="grid_"+item.x+"_"+item.y;
      createTrack(item.dir+"d", targetCell);
      tilesByGridXY[targetCell].push("tiledest"+item.color);
      createCanvasTrack(item.dir+"d", item.x, item.y);
      }
    if(type=="source"){
      targetCell="grid_"+item.x+"_"+item.y;
      createTrack(item.dir+"s", targetCell);
      tilesByGridXY[targetCell].push("tilesource"+item.color);
      createCanvasTrack(item.dir+"s", item.x, item.y);
      }
    if(type=="track"){
      createTrack(item.dir, "grid_"+item.x+"_"+item.y);
      createCanvasTrack(item.dir, item.x, item.y);
      }
    }
  //dbuga(JSON.stringify(tilesByGridXY));
  //restartIntervals();
  }
var progDivHeight=12;
var uiDivHeight=16;
var uiTop=100;
var squarePadLeft=0;

function setupClasses(){
  //dbuga("setupClasses()");
  var p=cellSize/96

  var buttonsTop=30*p;
  var buttonsLeft=0*p;

  var progDivTop=1;
  var progDivLeft=0;
  var progDivWidth=screenWidth;

  var childrenSize=82*p;
  var childrenPad=4*p;
  squarePadTop=0;
  squarePadLeft=0;
  if(viewportAspect<1){squarePadTop=screenHeight/2-screenWidth/2;}//portrait
  else{squarePadLeft=screenHeight/2-screenWidth/2;}//landscape
    

  //dbuga('screenWidth='+screenWidth);
  //dbuga('screenHeight='+screenHeight);
  //dbuga('squarePadLeft='+squarePadLeft);
  //dbuga('squarePadTop='+squarePadTop);
 
  
  uiTop=screenHeight-progDivHeight;
  
  addStyle('#arrowCircle', 'position:absolute; left:' + p*12 + 'px; top:' + p*12 + 'px; border-color:#DA251C;  border-style:solid; border-width:' + p*12 + 'px;  width:' + p*40 + 'px;  height:' + p*40 + 'px; -webkit-border-radius:' + p*48 + 'px;');
  addStyle('#arrowPoint', 'position:absolute; left:' + p*36 + 'px; top:' + p*5 + 'px; border-color:#fff #DA251C #fff  #fff ;  border-style:solid ;  border-width:' + p*15 + 'px ' + p*15 + 'px ' + p*15 + 'px 0px ;  width:0;  height:0;');
  addStyle('#progressHolder', 'position:absolute; top:' + uiTop + 'px; left:0; width:' + screenWidth + 'px; height:' + uiDivHeight + 'px;');
  addStyle('#progressDiv', 'position:absolute; display:block; overflow:hidden; width:' + progDivWidth + 'px; height:' + progDivHeight + 'px; position:absolute; top:' + progDivTop + 'px; left:' + progDivLeft + 'px; Zbackground-color:#fff;');
  addStyle('.grow', '  height:' + progDivHeight + 'px; width:' + p*100 + 'px; float:left;  Zwebkit-transition: width 1s ease;  ');
  addStyle('#helpCanvas', 'position:absolute; top:' + squarePadTop + 'px; left:' + squarePadLeft + 'px; background-color:rgba(0,0,255,.85);');
  document.getElementById('helpCanvas').width=screenWidth;
  document.getElementById('helpCanvas').height=screenWidth;
  addStyle('#compCanvas', 'position:absolute; top:' + squarePadTop + 'px; left:' + squarePadLeft + 'px; background-color:rgba(0,0,255,.85);');
  document.getElementById('compCanvas').width=screenWidth;
  document.getElementById('compCanvas').height=screenWidth;
  var loadingPx=Math.floor(screenWidth/6);
  addStyle('#loadingCanvas', 'position:absolute; top:0px; left:0px; Zbackground-color:rgba(255,0,0,.85);');
  document.getElementById('loadingCanvas').width=loadingPx;
  document.getElementById('loadingCanvas').height=loadingPx;

  addStyle('#highlighter', 'width:' + p*94 + 'px; height:' + p*94 + 'px; position:absolute;    -webkit-border-radius:' + p*20 + 'px;    background-color:#FFFF00;    opacity:1;    display:none;');
  addStyle('.tile', 'width:' + p*94 + 'px; height:' + p*94 + 'px; position:absolute;    border:0px #0000ee solid;    -webkit-border-radius:' + p*20 + 'px;    ');
  addStyle('.tiledestgreen', 'margin:' + p*14 + 'px; width:' + p*66 + 'px; height:' + p*66 + 'px; position:absolute;    background-color:#3C746B;    -webkit-border-radius:' + p*48 + 'px;    ');
  addStyle('.tiledestblue', 'margin:' + p*14 + 'px; width:' + p*66 + 'px; height:' + p*66 + 'px; position:absolute;    background-color:#005BA1;    -webkit-border-radius:' + p*48 + 'px;    ');
  addStyle('.tiledestblack', 'margin:' + p*14 + 'px; width:' + p*66 + 'px; height:' + p*66 + 'px; position:absolute;    background-color:#000000;    -webkit-border-radius:' + p*48 + 'px;    ');
  addStyle('.tiledestorange', 'margin:' + p*14 + 'px; width:' + p*66 + 'px; height:' + p*66 + 'px; position:absolute;    background-color:#DA251C;    -webkit-border-radius:' + p*48 + 'px;    ');
  addStyle('.tilesourcegreen', 'margin:' + p*4 + 'px; width:' + p*86 + 'px; height:' + p*86 + 'px; position:absolute;    background-color:#3C746B;    -webkit-border-radius:' + p*16 + 'px;    ');
  addStyle('.tilesourceblue', 'margin:' + p*4 + 'px; width:' + p*86 + 'px; height:' + p*86 + 'px; position:absolute;    background-color:#005BA1;    -webkit-border-radius:' + p*16 + 'px;    ');
  addStyle('.tilesourceblack', 'margin:' + p*4 + 'px; width:' + p*86 + 'px; height:' + p*86 + 'px; position:absolute;    background-color:#000000;    -webkit-border-radius:' + p*16 + 'px;    ');
  addStyle('.tilesourceorange', 'margin:' + p*4 + 'px; width:' + p*86 + 'px; height:' + p*86 + 'px; position:absolute;    background-color:#DA251C;    -webkit-border-radius:' + p*16 + 'px;    ');

  addStyle('.dot', '-webkit-border-radius:' + p*8 + 'px; position:absolute; width:' + p*24 + 'px; height:' + p*12 + 'px; opacity:0;');
  addStyle('.dot1', 'left:' + p*7 + 'px; top:' + p*13 + 'px;');
  addStyle('.dot2', 'left:' + p*55 + 'px; top:' + p*13 + 'px;');
  addStyle('.dot3', 'left:' + p*7 + 'px; top:' + p*61 + 'px;');
  addStyle('.dot4', 'left:' + p*55 + 'px; top:' + p*61 + 'px;');

  for(var s=0; s<=20; s++){
    addStyle('.L'+s, 'left:' + p*96*s + 'px;');
    addStyle('.T'+s, 'top:' + p*96*s + 'px;');
    }


  addStyle('.tbLeft', 'top:' + p*0 + 'px; left:' + p*38 + 'px; width:' + p*10 + 'px; height:' + p*94 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.tbRight', 'top:' + p*0 + 'px; left:' + p*54 + 'px; width:' + p*10 + 'px; height:' + p*94 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.lrTop', 'top:' + p*38 + 'px; left:' + p*0 + 'px; width:' + p*94 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.lrBottom', 'top:' + p*54 + 'px; left:' + p*0 + 'px; width:' + p*94 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');

  addStyle('.rTop', 'top:' + p*38 + 'px; left:' + p*47 + 'px; width:' + p*47 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.rBottom', 'top:' + p*54 + 'px; left:' + p*47 + 'px; width:' + p*47 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.lTop', 'top:' + p*38 + 'px; left:' + p*0 + 'px; width:' + p*47 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.lBottom', 'top:' + p*54 + 'px; left:' + p*0 + 'px; width:' + p*47 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.bLeft', 'top:' + p*47 + 'px; left:' + p*38 + 'px; width:' + p*10 + 'px; height:' + p*47 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.bRight', 'top:' + p*47 + 'px; left:' + p*54 + 'px; width:' + p*10 + 'px; height:' + p*47 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.tLeft', 'top:' + p*0 + 'px; left:' + p*38 + 'px; width:' + p*10 + 'px; height:' + p*46 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.tRight', 'top:' + p*0 + 'px; left:' + p*54 + 'px; width:' + p*10 + 'px; height:' + p*46 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');

  addStyle('.brOuter', 'top:' + p*38 + 'px; left:' + p*38 + 'px; width:' + p*54 + 'px; height:' + p*54 + 'px; border-top:' + p*2 + 'px #888  solid; border-left:' + p*2 + 'px #888 solid; -webkit-border-top-left-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.brInner', 'top:' + p*54 + 'px; left:' + p*54 + 'px; width:' + p*38 + 'px; height:' + p*38 + 'px; border-top:' + p*2 + 'px #888  solid; border-left:' + p*2 + 'px #888  solid; -webkit-border-top-left-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.tlOuter', 'top:' + p*0 + 'px; left:' + p*0 + 'px; width:' + p*54 + 'px; height:' + p*54 + 'px; border-bottom:' + p*2 + 'px #888  solid; border-right:' + p*2 + 'px #888  solid; -webkit-border-bottom-right-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.tlInner', 'top:' + p*0 + 'px; left:' + p*0 + 'px; width:' + p*38 + 'px; height:' + p*38 + 'px; border-bottom:' + p*2 + 'px #888  solid; border-right:' + p*2 + 'px #888  solid; -webkit-border-bottom-right-radius:' + p*100 + 'px; position:absolute;');

  addStyle('.trOuter', 'top:' + p*0 + 'px; left:' + p*38 + 'px; width:' + p*54 + 'px; height:' + p*54 + 'px; border-bottom:' + p*2 + 'px #888  solid; border-left:' + p*2 + 'px #888  solid; -webkit-border-bottom-left-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.trInner', 'top:' + p*0 + 'px; left:' + p*54 + 'px; width:' + p*38 + 'px; height:' + p*38 + 'px; border-bottom:' + p*2 + 'px #888  solid; border-left:' + p*2 + 'px #888  solid; -webkit-border-bottom-left-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.blOuter', 'top:' + p*38 + 'px; left:' + p*0 + 'px; width:' + p*54 + 'px; height:' + p*54 + 'px; border-top:' + p*2 + 'px #888  solid; border-right:' + p*2 + 'px #888  solid; -webkit-border-top-right-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.blInner', 'top:' + p*54 + 'px; left:' + p*0 + 'px; width:' + p*38 + 'px; height:' + p*38 + 'px; border-top:' + p*2 + 'px #888  solid; border-right:' + p*2 + 'px #888  solid; -webkit-border-top-right-radius:' + p*100 + 'px; position:absolute;');
/*

  addStyle('.car', 'width:' + p*96 + 'px; height:' + cellSize + 'px; position:absolute;');
  addStyle('.coupler', 'top:' + p*0  + 'px; left:' + p*46 +'px; width:' + p*10 +'px; height:' + cellSize + 'px; border-left:' + p*4 + 'px #1F1A17 solid; position:absolute;');

  addStyle('.blueTank',   'width:' + p*24 + 'px; height:' + p*80 + 'px; position:absolute; top:' + p*8 + 'px; left:' + p*36 + 'px; -webkit-border-radius:' + p*8 + 'px; background-color:#76C5F0; -webkit-border-radius: ' + p*100 +'px');
  addStyle('.orangeTank', 'width:' + p*24 + 'px; height:' + p*80 + 'px; position:absolute; top:' + p*8 + 'px; left:' + p*36 + 'px; -webkit-border-radius:' + p*8 + 'px; background-color:#F1A334;');
  addStyle('.blackCar',   'width:' + p*16 + 'px; height:' + p*72 + 'px; position:absolute; top:' + p*8 + 'px; left:' + p*36 + 'px; border:' + p*4 + 'px #555 solid; background-color:#000000;');
  addStyle('.greenCar',   'width:' + p*16 + 'px; height:' + p*72 + 'px; position:absolute; top:' + p*8 + 'px; left:' + p*36 + 'px; border:' + p*4 + 'px #3FB3A0 solid; background-color:#3C746B;');

  addStyle('.blueTrainRear',    'width:' + p*28 + 'px; height:' + p*36 + 'px; top:' + p*52 + 'px; left:' + p*34 + 'px;  background-color:#76C5F0; position:absolute; ');
  addStyle('.blueTrainBody',    'width:' + p*24 + 'px; height:' + p*60 + 'px; top:' + p*12 + 'px; left:' + p*36 + 'px; background-color:#76C5F0; position:absolute; ');
  addStyle('.blueTrainTank',    'width:' + p*12 + 'px; height:' + p*60 + 'px; top:' + p*10 + 'px; left:' + p*42 + 'px; background-color:#005BA1; -webkit-border-radius: ' + p*100 +'px; position:absolute; ');
  addStyle('.blueTrainCatcher', 'width:' + p*16 + 'px; height:' + p*16 + 'px; top:' + p*0  + 'px; left:' + p*40 + 'px; background-color:#76C5F0; position:absolute; -webkit-transform: rotate(45deg);');

  addStyle('.orangeTrainRear',    'width:' + p*28 + 'px; height:' + p*36 + 'px; top:' + p*52 + 'px; left:' + p*34 + 'px;  background-color:#F1A334; position:absolute; ');
  addStyle('.orangeTrainBody',    'width:' + p*24 + 'px; height:' + p*60 + 'px; top:' + p*12 + 'px; left:' + p*36 + 'px; background-color:#F1A334; position:absolute; ');
  addStyle('.orangeTrainTank',    'width:' + p*12 + 'px; height:' + p*60 + 'px; top:' + p*10 + 'px; left:' + p*42 + 'px; background-color:#DA251C; -webkit-border-radius: ' + p*100 +'px; position:absolute; ');
  addStyle('.orangeTrainCatcher', 'width:' + p*16 + 'px; height:' + p*16 + 'px; top:' + p*0  + 'px; left:' + p*40 + 'px; background-color:#F1A334; position:absolute; -webkit-transform: rotate(45deg);');

  addStyle('.greenTrainRear',    'width:' + p*28 + 'px; height:' + p*36 + 'px; top:' + p*52 + 'px; left:' + p*34 + 'px; background-color:#3FB3A0; position:absolute; ');
  addStyle('.greenTrainBody',    'width:' + p*24 + 'px; height:' + p*60 + 'px; top:' + p*12 + 'px; left:' + p*36 + 'px; background-color:#3FB3A0; position:absolute; ');
  addStyle('.greenTrainTank',    'width:' + p*12 + 'px; height:' + p*60 + 'px; top:' + p*10 + 'px; left:' + p*42 + 'px; background-color:#3C746B; -webkit-border-radius: ' + p*100 +'px; position:absolute; ');
  addStyle('.greenTrainCatcher', 'width:' + p*16 + 'px; height:' + p*16 + 'px; top:' + p*0  + 'px; left:' + p*40 + 'px; background-color:#3FB3A0; position:absolute; -webkit-transform: rotate(45deg);');

  addStyle('.blackTrainRear',    'width:' + p*28 + 'px; height:' + p*36 + 'px; top:' + p*52 + 'px; left:' + p*34 + 'px; background-color:#555; position:absolute; ');
  addStyle('.blackTrainBody',    'width:' + p*24 + 'px; height:' + p*60 + 'px; top:' + p*12 + 'px; left:' + p*36 + 'px; background-color:#555; position:absolute; ');
  addStyle('.blackTrainTank',    'width:' + p*12 + 'px; height:' + p*60 + 'px; top:' + p*10 + 'px; left:' + p*42 + 'px; background-color:#000; -webkit-border-radius: ' + p*10 +'px; position:absolute; ');
  addStyle('.blackTrainCatcher', 'width:' + p*16 + 'px; height:' + p*16 + 'px; top:' + p*0  + 'px; left:' + p*40 + 'px; background-color:#555; position:absolute; -webkit-transform: rotate(45deg);');
*/
  }
var gridContext;
var trackContext;
function setupGridData(){
  //dbuga('setupGridData()');
  tilesByGridXY={};
  for (x=0; x<cellsAcross; x++){
    for (y=0; y<cellsDown; y++){
      var gridXY="grid_"+x+"_"+y;
      var newArray=[];
      tilesByGridXY[gridXY]=newArray;
      }
    }
  trackContext.clearRect(0, 0, boardWidth, boardHeight);
  document.getElementById("trackCanvas").width=boardWidth;
  }

function fillGridCanvas(){
  //dbuga('fillGridCanvas');
  document.getElementById('gridCanvas').width=boardWidth;
  if((settingsObject["Tiles"].value=="Grid")||(settingsObject["Tiles"].value=="Guides")){
    gridContext.lineWidth= cellSize/60;
    gridContext.strokeStyle = "rgb(220, 220, 220)";
    radius=20*cellSize/96;
    for (x=0; x<cellsAcross; x++){
      for (y=0; y<cellsDown; y++){
        roundRect(gridContext, x*cellSize, y*cellSize, cellSize, cellSize, radius, false, true);
        }
      }
    }
  if(settingsObject["Tiles"].value=="Guides"){
    var joint=cellSize/30;
    //gridContext.strokeStyle = "rgb(180, 180, 180)";
    gridContext.lineWidth= cellSize/15;  
    gridContext.beginPath();
    for (x=0; x<cellsAcross; x++){
      for (y=0; y<cellsDown; y++){
        if(isTiled(x, y)==false){//self
          if(isTiled(x, y-1)==false){//top
            gridContext.moveTo((x+.4125)*cellSize, y*cellSize-joint);
            gridContext.lineTo((x+.4125)*cellSize, y*cellSize+joint);
            gridContext.moveTo((x+.5875)*cellSize, y*cellSize-joint);
            gridContext.lineTo((x+.5875)*cellSize, y*cellSize+joint);
            }
          if(isTiled(x-1, y)==false){//left
            gridContext.moveTo(x*cellSize-joint, (y+.4125)*cellSize);
            gridContext.lineTo(x*cellSize+joint, (y+.4125)*cellSize);
            gridContext.moveTo(x*cellSize-joint, (y+.5875)*cellSize);
            gridContext.lineTo(x*cellSize+joint, (y+.5875)*cellSize);
            }
          }
        }
      }
    }
  gridContext.stroke();
  
  //gridContext.fillStyle = "rgba(0,0,255,.5)";
  //gridContext.beginPath();
  //gridContext.arc(boardWidth/2,boardHeight/2, cellSize/2 ,0,6.29,true);
  //gridContext.fill();
  }
function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
  if (typeof stroke == "undefined" ) {
    stroke = true;
  }
  if (typeof radius === "undefined") {
    radius = 5;
  }
  ctx.beginPath();
  ctx.moveTo(x + radius, y);
  ctx.lineTo(x + width - radius, y);
  ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
  ctx.lineTo(x + width, y + height - radius);
  ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
  ctx.lineTo(x + radius, y + height);
  ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
  ctx.lineTo(x, y + radius);
  ctx.quadraticCurveTo(x, y, x + radius, y);
  ctx.closePath();
  if (stroke) {
    ctx.stroke();
  }
  if (fill) {
    ctx.fill();
  }        
}


//createCanvasTrack('lr', 2, 5)

function createCanvasTrack(theType, cellX, cellY){
  var originX=cellX*cellSize;
  var originY=cellY*cellSize;
  var unit=cellSize/12;

  // all ties
  if((settingsObject["Scale"]["value"]=="O")||(settingsObject["Scale"]["value"]=="HO")||(settingsObject["Scale"]["value"]=="N")){    
    trackContext.globalCompositeOperation = "destination-over";
    // N default case
    var start=.05;
    var step=.1;
    if(settingsObject["Scale"]["value"]=="N"){      
      trackContext.strokeStyle = "rgb(76,92,81)";
      trackContext.lineWidth = ""+Math.floor(5*unit)/10;
      }
    if(settingsObject["Scale"]["value"]=="HO"){      
      trackContext.strokeStyle = "rgb(88,89,57)";
      trackContext.lineWidth = ""+Math.floor(4*unit)/10;
      start=0.05;
      step=.09;
      }
    if(settingsObject["Scale"]["value"]=="O"){      
      trackContext.strokeStyle = "rgb(81,83,61)";
      trackContext.lineWidth = ""+Math.floor(8*unit)/10;
      start=.1;
      step=.4;
      }
    trackContext.beginPath();
    if((theType=="ts")||(theType=="td")){
      for (var y=start; y<=.5; y+=step){
        trackContext.moveTo(originX+4.5*unit, originY+y*cellSize);
        trackContext.lineTo(originX+7.5*unit, originY+y*cellSize);
        }
      }
    if((theType=="bs")||(theType=="bd")){
      for (var y=1-start; y>=.5; y-=step){
        trackContext.moveTo(originX+4.5*unit, originY+y*cellSize);
        trackContext.lineTo(originX+7.5*unit, originY+y*cellSize);
        }
      }
    if((theType=="ls")||(theType=="ld")){
      for (var x=start; x<=.5; x+=step){
        trackContext.moveTo(originX+cellSize*x, originY+4.5*unit);
        trackContext.lineTo(originX+cellSize*x, originY+7.5*unit);
        }
      }
    if((theType=="rs")||(theType=="rd")){
      for (var x=1-start; x>=.5; x-=step){
        trackContext.moveTo(originX+cellSize*x, originY+4.5*unit);
        trackContext.lineTo(originX+cellSize*x, originY+7.5*unit);
        }
      }
    if(theType=="lr"){
      for (var x=start; x<=1-start; x+=step){
        trackContext.moveTo(originX+cellSize*x, originY+4.5*unit);
        trackContext.lineTo(originX+cellSize*x, originY+7.5*unit);
        }
      }
    if(theType=="tb"){
      for (var y=start; y<=1-start; y+=step){
        trackContext.moveTo(originX+4.5*unit, originY+y*cellSize);
        trackContext.lineTo(originX+7.5*unit, originY+y*cellSize);
        }
      }
    if(theType=="br"){
      for (var deg=180+90*start; deg<=270-90*start/2; deg+=90*step){ // /2 not sure, floating point error?
        //dbuga(deg);
        trackContext.moveTo(originX+cellSize+4.5*unit*Math.cos(degToRad(deg)), originY+cellSize+4.5*unit*Math.sin(degToRad(deg)));
        trackContext.lineTo(originX+cellSize+7.5*unit*Math.cos(degToRad(deg)), originY+cellSize+7.5*unit*Math.sin(degToRad(deg)));
        }
      }
    if(theType=="bl"){
      for (var deg=270+90*start; deg<=360-90*start/2; deg+=90*step){
        //dbuga(deg);
        trackContext.moveTo(originX+4.5*unit*Math.cos(degToRad(deg)), originY+cellSize+4.5*unit*Math.sin(degToRad(deg)));
        trackContext.lineTo(originX+7.5*unit*Math.cos(degToRad(deg)), originY+cellSize+7.5*unit*Math.sin(degToRad(deg)));
        }
      }
    if(theType=="tl"){
      for (var deg=0+90*start; deg<=90-90*start/2; deg+=90*step){
        //dbuga(deg);
        trackContext.moveTo(originX+4.5*unit*Math.cos(degToRad(deg)), originY+4.5*unit*Math.sin(degToRad(deg)));
        trackContext.lineTo(originX+7.5*unit*Math.cos(degToRad(deg)), originY+7.5*unit*Math.sin(degToRad(deg)));
        }
      }
    if(theType=="tr"){
      for (var deg=90+90*start; deg<=180-90*start/2; deg+=90*step){
        //dbuga(deg);
        trackContext.moveTo(originX+cellSize+4.5*unit*Math.cos(degToRad(deg)), originY+4.5*unit*Math.sin(degToRad(deg)));
        trackContext.lineTo(originX+cellSize+7.5*unit*Math.cos(degToRad(deg)), originY+7.5*unit*Math.sin(degToRad(deg)));
        }
      }

    trackContext.stroke();
    }

  //normal two rails only
    trackContext.globalCompositeOperation = "source-over";

    if(settingsObject["Scale"]["value"]=="N"){      
      trackContext.strokeStyle = "rgb(199,185,172)";
      }
    if(settingsObject["Scale"]["value"]=="HO"){      
      trackContext.strokeStyle = "rgb(180,154,93)";
      }
    if(settingsObject["Scale"]["value"]=="O"){      
      trackContext.strokeStyle = "rgb(113,103,101)";
      }
  trackContext.lineWidth = ""+Math.floor(3*unit)/10;
  trackContext.beginPath();
  if((theType=="ts")||(theType=="td")){
    trackContext.moveTo(originX+5*unit, originY);
    trackContext.lineTo(originX+5*unit, originY+cellSize/2);
    trackContext.moveTo(originX+7*unit, originY);
    trackContext.lineTo(originX+7*unit, originY+cellSize/2);
    if(settingsObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+6*unit, originY);
      trackContext.lineTo(originX+6*unit, originY+cellSize/2);
      }
    }
  if((theType=="bs")||(theType=="bd")){
    trackContext.moveTo(originX+5*unit, originY+cellSize/2);
    trackContext.lineTo(originX+5*unit, originY+cellSize);
    trackContext.moveTo(originX+7*unit, originY+cellSize/2);
    trackContext.lineTo(originX+7*unit, originY+cellSize);
    if(settingsObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+6*unit, originY+cellSize/2);
      trackContext.lineTo(originX+6*unit, originY+cellSize);
      }
    }
  if((theType=="ls")||(theType=="ld")){
    trackContext.moveTo(originX, originY+5*unit);
    trackContext.lineTo(originX+cellSize/2, originY+5*unit);
    trackContext.moveTo(originX, originY+7*unit);
    trackContext.lineTo(originX+cellSize/2, originY+7*unit);
    if(settingsObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX, originY+6*unit);
      trackContext.lineTo(originX+cellSize/2, originY+6*unit);
      }
    }
  if((theType=="rs")||(theType=="rd")){
    trackContext.moveTo(originX+cellSize/2, originY+5*unit);
    trackContext.lineTo(originX+cellSize, originY+5*unit);
    trackContext.moveTo(originX+cellSize/2, originY+7*unit);
    trackContext.lineTo(originX+cellSize, originY+7*unit);
    if(settingsObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+cellSize/2, originY+6*unit);
      trackContext.lineTo(originX+cellSize, originY+6*unit);
      }
    }
  if(theType=="lr"){
    trackContext.moveTo(originX, originY+5*unit);
    trackContext.lineTo(originX+cellSize, originY+5*unit);
    trackContext.moveTo(originX, originY+7*unit);
    trackContext.lineTo(originX+cellSize, originY+7*unit);
    if(settingsObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX, originY+6*unit); //middle rail
      trackContext.lineTo(originX+cellSize, originY+6*unit);
      }
    }
  if(theType=="tb"){
    trackContext.moveTo(originX+5*unit, originY);
    trackContext.lineTo(originX+5*unit, originY+cellSize);
    trackContext.moveTo(originX+7*unit, originY);
    trackContext.lineTo(originX+7*unit, originY+cellSize);
    if(settingsObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+6*unit, originY);  //center rail
      trackContext.lineTo(originX+6*unit, originY+cellSize);
      }
    }
  if(theType=="br"){
    trackContext.arc(originX+cellSize, originY+cellSize, 7*unit, 1 * Math.PI, 1.5 * Math.PI, false);
    trackContext.moveTo(originX+7*unit, originY+cellSize);
    trackContext.arc(originX+cellSize, originY+cellSize, 5*unit, 1 * Math.PI, 1.5 * Math.PI, false);
    if(settingsObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+6*unit, originY+cellSize);
      trackContext.arc(originX+cellSize, originY+cellSize, 6*unit, 1 * Math.PI, 1.5 * Math.PI, false);
      }
    }
  if(theType=="bl"){
    trackContext.arc(originX, originY+cellSize, 7*unit, 0, 1.5 * Math.PI, true);
    trackContext.moveTo(originX+5*unit, originY+cellSize);
    trackContext.arc(originX, originY+cellSize, 5*unit, 0, 1.5 * Math.PI, true);
    if(settingsObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+6*unit, originY+cellSize);
      trackContext.arc(originX, originY+cellSize, 6*unit, 0, 1.5 * Math.PI, true);
      }
    }
  if(theType=="tl"){
    trackContext.arc(originX, originY, 7*unit, 0, .5 * Math.PI, false);
    trackContext.moveTo(originX+5*unit, originY);
    trackContext.arc(originX, originY, 5*unit, 0, .5 * Math.PI, false);
    if(settingsObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+6*unit, originY);
      trackContext.arc(originX, originY, 6*unit, 0, .5 * Math.PI, false);
      }
    }
  if(theType=="tr"){
    trackContext.arc(originX+cellSize, originY, 7*unit, Math.PI, .5 * Math.PI, true);
    trackContext.moveTo(originX+7*unit, originY);
    trackContext.arc(originX+cellSize, originY, 5*unit, Math.PI, .5 * Math.PI, true);
    if(settingsObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+6*unit, originY);
      trackContext.arc(originX+cellSize, originY, 6*unit, Math.PI, .5 * Math.PI, true);
      }
    }

  //trackContext.quadraticCurveTo(originX+cellSize, originY, originX, originY);
  trackContext.stroke();
  }
function setupCanvas(){
  //dbuga('setupCanvas()');
  //dbuga(" - boardHeight:"+boardHeight);


  htmlBlock="<canvas id=\"gridCanvas\" width=\""+boardWidth+"\" height=\""+boardHeight+"\" style=\"position:absolute;\"></canvas>";
  htmlBlock+="<canvas id=\"trackCanvas\" width=\""+boardWidth+"\" height=\""+boardHeight+"\" style=\"position:absolute;\"></canvas>";
  document.getElementById('canvasHolder').innerHTML=htmlBlock;
  gridContext = document.getElementById("gridCanvas").getContext("2d");
  trackContext = document.getElementById("trackCanvas").getContext("2d");

  }

function addStyle(styleName, styleCode){
  var style = document.createElement('style');
  style.type = 'text/css';
  style.innerHTML = styleName+' { '+styleCode+' }';
  document.getElementsByTagName('head')[0].appendChild(style);
  }
var screenWidth=100;
var screenHeight=100;
var viewportWidth=100;
var viewportHeight=100;
var screenAspect=screenWidth/screenHeight;
var viewportAspect=viewportWidth/viewportHeight;
var boardHeight=100;
var boardWidth=100;

var wrapper;
function changeGeometry(){
  viewportWidth = window.innerWidth;
  viewportHeight = window.innerHeight;
  viewportAspect=viewportWidth/viewportHeight;
  //dbuga("changeGeometry "+viewportWidth+" x "+viewportHeight+" viewportAspect:"+viewportAspect);
  changeView("changeGeometry");
    if(helpUp){updateHelpCanv();}
    if(compUp){updateCompCanv();}
  }

function mouseLevel(){
  if(platform=="android"){
    return false;
    }
  resetBoardTimersObjects();
  buildSequence=new Array();
  var fails=0;
  fails+=addColor(3,4);
  fails+=addColor(3,4);
  fails+=addColor(3,4);
  fails+=addColor(3,4);
  if(fails>0){
    //dbuga("retrying from scratch fails "+fails);
    ////mouseLevel();
    }
  }

var totalCells;
function toggleBanner(){
  bannerEnabled=!(bannerEnabled);
  initGeometry();

  changeView("toggleBanner");
  populateModals();
  }
function adGeometry(){
/*
32 - phones in landscape
50 - phones in portrait
90 - tablets in either orientation
More specifically, if the screen height of a device is between 400 and 720, an ad height of 50 is used in both orientations; for screen heights greater than 720, a 90 ad height is used.
*/
  document.getElementById('wrapper').style.top="0px";
  }

var colorsCanv;
var navCanv;

var helpImages=["info0", "info1", "info2", "info3", "info4"];
var atHelp=0;
var helpCanv;
var helpUp=true;
var compCanv;
var compUp=false;

var bannerEnabled=false;
var levelsCanv;
var levelsUp=false;
var settingsCanv;
var settingsUp=false;
var carsCanv;
var carsUp=false;
var graphicsCanv;
var graphicsUp=false;
var cameraCanv;

function initGeometry(){
  console.log("initGeometry()");
  helpCanv=document.getElementById("helpCanvas");
  compCanv=document.getElementById("compCanvas");
  levelsCanv=document.getElementById("levelsCanvas");
  settingsCanv=document.getElementById("settingsCanvas");
  carsCanv=document.getElementById("carsCanvas");
  graphicsCanv=document.getElementById("graphicsCanvas");
  cameraCanv=document.getElementById("cameraCanvas");


  colorsCanv=document.getElementById("colorsCanvas");
  navCanv=document.getElementById("navCanvas");
  wrapper=document.getElementById("wrapper");
  screenWidth = screen.width;
  screenHeight = screen.height;
  viewportWidth = window.innerWidth;
  viewportHeight = window.innerHeight;

  if(screenWidth>screenHeight){
    screenWidth = screen.height;
    screenHeight = screen.width;
    //dbuga('Landroid so swap screen dimensions');
    }// screen width is consistent with iOS now, width < height
  //dbuga("screenWidth="+screenWidth);
  //dbuga("screenHeight="+screenHeight);
  viewportAspect=viewportWidth/viewportHeight;

  if(screen.width==1680){// test iPhone dimension local

    screenWidth=320;
    screenHeight=480;//iphone 4

    screenHeight=Math.floor(320*16/9);//iphone 5

    screenWidth=414;//iphone 6+
    screenHeight=736;

    screenWidth=400;//cube 100
    screenHeight=736;
/*

    screenWidth=768;//ipad
    screenHeight=1024;

    screenWidth=600;//android
    screenHeight=1024;
*/
    }
  controlsPx=44;
  if(screenHeight>500){
    controlsPx=64;
    }
  screenAspect=screenWidth/screenHeight;
  document.getElementById('debugDiv').style.width=screenWidth+"px";
  
  //dbuga("initGeometry screen: "+screenWidth+" x "+screenHeight+" ");
  //dbuga("initGeometry viewport: "+ viewportWidth+" x "+ viewportHeight+" "+viewportAspect);

  adGeometry();
  boardGeometry();
  }
var cellsByWidth=[
{"width":320, "O":4, "HO":5, "N":6},
{"width":375, "O":4, "HO":5, "N":6},
{"width":414, "O":4, "HO":6, "N":8},
{"width":600, "O":6, "HO":8, "N":10},
{"width":768, "O":6, "HO":9, "N":12},
{"width":1024, "O":8, "HO":12, "N":16}
]
function returnCellsAcross(width, scale){
  var a=3;
  for (var c=0; c<cellsByWidth.length; c++){
    var group=cellsByWidth[c];
    if(width>=group.width){a=group[scale];}
    }
  return a;
  }
var boardPad=0;
var space=0;

function boardGeometry(){
  var scale=settingsObject["Scale"]["value"];
  cellsAcross=returnCellsAcross(screenWidth, scale)
  cellSize=Math.floor(10*screenWidth/cellsAcross)/10;
  //dbuga("cellSize="+cellSize);
  cubeSize=cellSize*shrink;
  cellsDown=Math.floor((screenHeight-controlsPx-13)/cellSize);
  totalCells=cellsAcross*cellsDown;
  space=(screenHeight-cellsDown*cellSize-controlsPx);
  boardPad=Math.floor(space/2);
  //dbuga("boardGeometry()");
  //dbuga(" - cellsAcross="+cellsAcross);
  //dbuga(" - cellsDown="+cellsDown);
  //dbuga(" - boardPad="+ boardPad);
  //dbuga(" - space="+space);

  boardWidth=screenWidth;
  boardHeight=cellsDown*cellSize;
  
  camera.style.webkitPerspective=boardHeight;
  //dbuga(" - boardHeight="+boardHeight +" boardWidth="+boardWidth);

  //wrapperHeight=(cellsDown+1.5)*cellSize;
  wrapper.style.width=boardWidth+"px";
  wrapper.style.height=boardHeight+"px";
  wrapper.style.left=0+"px";
  wrapper.style.top=0+"px";

  levelsCanv.width=screenWidth;
  levelsCanv.height=screenHeight;
  levelsCanv.style.top=controlsPx+"px";
  levelsCanv.style.left=(0-screenWidth)+"px";
  levelsCanv.style.backgroundColor=modalBg;

  settingsCanv.width=screenWidth;
  settingsCanv.height=screenHeight;
  settingsCanv.style.top=controlsPx+"px";
  settingsCanv.style.left=screenWidth+"px";
  settingsCanv.style.backgroundColor=modalBg;

  carsCanv.width=screenHeight;
  carsCanv.height=screenWidth-controlsPx;
  carsCanv.style.top=controlsPx+"px";
  carsCanv.style.left=screenHeight+"px";
  carsCanv.style.backgroundColor=modalBg;

  graphicsCanv.width=screenHeight;
  graphicsCanv.height=screenWidth-controlsPx;
  graphicsCanv.style.top=controlsPx+"px";
  graphicsCanv.style.left=screenHeight+"px";
  graphicsCanv.style.backgroundColor=modalBg;

  colorsCanv.width=screenHeight;
  colorsCanv.height=64;
  colorsCanv.style.top="0px";
  colorsCanv.style.left=0+"px";

  navCanv.width=screenWidth;
  navCanv.height=controlsPx;
  navCanv.style.top="0px";
  navCanv.style.left=0+"px";
  //navCanv.style.backgroundColor="rgba(33,33,255,"+bgAlpha+")";

  cellSizeHalf=cellSize/2;
  centerSize=cellSize/4;
  createInitialBuildSequence();
  setupClasses();
  setupCanvas();// maybe move to resetBoardTimersObjects() 
  //fillGridCanvas();// di move there 
  document.getElementById('gridCanvas').style.transform="translateZ(-"+cellSize/40+"px)"
  document.getElementById('fieldHolder').style.transform="translateZ(-"+cellSize/48+"px)"
  }
var destMs;
function restartIntervals(){ 
  fillGridCanvas();
  //dbuga('restartIntervals()');
  minFramesPerSecond=-4;
  //window.clearInterval(turnInterval);
  window.clearInterval(sourceInterval);
  window.clearInterval(destInterval);
  turnMs=Math.floor(1000/trainData.length);
  sourceMs=Math.floor(10000/sourceCount);
  destMs=Math.floor(1000/trainData.length);


    //turnInterval=window.setInterval(turnTick, turnMs);
    sourceInterval=window.setInterval(sourceTick, sourceMs);
    destInterval=window.setInterval(destTick, destMs);
  }
var platform="unknown";
var filePath="";
function debugStorage(){
  //dbuga("musicOn:"+localStorage.getItem("musicOn")+" sfxOn:"+localStorage.getItem("sfxOn"));
  }
var atLevel=0;
var levelData=[

    {"fields":[1,1], "space":16, "tank":false},
    {"fields":[2,2], "space":24, "tank":false},
    {"fields":[1,1,1], "space":24, "tank":false},
    {"fields":[2,2,2], "space":36, "tank":false},
    {"fields":[3,3], "space":32, "tank":false},
    {"fields":[1,1,1,1], "space":32, "tank":false},

    {"fields":[2,2,2,2], "space":48, "tank":false},
    {"fields":[3,3,3], "space":48, "tank":false},

    {"fields":[3,3,3,3], "space":72, "tank":false},
    
    {"fields":[4,4,4], "space":80, "tank":false},
    {"fields":[4,4,4,4], "space":80, "tank":false},
    {"fields":[19], "space":80, "tank":true},
    {"fields":[11], "space":40, "tank":true},
    {"fields":[3], "space":24, "tank":true}
  ];


var colorByNum=["orange","black","blue","green"];

// Possible Cell Counts
/*
Small 6 or 8 levels iPhone 4
4   42  48

medium 8 or 10 iphone 5/6
medium 6 or 10 iphone 6+
5   54  60  
6   54  60
6+  48  60
 
large ipad 9 or 12
P   72  80


mp  70  77

42 
48 
54 
60
72 iPad banner
70 
77  
80 iPad

    {"fields":[1,1,1], "space":24, "tank":false},
    {"fields":[5], "space":24, "tank":true},


*/
/* ------------------------------ POPULATE MODALS ---------------------------------- */

var graphicsSelectedColorNum=0;
var graphicsSelectedGraphic=0;
var graphicsEditing=false;
function openGraphics(carButton){
  console.log('openGraphics(carButton)');
  console.log(carButton);
  graphicsSelectedColorNum=carButton.c;
  graphicsSelectedGraphic=carButton.g;
  populateGraphics();
  openModal("graphics");
  //dbuga('carButton.c='+carButton.c+' focusCars='+focusCars);
  var color=colorList[focusCars];
  lastByColor[color]=carButton.g;
  //dbuga('set '+color+' '+lastByColor[color]);
  }

function populateGraphics(){

//[graphicsSelectedGraphic];

  dbuga('populateGraphics 0');
  graphicsCanv.width=screenHeight;
  var graphicsCtx=graphicsCanv.getContext('2d');

  var graphic=graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic];

  var gtl=gtlInWh(screenHeight, screenWidth-controlsPx-controlsPx-20);
  var g=gtl.g;
  var topPad=gtl.t;
  var leftPad=gtl.l;


  var buttonWidth=g*9;
  var buttonHeight=g*3;
  //dbuga("topPad="+topPad);
  //dbuga("leftPad="+leftPad);
  //end new

  var carButton={"buttonId":"car"}
  carButton.c=graphicsSelectedColorNum;
  carButton.g=graphicsSelectedGraphic;
  carButton.l=leftPad;
  carButton.r=leftPad+buttonWidth;
  carButton.t=topPad;
  carButton.b=topPad+buttonHeight;
  carButton.ref=graphic.ref;
  //graphicsButtons.push(carButton);
  var imageObj = imgRefs["boxside"+colorArray[carButton.c]];
  graphicsCtx.drawImage(imageObj, carButton.l, carButton.t, buttonWidth, buttonHeight);
  //dbuga('populateGraphics 9');

  graphicsCtx.drawImage(carButton.ref, carButton.l, carButton.t, buttonWidth, buttonHeight);
  //cameraCanv.style.display="none";


  graphicsButtons=[];

  if(graphicsEditing==false){
    graphicsButtons.push(returnModalButton("Done","right","landscape",false));
    graphicsButtons.push(returnModalButton("Camera","center","landscape",false));
    graphicsButtons.push(returnModalButton("Transparent","left","landscape",graphic.blackTrans));
    }
  else{
    graphicsButtons.push(returnModalButton("Save","left","landscape",false));
    graphicsButtons.push(returnModalButton("Retake","center","landscape",false));
    graphicsButtons.push(returnModalButton("Cancel","right","landscape",false));
    }

  for(var gb=0; gb<graphicsButtons.length; gb++){
    drawModalButton(graphicsCtx, graphicsButtons[gb]);
    }

  //dbuga('populateGraphics 10');

  }

function populateCars(){
  carsCanv.width=carsCanv.width;

  var gtl=gtlInWh(screenHeight, screenWidth-controlsPx-controlsPx-20);
  var g=gtl.g;
  var topPad=gtl.t;
  var leftPad=gtl.l;

  carsThumbs=[];
  var buttonWidth=g*3;
  var buttonHeight=g*1;
  dbuga("populateCars topPad="+topPad);
  //dbuga("leftPad="+leftPad);
  var carsCtx=carsCanv.getContext('2d');
  carsCtx.lineWidth=buttonHeight/12;
  for (var i=0; i<graphicsByColor[colorArray[focusCars]].length; i++){
    var graphic=graphicsByColor[colorArray[focusCars]][i];
    
    var carThumb={"buttonId":"car_"+focusCars+"-"+i};
    //dbuga(carThumb.buttonId);
    carThumb.c=focusCars;
    carThumb.g=i;
    carThumb.l=leftPad+buttonWidth*graphic.x;
    carThumb.r=leftPad+buttonWidth*graphic.x+buttonWidth;
    carThumb.t=topPad+buttonHeight*graphic.y;
    carThumb.b=topPad+buttonHeight*graphic.y+buttonHeight;
    carThumb.ref=graphic.ref;
    carsThumbs.push(carThumb);
    }


  for (var ct=0; ct<carsThumbs.length; ct++){
    var carThumb=carsThumbs[ct];

    carsCtx.strokeStyle="rgba(42,42,42,.25)";
    carsCtx.fillStyle="rgba(255,255,255,.9)";
    //roundRect(carsCtx, carThumb.l, carThumb.t, buttonWidth, buttonHeight, radius, true, false);
    
   
    var imageObj = imgRefs["boxside"+colorArray[carThumb.c]];
    carsCtx.drawImage(imageObj, carThumb.l, carThumb.t, buttonWidth, buttonHeight);
    

    carsCtx.drawImage(carThumb.ref, carThumb.l, carThumb.t, buttonWidth, buttonHeight);
    }
  carsButtons=[];
  if(clearingAll){
    carsButtons.push(returnModalButton("Sure?","center","landscape",false));
    carsButtons.push(returnModalButton("Cancel","right","landscape",false));
    }
  else{
    carsButtons.push(returnModalButton("Clear","left","landscape",false));
    carsButtons.push(returnModalButton("Done","right","landscape",false));
    }

  for(var cb=0; cb<carsButtons.length; cb++){
    drawModalButton(carsCtx, carsButtons[cb]);
    }
  minFramesPerSecond=-4;
  }
var clearingAll=false;
var settingsButtons=[
];
var levelButtons=[
];
var colorsButtons=[
];


function returnModalButton(label,align,orient,selected){
  //dbuga('returnModalButton('+label+','+align+','+orient+','+selected+')');
  var modalButton={"selected":selected, "label":label, "l":0, "r":0, "t":0, "b":0, "align":align};
  var buttonPad=9;
  var buttonWidth=controlsPx*2;
  var buttonHeight=controlsPx;
  var spread=(screenWidth-(buttonWidth+buttonPad*1.5)*3)/4;
  //dbug('spread:'+spread)
  var topPx=screenHeight-1-buttonPad-buttonHeight-controlsPx;
  //if(helpUp){topPx=screenWidth-buttonHeight-buttonPad;}
  var centerPx=screenWidth/2;
  if(orient=="landscape"){
    spread=(screenHeight-320)/12;
    topPx=screenWidth-1-buttonPad-buttonHeight-controlsPx;
    centerPx=screenHeight/2;
    buttonWidth*=1.5;
    //dbuga(label+' topPx:'+topPx+' screenWidth:'+screenWidth);
    }
  var leftPx=1+buttonPad+spread;
  if(align=="center"){leftPx=centerPx-buttonWidth/2;}
  if(align=="right"){leftPx=centerPx*2-1-buttonWidth-buttonPad-spread;}
  if(align=="square"){
    leftPx=squarePadLeft;
    topPx=squarePadTop;
    buttonWidth=screenWidth;
    buttonHeight=screenWidth;
    }

  modalButton.l=leftPx;
  modalButton.r=leftPx+buttonWidth;
  modalButton.t=topPx;
  modalButton.b=topPx+buttonHeight;
  return modalButton;
  }


var buttonStroke="rgba(60,60,60,0)";
var buttonFill="rgba(60,60,60,1)";

var buttonLabelStroke="rgba(0,0,0,0)";
var buttonLabelFill="#fff";


function drawModalButton(ctx, modalButton){
  if(modalButton.align=="square"){return false;}
  var buttonWidth=modalButton.r-modalButton.l;
  var buttonHeight=(modalButton.b- modalButton.t)*.75;
  //dbuga("drawModalButton "+modalButton.label);
  var buttonLine=buttonHeight/12;
  ctx.lineWidth=buttonLine;
  //dbuga(buttonLine);
  ctx.strokeStyle=buttonStroke;
  ctx.fillStyle=buttonFill;
  if(modalButton.label != "Transparent"){
    roundRect(ctx, modalButton.l, modalButton.t, buttonWidth, buttonHeight, buttonHeight/2, true, true);
    }
  var bcx=modalButton.l/2+modalButton.r/2;
  var bcy=modalButton.t+buttonHeight/2;
  var settingsFont=Math.floor(buttonHeight/2)+"px akziBold";
  ctx.font=settingsFont;
  ctx.lineCap="round";
  ctx.fillStyle=buttonLabelFill;
  ctx.strokeStyle=buttonLabelStroke;
  ctx.lineWidth=buttonLine/3;//text fattener
  ctx.textBaseline="middle";
  if(modalButton.label != "Transparent"){
    ctx.textAlign="center";
    ctx.strokeText(modalButton.label, bcx,bcy);
    ctx.fillText(modalButton.label, bcx,bcy);
    }
  else{// checkbox
    ctx.textAlign="left";
    ctx.fillStyle=buttonFill;
    ctx.strokeStyle=buttonFill;

    ctx.strokeText(modalButton.label, modalButton.l+buttonHeight/1.5,bcy);
    ctx.fillText(modalButton.label, modalButton.l+buttonHeight/1.5,bcy);
    var ref=document.getElementById("uncheckedPreload");
    ctx.globalAlpha=.75;
    if(graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic].blackTrans){
      ref=document.getElementById("checkedPreload");
      }
    ctx.drawImage(ref,modalButton.l,modalButton.t+buttonHeight/4,buttonHeight/2,buttonHeight/2); 
    ctx.globalAlpha=1;
    }
  }


function populateSettings(){
/*
  var groupAspect=(54+4)/(18+4);// matches car group width, padding
  var availHeight=screenWidth-controlsPx-controlsPx-20;
  var areaAspect=screenHeight/availHeight;
  var leftPad=0;
  var topPad=0;
  var g=0;
  if(areaAspect>groupAspect){//fit height, pad left
    g=availHeight/(4*6+4);
    topPad=g*2;
    leftPad=g*2+screenHeight/2-g*(3*18+4)/2;
    }
  else{//fit width, pad top // always for this aspect anyways.
    g=screenHeight/(54+4);
    leftPad=g*2;
    topPad=g*2+availHeight/2-g*(18+4)/2;
    }
  var buttonWidth=g*54;
  var buttonHeight=g*18;

*/

  var g=screenWidth/16;
  var radius=g/6;
  var cx=8;
  var cy=(screenHeight/2-screenWidth/2)/g+8.5;
  //dbuga("cy "+cy);
  var settingsCtx=settingsCanv.getContext('2d');
  settingsButtons=[];
  settingsButtons.push(returnModalButton("Help","left","portrait",false));
  settingsButtons.push(returnModalButton("About","center","portrait",false));
  settingsButtons.push(returnModalButton("Done","right","portrait",false));
  }
function drawSettingsButtons(){
  //dbuga('drawSettingsButtons');
  var settingsCtx=settingsCanv.getContext('2d');
  for (var b=0; b<settingsButtons.length; b++){
    drawModalButton(settingsCtx, settingsButtons[b]);
    }
  }
function drawHelpButtons(){
  //dbuga('drawSettingsButtons');
  var helpCtx=helpCanv.getContext('2d');
  for (var b=0; b<helpButtons.length; b++){
    drawModalButton(helpCtx, helpButtons[b]);
    }
  }
function drawCompButtons(){
  //dbuga('drawSettingsButtons');
  var compCtx=compCanv.getContext('2d');
  for (var b=0; b<compButtons.length; b++){
    drawModalButton(compCtx, compButtons[b]);
    }
  }
var levelsGridPx=0;
var levelsTopPad=0;
var levelsLeftPad=0;


var levelBoxes=[];
function populateLevels(){
  levelBoxes=[];
  var tankFound=false;
  //dbuga('populateLevels() cellSize='+cellSize);
  for (var dNum=0; dNum<levelData.length; dNum++){
    if(levelData[dNum].space <= totalCells){
      if(levelData[dNum].tank){
        if(tankFound==false){
          levelBoxes.push({"num":dNum});
          tankFound=true;
          }
        }
      else{// not tank
        levelBoxes.push({"num":dNum});
        }
      }
    }
  var buttonsAcross=2;
  if(levelBoxes.length>8){
    buttonsAcross=3;
    }
  var buttonsDown=Math.ceil(levelBoxes.length/buttonsAcross);
  var gridAcross=buttonsAcross*2+2;
  var gridDown=buttonsDown*2+3;
  var gridAspect=gridAcross/gridDown;
  var canvasAspect=screenWidth/screenHeight;
  if(gridAspect>canvasAspect){// fit width, pad top
    levelsGridPx=screenWidth/gridAcross;
    levelsLeftPad=0;
    levelsTopPad=(screenHeight-levelsGridPx*gridDown)/2;
    //dbuga(' - fit width');
    }
  else{
    levelsGridPx=screenHeight/gridDown;
    levelsTopPad=0;
    levelsLeftPad=(screenWidth-levelsGridPx*gridAcross)/2;
    }
  var buttonSize=levelsGridPx*2;
  //dbuga('populateLevels() levelsTopPad='+levelsTopPad+' buttonsDown:'+buttonsDown+' gridAspect:'+gridAspect);
  for (var b=0; b<levelBoxes.length; b++){
    levelBoxes[b].l=b%buttonsAcross*buttonSize+levelsLeftPad+levelsGridPx;
    levelBoxes[b].r=b%buttonsAcross*buttonSize+levelsLeftPad+buttonSize+levelsGridPx;
    levelBoxes[b].t=Math.floor(b/buttonsAcross)*buttonSize+levelsTopPad+levelsGridPx;
    levelBoxes[b].b=Math.floor(b/buttonsAcross)*buttonSize+levelsTopPad+buttonSize+levelsGridPx;
    }
/*////
  var cancelButton={"num":levelBoxes.length, "l":levelsLeftPad+levelsGridPx, "r":screenWidth-levelsLeftPad-levelsGridPx, "t":levelsTopPad+buttonsDown*buttonSize+levelsGridPx, "b":levelsTopPad+buttonsDown*buttonSize+levelsGridPx*2};
  levelBoxes.push(cancelButton);
*/
  levelButtons=[];
  levelButtons.push(returnModalButton("Cancel","right","portrait",false));

  }
var highlighted="rgba(255,255,100,1)";
function drawLevels(){
  var levelsCtx=levelsCanv.getContext('2d');
  levelsCanv.width=screenWidth;
  levelsCanv.style.zIndex="1";
  for (var b=0; b<levelButtons.length; b++){
    drawModalButton(levelsCtx, levelButtons[b]);
    }

  var buttonsAcross=2;
  var buttonSize=levelsGridPx*2;
  var fieldsAcross=4;
  var offset=1.5;
  
  for (var b=0; b<levelBoxes.length; b++){
    var dNum=levelBoxes[b].num;
    //dbuga(dNum+" fields[0]="+levelData[dNum].fields[0]);
    if(levelData[dNum].fields[0]==4){
      fieldsAcross=5;
      offset=2;
      }
    }
  //dbuga('fieldsAcross '+fieldsAcross);
  
  var pad=buttonSize/16;
  var radius=buttonSize/12;
  var fieldRad=buttonSize/(3.2*fieldsAcross);
  var baseRad=buttonSize/(3*fieldsAcross);
  var fieldSpread=buttonSize/(fieldsAcross+1);
  var buttonLine=buttonSize/14;


  levelsCtx.lineWidth=buttonLine;
  for (var b=0; b<levelBoxes.length; b++){
  levelsCtx.strokeStyle=buttonFill;
  levelsCtx.fillStyle=buttonLabelFill;

    if(atLevel==b){
      levelsCtx.fillStyle=highlighted;
      }
    var w=levelBoxes[b].r-levelBoxes[b].l-pad*2;
    var h=levelBoxes[b].b-levelBoxes[b].t-pad*2;
    roundRect(levelsCtx, levelBoxes[b].l+pad, levelBoxes[b].t+pad, w, h, radius, true, true);
    var cx=levelBoxes[b].l/2+levelBoxes[b].r/2;
    var cy=levelBoxes[b].t/2+levelBoxes[b].b/2;
    var dNum=levelBoxes[b].num;
    var req=0;
    for(var c=0;c<levelData[dNum].fields.length;c++){      
      var color=rgbArray[c];
      levelsCtx.fillStyle=color;    
      for(var f=0; f<=levelData[dNum].fields[c]; f++){
        req++;
        var useF=f%fieldsAcross;
        var yAdd=fieldSpread*Math.floor(f/fieldsAcross);
        var x=cx+(useF-offset)*fieldSpread;
        var y=cy+(c-offset)*fieldSpread;
        if(f==0){// silo
          levelsCtx.beginPath();
          levelsCtx.arc(x,y+yAdd,baseRad,0,Math.PI*2,true);
          levelsCtx.fill();
          }
        else{// field
          roundRect(levelsCtx, x-fieldRad, y+yAdd-fieldRad,fieldRad*2,fieldRad*2, fieldRad/3, true, false);
          }
        }
      }
    req*=4;
    levelsCtx.font=Math.floor(fieldSpread)+"px akzi";
    levelsCtx.fillStyle="black";
    levelsCtx.textAlign="center";
    levelsCtx.textBaseline="middle";
    //levelsCtx.fillText(req+" "+levelData[dNum].space, cx,cy+fieldSpread*2);
    }
  }

var visHeight=100;
function openModal(modal){
  console.log('openModal('+modal+')');
  closeModals();
  camera.style.webkitFilter="blur(5px)";
  if(modal=="levels"){
    drawLevels();
    levelsCanv.style.left=0+"px";
    levelsUp=true;
    navButtons[4].label="Select a<br>new level";
    }
  if(modal=="settings"){
    settingsCanv.style.left=0+"px";
    settingsUp=true;
    settingsDraw();
    navButtons[4].label="Settings";
    //dbuga('openModal settingsUp='+settingsUp);
    }
  if(modal=="cars"){
    clearingAll=false;

    carsCanv.style.left=0+"px";
    carsUp=true;
    populateCars();

    //dbuga('openModals() updateColorsCanv')
    updateColorsCanv('openModal cars');
    }
  if(modal=="graphics"){
    //dbuga('openModals() updateColorsCanv')
    graphicsCanv.style.left=0+"px";
    graphicsUp=true;
    updateColorsCanv('openModal graphics');
    }
  if(modal=="help"){
    helpUp=true;
    updateHelpCanv();
    }
  if(modal=="comp"){
    compUp=true;
    updateCompCanv();
    }
  }
var squarePx=0;
var deviceOrient="";
function updateCompCanv(){
  var totalMs=0;
  for(var c=0; c<completedCars.length; c++){
    totalMs+=completedCars[c].destroyed;
    totalMs-=completedCars[c].created;
    }
  console.log('updateCompCanv initCompleted:'+initCompleted);
  squarePadTop=0;
  squarePadLeft=0;
  squarePx=0;
  if(viewportAspect<1){//portrait
    deviceOrient="portrait";
    squarePadTop=(screenHeight-controlsPx)/2-screenWidth/2;
    compCanv.width=screenWidth;
    squarePx=screenWidth;
    compCanv.height=screenHeight-controlsPx;
    }
  else{//landscape
    deviceOrient="landscape";
    squarePx=screenWidth-controlsPx;
    squarePadLeft=(screenHeight-squarePx)/2;
    console.log(squarePadLeft + '=('+screenHeight+'-'+squarePx+')/2');
    compCanv.width=screenHeight;
    compCanv.height=screenWidth-controlsPx;
    }
  compCanv.style.top=controlsPx+"px";
  compCanv.style.left=0+"px";
  compCanv.style.backgroundColor=modalBg;
  compCanv.style.zIndex=3;
  compCanv.style.display="block";
  var ctx=compCanv.getContext('2d');
  ctx.fillStyle=modalFill;
  ctx.strokeStyle=modalStroke;
  ctx.lineWidth=squarePx*modalLine;
  var pad=squarePx*(1-modalShrink);
  roundRect(ctx, pad+squarePadLeft, pad+squarePadTop, squarePx-pad*2, squarePx-pad*2, modalRadius*squarePx, true, true);

  
    ctx.globalCompositeOperation = "source-atop";
    var img=document.getElementById(helps[0].img);
    ctx.drawImage(img,squarePadLeft,squarePadTop,squarePx,squarePx);
    ctx.globalCompositeOperation = "source-over";

  roundRect(ctx, pad+squarePadLeft, pad+squarePadTop, squarePx-pad*2, squarePx-pad*2, modalRadius*squarePx, false, true);

  var cx=squarePadLeft+squarePx/2;
  var headingPx=modalHeading*squarePx;
  var bodyPx=modalBody*squarePx;
  var atY=pad+squarePadTop+headingPx;
  ctx.textBaseline="middle";
  ctx.fillStyle=modalText;
  ctx.textAlign="center";
  ctx.font=headingPx+"px "+modalHeadingFont;
  
  atY+=wrapText(ctx, "Completed!", cx, atY, squarePx-pad*2, headingPx, false);
  ctx.font=bodyPx+"px "+modalBodyFont;
  var compBody=completedCars.length+" number of cars<br>";
  var totalSec=totalMs/1000;
  compBody+=Math.floor(totalSec)+" Total Seconds<br>";
  compBody+="Seconds per car: "+Math.floor(10*totalSec/completedCars.length)/10;
  var parts=compBody.split("<br>");
  for (var p=0; p<parts.length; p++){
    atY+=bodyPx/2;
    atY+=wrapText(ctx, parts[p], cx, atY, squarePx-pad*4, bodyPx, false);
    }
  compButtons=[];
  compButtons.push(returnModalButton("Done","right",deviceOrient,false));
  compButtons.push(returnModalButton("Done","square",deviceOrient,false));
  compButtons.push(returnModalButton("Restart","left",deviceOrient,false));
  drawCompButtons();
  }
var modalBg="rgba(255,255,255,.45)";
var modalText="rgba(70,70,70,1)";
var modalStroke="rgba(180,180,180,1)";
var modalFill="rgba(255,255,255,.75)";
var modalShrink=.95;
var modalLine=.025;
var modalRadius=.1;
var modalHeading=.08;
var modalBody=.05;
var modalHeadingFont="akziBold";
var modalBodyFont="akzi";
function updateHelpCanv(){
  console.log('updateHelpCanv initCompleted:'+initCompleted);
  squarePadTop=0;
  squarePadLeft=0;
  squarePx=0;
  if(viewportAspect<1){//portrait
    deviceOrient="portrait";
    squarePadTop=(screenHeight-controlsPx)/2-screenWidth/2;
    helpCanv.width=screenWidth;
    squarePx=screenWidth;
    helpCanv.height=screenHeight-controlsPx;
    }
  else{//landscape
    deviceOrient="landscape";
    squarePx=screenWidth-controlsPx;
    squarePadLeft=(screenHeight-squarePx)/2;
    console.log(squarePadLeft + '=('+screenHeight+'-'+squarePx+')/2');
    helpCanv.width=screenHeight;
    helpCanv.height=screenWidth-controlsPx;
    }
  helpCanv.style.top=controlsPx+"px";
  helpCanv.style.left=0+"px";
  helpCanv.style.zIndex=3;
  helpCanv.style.display="block";
  var ctx=helpCanv.getContext('2d');
  helpCanv.style.backgroundColor=modalBg;
  ctx.fillStyle=modalFill;
  ctx.strokeStyle=modalStroke;
  ctx.lineWidth=squarePx*modalLine;
  var pad=squarePx*(1-modalShrink);
  roundRect(ctx, pad+squarePadLeft, pad+squarePadTop, squarePx-pad*2, squarePx-pad*2, modalRadius*squarePx, true, true);

  if(helps[atHelp].img != ""){
    ctx.globalCompositeOperation = "source-atop";
    var img=document.getElementById(helps[atHelp].img);
    ctx.drawImage(img,squarePadLeft,squarePadTop,squarePx,squarePx);
    ctx.globalCompositeOperation = "source-over";
    }
  roundRect(ctx, pad+squarePadLeft, pad+squarePadTop, squarePx-pad*2, squarePx-pad*2, modalRadius*squarePx, false, true);

  var cx=squarePadLeft+squarePx/2;
  var headingPx=modalHeading*squarePx;
  var bodyPx=modalBody*squarePx;
  var atY=pad+squarePadTop+headingPx;
  ctx.textBaseline="middle";
  ctx.fillStyle=modalText;
  ctx.textAlign="center";
  ctx.font=headingPx+"px "+modalHeadingFont;
  
  atY+=wrapText(ctx, helps[atHelp].heading, cx, atY, squarePx-pad*2, headingPx, false);
  ctx.font=bodyPx+"px "+modalBodyFont;
  var parts=helps[atHelp].body.split("<br>");
  for (var p=0; p<parts.length; p++){
    atY+=bodyPx/2;
    atY+=wrapText(ctx, parts[p], cx, atY, squarePx-pad*3, bodyPx, false);
    }
  helpButtons=[];
  if(initCompleted){
    if(atHelp>0){
      helpButtons.push(returnModalButton("Prev","left",deviceOrient,false));
      }
    if(atHelp<maxHelp){
      helpButtons.push(returnModalButton("Next","center",deviceOrient,false));
      }
    helpButtons.push(returnModalButton("Done","right",deviceOrient,false));
    if(helps[atHelp].buttonLabel != ""){
      helpButtons.push(returnModalButton(helps[atHelp].buttonLabel,"square",deviceOrient,false));
      }
    drawHelpButtons();
    }
  }
function wrapText(context, text, x, y, maxWidth, lineHeight, stroke) {
        //console.log('wrap ' +text+' '+y);
        var height = lineHeight;
        var words = text.split(' ');
        var line = '';
        for(var n = 0; n < words.length; n++) {
          var testLine = line + words[n] + ' ';
          var metrics = context.measureText(testLine);
          var testWidth = metrics.width;
          if (testWidth > maxWidth && n > 0) {
            if(stroke){context.strokeText(line, x, y);}
            else{context.fillText(line, x, y);}
            line = words[n] + ' ';
            y += lineHeight;
            height += lineHeight;
            }
          else {
            line = testLine;
            }
          }
        if(stroke){context.strokeText(line, x, y);}
        else{context.fillText(line, x, y);}
        return height;
        }

var bgAlpha=.66;
function closeModals(){
  console.log('closeModals initCompleted:'+initCompleted +' firstRun:'+firstRun );
  clearingAll=false;
  if(localStorage.getItem("Scale") != settingsObject["Scale"]["value"]){updateScaleSetting();}
  if(localStorage.getItem("Detail") != settingsObject["Detail"]["value"]){updateDetailSetting();}
  if(localStorage.getItem("Tiles") != settingsObject["Tiles"]["value"]){updateTilesSetting();}

  if(initCompleted){
    if(firstRun==false){
      paused=false;
      helpCanv.style.left="-"+screenHeight+"px";
      helpUp=false;
      }
    }
  compUp=false;
  compCanv.style.left="-"+screenHeight+"px";
  levelsCanv.style.left="-"+screenWidth+"px";
  levelsUp=false;
  settingsCanv.style.left="-"+screenWidth+"px";
  settingsUp=false;
  carsCanv.style.left="-"+screenHeight+"px";
  carsUp=false;
  graphicsCanv.style.left="-"+screenHeight+"px";
  graphicsUp=false;
  updateColorsCanv('closeModals');
  graphicsEditing=false;
  camera.style.webkitFilter="none";
  for (var n=0; n<navButtons.length; n++){
    navButtons[n].selected=false;
    }
  navButtons[4].label="";
  updateNavCanv();
  }
function changeView(caller){
  console.log("changeView in "+caller+" shooting="+shooting);
  if(shooting){return false;}
  closeModals();
  if(viewportAspect>1){
    document.getElementById("navCanvas").style.display="none";
    document.getElementById("progressHolder").style.display="none";
    document.getElementById("prerails").style.display="none";
    //dbuga('changeView() updateColorsCanv')
    ////updateColorsCanv('changeView');
    colorsCanv.style.display="block";
    visHeight=viewportHeight;
    camera.style.marginTop= 0 +"px";

    }
  else{
    colorsCanv.style.display="none";
    document.getElementById("navCanvas").style.display="block";
    document.getElementById("progressHolder").style.display="block";
    document.getElementById("prerails").style.display="block";
    //document.getElementById("highlighter").style.display="block";
    updateNavCanv(); //in nav.js
    visHeight=boardHeight;
    camera.style.marginTop= boardPad +"px";
    camera.style.top= controlsPx+"px";
    camera.style.position= "absolute";
    }
  document.getElementById("wrapper").style.width= viewportWidth +"px";
  document.getElementById("wrapper").style.height= viewportHeight +"px";
  camera.style.width= viewportWidth +"px";
  camera.style.height= visHeight +"px";
  zoom.style.width= viewportWidth +"px";
  zoom.style.height= visHeight +"px";
  table.style.width= boardWidth +"px";
  table.style.height= boardHeight +"px";
  if(viewportAspect<1){fixCamera();}
  adGeometry();
  }
function init(){
  console.log('init() '+screen.width);
  document.body.addEventListener('mousedown', mouseDown, true); 
  document.body.addEventListener('mousemove', mouseMove, true); 
  document.body.addEventListener('mouseup', mouseUp, true); 
  if(screen.width==1680){
    //dbuga('local init()');
    initSession();
    }
  //dbuga('init()')
  }
var isMobile=false;
function onDeviceReady(){
  //dbuga('onDeviceReady() so initSession');
  isMobile=true;
  initSession();

  // dependant on <gap:plugin name="cordova-plugin-statusbar" source="npm" />
  StatusBar.overlaysWebView(true);
  StatusBar.hide();
  }  
function initStorage(){
  console.log('initStorage();');
  localStorage.setItem("initialized", "true");
  localStorage.setItem("tutorialStep", 0);
  localStorage.setItem("Music", settingsObject["Music"]["value"]);
  localStorage.setItem("Sounds", settingsObject["Sounds"]["value"]);
  localStorage.setItem("Scale", settingsObject["Scale"]["value"]);
  localStorage.setItem("Detail", settingsObject["Detail"]["value"]);
  localStorage.setItem("Tiles", settingsObject["Tiles"]["value"]);
  }
function saveStorage(){
  localStorage.setItem("Music", settingsObject["Music"]["value"]);
  localStorage.setItem("Sounds", settingsObject["Sounds"]["value"]);
  localStorage.setItem("Scale", settingsObject["Scale"]["value"]);
  localStorage.setItem("Detail", settingsObject["Detail"]["value"]);
  localStorage.setItem("Tiles", settingsObject["Tiles"]["value"]);
  }
function loadStorage(){
  settingsObject["Music"]["value"]=localStorage.getItem("Music");
  settingsObject["Sounds"]["value"]=localStorage.getItem("Sounds");
  settingsObject["Scale"]["value"]=localStorage.getItem("Scale");
  settingsObject["Detail"]["value"]=localStorage.getItem("Detail");
  settingsObject["Tiles"]["value"]=localStorage.getItem("Tiles");
  var keys=Object.keys(settingsObject);
  for (var k=0; k<keys.length; k++){
    //dbuga(keys[k]);
    var values=settingsObject[keys[k]]['values'];
    for (var v=0; v<values.length; v++){
      if(settingsObject[keys[k]].value==values[v]){
        settingsObject[keys[k]].pos=v-1;
        }
      }
    }
  }
var settingsObject={
  "Music":{"value":"On", "pos":0, "values":["Off", "On", "Classic"], "t":0, "r":0, "b":0, "l":0},
  "Sounds":{"value":"On", "pos":0,  "values":["Off", "On", "Classic"], "t":0, "r":0, "b":0, "l":0},
  "Scale":{"value":"O", "pos":0,  "values":["O", "HO", "N"], "t":0, "r":0, "b":0, "l":0},
  "Tiles":{"value":"Guides", "pos":1,  "values":["None", "Grid", "Guides"], "t":0, "r":0, "b":0, "l":0},
  "Detail":{"value":"Med", "pos":0,  "values":["Low", "Med", "High"], "t":0, "r":0, "b":0, "l":0}
};
var detailByValue={"Low":3, "Med":6, "High":9};
var firstRun=false;
function initSession(){
  console.log('initSession()');
  if (localStorage.getItem("initialized") === null) {
    firstRun=true;
    initStorage();
    }
  loadStorage();
  
  initGraphicsByColor();
  camera=document.getElementById("cameraDiv");
  table=document.getElementById("tableDiv");
  zoom=document.getElementById("zoomDiv");

  //dbuga('init()');
  document.addEventListener("pause", pauseGame, false);
  document.addEventListener("resume", resumeGame, false);
  //debugStorage(); 
  var wLoc=""+window.location+"";
  if(wLoc.indexOf("file:///")==0){
    platform="local";
    if(wLoc.indexOf("file:///var/mobile")==0){platform="dreamfreeze";}
    if(wLoc.indexOf("file:///android_asset")==0){platform="android";}
    }
  if(wLoc.indexOf("http://")==0){platform="web";}
  //should be good for android and iOS
  var path = window.location.pathname;
  path = path.substr( path, path.length - 10 );
  filePath= '' + path+'sounds';
  if(platform=="local"){filePath="sounds";}   
  if(platform=="web"){filePath="sounds";} 
  //dbug(JSON.stringify(localStorage));  
  genericDefault("sfxOn", "true");
  genericDefault("musicOn", "true");
  //debugStorage();

  //dbuga('initSound()');


  initSound();

  initGeometry();
  //dbuga('controlsPx='+controlsPx);
  setupNav();//moved updateNavCanv to resumeInit
  setupFaceData();
  updateDetail();
  imgRefs["tanksideblack"]=document.getElementById('tanksideblack');
  imgRefs["tanktopblack"]=document.getElementById('tanktopblack');
  imgRefs["tankendblack"]=document.getElementById('tankendblack');

  localStorageToImages();
  
  document.addEventListener('deviceready', function () {
    
    ////window.plugin.CanvasCamera.initialize(cameraCanv);
    }, false);

  //dbuga('end of initSession so start preloading');        
  //updateHelpCanv();
  openModal('help');
  window.setTimeout('preloadTick()',10);
  }
function measureLocalStorage(){
  for(var x in localStorage){
    //dbuga(x+"="+((localStorage[x].length * 2)/1024/1024).toFixed(2)+" MB");
    }
  }
function localStorageToImages(){
  console.log('localStorageToImages()');
  if(localStorage.getItem('graphicsByColor') != null){
    graphicsByColor=JSON.parse(localStorage.getItem('graphicsByColor'));
    }
  for (var d=0; d<graphicsPerColor*4; d++){
    if(localStorage.getItem('default'+d)!=null){
      var imageData=localStorage.getItem('default'+d);
      var parts=imageData.split("9");
      //dbuga(parts[0]);
      document.getElementById('default'+d).src=imageData;
      }
    }
  }
var graphicsPerColor=9;
var initCompleted=false;

function resumeInit(){
  console.log('resumeInit firstRun='+firstRun);

  changeView("resumeInit");
  resetBoardTimersObjects();
  closeLoading();
  document.getElementById('debugDiv').style.width=screenWidth+"px";
  navButtons[4].label="Select a<br>new level";

  populateModals();
  initCompleted=true;
  console.log('resume init happened....');
  updateNavCanv();
  rebuildSequence();
  if(firstRun==false){
    console.log('in resumeInit firstRun:'+firstRun+' so closeModals');
    closeModals();
    }
  else{
    console.log('in resumeInit firstRun:'+firstRun+' so updateHelpCanv');
    updateHelpCanv();
    }
  transmitBgMusicState();
  requestAnimationFrame(rafTick);
  }
var frames=0;
var secondInterval;
function populateModals(){
  //dbuga('populateModals()');
  populateLevels();
  //populateSettings();
  populateCars();
  //populateGraphics();

}
var fpsArray=[60,60,60,60,60,60];
var avgFps=0;
function secondTick(){
  if((settingsUp==false)&&(levelsUp==false)&&(helpUp==false)&&(paused==false)){
    fpsArray.unshift(frames);
    var junk=fpsArray.pop();
    var totalFrames=0;
    for (var f=0; f<fpsArray.length; f++){
      totalFrames+=fpsArray[f];
      }
    avgFps=Math.floor(10*totalFrames/fpsArray.length)/10;
    //dbug("secondTick frames "+fpsArray.join(" ")+" avgFps="+avgFps);
    frames=0;
    }
  }
var turnFrames=0;
var camPos={"x":0, "y":0, "d":0};
var nowMs=0;
function rafTick(ms){
  nowMs=Math.floor(ms);
  if(focusTrain>=trainData.length){focusTrain=0;}
  if((settingsUp==false)&&(levelsUp==false)&&(helpUp==false)&&(paused==false)){

    turnFrames++;
    var framesPerTurn=turnMs/17;
    if(turnFrames>=framesPerTurn){
      turnFrames=0;
      turnTick();
      //dbuga('turn');
      }
    frames++;
    if(trainData.length>0){
      camPos= returnProgPos(trainData[focusTrain], trainData[focusTrain].prog);
      for(var t=0; t<trainData.length; t++){
        //if((trainData[t].prevX != trainData[t].nextX)||(trainData[t].prevY != trainData[t].nextY)){
        if(trainData[t].moving){
          trainData[t].prog+=1/60;// maybe set proportional to frame ms to maintain sim speed
          var ref=trainData[t].ref;
          ref.style.webkitTransform=returnProgTransform(trainData[t], trainData[t].prog);
          }
        }
      testString="";
      for(var c=0; c<carData.length; c++){
        if(carData[c].attached){
          //if(trainData[carData[c].trainNum].moving){
            var ref=carData[c].ref;
            ref.style.webkitTransform=returnProgTransform(carData[c], trainData[carData[c].trainNum].prog);
          //}
          }
        }
      }
    for(var h=0; h<hideQueue.length; h++){
      hideQueue[h].style.opacity=0;
      hideQueue[h].style.display="none";
      }
    for(var s=0; s<showQueue.length; s++){
      showQueue[s].style.opacity=1;
      showQueue[s].style.display="block";
      }
    hideQueue=[];
    showQueue=[];

    if(combinedZoom.length>0){
      //ported 
      if(combinedZoom[focusTrain]>100){
        combinedZoom[focusTrain]=100;
        }
      if(combinedZoom[focusTrain]<0){
        combinedZoom[focusTrain]=0;
        }
      cameraDistancePercent=100-combinedZoom[focusTrain];
      cameraTilt=90*(combinedZoom[focusTrain]/100);

      //cameraXpercent=100-100*trainPos[focusTrain].x;
      //cameraYpercent=100-100*trainPos[focusTrain].y;
      }
    if(viewportAspect>1){
      locateCamera();
      }
    }
  requestAnimationFrame(rafTick);
}
var hideQueue=[];
var showQueue=[];
var testStr="";
var soundObject={};
function initSound(){
  return false;
  //dbuga('initSound()');
  loopLoad("On/measure_loop_inst");
  oneShotLoad("On/laytrack");
  oneShotLoad("On/carstart");
  oneShotLoad("On/carstop");
  oneShotLoad("On/trainstart");
  oneShotLoad("On/trainpause");
  oneShotLoad("On/applause");
  loopLoad("Classic/measure_loop_inst");
  oneShotLoad("Classic/laytrack");
  oneShotLoad("Classic/carstart");
  oneShotLoad("Classic/carstop");
  oneShotLoad("Classic/trainstart");
  oneShotLoad("Classic/trainpause");
  oneShotLoad("Classic/applause");
  }

function setupNav(){
  }
function restart(){
  //dbuga('restart()'); 
  resetBoardTimersObjects();
  rebuildSequence();
  }
function resetBoardTimersObjects(){
  totalCarsNeeded=0;
  totalCarsDocked=0;
  //dbuga('resetBoardTimersObjects()');
  setupGridData();
  //closeHelp();
  collisionData=new Object();
  possibleObject['blue']=0;
  possibleObject['black']=0;
  possibleObject['orange']=0;
  possibleObject['green']=0;
  scoreObject['blue']=0;
  scoreObject['black']=0;
  scoreObject['orange']=0;
  scoreObject['green']=0;
  zeroProgressBar();
  fullCellGlom="";
  //window.clearInterval(turnInterval);
  window.clearInterval(sourceInterval);
  colorCycle=0;
  sourceCount=0;
  destCount=0;
  carData=[];
  completedCars=[]; 
  trainData=[];
  sourceData=[];
  destData=[];
  checkTrainNum=0;
  checkSourceNum=0;
  document.getElementById('trainHolder').innerHTML="";
  document.getElementById('fieldHolder').innerHTML="";
  makeGridDivs();
  window.clearInterval(secondInterval);
  secondInterval=window.setInterval("secondTick()", 1000);
  //dbuga('resetBoardTimersObjects() completed');

  }

//build level functions

function addColor(fields, barrels){
  color=colorList[Math.floor(colorCycle)];
  colorCycle+=1;
  if(colorCycle>=4){
    colorCycle=0;
    } 
  var fails=randomTileGroup(color, fields, barrels);
  return fails;
  }
function createInitialBuildSequence(){
  //dbuga('createInitialBuildSequence() '+cellsAcross);
  var x0=1;
  var y0=0;
  var x1=cellsAcross-2;
  var y1=cellsDown-1;
  buildSequence=[];

  buildSequence.push(new buildObject("train", "orange", "b", x0, y0, 0));

  buildSequence.push(new buildObject("dest", "orange", "b", x0, y0, 0));
  buildSequence.push(new buildObject("track", "", "tl", x0, y0+1, 0));
  buildSequence.push(new buildObject("track", "", "tr", x0, y0+1, 0));

  buildSequence.push(new buildObject("source", "orange", "t", x1, y1, 2));
  buildSequence.push(new buildObject("track", "", "bl", x1, y1-1, 0));
  buildSequence.push(new buildObject("track", "", "br", x1, y1-1, 0));

  buildSequence.push(new buildObject("source", "orange", "t", x0, y1, 2));
  buildSequence.push(new buildObject("track", "", "bl", x0, y1-1, 0));
  buildSequence.push(new buildObject("track", "", "br", x0, y1-1, 0));

  buildSequence.push(new buildObject("track", "", "br", x0-1, y0+1, 0));
  buildSequence.push(new buildObject("track", "", "bl", x1+1, y0+1, 0));

  buildSequence.push(new buildObject("track", "", "tl", x1+1, y1-1, 0));
  buildSequence.push(new buildObject("track", "", "tr", x0-1, y1-1, 0));
  for(var x=x0; x<=x1; x++){
    buildSequence.push(new buildObject("track", "", "lr", x, y0+1, 0));
    buildSequence.push(new buildObject("track", "", "lr", x, y1-1, 0));
    }
  for(var y=y0+2; y<y1-1; y++){
    buildSequence.push(new buildObject("track", "", "tb", x0-1, y, 0));
    buildSequence.push(new buildObject("track", "", "tb", x1+1, y, 0));
    }

  //buildSequence.push(new buildObject("track", "", "bl", 2, 3, 0));
  
  //if(cellsAcross==8){createInitialBuildSequence768();}
  //else{createInitialBuildSequence320();}
  }
function createInitialBuildSequence768(){
  buildSequence=[];
  buildSequence.push(new buildObject("dest", "orange", "t", 2, 4, 0));
  buildSequence.push(new buildObject("train", "orange", "b", 6, 2, 0));
  buildSequence.push(new buildObject("source", "orange", "t", 5, 4, 2));
  //buildSequence.push(new buildObject("source", "orange", "t", 4, 6, 2));

  buildSequence.push(new buildObject("track", "", "bl", 2, 3, 0));
  buildSequence.push(new buildObject("track", "", "br", 2, 3, 0));
  buildSequence.push(new buildObject("track", "", "lr", 2, 3, 0));

  buildSequence.push(new buildObject("track", "", "bl", 5, 3, 0));
  buildSequence.push(new buildObject("track", "", "br", 5, 3, 0));
  buildSequence.push(new buildObject("track", "", "lr", 5, 3, 0));

  buildSequence.push(new buildObject("track", "", "lr", 3, 3, 0));
  buildSequence.push(new buildObject("track", "", "lr", 4, 3, 0));

  buildSequence.push(new buildObject("track", "", "tl", 6, 3, 0));
  buildSequence.push(new buildObject("track", "", "tb", 6, 2, 0));
  buildSequence.push(new buildObject("track", "", "bl", 6, 1, 0));

  buildSequence.push(new buildObject("track", "", "lr", 2, 1, 0));
  buildSequence.push(new buildObject("track", "", "lr", 3, 1, 0));
  buildSequence.push(new buildObject("track", "", "lr", 4, 1, 0));
  buildSequence.push(new buildObject("track", "", "lr", 5, 1, 0));

  buildSequence.push(new buildObject("track", "", "tr", 1, 3, 0));
  buildSequence.push(new buildObject("track", "", "tb", 1, 2, 0));
  buildSequence.push(new buildObject("track", "", "br", 1, 1, 0));
  }
  
function createInitialBuildSequence320(){
  buildSequence=[];
  buildSequence.push(new buildObject("dest", "orange", "t", 1, 4, 0));
  buildSequence.push(new buildObject("train", "orange", "b", 3, 1, 0));
  buildSequence.push(new buildObject("source", "orange", "t", 2, 4, 2));

  buildSequence.push(new buildObject("track", "", "bl", 1, 3, 0));
  buildSequence.push(new buildObject("track", "", "br", 1, 3, 0));
  buildSequence.push(new buildObject("track", "", "lr", 1, 3, 0));

  buildSequence.push(new buildObject("track", "", "bl", 2, 3, 0));
  buildSequence.push(new buildObject("track", "", "br", 2, 3, 0));


  buildSequence.push(new buildObject("track", "", "lr", 2, 3, 0));


  buildSequence.push(new buildObject("track", "", "tl", 3, 3, 0));
  buildSequence.push(new buildObject("track", "", "tb", 3, 2, 0));
  buildSequence.push(new buildObject("track", "", "bl", 3, 1, 0));

  buildSequence.push(new buildObject("track", "", "lr", 1, 1, 0));
  buildSequence.push(new buildObject("track", "", "lr", 2, 1, 0));

  buildSequence.push(new buildObject("track", "", "tr", 0, 3, 0));
  buildSequence.push(new buildObject("track", "", "tb", 0, 2, 0));
  buildSequence.push(new buildObject("track", "", "br", 0, 1, 0));

  }

function buildObject(type,color,dir,x,y, barrels){
  this.type=type;
  this.color=color;
  this.dir=dir;
  this.x=x;
  this.y=y;
  this.barrels=barrels;
  }
function randomTileGroup(color, fields, barrels){
  var fails=0;
  posObject=viableRandomPosition();
  //dbuga("randomTileGroup "+posObject.success+" "+posObject.x+" "+posObject.y);
  if(posObject.success==true){
    var buildItem=new Object();
    buildItem.type="dest";
    buildItem.color=color;
    buildItem.dir= posObject.dir;
    buildItem.x=posObject.x;
    buildItem.y=posObject.y;
    buildSequence.push(buildItem);

    var buildItem=new Object();
    buildItem.type="train";
    buildItem.color=color;
    buildItem.dir= posObject.dir;
    buildItem.x=posObject.x;
    buildItem.y=posObject.y;
    buildSequence.push(buildItem);

    destData.push(destObject(color, posObject.dir, posObject.x, posObject.y));
    var t=trainObject(color, posObject.x, posObject.y, posObject.dir);
    trainData.push(t);
    }
  else{
    fails++;
    }
  for (f=0; f<fields; f++){  
    posObject=viableRandomPosition();
    if(posObject.success==true){
      var buildItem=new Object();
      buildItem.type="source";
      buildItem.color=color;
      buildItem.dir=posObject.dir;
      buildItem.x=posObject.x;
      buildItem.y=posObject.y;
      buildItem.barrels=barrels;
      buildSequence.push(buildItem);
      sourceData.push(sourceObject(color, posObject.dir, posObject.x, posObject.y, barrels));
      displayBarrels("grid_"+posObject.x+"_"+posObject.y, barrels); 
      }
    else{
      fails++;
      }
    }
  return fails;
  }
function displayBarrels(examineCell, howMany){
  //debugString=examineCell+", "+howMany+"<br>";
  var cn=document.getElementById(examineCell).childNodes;
  var cnl=cn.length;  
  for (var n=0; n<cnl; n++){
    var thisClass=cn[n].className;
    if (thisClass.indexOf('tile')>-1){
      //debugString+=thisClass+" - ";
      barrelNodes=cn[n].childNodes;
      for (var b=0; b<barrelNodes.length; b++){
        if(howMany>b){
          barrelNodes[b].style.opacity="1";
          }
        else{
          barrelNodes[b].style.opacity="0";
          }        
        }
      }
    }
  }
function viableRandomPosition(){
  var allow=false;
  var failCount=0;
  var failLimit=50;
  var thisObject=new Object();
  unreservedCells=new Array();
  promotedCells=new Array();
  for (x=0; x<cellsAcross; x++){
    for (y=0; y<cellsDown; y++){
      testCell="grid_"+x+"_"+y;
      if(fullCellGlom.indexOf(testCell)==-1){
        unreservedCells.push(testCell);

        // promote by duplicating cells with less diagonal neighbors
        noDiagonals=true;
        if(isTiled(x-1, y-1)==true){noDiagonals=false;}
        if(isTiled(x+1, y-1)==true){noDiagonals=false;}
        if(isTiled(x-1, y+1)==true){noDiagonals=false;}
        if(isTiled(x+1, y+1)==true){noDiagonals=false;}
        if(noDiagonals==true){promotedCells.push(testCell);}
        }
      }
    }
  //dbug('unreservedCells:'+unreservedCells);

  while((allow == false)&&(failCount <=failLimit)){
    var thisFail=false;
    var dir=dirList[Math.floor(Math.random()*4)];
    if(unreservedCells.length==0){
      //alert("viableRandomPosition error, no unreserved cells");
      x=0;
      y=0;
      }
    else{
      //try promoted cells first if not toomany fails
      if((promotedCells.length>0)&&(failCount<failLimit/2)){
        useCell=promotedCells[Math.floor(Math.random()*promotedCells.length)];
        }
      else{
        useCell=unreservedCells[Math.floor(Math.random()*unreservedCells.length)];
        }
      cellParts=useCell.split("_");
      x=Number(cellParts[1]);
      y=Number(cellParts[2]);
      }

    var nextX=xDeltaByDir[dir]+x;  
    var nextY=yDeltaByDir[dir]+y;  
    var thisCell="grid_"+x+"_"+y;
    var adjCell="grid_"+nextX+"_"+nextY;
    if (fullCellGlom.indexOf(thisCell)>-1){
      thisFail=true;
      }

    //this and next - out of bounds or occupied?
    if((nextX<0)||(nextX>=cellsAcross)){
      thisFail=true;
      }
    if((nextY<0)||(nextY>=cellsDown)){
      thisFail=true;
      }
 
    if((isTiled(nextX, nextY)==true)||(isTiled(x, y)==true)){
      thisFail=true;
      }

    var reserveCellsArray=openAdjacentCellsArray(nextX, nextY, thisCell);

    if (thisFail==false){
      // check next for 2 or 3 untiled neighbors
      if(reserveCellsArray.length<2){
        thisFail=true;
        }
      }

    //// new wall walking test
    if(thisFail==false){
      var passedWalk=false;
      edgesBarredXY=[];
      // setup quad switches 0=right 1=down 2=left 3=up
      for (var tx=0; tx<cellsAcross; tx++){
        var col=[];
        for (var ty=0; ty<cellsDown; ty++){
          var cell=[false,false,false,false];
          if(ty==0){cell[3]=true;}
          else{
            var testId="grid_"+tx+"_"+(ty-1);
            if(tilesByGridXY[testId].length>0){cell[3]=true;}
            }
          if(ty==cellsDown-1){cell[1]=true;}
          else{
            var testId="grid_"+tx+"_"+(ty+1);
            if(tilesByGridXY[testId].length>0){cell[1]=true;}
            }
          if(tx==0){cell[2]=true;}
          else{
            var testId="grid_"+(tx-1)+"_"+ty;
            if(tilesByGridXY[testId].length>0){cell[2]=true;}
            }
          if(tx==cellsAcross-1){cell[0]=true;}
          else{
            var testId="grid_"+(tx+1)+"_"+ty;
            if(tilesByGridXY[testId].length>0){cell[0]=true;}
            }
          col.push(cell);
          }
        edgesBarredXY.push(col);
        }
      // bar self
      //dbug("x:"+x+" y:"+y+" dir:"+dir+"<br>");
      if(x>0){edgesBarredXY[x-1][y][0]=true;}
      if(x<cellsAcross-1){edgesBarredXY[x+1][y][2]=true;}
      if(y>0){edgesBarredXY[x][y-1][1]=true;}
      if(y<cellsDown-1){edgesBarredXY[x][y+1][3]=true;}
      var walkX=x+xDeltaByDir[dir];
      var walkY=y+yDeltaByDir[dir];
      var walkDir=dir;
      edgesBarredXY[walkX][walkY][ordByDir[reverseObject[walkDir]]]=false;
      var goalX=walkX;
      var goalY=walkY;
      var goalDir=reverseObject[dir];
      var walking=true;
      //debugCell(walkDir,walkX,walkY);
      var limit=40;
      while(walking){
        limit--;
        if(limit<0){
          walking=false;
          //dbuga("limit");
          }
        var foundStep=false;
        var testDir="not set";
        //dbuga("<b>"+walkDir+"</b>");


        if(foundStep==false){
          testDir=rightObject[walkDir];
          var ord=ordByDir[testDir];
          //dbuga("_ "+walkX+" "+walkY+" testDir:"+testDir+" ord:"+ord);
          if(edgesBarredXY[walkX][walkY][ord]==false){foundStep=true;}
          }
        if(foundStep==false){
          testDir=walkDir;
          var ord=ordByDir[testDir];
          //dbuga("___ "+walkX+" "+walkY+" test:"+testDir+" "+ord);
          if(edgesBarredXY[walkX][walkY][ord]==false){foundStep=true;}
          }
        if(foundStep==false){
          testDir=leftObject[walkDir];
          var ord=ordByDir[testDir];
          //dbuga("___ "+walkX+" "+walkY+" test:"+testDir+" "+ord);
          if(edgesBarredXY[walkX][walkY][ord]==false){foundStep=true;}
          }
         if(foundStep==false){
          walking=false;
          }
        else{
          //dbuga(" "+testDir);
/*
          trackContext.strokeStyle="rgba(0,0,255,.3)";
          trackContext.lineWidth=5;
          trackContext.beginPath();
          var pxX=walkX*cellSize+cellSize/2+xDeltaByDir[reverseObject[walkDir]]*cellSize/2.5;
          var pxY=walkY*cellSize+cellSize/2+yDeltaByDir[reverseObject[walkDir]]*cellSize/2.5;
          trackContext.moveTo(pxX,pxY);
*/
          if((walkX!=goalX)||(walkY!=goalY)){
            var ord=ordByDir[reverseObject[walkDir]];
            edgesBarredXY[walkX][walkY][ord]=true;
            }
          var ord=ordByDir[testDir];
          edgesBarredXY[walkX][walkY][ord]=true;

          walkDir=testDir;

/*
          var pxX=walkX*cellSize+cellSize/2+xDeltaByDir[walkDir]*cellSize/2.5;
          var pxY=walkY*cellSize+cellSize/2+yDeltaByDir[walkDir]*cellSize/2.5;
          trackContext.lineTo(pxX,pxY);
          trackContext.stroke();
*/
          walkX+=xDeltaByDir[walkDir];
          walkY+=yDeltaByDir[walkDir];
          if((walkX==goalX)&&(walkY==goalY)){
            limit=0;
            passedWalk=true;
            //dbuga(goalX+" "+goalY+" "+goalDir);
            }
          }
        }
      }
    if(passedWalk==false){
      thisFail=true;
      //dbuga(x+" "+y+" failedWalk");
      }
    //// end of wall walk


    if (thisFail==false){allow=true;}
    else{failCount++;}
    }
  if (failCount>failLimit){
    //alert('viableRandomPosition Failed to place tile. failCount='+failCount);
    thisObject.x=0;
    thisObject.y=0;
    thisObject.dir="r";
    thisObject.success=false;
    }
  else{
    thisObject.x=x;
    thisObject.y=y;
    thisObject.dir=dir;
    thisObject.success=true;
    fullCellGlom+=thisCell+adjCell;

    for (r=0; r<reserveCellsArray.length; r++){
      fullCellGlom+=reserveCellsArray[r];
      }
    }
  //debugCell(adjCell,thisObject.x,thisObject.y);
  //dbuga(buildSequence.length);
  return thisObject;
  }
var ordByDir={"r":0, "b":1, "l":2, "t":3};
var edgesBarredXY=[];
var pi=Math.PI;
function debugCell(message, cellX,cellY){
  trackContext.textAlign="center";
  trackContext.font="20px akzi";
  trackContext.fillStyle = "rgb(0, 0, 255)";
  trackContext.strokeStyle = "rgb(255, 255, 255)";
  trackContext.lineWidth= 2;

  pxX=cellX*cellSize+cellSize/2;
  pxY=cellY*cellSize+cellSize/2;
  trackContext.strokeText(message,pxX,pxY);
  trackContext.fillText(message,pxX,pxY);
  }
// destination functions

function destObject(color, dir, x, y){
  var deg=degByDir[dir];
  var d={};
  d.color=color; 
  var carsArray=new Array();
  d.carsArray=carsArray;
  d.barrels=0;
  d.nextX=x;//+xDeltaByDir[dir];
  d.nextY=y;//+yDeltaByDir[dir];
  d.deg=deg;
  d.dir=dir;
  d.x=x;
  d.y=y;
  d.xIntake=x+xDeltaByDir[dir];
  d.yIntake=y+yDeltaByDir[dir];
  d.nextDir=reverseObject[dir];
  d.nextDeg=degByDir[d.nextDir];

  destCount++;
  targetCell="grid_"+x+"_"+y;
  createTrack("tiledest"+color, targetCell);
  createTrack(dir+"d", targetCell);
  createCanvasTrack(dir+"d", x, y);
  return d;
  }

function destTick(){
  
  if((viewportWidth != window.innerWidth)||(viewportHeight != window.innerHeight)){
    changeGeometry();
    }
  }

function zeroProgressBar(){
  for (c=0; c<colorList.length; c++){
    color=colorList[c];
    document.getElementById(color+"ProgressDiv").style.width="0px";
    document.getElementById(color+"ProgressDiv").style.width="0px";
    }
  }
var totalCarsNeeded=0;
var totalCarsDocked=0;
function updateProgressBar(){
  totalCarsNeeded=0;
  totalCarsDocked=0;
  maxWidth=screenWidth;
  colorsInPlay=0;
  for (c=0; c<colorList.length; c++){
    color=colorList[c];
    if(possibleObject[color]>0){
      colorsInPlay++;
      totalCarsNeeded+=possibleObject[color];
      totalCarsDocked+=scoreObject[color];
      }
    }
  colorMaxWidth=maxWidth/colorsInPlay;
  for (c=0; c<colorList.length; c++){
    color=colorList[c];
    if(possibleObject[color]>0){
      progressPercent=scoreObject[color]/possibleObject[color];
      progressPixels=progressPercent*colorMaxWidth;
      document.getElementById(color+"ProgressDiv").style.width=progressPixels+"px";
      }
    }
  if(totalCarsDocked==totalCarsNeeded){
    //playSound("applause");
    //window.setTimeout("openModal('comp')", 1000);
    }
  }

// source functions

function sourceObject(color, dir, x, y, barrels){
  possibleObject[color]+=barrels;
  deg=degByDir[dir];
  var s=new Object();
  s.barrels=barrels;
  s.color=color; 
  s.occupied=false;
  s.deg=deg;
  s.dir=dir;
  s.x=x;
  s.y=y;
  sourceCount++;
  targetCell="grid_"+x+"_"+y;
  createTrack("tilesource"+color, targetCell);
  createTrack(dir+"s", targetCell);
  createCanvasTrack(dir+"s", x, y);
  return s;
  }
var sourceMs;
var turnMs=1000;

function sourceTick(){
  if((settingsUp)||(levelsUp)){
    return false;
    }
  sourceAction(checkSourceNum);
  checkSourceNum++;
  if (checkSourceNum>=sourceCount){
    checkSourceNum=0;
    }
  }
var minFps=40;
function sourceAction(sourceNum){

  if ((sourceData[sourceNum].occupied==false)&&(sourceData[sourceNum].barrels>0)&&(avgFps>minFps)){
    //dbuga(' unoccupied with barrels');

    sourceData[sourceNum].occupied=true;
    sourceData[sourceNum].barrels--;
    displayBarrels("grid_"+sourceData[sourceNum].x+"_"+sourceData[sourceNum].y, sourceData[sourceNum].barrels);
    useColor=sourceData[sourceNum].color;
     
    var newCar;
    if(levelData[levelBoxes[atLevel].num].tank){
      newCar=tankObject(useColor, sourceData[sourceNum].dir, sourceData[sourceNum].x, sourceData[sourceNum].y, sourceNum);
      }
    else{
      newCar=carObject(useColor, sourceData[sourceNum].dir, sourceData[sourceNum].x, sourceData[sourceNum].y, sourceNum);
      }
    carData.push(newCar);
    }
  if(avgFps<minFps){
    //dbug("<br>sourceAction stopped - fps=" +avgFps+" [" +(carData.length-totalCarsDocked)+"]");
    }
  else{
    //dbug("<br>"+avgFps +" ["+(carData.length-totalCarsDocked)+"]");
    }
  }

// car functions
function tankObject(color, dir, x, y, oid){
  var detail=detailByValue[settingsObject["Detail"]["value"]];
  //dbuga("color:"+color+" dir:"+dir+" x:"+x+" y:"+y+" oid:"+oid);
  deg=degByDir[dir];
  var c={};
  c.created=nowMs;
  c.color=color;
  c.trainNum=-1;
  c.attached=false;
  //dbuga(" - tankObject 3");
  c.track="";
  c.nextDeg=deg;
  c.prevDeg=deg;
  c.nextDir=dir;
  c.prevDir=dir;
  c.originId=oid;
  //dbuga(" - tankObject 4");
  c.prevX=x+xDeltaByDir[dir];
  c.prevY=y+yDeltaByDir[dir];
  c.nextX=x+xDeltaByDir[dir];
  c.nextY=y+yDeltaByDir[dir];
  //dbuga(" - tankObject 5");
  // create 3d car
  var useTransform=returnProgTransform(c, 0);
  var useCarId="car"+carData.length;

  var htmlString="";
  htmlString+='<div id="'+useCarId+'" class="cube">';
  //dbuga(" - tankObject 6");
  for (var f=0; f<faceData.tank.length; f++){
    htmlString+='<canvas id="carcanvas'+carData.length+'face'+f+'" width='+Math.floor(cubeSize*faceData.tank[f].width*detail)+' height='+Math.floor(cubeSize*faceData.tank[f].height*detail)+'  class="cubeFace '+color+'tank'+f+'"></canvas>'
    }
  htmlString+='</div>';
  //dbuga(" - tankObject 7");

  var newdiv = document.createElement('div');
  newdiv.innerHTML = htmlString;
  document.getElementById('trainHolder').appendChild(newdiv);
  //dbuga(" - tankObject 8");

  for (var f=0; f<faceData.tank.length; f++){
    var canv=document.getElementById('carcanvas'+carData.length+'face'+f);
    var ctx=canv.getContext('2d');
    //ctx.webkitImageSmoothingEnabled = false;
    ctx.imageSmoothingEnabled = false; /// future
    var imageObj = imgRefs[faceData["tank"][f].img+color];
    ctx.drawImage(imageObj, 0, 0, canv.width, canv.height);
    }

  //dbuga(" - tankObject 9");


  var elementRef=document.getElementById(useCarId);
  elementRef.style.webkitTransform=useTransform;
  c.ref=elementRef;
  return c;
  }
var lastByColor={"black":-1, "orange":-1, "blue":-1, "green":-1}
function carObject(color, dir, x, y, oid){
  var detail=detailByValue[settingsObject["Detail"]["value"]];
  
  //dbuga("color:"+color+" dir:"+dir+" x:"+x+" y:"+y+" oid:"+oid);
  deg=degByDir[dir];
  var c={};
  c.created=nowMs;
  c.color=color;
  c.color=color;
  c.trainNum=-1;
  c.attached=false;
  c.track="";
  c.nextDeg=deg;
  c.prevDeg=deg;
  c.nextDir=dir;
  c.prevDir=dir;
  c.originId=oid;
  c.prevX=x+xDeltaByDir[dir];
  c.prevY=y+yDeltaByDir[dir];
  c.nextX=x+xDeltaByDir[dir];
  c.nextY=y+yDeltaByDir[dir];
  // create 3d car
  var useTransform=returnProgTransform(c, 0);
  var useCarId="car"+carData.length;

  var htmlString="";
  htmlString+='<div id="'+useCarId+'" class="cube">';
  for (var f=0; f<faceData.box.length; f++){
    htmlString+='<canvas id="carcanvas'+carData.length+'face'+f+'" width='+Math.floor(cubeSize*faceData.box[f].width*detail)+' height='+Math.floor(cubeSize*faceData.box[f].height*detail)+'  class="cubeFace '+color+'box'+f+'"></canvas>'
    }
  htmlString+='</div>';

  var newdiv = document.createElement('div');
  newdiv.innerHTML = htmlString;
  document.getElementById('trainHolder').appendChild(newdiv);
  var graphicNum=rnd(graphicsByColor[color].length);
  if(lastByColor[color] > -1){
    //dbuga('choose '+color+' '+lastByColor[color]);
    graphicNum=lastByColor[color];
    lastByColor[color]=-1;
    }
  for (var f=0; f<faceData.box.length; f++){
    var canv=document.getElementById('carcanvas'+carData.length+'face'+f);
    var ctx=canv.getContext('2d');
    //ctx.webkitImageSmoothingEnabled = false;
    ctx.imageSmoothingEnabled = false; /// future
    var imageObj = imgRefs[faceData["box"][f].img+color];
    ctx.drawImage(imageObj, 0, 0, canv.width, canv.height);
    //if((faceData.box[f].img=="boxside")&&(rnd(10)<7)){
    if(faceData.box[f].img=="boxside"){
      //dbuga('boxside');
      var graphicRef=graphicsByColor[color][graphicNum].ref; 
      var g=shrink*detail*cellSize/24;
      ctx.drawImage(graphicRef, 0,0, g*24,g*8);
      }
    }



  var elementRef=document.getElementById(useCarId);
  elementRef.style.webkitTransform=useTransform;
  c.ref=elementRef;
  return c;
  }

// train functions

function trainObject(color, x, y, dir){
  var detail=detailByValue[settingsObject["Detail"]["value"]];
  
  var deg=degByDir[dir];
  var t={};

  t.prog=0, 
  t.color=color, 
  t.moving=false;
  t.started=false;
  t.carsArray=new Array();
  //t.transformCache="";
  t.track="";
  t.prevDeg=deg;
  t.prevDir=dir;
  t.nextDeg=deg;
  t.nextDir=dir;
  t.prevX=x;
  t.prevY=y;
  t.nextX=x+xDeltaByDir[dir];//+xDeltaByDir[dir];
  t.nextY=y+yDeltaByDir[dir];//+yDeltaByDir[dir];

  // create 3d train
  var useTransform=returnProgTransform(t, 1);
  var useTrainId="train"+trainData.length;

  var htmlString="";
  htmlString+='<div id="'+useTrainId+'" class="cube">';
  for (var f=0; f<faceData.engine.length; f++){
    //htmlString+='<canvas id="canvas'+trainData.length+'face'+f+'" width='+cubeSize+' height='+cubeSize+'  class="cubeFace '+color+'engine'+f+'"></canvas>'
    htmlString+='<canvas id="canvas'+trainData.length+'face'+f+'" width='+Math.floor(cubeSize*faceData.engine[f].width*detail)+' height='+Math.floor(cubeSize*faceData.engine[f].height*detail)+'  class="cubeFace '+color+'engine'+f+'"></canvas>'
    }
  htmlString+='</div>';

  var newdiv = document.createElement('div');
  newdiv.innerHTML = htmlString;
  document.getElementById('trainHolder').appendChild(newdiv);

  for (var f=0; f<faceData.engine.length; f++){
    var canv=document.getElementById('canvas'+trainData.length+'face'+f);
    var ctx=canv.getContext('2d');
    //ctx.webkitImageSmoothingEnabled = false;
    ctx.imageSmoothingEnabled = false; /// future
    var imageObj = imgRefs[faceData["engine"][f].img+color];
    ctx.drawImage(imageObj, 0, 0, canv.width, canv.height);
    }



  var elementRef=document.getElementById(useTrainId);
  elementRef.style.webkitTransform=useTransform;
  t.ref=elementRef;
  return t;
  }

function turnTick(){
  if((settingsUp==false)&&(levelsUp==false)&&(helpUp==false)&&(paused==false)){
    var debugString="turnTick() checkTrainNum="+checkTrainNum;
    for (var t=0; t<trainData.length; t++){
    debugString+="<br>"+t+" prev "+trainData[t].prevX+" "+trainData[t].prevY+" next"+trainData[t].nextX+" "+trainData[t].nextY+" nextDir "+trainData[t].nextDir+" nextDeg "+trainData[t].nextDeg;
      }
    //dbug(debugString);
    trainAction(checkTrainNum);
    checkTrainNum++;
    if (checkTrainNum>=trainData.length){
      checkTrainNum=0;
      }
    }
  }

function trainAction(trainNum){
  if(trainData.length<=trainNum){dbuga('no train '+trainNum); return false;}
  //if(trainNum==0){
    //dbug('');
    //dbuga('trainAction('+trainNum+')');
    //dbugaObject("trainData[trainNum]", trainData[trainNum]);
    //}

  // 1 - look ahead of train to determine valid tracks
  var examineCell="grid_"+trainData[trainNum].nextX+"_"+trainData[trainNum].nextY;
  var cn=tilesByGridXY[examineCell];
  var cnl=cn.length;
  var connectionsArray=new Array();
  var tracksArray=new Array();
  var reverseDir=reverseObject[trainData[trainNum].nextDir];
  var collided=false;
  //for each child node of examineCell
  for (var n=0; n<cnl; n++){
    var collision=false;
    var thisTrack=cn[n];
    if (thisTrack.indexOf(reverseDir)>-1){
      thisConnection=thisTrack.replace(reverseDir, "");
      tX=trainData[trainNum].nextX+xDeltaByDir[thisConnection];
      tY=trainData[trainNum].nextY+yDeltaByDir[thisConnection];

      //test if my destination line is occupied
      if(lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, thisConnection))==true){
        collision=true;
        }

      // maybe it's a double cross...
      if(thisConnection==trainData[trainNum].nextDir){
        //yes, we're testing a straight route. Are both other lines occupied?
        if((trainData[trainNum].nextDir=="r")||(trainData[trainNum].nextDir=="l")){
          //test top and bottom for occupied
          if((lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, "t"))==true)&&(lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, "b"))==true)){collision=true;}
          }
        else{
          //test left and right for occupied
          if((lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, "l"))==true)&&(lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, "r"))==true)){collision=true;}
          }
        }
      if((collision==false)&&(isTiled(tX, tY)==false)){
        tracksArray.push(thisTrack);
        connectionsArray.push(thisConnection);
        }
      if(collision==true){collided=true;}
      }
    }// end of child nodes, have tracksArray
  //if(trainNum==0){dbugaObject("tracksArray", tracksArray);}
  // 2 - detach -
  //check for destination adjacent to train next cell
  if (trainData[trainNum].carsArray.length>0){
    if(trainNum==0){  
     //dbuga("detach? prev "+trainData[trainNum].prevX+" "+trainData[trainNum].prevY+" "+carData[trainData[trainNum].carsArray[0]].nextDir+" "+trainData[trainNum].color);
     }

    foundDest=findDest(trainData[trainNum].prevX, trainData[trainNum].prevY, carData[trainData[trainNum].carsArray[0]].nextDir, trainData[trainNum].color);// changed to next
    //if(trainNum==0){dbuga("foundDest="+foundDest);}
    if (foundDest >-1){
      var tempCarsArray=trainData[trainNum].carsArray;
      destData[foundDest].carsArray=tempCarsArray;
      
      trainData[trainNum].carsArray=[];
      }
    }


  // 3 - check color progress and find dock
  if(possibleObject[trainData[trainNum].color]==scoreObject[trainData[trainNum].color]){
    foundDest=findDest(trainData[trainNum].nextX, trainData[trainNum].nextY, trainData[trainNum].nextDir, trainData[trainNum].color);

    if(foundDest >-1){
      destTrack="";
      destOppDir=reverseObject[destData[foundDest].dir];
      trainOppDir=reverseObject[trainData[trainNum].nextDir];
      tracksInCell=returnTracksInCell(trainData[trainNum].nextX,trainData[trainNum].nextY);
      for(var t=0; t<tracksInCell.length; t++){
        thisTrack=tracksInCell[t];
        if ((thisTrack.indexOf(trainOppDir)>-1)&&(thisTrack.indexOf(destOppDir)>-1)){
          tracksArray=[thisTrack];// remove non winners from list
          thisConnection=thisTrack.replace(trainOppDir, "");          
          connectionsArray=[thisConnection];
          playSound("applause");
          if(totalCarsDocked==totalCarsNeeded){
          //playSound("applause");
            window.setTimeout("openModal('comp')", 1000);
            }
          }
        }
      }
    }
  var starting=false; // starting will force selNum to zero

  // 3.5 - is moving?
  if((trainData[trainNum].moving==false)&&(tracksArray.length>0)){
    if(trainData[trainNum].started==false){
      trainData[trainNum].started=true;
      starting=true;
      }
    playSound("trainstart");
    }
  if((collided==true)&&(tracksArray.length==0)&&(trainData[trainNum].moving==true)){
    playSound("trainpause");
    }
  if(tracksArray.length==0){
    trainData[trainNum].moving=false;
    }
  else{
    trainData[trainNum].moving=true;
    }

    // 4 - attach to last car ?

    if (trainData[trainNum].carsArray.length>0){
      var cal=trainData[trainNum].carsArray.length;
      carNum=cal-1;
      lastCarId=trainData[trainNum].carsArray[carNum];
      //dbugaObject(carData[lastCarId]);
      //foundCar=findCar(carData[lastCarId].prevX, carData[lastCarId].prevY, carData[lastCarId].prevDir, trainData[trainNum].color);
      foundCar=findCar(carData[lastCarId].prevX, carData[lastCarId].prevY, carData[lastCarId].nextDir, trainData[trainNum].color);
      if(foundCar > -1){
        //dbuga("foundCar:"+foundCar);
        trainData[trainNum].carsArray.push(foundCar);
        carData[foundCar].attached=true;
        carData[foundCar].trainNum=trainNum;
        sourceData[carData[foundCar].originId].occupied=false;
        thisCarDiv="car"+foundCar;
        var thisRef=carData[foundCar].ref;
        showQueue.push(thisRef); 
        playSound("carstart");
        }
      else{
        //dbugaObject(carData);
        //alert('not linked');
        }
      }
    
    // 5 - attach to engine ?
    if (trainData[trainNum].carsArray.length==0){
      foundCar=findCar(trainData[trainNum].prevX, trainData[trainNum].prevY, trainData[trainNum].nextDir, trainData[trainNum].color);
      if (foundCar > -1){
        trainData[trainNum].carsArray.push(foundCar);
        carData[foundCar].attached=true;
        carData[foundCar].trainNum=trainNum;
        sourceData[carData[foundCar].originId].occupied=false;  
        var thisRef=carData[foundCar].ref;
        showQueue.push(thisRef); 
        playSound("carstart");
        }
      }
  if(trainData[trainNum].moving){

    // 6 - follows from last to second, then follow engine
    if (trainData[trainNum].carsArray.length>0){
      var cal=trainData[trainNum].carsArray.length;
      for (carNum=cal-1; carNum>-1; carNum--){
        thisCarId=trainData[trainNum].carsArray[carNum];
        if(carNum==0){
          //follow train
          carData[thisCarId]=followObject(trainData[trainNum], carData[thisCarId]);
          }
        else{
          parentCarId=trainData[trainNum].carsArray[carNum-1];
          carData[thisCarId]=followObject(carData[parentCarId], carData[thisCarId]);
          }
        collisionData['car'+thisCarId]=lineStringFromXYD(carData[thisCarId].prevX, carData[thisCarId].prevY, carData[thisCarId].nextDir);
        } 
      }//end of cars array length>0

    }// end of if moving

    // 6.5 - follows into dest
    if (destData[trainNum].carsArray.length>0){
      var cal=destData[trainNum].carsArray.length;
      for (carNum=cal-1; carNum>-1; carNum--){
        thisCarId=destData[trainNum].carsArray[carNum];
        if(carNum==0){// runs last
          if((carData[thisCarId].nextX==carData[thisCarId].prevX)&&(carData[thisCarId].nextY==carData[thisCarId].prevY)){
            //already docked, kill it
            var deadCar=destData[trainNum].carsArray.shift();
            var thisRef=carData[thisCarId].ref;
            hideQueue.push(thisRef);
            completedCars.push({"created":carData[thisCarId].created, "destroyed":nowMs});
            carData[thisCarId].attached=false;
            delete collisionData['car'+thisCarId];
            scoreObject[destData[trainNum].color]++;
            updateProgressBar();
            playSound("carstop");
            }
          else{//follow dest
            carData[thisCarId]=followObject(destData[trainNum], carData[thisCarId]);
            collisionData['car'+thisCarId]=lineStringFromXYD(carData[thisCarId].prevX, carData[thisCarId].prevY, carData[thisCarId].nextDir);            }
          }
        else{// follow car
          //dbuga('follow car '+ parentCarId);
          parentCarId=destData[trainNum].carsArray[carNum-1];
          carData[thisCarId]=followObject(carData[parentCarId], carData[thisCarId]);
          collisionData['car'+thisCarId]=lineStringFromXYD(carData[thisCarId].prevX, carData[thisCarId].prevY, carData[thisCarId].nextDir);
          }
        
        } 
      }//end of cars array length>0


  // 8 - Move Engine
  trainData[trainNum].prevDeg=trainData[trainNum].nextDeg
  trainData[trainNum].prevDir=trainData[trainNum].nextDir
  trainData[trainNum].prevX=trainData[trainNum].nextX;
  trainData[trainNum].prevY=trainData[trainNum].nextY;

  if(trainData[trainNum].moving){
    var selNum=Math.floor(Math.random()*tracksArray.length);
    if(starting){
      selNum=0;
      //dbuga('starting');
      }
     
    var selTrack=tracksArray[selNum];
    trainData[trainNum].track=selTrack;
    trainData[trainNum].nextDir=connectionsArray[selNum];

    collisionData['train'+trainNum]=lineStringFromXYD(trainData[trainNum].prevX, trainData[trainNum].prevY, trainData[trainNum].nextDir);


    trainData[trainNum].nextX+=xDeltaByDir[trainData[trainNum].nextDir];
    trainData[trainNum].nextY+=yDeltaByDir[trainData[trainNum].nextDir];
    trainData[trainNum].nextDeg=trainData[trainNum].prevDeg+degDeltaFromDirs(trainData[trainNum].prevDir, trainData[trainNum].nextDir);
    trainData[trainNum].prog=0;
    }// end of if moving


  //dbuga("completed");
  //dbugaObject(trainData[trainNum]);

  }
var completedCars=[];
// done.js

// ------------------- completed var and object declairations

var trainData=[];
//var turnInterval;

var destCount=0;
var destData=[];

var sourceInterval;


var sourceData=[];
var sourceCount=0;
var carData=[];

var checkTrainNum=0;
var checkSourceNum=0;

var collisionData={};

var scoreObject=new Object;
var possibleObject=new Object;
var buildSequence=new Array();

var degByDir=new Object();
degByDir['r']=90;
degByDir['l']=270;
degByDir['t']=0;
degByDir['b']=180;

var xDeltaByDir=new Object();
xDeltaByDir.l=-1;
xDeltaByDir.r=1;
xDeltaByDir.t=0;
xDeltaByDir.b=0;

var yDeltaByDir=new Object();
yDeltaByDir.l=0;
yDeltaByDir.r=0;
yDeltaByDir.t=-1;
yDeltaByDir.b=1;

var reverseObject= new Object();
reverseObject['l']="r";
reverseObject['r']="l";
reverseObject['t']="b";
reverseObject['b']="t";

var rightObject= new Object();
rightObject['l']="t";
rightObject['r']="b";
rightObject['t']="r";
rightObject['b']="l";

var leftObject= new Object();
leftObject['l']="b";
leftObject['r']="t";
leftObject['t']="l";
leftObject['b']="r";

var carHtmlByColor=new Object();
carHtmlByColor['blue']  ="<div id=\"carId\" class=\"notransit\" style><div class=\"coupler\"></div><div class=\"blueTank\"></div></div>";
carHtmlByColor['green'] ="<div id=\"carId\" class=\"notransit\" style><div class=\"coupler\"></div><div class=\"greenCar\"></div></div>";
carHtmlByColor['orange']="<div id=\"carId\" class=\"notransit\" style><div class=\"coupler\"></div><div class=\"orangeTank\"></div></div>";
carHtmlByColor['black'] ="<div id=\"carId\" class=\"notransit\" style><div class=\"coupler\"></div><div class=\"blackCar\"></div></div>";

var trainHtmlByColor=new Object();
trainHtmlByColor['blue']  ="<div id=\"trainId\" class=\"transit\" style><div class=\"coupler\"></div><div class=\"blueTrainBody\"></div><div class=\"blueTrainCatcher\"></div><div class=\"blueTrainTank\"></div><div class=\"blueTrainRear\"></div></div>";
trainHtmlByColor['green'] ="<div id=\"trainId\" class=\"transit\" style><div class=\"coupler\"></div><div class=\"greenTrainBody\"></div><div class=\"greenTrainCatcher\"></div><div class=\"greenTrainTank\"></div><div class=\"greenTrainRear\"></div></div>";
trainHtmlByColor['orange']="<div id=\"trainId\" class=\"transit\" style><div class=\"coupler\"></div><div class=\"orangeTrainBody\"></div><div class=\"orangeTrainCatcher\"></div><div class=\"orangeTrainTank\"></div><div class=\"orangeTrainRear\"></div></div>";
trainHtmlByColor['black'] ="<div id=\"trainId\" class=\"transit\" style><div class=\"coupler\"></div><div class=\"blackTrainBody\"></div><div class=\"blackTrainCatcher\"></div><div class=\"blackTrainTank\"></div><div class=\"blackTrainRear\"></div></div>";

var fullCellGlom=""; //needed for testing the path cells of tiles in viable code
var destInterval;

var dirList=new Array('t', 'b', 'r', 'l');
var colorList=new Array('black', 'orange', 'blue', 'green');
var colorCycle=0;
var tileList= new Array('trees', 'water', 'houses');


// ------------------- geometry util, display, and game functions

// used maybe for debugging
function returnObjectInfo(theObject){
  dstring=" prev: "+theObject.prevX+" "+theObject.prevY+" next: "+theObject.nextX+" "+theObject.nextY+" "+theObject.nextDir;
  return dstring;
  }
function dbug(theString){
  
  document.getElementById("debugDiv").style.display="block";
  document.getElementById("debugDiv").innerHTML=""+theString+"<br>";
  }
function dbuga(theString){


  document.getElementById("debugDiv").style.display="block";  
  document.getElementById("debugDiv").innerHTML+=theString+"<br>";
  }
function dbugc(theString){
  document.getElementById("debugDiv").innerHTML+=theString+" ";
  }
function dbugaObject(caption, theObject){
  var theString=JSON.stringify(theObject);
  var parts=theString.split(",");
  theString=parts.join(", ");
  parts=theString.split("}");
  theString=parts.join("}<br> ");
  document.getElementById("debugDiv").style.display="block";  
  document.getElementById("debugDiv").innerHTML+=caption+"="+theString+"<br>";
  }

function followObject(leader, follower){
  follower.prevX=follower.nextX;
  follower.prevY=follower.nextY;
  follower.prevDeg=follower.nextDeg;
  follower.prevDir=follower.nextDir;
  follower.nextX=leader.nextX;
  follower.nextY=leader.nextY;
  follower.nextDir=leader.nextDir;
  follower.nextDeg=leader.nextDeg;
  follower.track=leader.track;
  ////follower.transformCache=leader.transformCache;
  follower.animCache=leader.animCache;
  return follower;
  }


function degDeltaFromDirs(dir1, dir2){
  theDelta=0;
  if ((dir1=="r")&&(dir2=="t")){theDelta-=90;}
  if ((dir1=="t")&&(dir2=="l")){theDelta-=90;}
  if ((dir1=="l")&&(dir2=="b")){theDelta-=90;}
  if ((dir1=="b")&&(dir2=="r")){theDelta-=90;}

  if ((dir1=="r")&&(dir2=="b")){theDelta+=90;}
  if ((dir1=="b")&&(dir2=="l")){theDelta+=90;}
  if ((dir1=="l")&&(dir2=="t")){theDelta+=90;}
  if ((dir1=="t")&&(dir2=="r")){theDelta+=90;}
  return theDelta;
  }

function lineStringFromXYD(x, y, dir){
  if((dir=="l")||(dir=="r")){
    axis="v";
    if(dir=="l"){x-=1;}
    }
  if((dir=="t")||(dir=="b")){
    axis="h";
    if(dir=="t"){y-=1;}
    }
  lineString=axis+x+"_"+y;
  return lineString;
  }
function returnProgPos(anim, prog){
  var prevX=anim.prevX+.5;
  var prevY=anim.prevY+.5;
  if (anim.prevDir =="r"){prevX-=.5;}
  if (anim.prevDir =="b"){prevY-=.5;}
  if (anim.prevDir =="l"){prevX+=.5;}
  if (anim.prevDir =="t"){prevY+=.5;}

  var nextX=anim.nextX+.5;
  var nextY=anim.nextY+.5;
  if (anim.nextDir=="r"){nextX-=.5;}
  if (anim.nextDir =="b"){nextY-=.5;}
  if (anim.nextDir =="l"){nextX+=.5;}
  if (anim.nextDir =="t"){nextY+=.5;}
  var sumX=prevX*(1-prog)+(nextX*prog);
  var sumY=prevY*(1-prog)+(nextY*prog);


  if (anim.prevDir=="r"){anim.prevDeg=90;}
  if (anim.prevDir=="b"){anim.prevDeg=180;}
  if (anim.prevDir=="l"){anim.prevDeg=270;}
  if (anim.prevDir=="t"){anim.prevDeg=0;}
  if (anim.nextDir=="r"){anim.nextDeg=90;}
  if (anim.nextDir=="b"){anim.nextDeg=180;}
  if (anim.nextDir=="l"){anim.nextDeg=270;}
  if (anim.nextDir=="t"){anim.nextDeg=0;}
  if(anim.nextDeg-anim.prevDeg>180){anim.prevDeg+=360;}
  if(anim.prevDeg-anim.nextDeg>180){anim.nextDeg+=360;}

  var sumDeg=anim.prevDeg*(1-prog)+(anim.nextDeg*prog);
  //if(anim.prevDir=="t"){dbug(anim.prevDeg+" "+anim.nextDeg+" "+sumDeg);}


  if(anim.prevDir != anim.nextDir){
    // turn!
    //find center point
    var centerX;
    var centerY;
    var rads;
    if(anim.prevDir=="r"){
      centerX=prevX;
      centerY=nextY;
      if(anim.nextDir=="t"){rads=pi*(90-sumDeg-90)/180;}
      if(anim.nextDir=="b"){rads=pi*(90-sumDeg+90)/180;}
      }
    if(anim.prevDir =="l"){
      centerX=prevX;
      centerY=nextY;
      if(anim.nextDir=="t"){rads=pi*(90-sumDeg+90)/180;}
      if(anim.nextDir=="b"){rads=pi*(90-sumDeg-90)/180;}
      }
    if(anim.prevDir =="t"){
      centerX=nextX;
      centerY=prevY;
      if(anim.nextDir=="l"){rads=pi*(90-sumDeg-90)/180;}
      if(anim.nextDir=="r"){rads=pi*(90-sumDeg+90)/180;}
      }
    if(anim.prevDir =="b"){
      centerX=nextX;
      centerY=prevY;
      if(anim.nextDir=="l"){rads=pi*(90-sumDeg+90)/180;}
      if(anim.nextDir=="r"){rads=pi*(90-sumDeg-90)/180;}
      }
 
    sumX=centerX+.5*Math.cos(rads);
    sumY=centerY-.5*Math.sin(rads);
    }

  var transformString=" translate("+sumX+"px, "+sumY+"px) rotate("+sumDeg+"deg)"; 
  //dbuga('progTransform completed ');
    
  var newPos={"x":sumX, "y":sumY, "d":sumDeg};
  return newPos;

  }
function returnProgTransform(anim, prog){
  //dbug('progTransform '+JSON.stringify(anim));
  var prevX=anim.prevX*cellSize+cellSizeHalf;
  var prevY=anim.prevY*cellSize+cellSizeHalf;
  if (anim.prevDir =="r"){prevX-=cellSizeHalf;}
  if (anim.prevDir =="b"){prevY-=cellSizeHalf;}
  if (anim.prevDir =="l"){prevX+=cellSizeHalf;}
  if (anim.prevDir =="t"){prevY+=cellSizeHalf;}

  var nextX=anim.nextX*cellSize+cellSizeHalf;
  var nextY=anim.nextY*cellSize+cellSizeHalf;
  if (anim.nextDir=="r"){nextX-=cellSizeHalf;}
  if (anim.nextDir =="b"){nextY-=cellSizeHalf;}
  if (anim.nextDir =="l"){nextX+=cellSizeHalf;}
  if (anim.nextDir =="t"){nextY+=cellSizeHalf;}
  var sumX=prevX*(1-prog)+(nextX*prog);
  var sumY=prevY*(1-prog)+(nextY*prog);


  if (anim.prevDir=="r"){anim.prevDeg=90;}
  if (anim.prevDir=="b"){anim.prevDeg=180;}
  if (anim.prevDir=="l"){anim.prevDeg=270;}
  if (anim.prevDir=="t"){anim.prevDeg=0;}
  if (anim.nextDir=="r"){anim.nextDeg=90;}
  if (anim.nextDir=="b"){anim.nextDeg=180;}
  if (anim.nextDir=="l"){anim.nextDeg=270;}
  if (anim.nextDir=="t"){anim.nextDeg=0;}
  if(anim.nextDeg-anim.prevDeg>180){anim.prevDeg+=360;}
  if(anim.prevDeg-anim.nextDeg>180){anim.nextDeg+=360;}

  var sumDeg=anim.prevDeg*(1-prog)+(anim.nextDeg*prog);
  //if(anim.prevDir=="t"){dbug(anim.prevDeg+" "+anim.nextDeg+" "+sumDeg);}


  if(anim.prevDir != anim.nextDir){
    // turn!
    //find center point
    var centerX;
    var centerY;
    var rads;
    if(anim.prevDir=="r"){
      centerX=prevX;
      centerY=nextY;
      if(anim.nextDir=="t"){rads=pi*(90-sumDeg-90)/180;}
      if(anim.nextDir=="b"){rads=pi*(90-sumDeg+90)/180;}
      }
    if(anim.prevDir =="l"){
      centerX=prevX;
      centerY=nextY;
      if(anim.nextDir=="t"){rads=pi*(90-sumDeg+90)/180;}
      if(anim.nextDir=="b"){rads=pi*(90-sumDeg-90)/180;}
      }
    if(anim.prevDir =="t"){
      centerX=nextX;
      centerY=prevY;
      if(anim.nextDir=="l"){rads=pi*(90-sumDeg-90)/180;}
      if(anim.nextDir=="r"){rads=pi*(90-sumDeg+90)/180;}
      }
    if(anim.prevDir =="b"){
      centerX=nextX;
      centerY=prevY;
      if(anim.nextDir=="l"){rads=pi*(90-sumDeg+90)/180;}
      if(anim.nextDir=="r"){rads=pi*(90-sumDeg-90)/180;}
      }
 
    //var rads=pi*2*((sumDeg)/360);
    sumX=centerX+cellSizeHalf*Math.cos(rads);
    sumY=centerY-cellSizeHalf*Math.sin(rads);
    //dbuga(Math.floor(sumDeg)+" frac:"+Math.floor((rads/6.28)*100)/100+" cos:"+Math.floor(Math.cos(rads)*100)/100+" sin:"+Math.floor(Math.sin(rads)*-100)/100);
    }

  //var transformString=" translate("+sumX+"px, "+sumY+"px) rotate("+sumDeg+"deg)"; 
  //return transformString;
  //dbuga('progTransform completed ');
    var z=cubeSize/2;
    sumDeg-=90;
      var trans="";
    trans+="translateX("+sumX+"px) ";
    trans+="translateY("+sumY+"px) ";
    trans+=" rotateZ("+sumDeg+"deg) ";
    trans+=" translateZ("+z+"px)";  
  
  return trans;
  }

function makeGridDivs(){
  //dbuga('makeGridDivs()');
  for (x=0; x<cellsAcross; x++){
    for (y=0; y<cellsDown; y++){
      var newdiv = document.createElement('div');
      newdiv.innerHTML = "<div id=\"grid_"+x+"_"+y+"\" class=\"tile L"+x+" T"+y+"\"></div>";
      document.getElementById('fieldHolder').appendChild(newdiv);
      }
    }
  }

function returnTracksInCell(x,y){
  var tempArray= new Array();
  var examineCell="grid_"+x+"_"+y;
  //var cn=document.getElementById(examineCell).childNodes;
  var cn=tilesByGridXY[examineCell];
  var cnl=cn.length;  
  for (var n=0; n<cnl; n++){
    var thisClass=cn[n];
    if (thisClass.indexOf('tile')==-1){
      tempArray.push(thisClass);
      }
    }
  return tempArray;
  }
function lineIsOccupied(lineString){
  //debugString="";
  occupied=false;
  for (var k in collisionData){
    //debugString+=" "+collisionData[k];
    if(collisionData[k]==lineString){
      occupied=true;
      }
    }
  return occupied;
  }

function findDest(x, y, dir, color){
  var found=-1;
  carOppDir=reverseObject[dir];
  tracksInCell=returnTracksInCell(x,y);
  for (var d=0; d<destCount; d++){
    if ((destData[d].xIntake==x)&&(destData[d].yIntake==y)&&(destData[d].color==color)){
      destOppDir=reverseObject[destData[d].dir];
      // check for compatable tracks... 
      for(var t=0; t<tracksInCell.length; t++){
        thisTrack=tracksInCell[t];
        if ((thisTrack.indexOf(carOppDir)>-1)&&(thisTrack.indexOf(destOppDir)>-1)){
          found=d;
          }
        }
      }
    }
  return found;
  }

function findCar(x, y, dir, color){
  found=-1;
  for (c=0; c<carData.length; c++){
    carOppDir=reverseObject[carData[c].nextDir];
    tracksInCell=returnTracksInCell(x,y);

    if((carData[c].nextX==x)&&(carData[c].nextY==y)&&(carData[c].attached==false)&&(carData[c].color==color)){
      for(var t=0; t<tracksInCell.length; t++){
        thisTrack=tracksInCell[t];
        if ((thisTrack.indexOf(dir)>-1)&&(thisTrack.indexOf(carOppDir)>-1)){
          found=c;
          }
        }
      }
    }
  //dbuga(found);
  return found;
  }

// ------------------- functions related to touch and creating tracks

var tilesByGridXY={};

function createTrack(cellType, targetCell){
  //new database
  //dbuga(cellType+' '+targetCell);
  tilesByGridXY[targetCell].push(cellType);

  //old div database
  if(cellType.indexOf('tile')>-1){
    var newdiv = document.createElement('div');
    trackHtml=document.getElementById(cellType).innerHTML;
    newdiv.innerHTML = trackHtml;
    newdiv.className=cellType;
    document.getElementById(targetCell).appendChild(newdiv);
    }
  }

var mouseDragging=false;
function mouseDown(e){
  
  mouseDragging=true;
 
  var tid = e.target.id
  var x=e.clientX;
  var y=e.clientY;
  
  var tArray=[{"pageX":x, "pageY":y, "target":{"id":tid}}];
  var event={"type":"touchstart", "touches":tArray};
  touchStart(event);
  }
function mouseMove(e){
  e.preventDefault();
  if(mouseDragging){
    //dbug("mouseMove "+e.clientX+" "+e.clientY);
    var target = e.target;
    var id = target.id
    var event={"type":"touchmove", "touches":[{"pageX":e.clientX, "pageY":e.clientY, "target":{"id":id}}]}
    //console.log(event);
    touchMove(event);
    }// buzz off hover mouse.
  }
function mouseUp(e){
  e.preventDefault();
  mouseDragging=false;
  //dbuga("mouseUp");
  var event={"type":"touchend", "touches":[]};
  touchEnd(event);
  }

function touchCancel(event){ 
  }
function debugEvent(e){
  console.log(e);
  }
function touchStart(event){
  touchEvent(event);
  }
function touchMove(event){
  touchEvent(event);
  }
function touchEnd(event){
  touchEvent(event);
  }

function touchEvent(event){
  //dbug('touchEvent('+event.type+')');
  if(event.touches.length==0){//touchend
    if(viewportAspect<1){//portrait 
      if(levelsUp){
        return false;
        }
      else if(settingsUp){
        handleEventSettings(event);
        }
      else{
        handleEventDraw(event);
        }
      }
    else{//landscape
      if(graphicsUp){handleEventGraphics(event);}
      }
    }
  else{
    if(viewportAspect>1){
      var inColors=false;
      if(event.touches[0].pageY<controlsPx){
        if(colorsUp){
          inColors=true;
          }
        else{
          //if(event.touches[0].pageX>screenWidth-controlsPx){
          if(event.touches[0].pageX>screenHeight-controlsPx){// x circle
            inColors=true;
            }
          }
        }
      if(inColors){handleEventColors(event);}
      else{
        if(carsUp){handleEventCars(event);}
        else if(graphicsUp){handleEventGraphics(event);}
        else if(helpUp){handleEventHelp(event);}
        else if(compUp){handleEventComp(event);}
        else{handleEventDolly(event);}      
        }
      }
    else{//portraits
      if ((event.touches[0].pageY>controlsPx)){
        if(levelsUp){handleEventLevels(event);}
        else if(settingsUp){handleEventSettings(event);}
        else if(helpUp){handleEventHelp(event);}
        else if(compUp){handleEventComp(event);}
        else{handleEventDraw(event);}
        }
      else {
        handleEventNav(event);
        }
      }
    }
  }
function clearAllGraphics(){
  //dbuga('clearAllGraphics()');
  var atDefault=0;
  var color=colorArray[focusCars];
  var x=0; 
  var y=0;
  for (var i=0; i<graphicsPerColor; i++){
    processGraphic(focusCars, atDefault, true, true);
    atDefault++;
    }
  localStorage.setItem('graphicsByColor', JSON.stringify(graphicsByColor));

  }
/*
var atColor=0;
var atGraphic=0;

function graphicsTick(){
  //dbugc("-");
  var color;
  if(atColor<colorArray.length){
    color=colorArray[atColor];
    processGraphic(atColor, atGraphic, false, false);
    atGraphic++;
    if(atGraphic>=graphicsByColor[color].length){
      atGraphic=0;
      atColor++;
      }
    window.setTimeout('graphicsTick()',10);
    }
  else{// finished last color so resume
    resumeInit();
    }
  }
*/
 
function handleEventCars(e){
  if(e.type=="touchstart"){
    var t=e.touches[0];
    for (var ct=0; ct<carsThumbs.length; ct++){
      var carThumb=carsThumbs[ct];
      if(xyInTrbl(t.pageX, t.pageY-controlsPx,carThumb)){
        openGraphics(carThumb);
        }
      }
    //dbuga('t.pageX='+t.pageX+' t.pageY='+t.pageY);
    for (var cb=0; cb<carsButtons.length; cb++){
      if(xyInTrbl(t.pageX, t.pageY-controlsPx,carsButtons[cb])){
        //dbuga(carsButtons[cb].label);
        if(carsButtons[cb].label=="Done"){closeModals();}
        if(carsButtons[cb].label=="Clear"){
          clearingAll=true;
          }
        if(carsButtons[cb].label=="Sure?"){
          clearingAll=false;
          clearAllGraphics();
          }
        if(carsButtons[cb].label=="Cancel"){
          clearingAll=false;
          }
        populateCars();
        }
      } 
    }
  if(e.type=="touchmove"){
    return false;
    }
  if(e.type=="touchend"){
    return false;
    }
  }
function handleEventGraphics(e){
  //dbuga(' - handleEventGraphics('+e.type+') graphicsUp='+graphicsUp+' graphicsEditing='+graphicsEditing);
  if(e.type=="touchstart"){
    var t=e.touches[0];
        var found=false;
        for (var gb=0; gb<graphicsButtons.length; gb++){
          var graphicsButton=graphicsButtons[gb];
          var x=t.pageX;
          var y=t.pageY-controlsPx;
          if(xyInTrbl(x,y,graphicsButton)){

            if(graphicsButton.label=="Done"){
              openModal("cars");
              }
            if(graphicsButton.label=="Camera"){
              //dbuga('Camera');
              graphicsTake();
              }
            if(graphicsButton.label=="Transparent"){
              graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic].blackTrans=!(graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic].blackTrans);
              localStorage.setItem('graphicsByColor', JSON.stringify(graphicsByColor));
              processGraphic(graphicsSelectedColorNum, graphicsSelectedGraphic, false, false);
              populateGraphics();
              populateCars();
              }
            if(graphicsButton.label=="Save"){
              graphicsEditing=false;
              // move to storage, image for now
              saveGraphics();
              graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic].blackTrans=false;
              localStorage.setItem('graphicsByColor', JSON.stringify(graphicsByColor));
              }
            if(graphicsButton.label=="Cancel"){
              graphicsEditing=false;
              processGraphic(graphicsSelectedColorNum, graphicsSelectedGraphic, false, false);
              populateCars();
              
              }
            if(graphicsButton.label=="Retake"){
              graphicsTake();              
              }
            found=true;// because xyInTrbl
            if(graphicsButton.label=="car"){
              //dbuga('car touchstart');
              found=false;              
              }
            }
          }
        if(found==false){
          //dbuga('closeModals found=false 2');
          if(graphicsEditing==false){
            //closeModals(); // tap closed on background touch
            }
          else{            
            graphicsEvent=e;
            graphicsTouching=true;
            startMoveGraphics();
            //dbuga('graphics  touchstart! '+e.touches.length);
            }
          }
        else{// found == true
          //populateGraphics(); 
          //this may be needed elsewhere. Trans?
          }

    }
  if(e.type=="touchmove"){
    if((graphicsEditing)&&(graphicsTouching)){
      graphicsEvent=e;
      moveGraphics();
      //dbuga('graphics  touchmove '+e.touches.length);
      }
    }
  if(e.type=="touchend"){
    if((graphicsEditing)&&(graphicsTouching)){
      graphicsEvent=e;
      //dbuga('graphics  touchend! '+e.touches.length);
      if(e.touches.length >0){
        startMoveGraphics();
        }
      else{
        graphicsTouching=false;
        postviewGraphics();
        }
      }
    }
  }




function handleEventDolly(e){
  if(e.type=="touchstart"){
    var t=e.touches[0];
    prevTouchX=t.pageX;
    prevTouchY=t.pageY-controlsPx;
    }
  if(e.type=="touchmove"){
    var t=e.touches[0];
    //normal drag of pan zoom camera on table
    var deltaX=prevTouchX-t.pageX;
    var deltaY=prevTouchY-(t.pageY-controlsPx);
    combinedZoom[focusTrain]-=deltaY/5;
    if(t.pageY-controlsPx>(boardWidth/2)){cameraRotationDegrees[focusTrain]+=deltaX/2.5;}
    else{cameraRotationDegrees[focusTrain]-=deltaX/15;}
    if(combinedZoom[focusTrain]<0){combinedZoom[focusTrain]=0;}
    if(combinedZoom[focusTrain]>100){combinedZoom[focusTrain]=100;}
    prevTouchX=t.pageX;
    prevTouchY=t.pageY-controlsPx;
    }

  }


var focusCars=0;
function handleEventColors(event){
  //dbuga('handleEventColors '+event.type);
  if(event.type=="touchstart"){
    var t=event.touches[0];
    for (var b=0; b<colorsButtons.length; b++){
      if(xyInTrbl(t.pageX, t.pageY,colorsButtons[b])){
        var label=colorsButtons[b].label;
        if(label=="showHide"){
          if(colorsUp==false){
            colorsUp=true;
            }
          else{
            closeModals();
            colorsUp=false;
            }
          }
        if(label=="camera"){
          if((carsUp)||(graphicsUp)){
            //dbuga('closeModals car button');
            closeModals();
            }
          else{
            openModal("cars");
            }
          }
        if(label.indexOf("color_")==0){
          var parts=label.split("_");
          var c=Number(parts[1]);
          if((carsUp)||(graphicsUp)){
            if(c<trainData.length){focusTrain=c;}
            focusCars=c;
            populateCars();
            }
          else{
            focusTrain=c;
            focusCars=c;
            if(graphicsUp){openModal("cars");}
            }    
          }      
        }
      }
    }
  updateColorsCanv('touchstart 1');
  }

/*
    if(colorsUp==false){
      //dbuga("x:"+t.pageX+" sh:"+screenHeight+" cp:"+controlsPx);
      if(t.pageX>screenHeight-controlsPx){//settings circle
        //colorsUp=true;
        //updateColorsCanv('touchstart 1');
        }
      }
    else{
      var tryFocus=Math.floor((t.pageX)/controlsPx);
      if(carsUp){
        //dbuga('tryFocus='+tryFocus);
        if(tryFocus<4){
          //focusCars=tryFocus;
          //updateColorsCanv('carsUp');
          //populateCars();
        
          }
      }
      else{//train focus
        //dbuga('tryFocus='+tryFocus);
        if((tryFocus<trainData.length)&&(tryFocus != focusTrain)){
          //focusTrain=tryFocus;
          //focusCars=tryFocus;
          //updateColorsCanv('touchstart 2');
          //if(graphicsUp){openModal("cars");}
          }
        }
      if(t.pageX>screenHeight-controlsPx){// x circle
        //dbuga('closeModals t.pageX<controlsPx');
        //closeModals();
        //colorsUp=false;
        //updateColorsCanv('x circle');
        }
      if((t.pageX>screenHeight-controlsPx*2)&&(t.pageX<screenHeight-controlsPx)){// carmera button
        if((carsUp)||(graphicsUp)){
          //dbuga('closeModals car button');
          closeModals();
          }
        else{
          openModal("cars");
          }
        }
      }
    }
  }  
*/
// ported code
var camera;
var zoom;
var table;

var cameraXpercent=50;
var cameraYpercent=50;
var cameraDistancePercent=0;
var cameraRotationDegrees=[rnd(360),rnd(360),rnd(360),rnd(360)];
var combinedZoom=[rnd(101),rnd(101),rnd(101),rnd(101)];
var cameraTilt=0;

cameraRotationDegrees=[180,90,270,0];
combinedZoom =[75,25,0,100];


var prevTouchX=0;
var prevTouchY=0;
var focusTrain=0;

var shooting=false;
function graphicsTake(){
              graphicsCanv.width=screenHeight;
              var graphicsCtx=graphicsCanv.getContext('2d');
              graphicsCtx.textBaseline="middle";
              graphicsCtx.fillStyle="black";
              graphicsCtx.font=screenWidth/10+"px akzi";
              graphicsCtx.textAlign="center";
              
              graphicsCtx.fillText("Loading Photo...", screenHeight/2, screenWidth/2-controlsPx/2);
              window.setTimeout('cameraTake()',50);              
  }
function cameraTake(){
  shooting=true;
  //dbuga('cameraTake gscn'+  graphicsSelectedColorNum+' gsg='+graphicsSelectedGraphic);
  navigator.camera.getPicture(onSuccess, onFail, { quality: 50,
    destinationType: Camera.DestinationType.DATA_URL
    });
  }
function onFail(message) {
  //dbuga('onFail');
  shooting=false;
  graphicsEditing=false;
  populateGraphics();
  }
function onSuccess(imageData) {
    //dbuga('success '+imageData.length);

    var image = document.getElementById('cameraImg');
    image.style.display="block";
    image.onload=function(){
      cameraLoaded();
      };
    image.src = "data:image/jpeg;base64," + imageData;
    shooting=false;
    }
    
function cameraLoaded(){
    //dbuga('cameraLoaded()');
    graphicsEditing=true;
    var image = document.getElementById('cameraImg');
    graphicsScale=.9;
    graphicsOffsetX=0;
    graphicsOffsetY=0;
    //dbuga('image.naturalWidth: '+image.naturalWidth +' image.naturalHeight:'+image.naturalHeight);
    populateGraphics();
    previewGraphics();
    postviewGraphics();
    updateColorsCanv('cameraLoaded');
    }


function postviewGraphics(){
  cameraCanv.width=800;
  cameraCanv.height=200;
  cameraCanv.style.display="none";
  var image = document.getElementById('cameraImg');
  var offsetMultiplier=graphicsScale*image.naturalWidth/400;
  var graphicsCtx=graphicsCanv.getContext('2d');
  graphicsCtx.lineWidth=cellSize/16;
  var graphic=graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic];

  var buttonWidth=cellSize*3;
  var buttonHeight=cellSize*1;
  var radius=cellSize/8;
  var pad=cellSize/10;
  var topPad=(screenWidth-controlsPx-buttonHeight*4)/2;
  var leftPad=(screenHeight-buttonWidth*3)/2;  
  var carButton={"label":"car"}

  carButton.sampleWidth=image.naturalWidth*graphicsScale;
  carButton.sampleHeight=carButton.sampleWidth/4;
  carButton.sampleTop=image.naturalHeight/2-carButton.sampleHeight/2+graphicsOffsetY*offsetMultiplier;
  carButton.sampleLeft=image.naturalWidth/2-carButton.sampleWidth/2+graphicsOffsetX*offsetMultiplier;

  carButton.c=graphicsSelectedColorNum;
  carButton.g= graphicsSelectedGraphic;
  carButton.l=leftPad;
  carButton.r=leftPad+buttonWidth*3;
  carButton.t=topPad;
  carButton.b=topPad+buttonHeight*3;
  carButton.ref=image;
  var carGrid=buttonWidth*3/60;
  var cameraCtx=cameraCanv.getContext('2d');
  cameraCtx.drawImage(carButton.ref, carButton.sampleLeft, carButton.sampleTop, carButton.sampleWidth, carButton.sampleHeight, 0,0,800,200);
  //console.log(carButton);
  
  }
var groupGridPad=.25;
function gtlInWh(w,h){
  var gtl={"g":0,"t":0,"l":0};

  var groupAcross=(9+groupGridPad*2);
  var groupDown=(3+groupGridPad*2);
  var groupAspect=groupAcross/groupDown;
  var availHeight=screenWidth-controlsPx-controlsPx-20;//10 px modal pad
  var areaAspect=w/h;
  if(areaAspect>groupAspect){//fit height, pad left
    //dbug('fit height');
    gtl.g=availHeight/groupDown;
    gtl.t=gtl.g*groupGridPad;
    gtl.l=gtl.g*groupGridPad+screenHeight/2-gtl.g*groupAcross/2;
    }
  else{//fit width, pad top
    //dbug('fit width');
    gtl.g=screenHeight/groupAcross;
    gtl.l=gtl.g*groupGridPad;
    gtl.t=gtl.g*groupGridPad+availHeight/2-gtl.g*groupDown/2;
    }
  return gtl;
  }
function previewGraphics(){
  dbuga('previewGraphics');
  var image = document.getElementById('cameraImg');
  var offsetMultiplier=graphicsScale*image.naturalWidth/400;
  var graphicsCtx=graphicsCanv.getContext('2d');
  //graphicsCtx.lineWidth=cellSize/16;
  var graphic=graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic];

  var gtl=gtlInWh(screenHeight, screenWidth-controlsPx-controlsPx-20);
  var g=gtl.g;
  var topPad=gtl.t;
  var leftPad=gtl.l;

  var inset=g/2;
  graphicsCtx.lineWidth=1;
  graphicsCtx.strokeStyle="red";
  graphicsCtx.strokeRect(leftPad+inset, topPad+inset, g*9-inset*2, g*3-inset*2);

  var buttonWidth=g*9-inset*2;
  // 22x7.5 at 40
  var carGrid=buttonWidth/22;
  var buttonHeight=carGrid*7.5;

  var carButton={"label":"car"}

  carButton.sampleWidth=image.naturalWidth*graphicsScale;
  carButton.sampleHeight=carButton.sampleWidth/4;
  carButton.sampleTop=image.naturalHeight/2-carButton.sampleHeight/2+graphicsOffsetY*offsetMultiplier;
  carButton.sampleLeft=image.naturalWidth/2-carButton.sampleWidth/2+graphicsOffsetX*offsetMultiplier;

  carButton.c=graphicsSelectedColorNum;
  carButton.g=graphicsSelectedGraphic;
  carButton.l=leftPad+inset;
  carButton.r=leftPad+buttonWidth;
  carButton.t=topPad+inset;
  carButton.b=topPad+buttonHeight;
  carButton.h=topPad+buttonHeight;

  carButton.ref=image;
  var carGrid=buttonWidth*3/60;

  var imageObj = imgRefs["boxside"+colorArray[carButton.c]];
  graphicsCtx.drawImage(imageObj, carButton.l, carButton.t, buttonWidth, buttonHeight);
  //graphicsCtx.drawImage(carButton.ref, carButton.sampleLeft, carButton.sampleTop, carButton.sampleWidth, carButton.sampleHeight, carButton.l, carButton.t, buttonWidth, buttonHeight);
  //console.log(carButton);
  
  }

function testImageSample(image, scale, offsetX, offsetY){
  if(scale<.1){return false;}
  var offsetMultiplier=scale*image.naturalWidth/400;
  var sampleWidth=image.naturalWidth*scale;
  var sampleHeight=sampleWidth/4; //800 x 200
  var sampleTop=image.naturalHeight/2-sampleHeight/2+offsetY*offsetMultiplier;
  var sampleLeft=image.naturalWidth/2-sampleWidth/2+offsetX*offsetMultiplier;

  if(sampleLeft<0){return false;}
  if(sampleLeft+sampleWidth>=image.naturalWidth){return false;}
  if(sampleTop<0){return false;}
  if(sampleTop+sampleHeight>=image.naturalHeight){return false;}
  return true;
  }

function encode(data){
  var str = String.fromCharCode.apply(null,data);
  return btoa(str).replace(/.{76}(?=.)/g,'$&\n');
  }
function saveGraphics(){
  var cameraCtx=cameraCanv.getContext('2d');
  var dataURL = cameraCanv.toDataURL('image/jpeg');
  var imageId= graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic].imageId;
  //dbuga('saveGraphics '+imageId);
  var image=document.getElementById(imageId);
  image.onload=function (){
    saveComplete();
    };
  image.src = dataURL;
  localStorage.setItem(imageId, dataURL);

  }
function saveComplete(){
  processGraphic(graphicsSelectedColorNum, graphicsSelectedGraphic, false, true);
  populateCars();
  populateGraphics();
  updateColorsCanv('saveComplete');
  //dbuga('saveComplete');
  }


function closeLoading(){
  document.getElementById('loadingCanvas').style.display="none";
  }
function closeHelp(){
  console.log('closeHelp');
  paused=false;
  document.getElementById('helpCanvas').style.display="none";
  helpUp=false;
  }
function closeComp(){
  console.log('closeComp');
  paused=false;
  document.getElementById('compCanvas').style.display="none";
  compUp=false;
  }

var graphicsTouching=false;
var graphicsEvent;

var graphicsStartX;
var graphicsStartY;
var graphicsStartR;
var graphicsAtX;
var graphicsAtY;
var graphicsAtR;

var graphicsStartScale=1;
var graphicsStartOffsetX=0;
var graphicsStartOffsetY=0;
var graphicsScale=1;
var graphicsOffsetX=0;
var graphicsOffsetY=0;

function startMoveGraphics(){
  var sumX=0;
  var sumY=0;
  for (var t=0; t<graphicsEvent.touches.length; t++){
    sumX+=graphicsEvent.touches[t].pageX;
    sumY+=graphicsEvent.touches[t].pageY;
    }
  graphicsAtX=sumX/graphicsEvent.touches.length;
  graphicsAtY=sumY/graphicsEvent.touches.length;
  var sumR=0;
  for (var t=0; t<graphicsEvent.touches.length; t++){
    var deltaX=graphicsEvent.touches[t].pageX-graphicsAtX;
    var deltaY=graphicsEvent.touches[t].pageY-graphicsAtY;
    sumR+=Math.sqrt(deltaX*deltaX+deltaY*deltaY);
    }
  graphicsAtR=sumR/graphicsEvent.touches.length;

  graphicsStartX=graphicsAtX;
  graphicsStartY=graphicsAtY;
  graphicsStartR=graphicsAtR;

  graphicsStartScale=graphicsScale;
  graphicsStartOffsetX=graphicsOffsetX;
  graphicsStartOffsetY=graphicsOffsetY;
  }

function moveGraphics(){
  var sumX=0;
  var sumY=0;
  for (var t=0; t<graphicsEvent.touches.length; t++){
    sumX+=graphicsEvent.touches[t].pageX;
    sumY+=graphicsEvent.touches[t].pageY;
    }
  graphicsAtX=sumX/graphicsEvent.touches.length;
  graphicsAtY=sumY/graphicsEvent.touches.length;
  var sumR=0;
  for (var t=0; t<graphicsEvent.touches.length; t++){
    var deltaX=graphicsEvent.touches[t].pageX-graphicsAtX;
    var deltaY=graphicsEvent.touches[t].pageY-graphicsAtY;
    sumR+=Math.sqrt(deltaX*deltaX+deltaY*deltaY);
    }
  graphicsAtR=sumR/graphicsEvent.touches.length;
  var deltaX=graphicsAtX-graphicsStartX;
  var deltaY=graphicsAtY-graphicsStartY;
  var deltaR=graphicsAtR-graphicsStartR;

  //dbuga('deltaX='+deltaX);
  //dbuga('deltaY='+deltaY);
  //dbuga('deltaR='+deltaR);
  var tryScale=graphicsStartScale-(deltaR/screenWidth);
  var tryX=graphicsStartOffsetX-deltaX;
  var tryY=graphicsStartOffsetY-deltaY;
  var image=document.getElementById('cameraImg');
  var moved=false;
  if(testImageSample(image, tryScale, tryX, tryY)){// priority all
    graphicsScale=tryScale;
    graphicsOffsetX=tryX;
    graphicsOffsetY=tryY;
    moved=true;
    //dbuga('all');
    }
  if(moved==false){
    if(testImageSample(image, graphicsScale, tryX, tryY)){// omit scale
      graphicsOffsetX=tryX;
      graphicsOffsetY=tryY;
      moved=true;

      graphicsStartR=graphicsAtR;
      graphicsStartScale=graphicsScale;

      //dbuga('omit Scale');
      }
    }
  if(moved==false){
    if(testImageSample(image, tryScale, graphicsOffsetX, tryY)){// omit X
      graphicsScale=tryScale;
      graphicsOffsetY=tryY;

      graphicsStartX=graphicsAtX;
      graphicsStartOffsetX=graphicsOffsetX;
      //dbuga('omit X');
      }
    }
  if(moved==false){
    if(testImageSample(image, tryScale, tryX, graphicsOffsetY)){// omit Y
      graphicsScale=tryScale;
      graphicsOffsetX=tryX;
      graphicsStartY=graphicsAtY;
      graphicsStartOffsetY=graphicsOffsetY;      
      moved=true;
      //dbuga('omit Y');
      }
    }
  if(moved==false){
    //dbuga('no move');
    }
  //dbuga('graphicsScale='+graphicsScale);
  //dbuga('graphicsOffsetX='+graphicsOffsetX);
  //dbuga('graphicsOffsetY='+graphicsOffsetY);
  previewGraphics();
  //dbuga('completed moveGraphics');
  }
function fixCamera(){
  transformString='';
  transformString+='rotateX(0deg) ';
  transformString+='rotateZ(0deg)';
  transformString+='translateX('+(boardWidth*0)+'px) ';
  transformString+='translateY('+(boardHeight*0)+'px) ';
  //transformString+='translateX(0) ';
  //transformString+='translateY(0) ';
  //dbug(transformString);
  table.style.webkitTransform=transformString;
  
  
  transformString='translateZ('+((100-100)*boardHeight/100)+'px) translateY('+(0*boardWidth/100)+'px)';
  zoom.style.webkitTransform=transformString;

  }
function locateCamera(){

  cameraXpercent=100-100*camPos.x/cellsAcross;
  cameraYpercent=100-100*camPos.y/cellsDown;

  //dbug("locateCamera");
  //dbuga("screen "+screenWidth+"x"+screenHeight);
  centerAmount=0;
  if(combinedZoom[focusTrain]<50){
    centerAmount=(100-combinedZoom[focusTrain]*2)/100;
    }
  xDif=cameraXpercent-50;
  yDif=cameraYpercent-50;
  xMod=xDif*centerAmount;
  yMod=yDif*centerAmount;
  var landscapePx=Math.abs(cellsAcross-cellsDown)*cellSize;
  useX=cameraXpercent-xMod;
  useY=cameraYpercent-yMod;
  
  var useDeg=cameraRotationDegrees[focusTrain];
  if(combinedZoom[focusTrain]>95){
    useDeg=cameraRotationDegrees[focusTrain]-camPos.d;
    }
  //dbuga("combinedZoom["+focusTrain+"] "+combinedZoom[focusTrain]);
  //dbuga("camPos.d "+camPos.d);
  //dbuga("useDeg "+useDeg);
  //dbuga("cameraRotationDegrees["+focusTrain+"] "+cameraRotationDegrees[focusTrain]);
  //dbuga("cameraTilt "+ cameraTilt);
  //dbuga("useX "+useX);
  //dbuga("useY "+useY);
  //dbuga("landscapePx "+ landscapePx);

  //table rotates, tilts and moves xy under camera centerline
  transformString='';
  transformString+='translateY(' + (visHeight-boardHeight)/2 + 'px) ';
  transformString+='translateX(' + (viewportWidth-boardWidth)/2 + 'px) ';
  transformString+='rotateX('+cameraTilt+'deg) ';
  transformString+='rotateZ('+useDeg+'deg)';
  transformString+='translateY(' + boardHeight*(useY-50)/100+'px) ';
  transformString+='translateX(' + boardWidth*(useX-50)/100+'px) ';

  table.style.webkitTransform=transformString;
  var uncenter=1-centerAmount;
  var cameraDistancePx=(100-cameraDistancePercent)*boardWidth/100-cameraDistancePercent*controlsPx*2/100;
  //dbuga(cameraDistancePercent+" "+cameraDistancePx)
   var cabViewDown=uncenter*cellSize/5;
   var cabViewForward=uncenter*landscapePx+cellSize/7;
  //dbuga("cameraDistancePercent="+cameraDistancePercent);
  //dbuga("cameraDistancePx="+cameraDistancePx);
  //dbuga("cabViewForward:"+ cabViewForward);
  
  transformString='translateZ('+(cameraDistancePx+cabViewForward)+'px) translateY('+cabViewDown+'px) translateX(0px)';
  zoom.style.webkitTransform=transformString;
  //dbuga(transformString);
  }



var lox=.5;
var loy=0;




var lastX=0;
var lastY=0;
var centerSize=24;
function xyOn(x,y, dir, dist){
  var leftPx=x*cellSize;
  var topPx=y*cellSize+boardPad;
  document.getElementById("prerails").style.top=(controlsPx+topPx)+"px";
  document.getElementById("prerails").style.left=leftPx+"px";
  if((dist>centerSize)&&(x<cellsAcross)){
    if(dir=="l"){leftPx-=cellSizeHalf;}
    if(x<(cellsAcross-1)){
      if(dir=="r"){leftPx+=cellSizeHalf;}
      }
    if(dir=="t"){topPx-=cellSizeHalf;}
    if(dir=="b"){topPx+=cellSizeHalf;}
    }
  document.getElementById("highlighter").style.top=(controlsPx+topPx)+"px";
  document.getElementById("highlighter").style.left=leftPx+"px";
  document.getElementById("highlighter").style.display="block";
  }
function xyOff(x,y){
  document.getElementById("highlighter").style.display="none";
  }
var cachePageX=0;
var cachePageY=0;

function xydirFromTouch(thisTouch){
  var xydirObject=new Object();
  xydirObject.x=Math.floor((thisTouch.pageX)/cellSize);
  xydirObject.y=Math.floor((thisTouch.pageY-boardPad-controlsPx)/cellSize);

  centerX=cellSizeHalf+(cellSize*xydirObject.x);
  centerY=cellSizeHalf+(cellSize*xydirObject.y);
  if(Math.abs(centerX-thisTouch.pageX)>Math.abs(centerY-(thisTouch.pageY-boardPad-controlsPx))){
    // further on X axis
    if (centerX-thisTouch.pageX > 0){
      xydirObject.dir="l";
      }
    else{
      xydirObject.dir="r";
      }
    }
  else{
    // further on Y axis
    if (centerY-(thisTouch.pageY-boardPad-controlsPx) > 0){
      xydirObject.dir="t";
      }
    else{
      xydirObject.dir="b";
      }
    }
  distX=Math.abs(centerX-thisTouch.pageX);
  distY=Math.abs(centerY-(thisTouch.pageY-boardPad-controlsPx));
  xydirObject.dist=Math.sqrt(distX*distX + distY*distY);
  return xydirObject;

  }
// global vars for touch metrics
var lastSquare="";
var startDir="";
var lastDir="";
var lastDist=0;
var inSquare="";
//These are really global
var squareX=99;
var squareY=99;
var lastLastDir="";
function handleEventLevels(e){
  if(e.touches.length>0){
    //dbuga("handleEventLevels(target:"+e.touches[0].target.id+", type:"+e.type+")");
    }
  else{
    //dbuga("handleEventLevels(type:"+e.type+")");
    }

  var typ = e.type;
  if(typ == "touchstart"){
    var x=e.touches[0].pageX;
    var y=e.touches[0].pageY-controlsPx;
    //dbug("touchstart "+x+" "+y);
    for (var b=0; b<levelButtons.length; b++){
      if(xyInTrbl(x,y,levelButtons[b])){
        if(levelButtons[b].label=="Cancel"){closeModals();}
        }
      }
    for (var b=0; b<levelBoxes.length; b++){
      if(xyInTrbl(x,y,levelBoxes[b])){
        atLevel=b;
        drawLevels();
        window.setTimeout("createLevel()",200);
        closeModals();
        }
      //dbuga('closeModals handleEventLevels');
      }
    }
  }
function xyInTrbl(x,y,trbl){
  //dbuga(x+" "+y+" "+trbl.t+" "+trbl.r+" "+trbl.b+" "+trbl.l);
  if((trbl.t<y)&&(trbl.r>x)&&(trbl.b>y)&&(trbl.l<x)){return true;}
  else{return false;}
  }
var settingsTouchingId="";
var settingsButtonNum=-1;
var carsThumbs=[];
var carsButtons=[];
var graphicsButtons=[];
var settingsButtons=[];
var helpButtons=[];
var compButtons=[];

function handleEventComp(e){
  console.log('handleEventComp ');
  if(e.type=="touchstart"){
    var t=e.touches[0];
    var found=false;
      var x=t.pageX;
      var y=t.pageY-controlsPx;
    //dbuga('x:'+x+' y:'+y);
    for (var b=0; b<compButtons.length; b++){
      var compButton=compButtons[b];
      if(xyInTrbl(x,y,compButton)){
        if(compButton.label=="Done"){
          closeModals();
          }
        if(compButton.label=="Restart"){
          restart();
          closeModals()
          }
        }
      }
    }
  if(e.type=="touchmove"){
    }
  if(e.type=="touchend"){
    }
  }
function handleEventHelp(e){
  console.log('handleEventHelp atHelp='+atHelp);
  if(e.type=="touchstart"){
    var t=e.touches[0];
    var found=false;
      var x=t.pageX;
      var y=t.pageY-controlsPx;
    //dbuga('x:'+x+' y:'+y);
    for (var hb=0; hb<helpButtons.length; hb++){
      var helpButton=helpButtons[hb];
      if(xyInTrbl(x,y,helpButton)){
        if(helpButton.label=="Prev"){
          found=true;
          atHelp--;
          if(atHelp<0){atHelp=0;}
          }
        if(helpButton.label=="Next"){
          found=true;
          atHelp++;
          console.log(hb+' '+helpButton.label+' atHelp now '+atHelp);
          if(atHelp>maxHelp){atHelp=maxHelp;}
          }
        if(helpButton.label=="www"){
          openBrowser("http://www.jambots.com/railroadTrain");
          }
        if(helpButton.label=="Done"){
          closeHelp();
          closeModals();
          }
        //dbug(atHelp);
        }
      }// hb loop
    if(found){
      updateHelpCanv();
      }
    }
  if(e.type=="touchmove"){
    }
  if(e.type=="touchend"){
    }
  }
function openBrowser(url){
  //dbuga(url);
  var ref=cordova.InAppBrowser.open(url, "_system");
  }
function handleEventSettings(e){
  var typ = e.type;
  if(typ == "touchstart"){
    settingsTouchingId="";
    settingsButtonNum=-1;
    var x=e.touches[0].pageX;
    var y=e.touches[0].pageY-controlsPx;
    var keys=Object.keys(settingsObject);
    for (var k=0; k<keys.length; k++){
      if(xyInTrbl(x,y,settingsObject[keys[k]])){
        settingsTouchingId=keys[k];
        }
      }
    for (var b=0; b<settingsButtons.length; b++){
      if(xyInTrbl(x,y,settingsButtons[b])){
        settingsButtonNum=b;
        }
      }
    
    }
  if((typ=="touchstart")||(typ=="touchmove")){
    if(settingsTouchingId !=""){
      var x=e.touches[0].pageX;
      var y=e.touches[0].pageY-controlsPx;
      var w=settingsObject[settingsTouchingId].r-settingsObject[settingsTouchingId].l;
      var prog=(x-settingsObject[settingsTouchingId].l)/w;
      if(prog<0){prog=0;}
      if(prog>1){prog=1;}
      //dbug(prog);
      settingsObject[settingsTouchingId]["pos"]=prog*2-1;
      settingsDraw();
      }
    }
  if(typ=="touchend"){
    if(settingsTouchingId !=""){
      var pos=settingsObject[settingsTouchingId].pos; //-1 to 1
      var selection=Math.floor(pos+1+1/3);
      //dbuga("pos:" +pos +" selection:"+selection);
      settingsObject[settingsTouchingId]["value"]=settingsObject[settingsTouchingId]["values"][selection];
      settingsObject[settingsTouchingId]["pos"]=selection-1;
      // immediate sound response
      if(localStorage.getItem("Music") != settingsObject["Music"]["value"]){updateMusicSetting();}
      if(localStorage.getItem("Sounds") != settingsObject["Sounds"]["value"]){updateSoundsSetting();}
      settingsDraw();
      }
    if(settingsButtonNum>-1){
      var buttonLabel=settingsButtons[settingsButtonNum].label;
      //dbuga('buttonLabel='+buttonLabel);
      if(buttonLabel=="Done"){
        closeModals();
        }
      if(buttonLabel=="Help"){atHelp=1; openModal("help");}
      }
    settingsTouchingId="";
    settingsButtonNum=-1;    
    }// end of touchend
  }
function updateMusicSetting(){
  //dbuga("updateMusicSetting()");
  saveStorage();
  transmitBgMusicState();
  }
function updateSoundsSetting(){
  //dbuga("updateSoundsSetting()");
  saveStorage();
  if(settingsObject.Sounds.value != "Off"){
    playSound("trainstart");
    }
  }
function updateScaleSetting(){
  //dbuga("updateScaleSetting()");
  saveStorage();
  updateScale();
  }
function updateScale(){
  boardGeometry();
  setupFaceData();
  camera.style.marginTop= boardPad +"px";
  updateDetailSetting();
  setupClasses();
  setupCanvas();
  populateLevels();
  atLevel=0;
  resetBoardTimersObjects();
  rebuildSequence();
  changeView("updateScaleSetting");

  }
function updateTilesSetting(){
  //dbuga("updateTilesSetting()");
  saveStorage();
  fillGridCanvas();
  }
function updateDetailSetting(){
  //dbuga("updateDetailSetting()");
  saveStorage();
  updateDetail();
  resetBoardTimersObjects();
  rebuildSequence();
  }
function updateDetail(){
  var detail=detailByValue[settingsObject["Detail"]["value"]];
  var scaleString='scale3d('+1/detail+', '+1/detail+', '+1/detail+')';
  var style = document.createElement('style');
  style.type = 'text/css';
  style.innerHTML = '';
  for(var c=0; c<4; c++){
    var color=colorList[c];
    for(var f=0; f<faceData.engine.length; f++){
      style.innerHTML += '.'+color+'engine' + f + '{-webkit-transform: ' + faceData.engine[f].trans + ' '+scaleString+';}';
      }  

    for(var f=0; f<faceData.box.length; f++){
      style.innerHTML += '.'+color+'box' + f + '{-webkit-transform: ' + faceData.box[f].trans + ' '+ scaleString +';}';
      }  
    }  
  for(var f=0; f<faceData.tank.length; f++){
    style.innerHTML += '.blacktank' + f + '{-webkit-backface-visibility:visible; -webkit-transform: ' + faceData.tank[f].trans + ' '+ scaleString +';}';
    }  
  document.getElementsByTagName('head')[0].appendChild(style);
  //resetBoardTimersObjects();
  //rebuildSequence();
  }
function createLevel(){
  
  //dbuga('createLevel()');
          var fails=-1;
          var boost=1;
          while(fails!=0){
            //dbuga("retrying from scratch fails "+fails);
            fails=0;
            resetBoardTimersObjects();
            buildSequence=new Array();
            var thisData=levelData[levelBoxes[atLevel].num].fields;
            for (var c=0; c<thisData.length; c++){
              fails+=addColor(thisData[c],4);
              }
            }
  /*
  // test to add criss cross
  var validArray=[];
  for(var x=1; x<cellsAcross-1; x++){
    for(var y=1; y<cellsDown-1; y++){
      var adjSum=returnTracksInCell(x,y);
      adjSum+=returnTracksInCell(x-1,y);
      adjSum+=returnTracksInCell(x+1,y);
      adjSum+=returnTracksInCell(x,y-1);
      adjSum+=returnTracksInCell(x,y+1);
      if(adjSum==0){validArray.push({"x":x,"y":y});}
      }
    }
  if(validArray.length>0){
    var pick=rnd(validArray.length);
    var x=validArray[pick].x;
    var y=validArray[pick].y;
    createTrack("lr", "grid_"+x+"_"+y);
    createCanvasTrack("lr", x, y);
    buildSequence.push(new buildObject("track", "", "lr", x, y, 0));
    createTrack("tb", "grid_"+x+"_"+y);
    createCanvasTrack("tb", x, y);
    buildSequence.push(new buildObject("track", "", "tb", x, y, 0));
    }
  */
  restartIntervals();
  navButtons[4].label="Drag to<br>place tracks";
  updateNavCanv();
  updateColorsCanv('createLevel');
  }
var controlsPx=44;
var navButtons=[
  {"label":"settings", "align":"right", "selected":false, "t":0, "r":0, "b":0, "l":0},
  {"label":"levels", "align":"left", "selected":false, "t":0, "r":0, "b":0, "l":0},
  {"label":"reset", "align":"left", "selected":false, "t":0, "r":0, "b":0, "l":0},
  {"label":"undo", "align":"right", "selected":false, "t":0, "r":0, "b":0, "l":0},
  {"label":"Select a<br>new level", "align":"center", "selected":false, "t":0, "r":0, "b":0, "l":0}
  ];
var iconShrink=.9;
function updateNavCanv(){
  console.log('updateNavCanv() initCompleted:'+initCompleted);
  if(initCompleted==false){return false;}
  navCanv.width=screenWidth;
  navCanv.height=controlsPx;
  navCanv.style.top="0px";
  var navCtx=navCanv.getContext("2d");

    var grad = navCtx.createLinearGradient(0, controlsPx, 0, 0);
    grad.addColorStop(0, "rgba(225,225,225,.75)");
    grad.addColorStop(0.2, "rgba(225,225,225,.90)");
    grad.addColorStop(0.5, "rgba(255,255,255,.80)");
    grad.addColorStop(0.8, "rgba(255,255,255,.90)");
    grad.addColorStop(1, "rgba(255,255,255,.75)");
    navCtx.fillStyle=grad;
    navCtx.fillRect(0,0,screenWidth, controlsPx);



  var atLeft=0;
  var atRight=screenWidth;
  for (var n=0; n<navButtons.length; n++){
    if(navButtons[n].align=="left"){
      navButtons[n].t=0;
      navButtons[n].r=atLeft+controlsPx;
      navButtons[n].b=controlsPx;
      navButtons[n].l=atLeft;
      atLeft+=controlsPx;
      }
    else if(navButtons[n].align=="right"){
      navButtons[n].t=0;
      navButtons[n].r=atRight;
      navButtons[n].b=controlsPx;
      navButtons[n].l=atRight-controlsPx;
      atRight-=controlsPx;
      }
    else{// center so use label in remaining area. Do last!
      navButtons[n].t=0;
      navButtons[n].r=atRight;
      navButtons[n].b=controlsPx;
      navButtons[n].l=atLeft;
      }
    }
  for (var n=0; n<navButtons.length; n++){
    if(navButtons[n].align=="center"){
      var parts=navButtons[n].label.split("<br>");
      var denom=parts.length+1;
      var step=(navButtons[n].b-navButtons[n].t)/denom; // half or third
      var y=navButtons[n].t+step;
      var x=navButtons[n].l+navButtons[n].r/2-navButtons[n].l/2;
      //console.log(x+" "+step);

      navCtx.textBaseline="middle";
      navCtx.fillStyle="black";
      navCtx.font=controlsPx/3+"px akzi";
      navCtx.textAlign="center";
      navCtx.textBaseline="middle";
      for (var p=0; p<parts.length; p++){
        navCtx.fillText(parts[p], x,y+step*p);
        
        }
      }
    else{
      //console.log(navButtons[n].label+"Preload");
      var ref=document.getElementById(navButtons[n].label+"Preload");
      var pad=controlsPx/2-controlsPx*iconShrink/2;
      if(navButtons[n].selected){navCtx.globalAlpha=.5;}
      else{navCtx.globalAlpha=.75;}
      navCtx.drawImage(ref,navButtons[n].l+pad,navButtons[n].t+pad,controlsPx-pad*2,controlsPx-pad*2); 
      navCtx.globalAlpha=1;
      }
    }
  }
function updateColorsCanv(caller){
  colorsButtons=[];
  //dbuga('updateColorsCanv('+caller+')');
  console.log('updateColorsCanv('+caller+') initCompleted:'+initCompleted);
  if(initCompleted==false){return false;}

  colorsCanv.width=screenHeight;
  colorsCanv.height=controlsPx;
  colorsCanv.style.top="0px";
  var pad=controlsPx/2-controlsPx*iconShrink/2;
  
  var h=controlsPx;
  var colorsCtx=colorsCanv.getContext("2d");
  if(colorsUp){
    var grad = colorsCtx.createLinearGradient(0, h, 0, 0);
    grad.addColorStop(0, "rgba(225,225,225,.75)");
    grad.addColorStop(0.2, "rgba(225,225,225,.90)");
    grad.addColorStop(0.5, "rgba(255,255,255,.80)");
    grad.addColorStop(0.8, "rgba(255,255,255,.90)");
    grad.addColorStop(1, "rgba(255,255,255,.75)");
    colorsCtx.fillStyle=grad;
    colorsCtx.fillRect(0,0,screenHeight, h);
    if((carsUp)||(graphicsUp)){
      colorsCtx.globalAlpha=.5;
      }
    colorsButtons.push({"label":"camera", "t":0, "r":screenHeight-h, "b":controlsPx, "l":screenHeight-h*2});
    var ref=document.getElementById("cameraPreload");
    colorsCtx.drawImage(ref,screenHeight-h*2+pad,0, controlsPx-pad*2+pad, controlsPx-pad*2); 
    colorsCtx.globalAlpha=1;
//navCtx.drawImage(ref,navButtons[n].l+pad,navButtons[n].t+pad,controlsPx-pad*2,controlsPx-pad*2); 

    var colorLimit=-1;
    var selected=focusTrain;
    if(carsUp){
      colorLimit=4;
      selected=focusCars;
      }
    else{
      if(trainData.length==0){
        colorLimit=-1;
        }
      else{
        //colorLimit=levelData[levelBoxes[atLevel].num].fields.length;
        colorLimit=trainData.length;
        if(colorLimit==1){colorLimit=-1;}
        }
      }
    //dbuga('colorLimit='+colorLimit)
    for (var c=0; c<colorLimit; c++){
      colorsCtx.lineWidth=h/10;
      colorsCtx.fillStyle=rgbArray[c];
      colorsCtx.strokeStyle=rgbArray[c];
      colorsCtx.beginPath();
      colorsButtons.push({"label":"color_"+c, "t":0, "r":c*h+h, "b":h, "l":c*h});

      colorsCtx.arc(h/2+h*c, h/2, h/2.5-pad, 0, pi*2, true);
      if(c==selected){
        colorsCtx.fill();
        }
      colorsCtx.stroke();
      }

    var fontPx=h/2.5;
    colorsCtx.fillStyle="black";
    colorsCtx.font=fontPx+"px akzi";
    colorsCtx.textAlign="center";
    colorsCtx.textBaseline="middle";
    if(carsUp){
      colorsCtx.fillText("Select a car", screenHeight/2,h/4);
      colorsCtx.fillText("to repaint", screenHeight/2,3*h/4);
      }
    else if(graphicsUp){
      if(graphicsEditing){
        colorsCtx.fillText("Pinch to", screenHeight/2,h/4);
        colorsCtx.fillText("Pan and Zoom", screenHeight/2,3*h/4);
        }
      else{
        colorsCtx.fillText("Modify", screenHeight/2,h/4);
        colorsCtx.fillText("Boxcar", screenHeight/2,3*h/4);
        }
      }  
    else{
      colorsCtx.fillText("Drag to zoom", screenHeight/2,h/4);
      colorsCtx.fillText("Rotate to play", screenHeight/2,3*h/4);
      }  
    var ref=document.getElementById("hidePreload");
    colorsCtx.drawImage(ref,screenHeight-h,0, controlsPx, controlsPx); 
    }
  else{
    var ref=document.getElementById("showPreload");
    colorsCtx.globalAlpha=.5;
    colorsCtx.drawImage(ref,screenHeight-h,0, controlsPx, controlsPx); 
    colorsCtx.globalAlpha=.5;
    }
  colorsButtons.push({"label":"showHide", "t":0, "r":screenHeight, "b":h, "l":screenHeight-h});
  }
function handleEventDraw(e){
  if(e.touches.length>0){
    //dbuga("handleEventDraw(y:"+e.touches[0].pageY+", type:"+e.type+")");
    }
  else{
    //dbuga("handleEventDraw(type:"+e.type+")");
    }
  var typ = e.type;

  //dbuga("handleEventDraw:"+typ);
  attemptDraw=false;
  if ((typ == "touchstart")||(typ == "touchmove")){  
    target=e.touches[0].target.id;
    xydir=xydirFromTouch(e.touches[0]);
    }

  if (typ == "touchmove"){
    if (xydir.y>=cellsDown){
      // out of bounds
      typ="outofbounds";
      lastSquare="";
      lastDir="";
      startDir="";
      }
    }
  if (typ == "touchstart"){
    inSquare=xydir.x+" "+xydir.y;
    lastSquare=xydir.x+" "+xydir.y;
    squareX=xydir.x;
    squareY=xydir.y;
    startDir=xydir.dir
    }
  if ((typ == "touchmove")||(typ == "touchstart")){
    xyOn(xydir.x, xydir.y, xydir.dir, xydir.dist);
    }
  if(typ=="touchmove"){
    inSquare=xydir.x+" "+xydir.y;
    if (lastSquare != inSquare){

      //dbuga("<br> inSquare="+inSquare +" != lastSquare="+lastSquare+" ");
      //xyOff(squareX, squareY);
      if(startDir != lastDir){
        //dbuga(" startDir="+startDir +" != lastDir="+lastDir+" ");
        }
      attemptDraw=true;


      }
    else{
      //just moved within square
      lastDir=xydir.dir;
      squareX=xydir.x;
      squareY=xydir.y;
      lastDist=xydir.dist;
      cellType="none";

      hidePretracks();

      if((startDir=="t")&&(lastDir=="b")){cellType="tbPre";}
      if((startDir=="b")&&(lastDir=="t")){cellType="tbPre";}
      if((startDir=="l")&&(lastDir=="r")){cellType="lrPre";}
      if((startDir=="r")&&(lastDir=="l")){cellType="lrPre";}
      if((startDir=="t")&&(lastDir=="l")){cellType="tlPre";}//ccw
      if((startDir=="l")&&(lastDir=="t")){cellType="tlPre";}//cw
      if((startDir=="t")&&(lastDir=="r")){cellType="trPre";}//ccw
      if((startDir=="r")&&(lastDir=="t")){cellType="trPre";}//cw
      if((startDir=="b")&&(lastDir=="l")){cellType="blPre";}//ccw
      if((startDir=="l")&&(lastDir=="b")){cellType="blPre";}//cw
      if((startDir=="b")&&(lastDir=="r")){cellType="brPre";}//ccw
      if((startDir=="r")&&(lastDir=="b")){cellType="brPre";}//cw
      if(lastDist<centerSize){
        if(startDir=="r"){cellType="rPre";}
        if(startDir=="l"){cellType="lPre";}
        if(startDir=="t"){cellType="tPre";}
        if(startDir=="b"){cellType="bPre";}
        }
      if(cellType != "none"){
        document.getElementById(cellType).style.display="block";
        }
      }
    }
  if(typ=="touchend"){
    //dbuga("draw touchend")
    if(lastDir != startDir){
      // end having moved across square
      if (lastDist>centerSize){
        // but not ending in the center
        attemptDraw=true;
        }
      }
    }



  if(attemptDraw == true){
    attemptDrawTrack();
    }
  if (lastSquare != inSquare){
    if(typ=="touchmove"){
      lastSquare=inSquare;
      startDir=xydir.dir;
      lastDir="";
      }
    }
  if(typ=="touchend"){
    hidePretracks();
    if(squareY<cellsDown){
      xyOff(squareX, squareY);
      }
    lastSquare="";
    startDir="";
    lastDir="";
    inSquare="";
    }
  }

function attemptDrawTrack(){
  // DRAW TRACK!!!!
  targetCell="grid_"+squareX+"_"+squareY;
  //dbuga(" attemptDraw targetCell="+targetCell+" ");
  cellType="error";
  if((startDir=="t")&&(lastDir=="b")){cellType="tb";}
  if((startDir=="b")&&(lastDir=="t")){cellType="tb";}
  if((startDir=="l")&&(lastDir=="r")){cellType="lr";}
  if((startDir=="r")&&(lastDir=="l")){cellType="lr";}
  if((startDir=="t")&&(lastDir=="l")){cellType="tl";}//ccw
  if((startDir=="l")&&(lastDir=="t")){cellType="tl";}//cw
  if((startDir=="t")&&(lastDir=="r")){cellType="tr";}//ccw
  if((startDir=="r")&&(lastDir=="t")){cellType="tr";}//cw
  if((startDir=="b")&&(lastDir=="l")){cellType="bl";}//ccw
  if((startDir=="l")&&(lastDir=="b")){cellType="bl";}//cw
  if((startDir=="b")&&(lastDir=="r")){cellType="br";}//ccw
  if((startDir=="r")&&(lastDir=="b")){cellType="br";}//cw
  
  if (isTiled(squareX, squareY)==true){cellType="error";}// can't track on a tiled cell
//dbug("isTiled("+squareX+", "+squareY+")="+isTiled(squareX, squareY));
  // source hookups pass at this point... 
  if (cellType != "error"){
    passSourceTests=true;
    var dirsArray=cellType.split("");
    for (d=0; d<2; d++){
      thisDir=dirsArray[d];
      tX=Number(squareX)+Number(xDeltaByDir[thisDir]);
      tY=Number(squareY)+Number(yDeltaByDir[thisDir]);
      if ((isSourceInDir(tX, tY, thisDir)==false)&&(isTiled(tX, tY)==true)){
        passSourceTests=false;
        }
      }
    if (passSourceTests == false){
      cellType="error";
      }
    }
   //dbuga(" cellType="+cellType);
  if (cellType != "error"){
    // test cell for extant track
    //var cn=document.getElementById(targetCell).childNodes;
    cn=tilesByGridXY[targetCell];
    cnl=cn.length;
    tracksGlom="|";
    for (n=0; n<cnl; n++){
      //thisClass=cn[n].className;
      thisClass=cn[n];
      tracksGlom+=thisClass+"|";
      }
    if (tracksGlom.indexOf(cellType)==-1){
      fullCellGlom+="grid_"+squareX+"_"+squareY;
      createTrack(cellType, targetCell);
      createCanvasTrack(cellType, squareX, squareY);
      buildSequence.push(new buildObject("track", "", cellType, squareX, squareY, 0));
      //playSound("laytrack");
      lastLastDir=lastDir;
      ////lastDir="";// try to fix pretack
      hidePretracks();
      } 
    }
  if(navButtons[4].label != ""){
    navButtons[4].label="";
    updateNavCanv();
    }
  }
var pretrackArray=new Array("blPre","brPre","tlPre","trPre","lrPre","tbPre","tPre","bPre","lPre","rPre");
function hidePretracks(){
  for (p=0; p<pretrackArray.length; p++){
    pId=pretrackArray[p];
    document.getElementById(pId).style.display="none";
    }
  }

//functions that examine the board state



function isSourceInDir(xx,yy,d){
  useD=reverseObject[d];
  cellIsSource=false;
  if((xx>-1)&&(xx<cellsAcross)&&(yy>-1)&&(yy<cellsDown)){
    testCell="grid_"+xx+"_"+yy;
    //var cn=document.getElementById(testCell).childNodes;
    var cn=tilesByGridXY[testCell];
    for (n=0; n<cn.length; n++){
      //thisClass=cn[n].className;
      thisClass=cn[n];
      if ((thisClass==useD+"s")||(thisClass==useD+"d")){
        cellIsSource=true;
        }
      }
    }
  return cellIsSource;
  }
function isTiled(x,y){
  tiled=false;
  if((x<0)||(x>=cellsAcross)||(y<0)||(y>=cellsDown)||(isNaN(x))||(Object.keys(tilesByGridXY).length==0)){
    //out of bounds, call it tiled
    //dbuga('<br>out of bounds, call it tiled'+x+" "+y);
 
    tiled=true;
    }
  else{
    testCell2="grid_"+x+"_"+y;
    //var cn=document.getElementById(testCell2).childNodes;
    var cn=tilesByGridXY[testCell2];
    for (n=0; n<cn.length; n++){
      //thisClass=cn[n].className;
      thisClass=cn[n];
      //if ((thisClass.indexOf('source')>-1)||(thisClass.indexOf('dest')>-1)){
      if (thisClass.indexOf('tile')>-1){
        tiled=true;
        }
      }
    }
  return tiled;
  }

function openAdjacentCellsArray(x, y, excludeCell){
  var openArray=new Array();
  var returnArray=new Array();
  xMinus=x-1;
  xPlus=x+1;
  yMinus=y-1;
  yPlus=y+1;

  if (isTiled(xMinus, y)==false){
    if(excludeCell != "grid_"+xMinus+"_"+y){
      openArray.push("grid_"+xMinus+"_"+y);
      }
    }
  if (isTiled(xPlus, y)==false){
    if(excludeCell != "grid_"+xPlus+"_"+y){
      openArray.push("grid_"+xPlus+"_"+y);
      }
    }
  if (isTiled(x, yPlus)==false){
    if(excludeCell != "grid_"+x+"_"+yPlus){
      openArray.push("grid_"+x+"_"+yPlus);
      }
    }
  if (isTiled(x, yMinus)==false){
    if(excludeCell != "grid_"+x+"_"+yMinus){
      openArray.push("grid_"+x+"_"+yMinus);
      }
    }
  if(openArray.length==3){
    excludeNum=Math.floor(Math.random()*3);
    }
  else{
    excludeNum=4;
    }
  for (o=0; o<openArray.length; o++){
    if(o != excludeNum){
      returnArray.push(openArray[o]);
      }
    }
  return returnArray;
  }
function processTransPanel(){
  var c=document.getElementById("myCanvas");
  var ctx=c.getContext("2d");
  var imgData=ctx.createImageData(100,100);
  for (var i=0;i<imgData.data.length;i+=4)
    {
    imgData.data[i+0]=255;
    imgData.data[i+1]=0;
    imgData.data[i+2]=0;
    imgData.data[i+3]=255;
    }
  ctx.putImageData(imgData,10,10);
  }
// done.js

var atImage=0;
var atFolder=0;
var imageIdArray=["boxside","boxtop","boxend", "enginefloor", "engineroof", "enginenose", "enginecab", "enginestarinner", "enginestarouter", "engineportinner", "engineportouter"];
var folderArray=["source","trans","grey","green","blue","orange","black"];
var imgRefs={};
var colorArray=["black","orange","blue","green"];
var rgbValArray=[[30,30,30],[218,37,28],[0,91,161],[63,179,160]];
var rgbArray=["rgb(30,30,30)","rgb(218,37,28)","rgb(0,91,161)","rgb(63,179,160)"];

var graphicsByColor={};
function initGraphicsByColor(){
  var atDefault=0;
  for (var c=0; c<colorArray.length; c++){
    var color=colorArray[c];
    graphicsByColor[color]=[];
    var x=0; 
    var y=0;
    for (var i=0; i<graphicsPerColor; i++){
      var imageObj={
        "imageId":"default"+atDefault,
        "blackTrans":isMobile,
        "x":x,
        "y":y        
        }
      graphicsByColor[color].push(imageObj);
      atDefault++;
      x++;
      if(x>2){
        x=0;
        y++;
        }
      }
    }
  }

/*
var graphicsByColor={
  "black":[{"imageId":"default0", "blackTrans":true},{"imageId":"default1", "blackTrans":true},{"imageId":"default2", "blackTrans":true}],
  "orange":[{"imageId":"default3", "blackTrans":true},{"imageId":"default4", "blackTrans":true},{"imageId":"default5", "blackTrans":true}],
  "blue":[{"imageId":"default6", "blackTrans":true},{"imageId":"default7", "blackTrans":false},{"imageId":"default8", "blackTrans":true}],
  "green":[{"imageId":"default9", "blackTrans":false},{"imageId":"default10", "blackTrans":false},{"imageId":"default11", "blackTrans":true}]
}
*/
var atColor=0;
var atGraphic=0;
var loadMs=10;
function preloadTick(){
  if(atImage<imageIdArray.length){
    var imageId=imageIdArray[atImage]+folderArray[atFolder];
    imgRefs[imageId]=document.getElementById(imageId);

    atFolder++;
    if(atFolder>=folderArray.length){
      //dbuga(' ! ' +atFolder +'>='+folderArray.length);
      atFolder=0;
      atImage++;
    }
    updateLoading();
    window.setTimeout('preloadTick()', loadMs);
  }
  else{
    graphicsTick();
  }
}

function graphicsTick(){
  //dbug("graphicsTick "+atGraphic);

  var color;
  if(atColor<colorArray.length){
    color=colorArray[atColor];
    ////
    processGraphic(atColor, atGraphic, false, false);
    ////
    atGraphic++;
    if(atGraphic>=graphicsByColor[color].length){
      atGraphic=0;
      atColor++;
      }
    updateLoading();
    window.setTimeout('graphicsTick()',loadMs);
    }
  else{// finished last color so resume
    resumeInit();
    }
  }

function updateLoading(){
  var totalGraphics=graphicsPerColor*4;
  var completedGraphics=graphicsPerColor*atColor+atGraphic;

  var totalImages=imageIdArray.length*folderArray.length;
  var completedImages=atFolder+folderArray.length*atImage;
  var total=totalImages+totalGraphics;
  var completed=completedImages+completedGraphics;
  //dbug(completed+' / '+total);
  //dbuga('images: '+completedImages+' / '+totalImages);
  var frac=completed/total;
  //var frac=completedImages/totalImages;
  //var frac=completedGraphics/totalGraphics;
  var perc=Math.floor(frac*100);
  var loadingPx=screenWidth/6;
  var canv=document.getElementById('loadingCanvas');
  var ctx=canv.getContext('2d');
  canv.width=loadingPx;
  canv.style.zIndex=4;
  var linePx=loadingPx/12;
  ctx.lineWidth=linePx;
  ctx.strokeStyle="rgb(100,100,100)";
  ctx.fillStyle="rgb(200,200,200)";
  ctx.beginPath();
  ctx.arc(loadingPx/2, loadingPx/2, loadingPx/2-linePx*1.5, 0, pi*2);
  ctx.closePath();
  ctx.fill();
  ctx.beginPath();
  ctx.arc(loadingPx/2, loadingPx/2, loadingPx/2-linePx*2.0, pi*1.5, pi*(1.5+2*frac));
  ctx.stroke();
  ctx.font=loadingPx/5+"px akzi";
  ctx.fillStyle="rgb(100,100,100)";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  ctx.fillText(perc+"%", loadingPx/2, loadingPx/2);
  }

function processGraphic(colorNum, graphicNum, blacken, cache){
  var color=colorArray[colorNum];
  
  var imageId= graphicsByColor[color][graphicNum].imageId;
  var cached=false;
  var keys=Object.keys(localStorage);
  for (var k=0; k<keys.length; k++){
    if(keys[k]==imageId){
      //dbuga('FOUND! processGraphic('+colorNum+', '+graphicNum+')'+imageId);
      cached=true;
      }
    }
  if(cache){cached=false;}// new image doesn't pull in local storage
  var blackTrans= graphicsByColor[color][graphicNum].blackTrans;
  if(blacken){
    imageId="defaultblack";
    blackTrans=true;
    cached=false;
    }
  if(cached){// use img default ref //data:image/jpeg;base64,
    document.getElementById(imageId).src="" +localStorage.getItem(imageId);
    }
  //dbuga("processGraphic "+colorNum+", "+graphicNum+" blackTrans="+blackTrans);
  var alphaSourceRef=imgRefs['boxsidesource'];
  var alphaRef=returnCanvas(alphaSourceRef.width, alphaSourceRef.height);
  imageCanvas(alphaRef, alphaSourceRef);
  var textureSourceRef=imgRefs['boxsidetrans'];
  var textureRef=returnCanvas(textureSourceRef.width, textureSourceRef.height);
  transifyCanvas(textureRef, textureSourceRef);

  graphicsByColor[color][graphicNum].blackTrans=blackTrans;
  if(blackTrans==false){
    //make flat
    var flatSourceRef=document.getElementById(imageId);
    var flatRef=returnCanvas(textureSourceRef.width, textureSourceRef.height);
    placeWithin(flatRef, flatSourceRef); 
    var flatOutputRef=returnCanvas(textureSourceRef.width, textureSourceRef.height);
    colorizeCanvas(flatOutputRef, textureRef, alphaRef, [127,127,127]);
    overlayCanvas(flatOutputRef, flatRef);
    graphicsByColor[color][graphicNum].ref= flatOutputRef;
    }
  else{
    //make logo source
    var logoSourceRef=document.getElementById(imageId);
    var logoRef=returnCanvas(textureSourceRef.width, textureSourceRef.height);
    //document.body.appendChild(logoRef);
    placeWithin(logoRef, logoSourceRef);
     
    //make texture logo
    var logoTextureRef=returnCanvas(textureSourceRef.width, textureSourceRef.height);
    colorizeCanvas(logoTextureRef, textureRef, alphaRef, [127,127,127]);
    overlayCanvas(logoTextureRef, logoRef);
    trimBox(logoTextureRef);  
    blackToTrans(logoTextureRef);
    graphicsByColor[color][graphicNum].ref= logoTextureRef;

    if(blacken){
      var dataURL = logoTextureRef.toDataURL('image/jpeg');
      var imageId= graphicsByColor[color][graphicNum].imageId;
      //dbuga('process blacken '+imageId);
      localStorage.setItem(imageId, dataURL);
      }
    }
  }


function trimBox(canv){
  var g=Math.floor(canv.width/24);
  var ctx=canv.getContext('2d');
  ctx.clearRect(0,0,g*24,g);
  ctx.clearRect(0,0,g,g*8);
  ctx.clearRect(0,g*7,g*24,g);
  ctx.clearRect(g*23,0,g,g*8);
  //dbuga(g);
  }
function returnCanvas(w,h){
  var canvas=document.createElement("canvas");
  canvas.width = w;
  canvas.height = h;
  return canvas;
  }
function transifyCanvas(transCanvas, sourceRef){
  return false;////

  var transCtx = transCanvas.getContext("2d");

  transCtx.drawImage(sourceRef, 0, 0);
  var image = transCtx.getImageData(0, 0, sourceRef.width, sourceRef.height);
  var imageData = image.data
  var length = imageData.length;
  var mostSatPixel=-1;
  var mostSatFrac=0;
  var mostSatAvg=0;
  var leastSatPixel=-1;
  var leastSatFrac=1;
  var leastSatAvg=0;

  for(var i=0; i < length; i+=4){
    var r=imageData[i];
    var g=imageData[i+1];
    var b=imageData[i+2];
    var a=imageData[i+3];
    var avg=(r+g+b)/3;
    var rg=Math.abs(r-g);
    var gb=Math.abs(g-b);
    var br=Math.abs(b-r);
    var sat=(rg+gb+br)/510; // 0-1
    if(sat>mostSatFrac){
      mostSatPixel=i;
      mostSatFrac=sat;
      mostSatAvg=avg;
    }
    if(sat<leastSatFrac){
      leastSatPixel=i;
      leastSatFrac=sat;
      leastSatAvg=avg;
    }
  }

  for(var i=0; i < length; i+=4){
    var r=imageData[i];
    var g=imageData[i+1];
    var b=imageData[i+2];
    var a=imageData[i+3];
    var avg=(r+g+b)/3;
    var rg=Math.abs(r-g);
    var gb=Math.abs(g-b);
    var br=Math.abs(b-r);
    var sat=(rg+gb+br)/510; // 0-1

    var alpha=a-((sat)*(255));
    if(alpha<0){alpha=0;}
    avg=Math.floor((avg+0)/1);
    imageData[i]=avg;
    imageData[i+1]=avg;
    imageData[i+2]=avg;
    imageData[i+3]=Math.floor(alpha);

  }
  image.data = imageData;
  transCtx.putImageData(image, 0, 0);
}
function blackToTrans(transCanvas){
  var transCtx = transCanvas.getContext("2d");
  var image = transCtx.getImageData(0, 0, transCanvas.width, transCanvas.height);
  var imageData = image.data
  var length = imageData.length;


  var transStart=72;
  var transLimit=64;

  var transRange=transStart-transLimit;
  for(var i=0; i < length; i+=4){
    var r=imageData[i];
    var g=imageData[i+1];
    var b=imageData[i+2];
    var a=imageData[i+3];
    var avg=(r+g+b)/3;

    var rg=Math.abs(r-g);
    var gb=Math.abs(g-b);
    var br=Math.abs(b-r);
    var sat=(rg+gb+br)/510; // 0-1
    var alpha=Math.floor((avg-transLimit)*transRange);
    
    if(alpha<0){alpha=0;}
    if(alpha>255){alpha=255;}
    else{
      imageData[i+3]=Math.floor(alpha);
      }
    }
  image.data = imageData;
  transCtx.putImageData(image, 0, 0);
  }

function colorizeCanvas(colorizedCanvas, transRef, shapeRef, rgb){
  return false;////

  var r=rgb[0];
  var g=rgb[1];
  var b=rgb[2];

  var colorizedCtx=colorizedCanvas.getContext('2d');
  colorizedCtx.drawImage(transRef, 0, 0);

  var transCtx=transRef.getContext('2d');
  var shapeCtx=shapeRef.getContext('2d');
  
  var image = colorizedCtx.getImageData(0, 0, transRef.width, transRef.height);
  var shape = shapeCtx.getImageData(0, 0, transRef.width, transRef.height);
  var shapeData = shape.data
  var imageData = image.data
  var length = imageData.length;

  for(var i=0; i < length; i+=4){
    var a=shapeData[i+3];
    if(a>10){
      imageData[i]=r;
      imageData[i+1]=g;
      imageData[i+2]=b;
      imageData[i+3]=255;
    }
    else{
      imageData[i]=r;
      imageData[i+1]=g;
      imageData[i+2]=b;
      imageData[i+3]=Math.floor(255*a/4);
    }
  }
  image.data = imageData;
  colorizedCtx.putImageData(image, 0, 0);
  colorizedCtx.drawImage(transRef, 0, 0);
}
function imageCanvas(canvasRef, imageRef){
  var ctx=canvasRef.getContext("2d");
  ctx.drawImage(imageRef, 0, 0);
  } 
function overlayCanvas(canvasRef, imageRef){
  var ctx=canvasRef.getContext("2d");
  ctx.globalCompositeOperation = "overlay";
  ctx.drawImage(imageRef, 0, 0);
  } 
function multiplyCanvas(canvasRef, imageRef){
  var ctx=canvasRef.getContext("2d");
  ctx.globalCompositeOperation = "multiply";
  ctx.drawImage(imageRef, 0, 0);
  } 
function placeWithin(canvasRef, imageRef){
  var g= canvasRef.width/24;
  var ctx=canvasRef.getContext("2d");
  ctx.drawImage(imageRef, g,g, g*22,g*6);
  } 




// chromaris switches
//toggleSwitch(4,4,"horizontal",0, ["a","b","c"], "alphabet");
var len=2;
var slot=1.5;
function settingsDraw(){
  var canv=document.getElementById('settingsCanvas');
  canv.width=canv.width;
  settingsCanv.style.zIndex=1;
  var keys=Object.keys(settingsObject);
  var g=(screenHeight-controlsPx-controlsPx)/(keys.length*4+4);// availHeight/18
  var cx=.5*screenWidth/g;
  var cy=((screenHeight-controlsPx-controlsPx)/2-screenWidth/2)/g+cx;
  //dbuga("cy="+cy+" g="+g);

  var ctx=canv.getContext('2d');
  //ctx.lineWidth=4;
  //ctx.strokeStyle="blue";
  //ctx.strokeRect(0,g*(cy-halfHeight),g*18, g*24);// 3/4 aspect fitted

  for (var k=0; k<keys.length; k++){
    var y=(k-2.25)*4;
    toggleSwitch(g, cx, cy, 0,y,"horizontal",settingsObject[keys[k]]['pos'], settingsObject[keys[k]]['values'], keys[k]);
    x0=cx;
    y0=cy+y;


    //ctx.strokeRect(g*(x0-2), g*(y0-2),g*4,g*4);
    settingsObject[keys[k]]["t"]=g*(y0-2);
    settingsObject[keys[k]]["r"]=g*(x0+2);
    settingsObject[keys[k]]["b"]=g*(y0+2);
    settingsObject[keys[k]]["l"]=g*(x0-2);
    }
  populateSettings();
  drawSettingsButtons();
  ctx.font=g/1.5+"px akzi";
  ctx.fillStyle="#333";
  ctx.textAlign="center";
  ctx.fillText("AVERAGE FPS: "+avgFps,g*cx, g*22);
  
  }
     
function toggleSwitch(g, cx,cy, x0,y0,orient,pos, tics, label){//returns path


  x0+=cx;
  y0+=cy;



  var canv=document.getElementById('settingsCanvas');
  var ctx=canv.getContext('2d');

  ctx.clearRect(g*(x0-2), g*(y0-2),g*4,g*4);

  ctx.strokeStyle="#444";
  if(orient=="vertical"){x0--;}


  ctx.fillStyle="#444";
  
  if(orient=="horizontal"){
    var min=(x0-len)*g;
    var max=(x0+len)*g;
    
    var range=max-min;
    var step=range/(tics.length-1);
   
    ctx.strokeStyle="#444";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
 
    ctx.font=g/1.5+"px akzi";
    for (var t=0; t<tics.length; t++){
      ctx.fillText(tics[t], min+t*step, y0*g+g*1.25);
      }
    ctx.font=g/1.5+"px akziBold";
    ctx.fillText(label, x0*g,y0*g-g*1.25);
    }
  else{
    var min=(y0-slot)*g;
    var max=(y0+slot)*g;

    var range=max-min;
    var step=range/(tics.length-1);
    ctx.font=g/1.5+"px akzi";
    ctx.strokeStyle="#444";
    ctx.textAlign="left";
    ctx.textBaseline="middle";
 
    ctx.fillText(label, x0*g-g*.5 ,y0*g+g*2);
    for (var t=0; t<tics.length; t++){
      ctx.fillText(tics[t], x0*g+g*1, min+t*step);
      }
    }


  ctx.beginPath();
  var x1;
  var y1;
  if(orient=="horizontal"){
    x1=x0+len*pos;
    y1=y0;
    ctx.arc((x0-slot)*g,(y0)*g, 2+g/2,pi*.5,pi*1.5,false);
    ctx.arc((x0+slot)*g,(y0)*g, 2+g/2,pi*1.5,pi*.5,false);
    }
  else{
    x1=x0;
    y1=y0+len*pos;
    ctx.arc((x0)*g,(y0-slot)*g, 2+g/2,pi*1,pi*0,false);
    ctx.arc((x0)*g,(y0+slot)*g, 2+g/2,pi*0,pi*1,false);
    }
  
  ctx.closePath();
  ctx.fill();

  var x1;
  var y1;
  if(orient=="horizontal"){
    x1=x0+len*pos;
    y1=y0;
    }
  else{
    x1=x0;
    y1=y0+len*pos;
    }
  var x2=x0;
  var y2=y0;  
  if(orient=="horizontal"){
    x2+=len*pos/2;
    }
  else{
    y2+=len*pos/2;
    }


  ctx.lineWidth=2;

  ctx.strokeStyle="#666";

  var p=.01;
  // px py is slight perspective offset
  var px=(cx-x1)*p;
  var py=(cy-y1)*p;
  var dx=(x0-x1+px);
  var dy=(y0-y1+py);
  var dist=Math.sqrt(dx*dx+dy*dy);
  var squeeze=1-dist/(len*2);
  var vec=Math.atan2(-dy, -dx);
  var deg=(360+Math.floor(180*vec/pi))%360;
  var mx1=x0-dx;
  var my1=y0-dy;
  ctx.beginPath();
  //ctx.arc(mx1*g,my1*g,g/2,vec-pi*1.5,vec-pi*.5,true);
  oval(ctx, mx1*g,my1*g,g/2,squeeze*g/2,vec+pi/2,true)
  ctx.arc(x2*g,y2*g,g/2,vec+pi*1.5,vec+pi*.5,true);
  ctx.closePath();
  var bgColor={"r":200, "g":200, "b":200};
  ctx.fillStyle="rgb("+ bgColor.r +","+bgColor.g+","+bgColor.b+")";
  ctx.fill();
  ctx.stroke();
  ctx.beginPath();
  oval(ctx,mx1*g,my1*g,g/2,squeeze*g/2,vec+pi/2,false);
  ctx.stroke();
  
  }
function oval(ctx, x,y,r0,r1,radians,counter){
  
  var x0=x+r0*Math.cos(radians);
  var y0=y+r0*Math.sin(radians);
  var x1=x+r1*Math.cos(radians+pi/2);
  var y1=y+r1*Math.sin(radians+pi/2);
  var x2=x+r0*Math.cos(radians+pi);
  var y2=y+r0*Math.sin(radians+pi);
  var x3=x+r1*Math.cos(radians-pi/2);
  var y3=y+r1*Math.sin(radians-pi/2);
  var cpx1=x2+r1*Math.cos(radians+pi/2);
  var cpy1=y2+r1*Math.sin(radians+pi/2);
  var cpx0=x0+r1*Math.cos(radians+pi/2);
  var cpy0=y0+r1*Math.sin(radians+pi/2);
  var cpx2=x2+r1*Math.cos(radians-pi/2);
  var cpy2=y2+r1*Math.sin(radians-pi/2);
  var cpx3=x0+r1*Math.cos(radians-pi/2);
  var cpy3=y0+r1*Math.sin(radians-pi/2);
  //plot(x0,y0,"black");
  ctx.beginPath();
  if(counter){
    //plot(cpx3,cpy3,"rgba(255,255,0,1)");
    //plot(cpx2,cpy2,"rgba(0,0,255,1)");
    ctx.moveTo(x0,y0);
    ctx.quadraticCurveTo(cpx3,cpy3,x3,y3);
    ctx.quadraticCurveTo(cpx2,cpy2,x2,y2);
    }
  else{
    //plot(cpx1,cpy1,"rgba(255,0,0,1)");
    //plot(cpx0,cpy0,"rgba(0,255,0,1)");
    ctx.moveTo(x0,y0);
    ctx.quadraticCurveTo(cpx0,cpy0,x1,y1);
    ctx.quadraticCurveTo(cpx1,cpy1,x2,y2);
    }
  ctx.stroke();
  //moveTo beginning
  //bez to perp
  //bez to end 
  }

//util.js 
function bez(ctx,x0,y0,deg0,dist0,x1,y1,deg1,dist1){
  var cp0x=x0+dist0*Math.cos(deg0/180 * Math.PI);
  var cp0y=y0+dist0*Math.sin(deg0/180 * Math.PI);
  var cp1x=x1-dist1*Math.cos(deg1/180 * Math.PI);
  var cp1y=y1-dist1*Math.sin(deg1/ 180 * Math.PI);
  ctx.bezierCurveTo(cp0x, cp0y, cp1x,cp1y, x1,y1);
}


function GetOffset (object, offset) {
            if (!object)
                return;
            offset.x += object.offsetLeft;
            offset.y += object.offsetTop;

            GetOffset (object.offsetParent, offset);
        }
function GetScrolled (object, scrolled) {
            if (!object)
                return;
            scrolled.x += object.scrollLeft;
            scrolled.y += object.scrollTop;

    if (object.tagName.toLowerCase () != "html") {
        GetScrolled (object.parentNode, scrolled);
    }
  }
function urlDecode(str) {
  return decodeURIComponent((str+'').replace(/\+/g, '%20'));
  }
function solveAngle(a, b, c) {  // Returns angle C using law of cosines
  var temp = (a * a + b * b - c * c) / (2 * a * b);
  if (temp >= -1 && temp <= 1){return radToDeg(Math.acos(temp));}
  else{return "No solution";}
  }
function degToRad(x) {
	return x / 180 * Math.PI;
}

function radToDeg(x) {
	return x / Math.PI * 180;
}
function rnd(range) {
  return Math.floor(Math.random()*range);
  }
var helps=[
  {"heading":"Railroad Train", "body":"by Jambots.com", "img":"helps0Preload", "buttonLabel":""},
  {"heading":"How to Play", "body":"Choose a level.<br>Draw a loop past the fields and silos. Connect the fields and silos to the loop to pick up and drop off cars. <br>Get all the cars into the silos to win!", "img":"helps1Preload",  "buttonLabel":""},
  {"heading":"Drawing Tracks", "body":"Tracks are placed by dragging across a tile from one edge to another.<br>Keep dragging to draw continuous tracks.<br>Guide marks indicate valid track positions.", "img":"helps2Preload",  "buttonLabel":""},
  {"heading":"Cinematic Mode", "body":"Orient your device to landscape and watch your game progress.<br>Colored circles change the view. Drag to pan and zoom.", "img":"helps3Preload",  "buttonLabel":""},
  {"heading":"Modify Cars", "body":"In Cinematic mode select the camera icon to modify the car graphics.<br>Select a color and tap a car to modify.<br>Use the Camera button to take and add pictures to cars. Be sure to keep your device oriented landscape. Pinch to scale and position then Save.<br>Dark areas become transparent when the checkbox is checked.", "img":"helps4Preload",  "buttonLabel":""},
  {"heading":"Settings", "body":"Levels of differing complexity will be available depending on the Scale setting and your device's screen size.<br>The largest scale, O, is much easier to draw tracks and simpler to solve. The smallest scale, N, gives you the most track space and complexity but it can be difficult to draw accurately without a stylus.<br>Lower Detail settings can improve frame rate. When the frame rate drops new cars will not spawn.", "img":"helps5Preload",  "buttonLabel":""},
  {"heading":"Strategy Guide", "body":"Start all the trains moving in the same direction.<br>Trains will follow branches randomly and may miss the silo sometimes.<br>Remember to draw track back into silos to drop off cars.<br>Watch videos about Railroad Train on the jambots.com website.<br>CLICK HERE", "img":"",  "buttonLabel":"www"}
  ];
var atHelp=0;
var maxHelp=helps.length-1;

</script>
</head>
<body onload="init()" ontouchstart="event.preventDefault(); touchStart(event);" ontouchmove="event.preventDefault(); touchMove(event);" ontouchend="event.preventDefault(); touchEnd(event);" ontouchcancel="touchCancel(event);" style="background-color:#fff; width:100%; height:100%;">
<div id="wrapper" style="display:block; position:absolute; top:0px; left:100px; overflow:hidden; Zbackground-color:white;">
  <div id="highlighter"></div>
  <div id="prerails">
    <div id="blPre" class="bl" style="display:none;"><div class="blInner blueBorder"></div><div class="blOuter blueBorder"></div></div>
    <div id="brPre" class="br" style="display:none;"><div class="brInner blueBorder"></div><div class="brOuter blueBorder"></div></div>
    <div id="tlPre" class="tl" style="display:none;"><div class="tlInner blueBorder"></div><div class="tlOuter blueBorder"></div></div>
    <div id="trPre" class="tr" style="display:none;"><div class="trInner blueBorder"></div><div class="trOuter blueBorder"></div></div>
    <div id="lrPre" class="lr" style="display:none;"><div class="lrTop blueBorder"></div><div class="lrBottom blueBorder"></div></div>
    <div id="tbPre" class="tb" style="display:none;"><div class="tbLeft blueBorder"></div><div class="tbRight blueBorder"></div></div>

    <div id="tPre" class="ts" style="display:none;"><div class="tLeft blueBorder"></div><div class="tRight blueBorder"></div></div>
    <div id="bPre" class="bs" style="display:none;"><div class="bLeft blueBorder"></div><div class="bRight blueBorder"></div></div>
    <div id="lPre" class="ls" style="display:none;"><div class="lTop blueBorder"></div><div class="lBottom blueBorder"></div></div>
    <div id="rPre" class="rs" style="display:none;"><div class="rTop blueBorder"></div><div class="rBottom blueBorder"></div></div>
  </div>

  <div id="cameraDiv">
    <div id="zoomDiv">
      <div id="tableDiv">
<div id="fieldHolder"  style="background-color:yellow;"></div>
<div id="canvasHolder" style="background-color:yellow;"	></div>
<div id="trainHolder" ></div>
      </div>
    </div>
  </div>


  <div id="progressHolder" class="">
    <div id="progressDiv" >  
      <div id="blackProgressDiv" class="darkblack grow" ></div>
      <div id="orangeProgressDiv" class="darkorange grow" ></div>
      <div id="blueProgressDiv" class="darkblue grow" ></div>
      <div id="greenProgressDiv" class="darkgreen grow" ></div>
    </div>
  </div>

</div>
<canvas id="colorsCanvas" style="position:absolute;"></canvas>
<canvas id="navCanvas" style="position:absolute;"></canvas>
<canvas id="levelsCanvas" style="position:absolute;"></canvas>
<canvas id="settingsCanvas" style="position:absolute;"></canvas>
<canvas id="carsCanvas" style="position:absolute;"></canvas>
<canvas id="graphicsCanvas" style="position:absolute;"></canvas>
<canvas id="cameraCanvas" style="position:absolute;" width="100" height="100"></canvas>
<canvas id="helpCanvas" style="position:absolute;"></canvas>
<canvas id="compCanvas" style="position:absolute;"></canvas>
<canvas id="loadingCanvas"></canvas>

<div id="debugDiv" style="display:none; position:absolute; top:150px; left:10px; font-size:16px; width:750px; z-index:3; background-color:rgba(255,255,255,.5);"></div>

<div id="sources" style="display:none;">
  <div id="tiledestblue" class="tiledestblue"></div>
  <div id="tiledestblack" class="tiledestblack"></div>
  <div id="tiledestorange" class="tiledestorange"></div>
  <div id="tiledestgreen" class="tiledestgreen"></div>
  <div id="tilesourceblue" class="tilesourceblue"><div class="dot blue dot1"></div><div class="dot blue dot2"></div><div class="dot blue dot3"></div><div class="dot blue dot4"></div><div class="dot blue dot5"></div></div>
  <div id="tilesourceblack" class="tilesourceblack"><div class="dot black dot1"></div><div class="dot black dot2"></div><div class="dot black dot3"></div><div class="dot black dot4"></div><div class="dot black dot5"></div></div>
  <div id="tilesourceorange" class="tilesourceorange"><div class="dot orange dot1"></div><div class="dot orange dot2"></div><div class="dot orange dot3"></div><div class="dot orange dot4"></div><div class="dot orange dot5"></div></div>
  <div id="tilesourcegreen" class="tilesourcegreen"><div class="dot green dot1"></div><div class="dot green dot2"></div><div class="dot green dot3"></div><div class="dot green dot4"></div><div class="dot green dot5"></div></div>

</div>

  <div id="preload" >
<img id="cameraImg" src="default/default2.jpg" />
<img src="helps/helps0.png" id="helps0Preload"   style="display:none;" />
<img src="helps/helps1.png" id="helps1Preload"   style="display:none;" />
<img src="helps/helps2.png" id="helps2Preload"   style="display:none;" />
<img src="helps/helps3.png" id="helps3Preload"   style="display:none;" />
<img src="helps/helps4.png" id="helps4Preload"   style="display:none;" />
<img src="helps/helps5.png" id="helps5Preload"   style="display:none;" />
<img src="trainicons/checked.png" id="checkedPreload"   style="display:none;" />
<img src="trainicons/unchecked.png" id="uncheckedPreload"   style="display:none;" />
<img src="trainicons/camera.png" id="cameraPreload"   style="display:none;" />
<img src="trainicons/hide.png" id="hidePreload"   style="display:none;" />
<img src="trainicons/levels.png" id="levelsPreload"   style="display:none;" />
<img src="trainicons/reset.png" id="resetPreload"   style="display:none;" />
<img src="trainicons/settings.png" id="settingsPreload"   style="display:none;" />
<img src="trainicons/show.png" id="showPreload"   style="display:none;" />
<img src="trainicons/undo.png" id="undoPreload"   style="display:none;" />
<img src="default/black.jpg" id="defaultblack"   style="display:none;" />
<img src="fakegraphics/21a.png" id="default0"   style="display:none;" />
<img src="fakegraphics/26a.png" id="default1"   style="display:none;" />
<img src="fakegraphics/2a.png" id="default2"   style="display:none;" />
<img src="fakegraphics/3a.png" id="default3"   style="display:none;" />
<img src="fakegraphics/4a.png" id="default4"   style="display:none;" />
<img src="fakegraphics/5a.png" id="default5"   style="display:none;" />
<img src="fakegraphics/6a.png" id="default6"   style="display:none;" />
<img src="fakegraphics/7a.png" id="default7"   style="display:none;" />
<img src="fakegraphics/8a.png" id="default8"   style="display:none;" />
<img src="fakegraphics/9a.png" id="default9"   style="display:none;" />
<img src="fakegraphics/10a.png" id="default10"   style="display:none;" />
<img src="fakegraphics/11a.png" id="default11"   style="display:none;" />
<img src="fakegraphics/12a.png" id="default12"   style="display:none;" />
<img src="fakegraphics/13a.png" id="default13"   style="display:none;" />
<img src="fakegraphics/14a.png" id="default14"   style="display:none;" />
<img src="fakegraphics/15a.png" id="default15"   style="display:none;" />
<img src="fakegraphics/16a.png" id="default16"   style="display:none;" />
<img src="fakegraphics/17a.png" id="default17"   style="display:none;" />
<img src="fakegraphics/18a.png" id="default18"   style="display:none;" />
<img src="fakegraphics/19a.png" id="default19"   style="display:none;" />
<img src="fakegraphics/20a.png" id="default20"   style="display:none;" />
<img src="fakegraphics/0a.png" id="default21"   style="display:none;" />
<img src="fakegraphics/22a.png" id="default22"   style="display:none;" />
<img src="fakegraphics/23a.png" id="default23"   style="display:none;" />
<img src="fakegraphics/24a.png" id="default24"   style="display:none;" />
<img src="fakegraphics/25a.png" id="default25"   style="display:none;" />
<img src="fakegraphics/1a.png" id="default26"   style="display:none;" />
<img src="fakegraphics/27a.png" id="default27"   style="display:none;" />
<img src="fakegraphics/28a.png" id="default28"   style="display:none;" />
<img src="fakegraphics/29a.png" id="default29"   style="display:none;" />
<img src="fakegraphics/30a.png" id="default30"   style="display:none;" />
<img src="fakegraphics/31a.png" id="default31"   style="display:none;" />
<img src="fakegraphics/32a.png" id="default32"   style="display:none;" />
<img src="fakegraphics/33a.png" id="default33"   style="display:none;" />
<img src="fakegraphics/34a.png" id="default34"   style="display:none;" />
<img src="fakegraphics/35a.png" id="default35"   style="display:none;" />

<img src="sprites/tank/tankside.png" id="tanksideblack"  style="display:none;" />
<img src="sprites/tank/tankend.png" id="tankendblack"  style="display:none;" />
<img src="sprites/tank/tanktop.png" id="tanktopblack" style="display:none;" />

<img src="sprites/trans/boxside.png" id="boxsidetrans"  style="display:none;" />
<img src="sprites/source/boxside.png" id="boxsidesource"  style="display:none;" />
<!--
<img src="sprites/trans/boxend.png" id="boxendtrans"  style="display:none;" />
<img src="sprites/trans/boxtop.png" id="boxtoptrans" style="display:none;" />
<img src="sprites/trans/engineportinner.png" id="engineportinnertrans" style="display:none;" />
<img src="sprites/trans/engineportouter.png" id="engineportoutertrans" style="display:none;" />
<img src="sprites/trans/enginestarinner.png" id="enginestarinnertrans" style="display:none;" />
<img src="sprites/trans/enginestarouter.png" id="enginestaroutertrans" style="display:none;" />
<img src="sprites/trans/enginefloor.png" id="enginefloortrans" style="display:none;" />
<img src="sprites/trans/engineroof.png" id="enginerooftrans" style="display:none;" />
<img src="sprites/trans/enginenose.png" id="enginenosetrans" style="display:none;" />
<img src="sprites/trans/enginecab.png" id="enginecabtrans" style="display:none;" />

<img src="sprites/source/boxend.png" id="boxendsource"  style="display:none;" />
<img src="sprites/source/boxtop.png" id="boxtopsource" style="display:none;" />
<img src="sprites/source/engineportinner.png" id="engineportinnersource" style="display:none;" />
<img src="sprites/source/engineportouter.png" id="engineportoutersource" style="display:none;" />
<img src="sprites/source/enginestarinner.png" id="enginestarinnersource" style="display:none;" />
<img src="sprites/source/enginestarouter.png" id="enginestaroutersource" style="display:none;" />
<img src="sprites/source/enginefloor.png" id="enginefloorsource" style="display:none;" />
<img src="sprites/source/engineroof.png" id="engineroofsource" style="display:none;" />
<img src="sprites/source/enginenose.png" id="enginenosesource" style="display:none;" />
<img src="sprites/source/enginecab.png" id="enginecabsource" style="display:none;" />
-->
<img src="sprites/green/boxside.png" id="boxsidegreen"  style="display:none;" />
<img src="sprites/green/boxend.png" id="boxendgreen"  style="display:none;" />
<img src="sprites/green/boxtop.png" id="boxtopgreen" style="display:none;" />
<img src="sprites/green/engineportinner.png" id="engineportinnergreen" style="display:none;" />
<img src="sprites/green/engineportouter.png" id="engineportoutergreen" style="display:none;" />
<img src="sprites/green/enginestarinner.png" id="enginestarinnergreen" style="display:none;" />
<img src="sprites/green/enginestarouter.png" id="enginestaroutergreen" style="display:none;" />
<img src="sprites/green/enginefloor.png" id="enginefloorgreen" style="display:none;" />
<img src="sprites/green/engineroof.png" id="engineroofgreen" style="display:none;" />
<img src="sprites/green/enginenose.png" id="enginenosegreen" style="display:none;" />
<img src="sprites/green/enginecab.png" id="enginecabgreen" style="display:none;" />

<img src="sprites/blue/boxside.png" id="boxsideblue"  style="display:none;" />
<img src="sprites/blue/boxend.png" id="boxendblue"  style="display:none;" />
<img src="sprites/blue/boxtop.png" id="boxtopblue" style="display:none;" />
<img src="sprites/blue/engineportinner.png" id="engineportinnerblue" style="display:none;" />
<img src="sprites/blue/engineportouter.png" id="engineportouterblue" style="display:none;" />
<img src="sprites/blue/enginestarinner.png" id="enginestarinnerblue" style="display:none;" />
<img src="sprites/blue/enginestarouter.png" id="enginestarouterblue" style="display:none;" />
<img src="sprites/blue/enginefloor.png" id="enginefloorblue" style="display:none;" />
<img src="sprites/blue/engineroof.png" id="engineroofblue" style="display:none;" />
<img src="sprites/blue/enginenose.png" id="enginenoseblue" style="display:none;" />
<img src="sprites/blue/enginecab.png" id="enginecabblue" style="display:none;" />

<img src="sprites/orange/boxside.png" id="boxsideorange"  style="display:none;" />
<img src="sprites/orange/boxend.png" id="boxendorange"  style="display:none;" />
<img src="sprites/orange/boxtop.png" id="boxtoporange" style="display:none;" />
<img src="sprites/orange/engineportinner.png" id="engineportinnerorange" style="display:none;" />
<img src="sprites/orange/engineportouter.png" id="engineportouterorange" style="display:none;" />
<img src="sprites/orange/enginestarinner.png" id="enginestarinnerorange" style="display:none;" />
<img src="sprites/orange/enginestarouter.png" id="enginestarouterorange" style="display:none;" />
<img src="sprites/orange/enginefloor.png" id="enginefloororange" style="display:none;" />
<img src="sprites/orange/engineroof.png" id="enginerooforange" style="display:none;" />
<img src="sprites/orange/enginenose.png" id="enginenoseorange" style="display:none;" />
<img src="sprites/orange/enginecab.png" id="enginecaborange" style="display:none;" />

<img src="sprites/black/boxside.png" id="boxsideblack"  style="display:none;" />
<img src="sprites/black/boxend.png" id="boxendblack"  style="display:none;" />
<img src="sprites/black/boxtop.png" id="boxtopblack" style="display:none;" />
<img src="sprites/black/engineportinner.png" id="engineportinnerblack" style="display:none;" />
<img src="sprites/black/engineportouter.png" id="engineportouterblack" style="display:none;" />
<img src="sprites/black/enginestarinner.png" id="enginestarinnerblack" style="display:none;" />
<img src="sprites/black/enginestarouter.png" id="enginestarouterblack" style="display:none;" />
<img src="sprites/black/enginefloor.png" id="enginefloorblack" style="display:none;" />
<img src="sprites/black/engineroof.png" id="engineroofblack" style="display:none;" />
<img src="sprites/black/enginenose.png" id="enginenoseblack" style="display:none;" />
<img src="sprites/black/enginecab.png" id="enginecabblack" style="display:none;" />

<img src="sprites/grey/boxside.png" id="boxsidegrey"  style="display:none;" />
<img src="sprites/grey/boxend.png" id="boxendgrey"  style="display:none;" />
<img src="sprites/grey/boxtop.png" id="boxtopgrey" style="display:none;" />
<img src="sprites/grey/engineportinner.png" id="engineportinnergrey" style="display:none;" />
<img src="sprites/grey/engineportouter.png" id="engineportoutergrey" style="display:none;" />
<img src="sprites/grey/enginestarinner.png" id="enginestarinnergrey" style="display:none;" />
<img src="sprites/grey/enginestarouter.png" id="enginestaroutergrey" style="display:none;" />
<img src="sprites/grey/enginefloor.png" id="enginefloorgrey" style="display:none;" />
<img src="sprites/grey/engineroof.png" id="engineroofgrey" style="display:none;" />
<img src="sprites/grey/enginenose.png" id="enginenosegrey" style="display:none;" />
<img src="sprites/grey/enginecab.png" id="enginecabgrey" style="display:none;" />



<!-- 
Who else but Jambots.com could create a train puzzle you solve using multiple engines each pulling multiple cars on tracks that YOU draw? Play endless procedurally genrated challenges in three different model scales. Put your photos on the box cars and watch your game play out from a 3d chase or in-cab view. Now with no ad banners, this is a free upgrade for anyone who already had the previous ad-supported version. This is a puzzle, not a simulation of real or toy trains.


Help File
Choose a level to begin playing. Drag across tiles to create tracks. Make a loop for the engine to pass by any fields of the same color and return past the silo. Draw tracks from the fields to the loop so cars can be picked up. Finaly add a track for the cars to move into the silo. Get all the cars of all colors into the silos to win!
Tracks will only be placed crossing a tile from one edge to another connecting two adjacent valid tiles. Tracks be laid to silos and fields in only the direction that tracks protrude. Engines will follow tracks when not obstructed, choosing randomly at branches. Cars will attach to the engine or other cars of the same color at an adjacent tile if track allows.

Scale
Levels of differing complexity will be available depending on the Scale setting and your device's size.

The default scale, "HO" provides a balance of complexity and useablity. The largest scale, "O" is much easier to draw tracks and simpler to solve. The smallest scale, "N" gives you the most track space and complexity but it can be difficult to draw accurately without a stylus. 
Guides are the two spots on the edge of a tile. If you are having trouble getting the tracks to go where you want, try starting at one guide and drag slowly across the cell to another guide. Keep dragging across multiple cells to lay continuous track. 
At any given scale setting a tablet will have more cells available for tracks than a phone. Device size and aspect ratios vary so the grid will adapt to the best fit for each scale. The number of levels also varies with the grid space available.

Detail
Your most recent average Frames Per Second is displayed at the bottom of Settings. When AVERAGE FPS falls below 40 cars will stop spawning temporarily. Faster devices will allow more cars but running too many cars can cause congestion or result in the app closing. Set Detail to "Low" to improve performance. Try "High" Detail if you have a very fast device or want the best looking close-ups in video capture. If you have macOS and an iOS device with Lightning cable you can use QuickTime to capture video of your game. Rotating the device will stop the recording!

Graphics
A set of 36 graphics are loaded randomly when you first open the app. You can replace these with your own graphics using the camera button. Use the Clear button to make all the graphics for the selected color blank. The random graphics will change out each time you open the game but user created or cleared graphics will persist. You can remove any user generated graphics and restore the random feed. Go to your device's settings, under Apps, and clear  data for Railroad Train. Transparent makes dark areas into the car color and works best with white graphics and text on black. 
-->
  </div>
<span style="font-family:akziLight; position:absolute; top:-100px;">akziLight</span>
<span style="font-family:akzi; position:absolute; top:-100px;">akzi</span>
<span style="font-family:akziBold; position:absolute; top:-100px;">akziBold</span>
</body>
</html>  
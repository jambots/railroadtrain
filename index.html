<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name = "apple-mobile-web-app-capable" content = "yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script type="text/javascript" src="done.js?18"></script>
<link rel="stylesheet" type="text/css" href="reset-min.css">
<link rel="stylesheet" type="text/css" href="interface.css?1">
<link rel="stylesheet" type="text/css" href="nav.css">
<script src="phonegap.js"></script>
<script src="nav.js?3"></script>
<script src="howler.min.js"></script>

<style>


@font-face {
    font-family: akzi;
    src: url(ttf/akzidenzgrotesklight.ttf);
}
.cubeFace{
  
  display: block;
  position: absolute;
  -webkit-backface-visibility: hidden;
  opacity: 1; 
  -webkit-transform-style: preserve-3d;
  -webkit-transform-origin: 0 0 0;

}

.cube{
  -webkit-backface-visibility: hidden;

  position:relative;
  -webkit-transform-style: preserve-3d;
  -webkit-transform-origin: 0px 0 0px;
}

.background{position:absolute; top:-64px; left:-64px;}


div{image-rendering: -webkit-optimize-speed; user-select: none;}
canvas{
user-select: none;
image-rendering: -webkit-optimize-speed;
-webkit-backface-visibility: hidden;
}
img{image-rendering: -webkit-optimize-speed;}
#preload{
display:none;
position:absolute;
top:798px;
width:768px;
}

#preload{display:none;}
#cameraDiv{
  background-repeat:no-repeat;
  background-position:50% 50%;
  -webkit-perspective-origin: 50% 50% 50%;
  -webkit-perspective: 786;
  display:block;
  -webkit-transform-style: preserve-3d;
  -webkit-backface-visibility:hidden;
  }
#zoomDiv{
  background-repeat:no-repeat;
  background-position:50% 50%;

  display:block;
  -webkit-transform-style: preserve-3d;
  -webkit-backface-visibility:hidden;
  }
#tableDiv{
  display:block;
  -webkit-transform-style: preserve-3d;
  -webkit-backface-visibility:hidden;
  }
#trainHolder{
  background-image:url(images/grid_yellow.png);
  background-repeat:no-repeat;
  background-position:50% 50%;

  -webkit-transform-style: preserve-3d;
}
#wrapper{
  -webkit-transform-style: preserve-3d;
  background-color:#fff;
  zbackground-image:url(images/grid_white.png);
}
</style>

<script type="text/javascript" charset="utf-8">

document.addEventListener("deviceready", onDeviceReady, false);

function saveImageData(key, data){
  if(web){
    saveImageDataLocalStorage(key, data);
    }
  else{
    saveImageDataPhonegap(key, data);
    }
  }
function saveImageDataLocalStorage(key, data){
  //dbuga("saveImageDataLocalStorage <br>"+key);
  
  var purged=0;
  var nameStack=JSON.parse(localStorage.getItem("nameStack"));
  var currentName="not set";
  if(setKeys.length>1){currentName=setKeys[1];}
  var favorites=sets["9999_Favorites"];
  var favStack=[];
  var normStack=[];
  var currentStack=[];
  for (var n=0; n<nameStack.length; n++){
    var thisName=nameStack[n];
    var isFav=false;
    for (var f=0; f<favorites.length; f++){
      var favName=favorites[f].largeUrl;
      if(thisName.indexOf(favName)>-1){isFav=true;}
      }
    if(isFav){
      favStack.push(thisName);
      }
    else{
      if(thisName.indexOf(currentName)>-1){
        currentStack.push(thisName);
        }
      else{
        normStack.push(thisName);
        }
      }
    }
  nameStack=normStack.concat(currentStack, favStack);

  
  var saved=true;
  
  try{
    localStorage.setItem(key, data);
    } catch(e) {
    //dbuga(e);
    saved=false;
    }
  while((saved==false)&&(nameStack.length>0)){
    var delKey=nameStack.shift();
    localStorage.setItem(delKey, "");
    //dbuga(' -  purge '+delKey);
    purged++;
    saved=true;
    try{
      localStorage.setItem(key, data);
      } catch(e) {
      //dbuga(e);
      saved=false;
      }
    }

  if(saved){
    nameStack.push(key);
    //dbuga(' saved: '+nameStack.length+" "+key);
    purged=0;
    }
  else{
    //dbuga('failed '+key);
    }
  localStorage.setItem("nameStack", JSON.stringify(nameStack));
  }

function saveImageDataPhonegap(key, data){
  //dbuga("<br>saveImageDataPhonegap "+key);
  var nameStack=JSON.parse(localStorage.getItem("nameStack"));
  nameStack.push(key);
  var temp=key.split("/");
  var fname=temp.pop();
  //dbuga(fname +" save to db" );
  localStorage.setItem("nameStack", JSON.stringify(nameStack));
  db.transaction(function(tx) {
    tx.executeSql("INSERT INTO test_table (image_url, image_data) VALUES (?,?)", [key, data], function(tx, res){
      //dbuga("inserted");
      }, function(e) {
        //dbuga("not inserted ERROR: " + e.message);
      });
    });

  }


var comQueue=new Array();

var cellSize=96;
var cellSizeHalf=48;
var cellsAcross=8;
var cellsDown=8;
var shrink=.95;

var colorsUp=true;
var cubeSize=cellSize;
var faceData={};
function setupFaceData(){
  dbuga("setupFaceData() cubeSize="+cubeSize);
  var s=cubeSize;
  faceData={
  "tank":[
    {"img":"tanktop", "width":1, "height":6/24, "trans":'translateZ('+ -s*18/48+'px) translateY('+ -s*6/48+'px) translateX('+ -s*24/48+'px)'},
    {"img":"tanktop", "width":1, "height":6/24, "trans":'translateZ('+ -s*22/48+'px) translateY('+ -s*6/48+'px) translateX('+ -s*24/48+'px)'},
    {"img":"tankside", "width":1, "height":8/24, "trans":'rotateX(-90deg) translateZ('+s*0/48+'px) translateY('+s*8/48+'px) translateX('+-s*24/48+'px)'},
    {"img":"tankend", "width":6/24, "height":8/24, "trans":'rotateX(-90deg)  rotateY(-90deg) translateZ('+s*20/48+'px) translateY('+s*8/48+'px) translateX('+-s*6/48+'px)'},
    {"img":"tankend", "width":6/24, "height":8/24, "trans":'rotateX(-90deg)  rotateY(-270deg) translateZ('+s*20/48+'px) translateY('+s*8/48+'px) translateX('+-s*6/48+'px)'}
  ],
  "box":[
    {"img":"boxtop", "width":1, "height":6/24, "trans":'translateZ('+ -s*10/48+'px) translateY('+ -s*6/48+'px) translateX('+ -s*24/48+'px)'},
    {"img":"boxside", "width":1, "height":8/24, "trans":'rotateX(-90deg) translateZ('+cubeSize*5/48+'px) translateY('+s*8/48+'px) translateX('+-s*24/48+'px)'},
    {"img":"boxside", "width":1, "height":8/24, "trans":'rotateX(-90deg) rotateY(180deg) translateZ('+s*5/48+'px) translateY('+s*8/48+'px) translateX('+-s*24/48+'px)'},
    {"img":"boxend", "width":6/24, "height":8/24, "trans":'rotateX(-90deg)  rotateY(-90deg) translateZ('+s*22/48+'px) translateY('+s*8/48+'px) translateX('+-s*6/48+'px)'},
    {"img":"boxend", "width":6/24, "height":8/24, "trans":'rotateX(-90deg)  rotateY(-270deg) translateZ('+s*22/48+'px) translateY('+s*8/48+'px) translateX('+-s*6/48+'px)'}
  ],
  "engine":[
    {"img":"enginefloor", "width":1, "height":6/24, "trans":'rotateZ(180deg) translateZ('+-s*21/48+'px) translateY('+-s*6/48+'px) translateX('+-s*24/48+'px)'},
    {"img":"engineroof", "width":1, "height":6/24, "trans":'rotateZ(180deg) translateZ('+-s*11/48+'px) translateY('+-s*6/48+'px) translateX('+-s*24/48+'px)'},
    {"img":"enginestarouter", "width":1, "height":8/24, "trans":'rotateX(-90deg) translateZ('+s*5/48+'px) translateY('+s*8/48+'px) translateX('+-s*24/48+'px)'},
    {"img":"enginestarinner", "width":1, "height":8/24, "trans":'rotateX(-90deg) translateZ('+s*3/48+'px) translateY('+s*8/48+'px) translateX('+-s*24/48+'px)'},
    {"img":"engineportouter", "width":1, "height":8/24, "trans":'rotateX(-90deg) rotateY(180deg) translateZ('+s*5/48+'px) translateY('+s*8/48+'px) translateX('+-s*24/48+'px)'},
    {"img":"engineportinner", "width":1, "height":8/24, "trans":'rotateX(-90deg) rotateY(180deg) translateZ('+s*3/48+'px) translateY('+s*8/48+'px) translateX('+-s*24/48+'px)'},
    {"img":"enginenose", "width":6/24, "height":8/24, "trans":'rotateX(-90deg)  rotateY(-90deg) translateZ('+s*20/48+'px) translateY('+s*8/48+'px) translateX('+-s*6/48+'px)'},
    {"img":"enginenose", "width":6/24, "height":8/24, "trans":'rotateX(-90deg)  rotateY(-270deg) translateZ('+s*20/48+'px) translateY('+s*8/48+'px) translateX('+-s*6/48+'px)'},
    {"img":"enginecab", "width":6/24, "height":8/24, "trans":'rotateX(-90deg)  rotateY(-90deg) translateZ('+-s*7/48+'px) translateY('+s*8/48+'px) translateX('+-s*6/48+'px)'},
    {"img":"enginecab", "width":6/24, "height":8/24, "trans":'rotateX(-90deg)  rotateY(-270deg) translateZ('+s*14/48+'px) translateY('+s*8/48+'px) translateX('+-s*6/48+'px)'}
  ]

};
}
var colors=["orange", "black", "blue", "green"];




////var musicOn=true;
////var sfxOn=true;




function comTick(){
  return false;
  if(comQueue.length >0){
    thisCom=comQueue.join('&');
    comQueue=new Array();
    pea=rnd(10000);
    window.location.hash="#"+thisCom+"&unique="+pea;
    displCom=thisCom.replace(/\&/g, "<br>");
    }
  comGlom="";
  comQueue=new Array();
  }

function genericDefault(itemName, defaultValue){
  if(platform=="android"){
    if (localStorage.getItem(itemName) === null) {
      localStorage.setItem(itemName, defaultValue);
      }
    }
  }
function genericSet(itemName, newValue){
  if(platform=="android"){
    localStorage.setItem(itemName, newValue);
    }
  }
function genericGet(itemName){
  var value="notSet";
  if(platform=="android"){
    value=localStorage.getItem(itemName);
    }
  return value;
  }


function rnd(range){
  return Math.floor(Math.random()*range);
  }
var paused=false;
function pauseGame(){
  //dbuga("pauseGame()");
  paused=true;
  loopStop("measure_loop_inst");
  // called by shell
  return true;
  }
function resumeGame(){
  // called by shell
  //requestPersistenceData();
  dbuga("resumeGame()");
  paused=false;
  transmitBgMusicState();
  return true;
  }


function transmitBgMusicState(){
  //dbuga("transmitBgMusicState()");
  debugStorage();
  if(genericGet("musicOn") == "true"){
    loopStart("measure_loop_inst");
    }
  else{
    loopStop("measure_loop_inst");
    }
  
  
  }
var soundCount=0;
var soundRefByName={};
function oneShot(soundName){
  //dbuga("oneShot("+soundName+")");
  if(persistenceObject.music=="on"){
    if(platform=="android"){
      if(soundRefByName.hasOwnProperty(soundName)){
        //dbuga(' - extant '+soundName);
        //soundRefByName[soundName].stop();
        soundRefByName[soundName].play();
        //dbuga(' - played');
        }
      else{
        var newSound = new Media(filePath+"/"+soundName+".mp3");
        soundRefByName[soundName]=newSound;
        //dbuga('new Media '+soundName);
        }
      }
    if((platform=="web")||(platform=="local")){
      if(soundRefByName.hasOwnProperty(soundName)){
        //dbuga(' - extant '+soundName);
        //soundRefByName[soundName].stop();
        soundRefByName[soundName].play();
        //dbuga(' - played');
        }
      else{
        var newSound = new Howl({
          urls: [filePath+"/"+soundName+".mp3"],
          autoplay: true,
          loop: false,
          volume: 0.5,
          onend: function() {
            //alert('Finished!');
            }
          });
        soundRefByName[soundName]=newSound;
        //dbuga('new howl '+soundName);
 
        }  
      }  
    if(platform=="dreamfreeze"){
      if(soundRefByName.hasOwnProperty(soundName)){
        var soundChannel=soundRefByName[soundName];
        comQueue.push("action=manageSound|channel="+soundChannel+"|mode=play");
        comTick();
        }
      }
    }  
  }
function loopStart(soundName){
  //dbuga("loopStart("+soundName+") "+platform);
  if(persistenceObject.music=="on"){
    if(platform=="android"){
      //dbuga('BOOYA!');
      if(soundRefByName.hasOwnProperty(soundName)){
        soundRefByName[soundName].play();
        }
      }
    if((platform=="web")||(platform=="local")){
      if(soundRefByName.hasOwnProperty(soundName)){
        //dbuga('openedWithStupidLoop: '+ openedWithStupidLoop);
        if(openedWithStupidLoop==false){
          //dbuga(' - extant '+soundName);
          soundRefByName[soundName].stop();
          soundRefByName[soundName].play();
          //dbuga(' - played');
          }
        }
      else{
        var newSound = new Howl({
          urls: [filePath+"/"+soundName+".mp3"],
          autoplay: true,
          loop: true,
          volume: 0.5,
          onend: function() {
            //alert('Finished!');
            }
          });
        soundRefByName[soundName]=newSound;
        //dbuga('new howl '+soundName);
 
        }  
      }  
    if(platform=="dreamfreeze"){
      if(soundRefByName.hasOwnProperty(soundName)){
        var soundChannel=soundRefByName[soundName];
        //dbuga("loopStart() "+soundChannel+" : "+soundName);
        
        comQueue.push("action=manageSound|channel="+soundChannel+"|loop=true|starttime=0|mode=play");
        comTick();
        }
      }
    }  
  }

function statusCallback(theStatus){
  var statusArray=['MEDIA_NONE', 'MEDIA_STARTING', 'MEDIA_RUNNING', 'MEDIA_PAUSED', 'MEDIA_STOPPED'];
  //dbuga('media status '+statusArray[theStatus]);
  if(soundRefByName.hasOwnProperty("musicloop")){
    var loopRef=soundRefByName["musicloop"];
    loopRef.getCurrentPosition(
        // success callback
        function (position) {
            if (position > -1) {
                //dbuga((position) + " sec");
            if((ladCount>0)&&(theStatus==4)&&(position<.01)){loopStart("musicloop");}//loop hack for bullshit media
            }
        },
        // error callback
        function (e) {
            //dbuga("Error getting pos=" + e);
        }
    );
    }
  }
function errorCallback(er){
  //dbuga("media error "+JSON.stringify(er))
  }
function successCallback(evt){
  //dbuga("HEY ": + JSON.stringify(evt));
  //singMedia.play();
  }


function oneShotLoad(soundName){
  if(platform=="android"){
    var newSound = new Media(filePath+"/"+soundName+".mp3");
    soundRefByName[soundName]=newSound;
    //dbuga('new Media '+soundName);
    }
  if((platform=="web")||(platform=="local")){
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga('extant');
      }
    else{
      //dbuga('new howl');
      var newSound = new Howl({
        urls: [filePath+"/"+soundName+".mp3"],
        autoplay: false,
        loop: false,
        volume: 0.5,
        onend: function() {
          //alert('Finished!');
          }
        });
      soundRefByName[soundName]=newSound;
      }  
    }  
  if(platform=="dreamfreeze"){
    if(soundRefByName.hasOwnProperty(soundName)){
      }
    else{
      var soundChannel=soundCount;
      var soundFile="sounds/"+soundName+".mp3";
      comQueue.push("action=manageSound|file="+soundFile+"|channel="+soundChannel+"|mode=prepare");
      soundRefByName[soundName]=soundChannel;
      //dbuga("soundChannel: "+soundChannel+" soundName:"+soundName);
      soundCount++;
      }  
    comTick();
    }
  }
function loopStop(soundName){
  if(platform=="android"){
    //dbuga('ANDROID loopStop');
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga('extant '+soundName);
      //dbuga('stop andriod');
      soundRefByName[soundName].stop();
      }  
    }
  if((platform=="web")||(platform=="local")){
    openedWithStupidLoop=false;
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga('extant '+soundName);
      //dbuga('stop howl');
      soundRefByName[soundName].stop();
      }  
    else{
      //dbuga('non-extant '+soundName);
      }
    }  
  if(platform=="dreamfreeze"){
    if(soundRefByName.hasOwnProperty(soundName)){
      var soundChannel=soundRefByName[soundName];
      comQueue.push("action=manageSound|channel="+soundChannel+"|mode=pause");
      comTick();
      }
    }

  }
var persistenceObject={"music":"on", "sfx":"on"};
function loopLoad(soundName){
  if(platform=="android"){
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga(' - extant '+soundName);
      //soundRefByName[soundName].stop();
      soundRefByName[soundName].play();
      //dbuga(' - played');
      }
    else{
      var newSound = new Media(filePath+"/"+soundName+".mp3", successCallback, errorCallback, statusCallback);
      soundRefByName[soundName]=newSound;
      //dbuga('new Media '+soundName);
      }
    }
  if((platform=="web")||(platform=="local")){
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga(' - extant: '+ soundName);
      }
    else{
      var shallAutoplay=false;
      if(persistenceObject.music=="on"){
        shallAutoplay=true;
        openedWithStupidLoop=true;
        }
      //dbuga(' - new Howl: '+ soundName);
      var newSound = new Howl({
        urls: [filePath+"/"+soundName+".mp3"],
        autoplay: shallAutoplay,
        loop: true,
        volume: 0.5,
        onend: function() {
          //alert('Finished!');
          }
        });
      soundRefByName[soundName]=newSound;
      }  
    }  
  if(platform=="dreamfreeze"){
    if(soundRefByName.hasOwnProperty(soundName)){
      }
    else{
      var soundChannel=soundCount;
      var soundFile="sounds/"+soundName+".mp3";
      comQueue.push("action=manageSound|file="+soundFile+"|channel="+soundChannel+"|mode=prepare|loop=true");
      soundRefByName[soundName]=soundChannel;
      //dbuga("soundChannel: "+soundChannel+" soundName:"+soundName);
      soundCount++;
      }  
    comTick();
    }  
  }


function playSound(theSound){
  //dbug(sfxOn);
  if((genericGet("sfxOn") == "true")&&(paused==false)){
    oneShot(theSound);
    }
  }
function resetUndoLabel(){
  document.getElementById('undo_label').style.opacity=".5";
  }
function undo(){
  lastItemType=buildSequence[buildSequence.length-1].type;
  if((lastItemType != "source")&&(lastItemType != "dest")&&(lastItemType != "train")){
    trash=buildSequence.pop();
    }
  //dbugBuildSequence();
  //resetBoardTimersObjects();
  rebuildTracks();
  }

function handleEventUi(e){

  target=e.touches[0].target.id;
  //dbuga("handleEventUi "+target);
  if(target == "level_touch"){
    if(levelsUp){
      //dbuga('closeModals levelsUp');
      closeModals();
      minFramesPerSecond=999;
      }
    else{
      openModal("levels");
      }
    }
  if(target == "menu_touch"){
    if(menuUp){
      //dbuga('closeModals menu_touch');
      closeModals();
      minFramesPerSecond=999;
      }
    else{
      openModal("menu");
      }
    }
/*
  if(target == "music_touch"){
    if(genericGet("musicOn") == "true"){
      genericSet("musicOn", "false");
      //document.getElementById('music_label').style.opacity=".5";
      }
    else{
      genericSet("musicOn", "true");
      //document.getElementById('Music_label').style.opacity="1";
      }
    transmitBgMusicState();
    }

  if (target == "sfx_touch"){
    if(genericGet("sfxOn") == "true"){
      genericSet("sfxOn","false");
      document.getElementById('Sfx_label').style.opacity=".5";
      }
    else{
      genericSet("sfxOn","true");
      document.getElementById('Sfx_label').style.opacity="1";
      oneShot("trainstart");
      }
    }

*/
  if (target == "undo_touch"){
    undo();
    document.getElementById('undo_label').style.opacity="1";
    window.setTimeout('resetUndoLabel()', 400);
    }
  if (target == "reset_touch"){
    resetBoardTimersObjects();
    removeAllTracks();
    rebuildSequence();
    }
  }

function removeAllTracks(){
  //dbug('');
  var tempSequence=buildSequence;
  buildSequence=new Array();
  for (var i in tempSequence){
    if(tempSequence[i].type!="track"){
      buildSequence.push(tempSequence[i]);
      }
    }
  }
function dbugBuildSequence(){
  //dbug('');
  for (var i in buildSequence){
    item=buildSequence[i];
    //dbuga("x="+item.x+" y="+item.y+" type="+item.type+"<br>");
    }
  }
function rebuildSequence(){
  //dbuga('rebuildSequence()');
  //dbugaObject(destData);
  for (var i in buildSequence){
    item=buildSequence[i];
    type=item.type;
    if(type=="dest"){
      //dbugaObject(item);
      var newDest=destObject(item.color, item.dir, item.x, item.y);
      //dbugaObject(newDest);
      destData.push(newDest);
      }
    if(type=="train"){
      var t=trainObject(item.color, item.x, item.y, item.dir);
      trainData.push(t);
      }
    if(type=="source"){
      sourceData.push(sourceObject(item.color, item.dir, item.x, item.y, item.barrels));
      displayBarrels("grid_"+item.x+"_"+item.y, item.barrels); 
      }
    if(type=="track"){
      createTrack(item.dir, "grid_"+item.x+"_"+item.y);
      createCanvasTrack(item.dir, item.x, item.y);
      }
    }
  //dbuga(JSON.stringify(tilesByGridXY));
  restartIntervals();
  }

function rebuildTracks(){
  //dbuga('rebuildTracks()');
  trackContext.clearRect(0, 0, boardWidth, boardHeight)
  document.getElementById("trackCanvas").width=boardWidth;
  //eraseGridData
  tilesByGridXY={};
  for (x=0; x<cellsAcross; x++){
    for (y=0; y<cellsDown; y++){
      gridXY="grid_"+x+"_"+y;
      tilesByGridXY[gridXY]=new Array();
      }
    }
  for (var i in buildSequence){
    item=buildSequence[i];
    type=item.type;
    var targetCell="";
    if(type=="dest"){
      targetCell="grid_"+item.x+"_"+item.y;
      createTrack(item.dir+"d", targetCell);
      tilesByGridXY[targetCell].push("tiledest"+item.color);
      createCanvasTrack(item.dir+"d", item.x, item.y);
      }
    if(type=="source"){
      targetCell="grid_"+item.x+"_"+item.y;
      createTrack(item.dir+"s", targetCell);
      tilesByGridXY[targetCell].push("tilesource"+item.color);
      createCanvasTrack(item.dir+"s", item.x, item.y);
      }
    if(type=="track"){
      createTrack(item.dir, "grid_"+item.x+"_"+item.y);
      createCanvasTrack(item.dir, item.x, item.y);
      }
    }
  //dbuga(JSON.stringify(tilesByGridXY));
  //restartIntervals();
  }
var progDivHeight=12;
var uiDivHeight=16;
var uiTop=100;
var squarePadLeft=0;

function setupClasses(){
  dbuga("setupClasses()");
  var p=cellSize/96

  var buttonsTop=30*p;
  var buttonsLeft=0*p;

  var progDivTop=1;
  var progDivLeft=0;
  var progDivWidth=screenWidth;

  var childrenSize=82*p;
  var childrenPad=4*p;
  squarePadTop=0;
  squarePadLeft=0;
  if(viewportAspect<1){squarePadTop=screenHeight/2-screenWidth/2;}//portrait
  else{squarePadLeft=screenHeight/2-screenWidth/2;}//landscape
    

  //dbuga('screenWidth='+screenWidth);
  //dbuga('screenHeight='+screenHeight);
  //dbuga('squarePadLeft='+squarePadLeft);
  //dbuga('squarePadTop='+squarePadTop);
 
  
  uiTop=portraitScreenHeight-44-progDivHeight-adHeight;

  addStyle('#arrowCircle', 'position:absolute; left:' + p*12 + 'px; top:' + p*12 + 'px; border-color:#DA251C;  border-style:solid; border-width:' + p*12 + 'px;  width:' + p*40 + 'px;  height:' + p*40 + 'px; -webkit-border-radius:' + p*48 + 'px;');
  addStyle('#arrowPoint', 'position:absolute; left:' + p*36 + 'px; top:' + p*5 + 'px; border-color:#fff #DA251C #fff  #fff ;  border-style:solid ;  border-width:' + p*15 + 'px ' + p*15 + 'px ' + p*15 + 'px 0px ;  width:0;  height:0;');
  addStyle('#uiHolder', 'position:absolute; top:' + uiTop + 'px; left:0; width:' + screenWidth + 'px; height:' + uiDivHeight + 'px;');
  addStyle('#progressDiv', 'position:absolute; display:block; overflow:hidden; width:' + progDivWidth + 'px; height:' + progDivHeight + 'px; position:absolute; top:' + progDivTop + 'px; left:' + progDivLeft + 'px; Zbackground-color:#fff;');
  addStyle('.grow', '  height:' + progDivHeight + 'px; width:' + p*100 + 'px; float:left;  Zwebkit-transition: width 1s ease;  ');
  addStyle('#helpCanvas', 'position:absolute; top:' + squarePadTop + 'px; left:' + squarePadLeft + 'px;  width:' + screenWidth + 'px; height:' + screenWidth + 'px; background-color:rgba(0,0,255,.85);');

  addStyle('#highlighter', 'width:' + p*94 + 'px; height:' + p*94 + 'px; position:absolute;    -webkit-border-radius:' + p*20 + 'px;    background-color:#FFFF00;    opacity:1;    display:none;');
  addStyle('.tile', 'width:' + p*94 + 'px; height:' + p*94 + 'px; position:absolute;    border:0px #0000ee solid;    -webkit-border-radius:' + p*20 + 'px;    ');
  addStyle('.tiledestgreen', 'margin:' + p*14 + 'px; width:' + p*66 + 'px; height:' + p*66 + 'px; position:absolute;    background-color:#3C746B;    -webkit-border-radius:' + p*48 + 'px;    ');
  addStyle('.tiledestblue', 'margin:' + p*14 + 'px; width:' + p*66 + 'px; height:' + p*66 + 'px; position:absolute;    background-color:#005BA1;    -webkit-border-radius:' + p*48 + 'px;    ');
  addStyle('.tiledestblack', 'margin:' + p*14 + 'px; width:' + p*66 + 'px; height:' + p*66 + 'px; position:absolute;    background-color:#000000;    -webkit-border-radius:' + p*48 + 'px;    ');
  addStyle('.tiledestorange', 'margin:' + p*14 + 'px; width:' + p*66 + 'px; height:' + p*66 + 'px; position:absolute;    background-color:#DA251C;    -webkit-border-radius:' + p*48 + 'px;    ');
  addStyle('.tilesourcegreen', 'margin:' + p*4 + 'px; width:' + p*86 + 'px; height:' + p*86 + 'px; position:absolute;    background-color:#3C746B;    -webkit-border-radius:' + p*16 + 'px;    ');
  addStyle('.tilesourceblue', 'margin:' + p*4 + 'px; width:' + p*86 + 'px; height:' + p*86 + 'px; position:absolute;    background-color:#005BA1;    -webkit-border-radius:' + p*16 + 'px;    ');
  addStyle('.tilesourceblack', 'margin:' + p*4 + 'px; width:' + p*86 + 'px; height:' + p*86 + 'px; position:absolute;    background-color:#000000;    -webkit-border-radius:' + p*16 + 'px;    ');
  addStyle('.tilesourceorange', 'margin:' + p*4 + 'px; width:' + p*86 + 'px; height:' + p*86 + 'px; position:absolute;    background-color:#DA251C;    -webkit-border-radius:' + p*16 + 'px;    ');

  addStyle('.dot', '-webkit-border-radius:' + p*8 + 'px; position:absolute; width:' + p*24 + 'px; height:' + p*12 + 'px; opacity:0;');
  addStyle('.dot1', 'left:' + p*7 + 'px; top:' + p*13 + 'px;');
  addStyle('.dot2', 'left:' + p*55 + 'px; top:' + p*13 + 'px;');
  addStyle('.dot3', 'left:' + p*7 + 'px; top:' + p*61 + 'px;');
  addStyle('.dot4', 'left:' + p*55 + 'px; top:' + p*61 + 'px;');

  for(var s=0; s<=20; s++){
    addStyle('.L'+s, 'left:' + p*96*s + 'px;');
    addStyle('.T'+s, 'top:' + p*96*s + 'px;');
    }


  addStyle('.tbLeft', 'top:' + p*0 + 'px; left:' + p*38 + 'px; width:' + p*10 + 'px; height:' + p*94 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.tbRight', 'top:' + p*0 + 'px; left:' + p*54 + 'px; width:' + p*10 + 'px; height:' + p*94 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.lrTop', 'top:' + p*38 + 'px; left:' + p*0 + 'px; width:' + p*94 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.lrBottom', 'top:' + p*54 + 'px; left:' + p*0 + 'px; width:' + p*94 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');

  addStyle('.rTop', 'top:' + p*38 + 'px; left:' + p*47 + 'px; width:' + p*47 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.rBottom', 'top:' + p*54 + 'px; left:' + p*47 + 'px; width:' + p*47 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.lTop', 'top:' + p*38 + 'px; left:' + p*0 + 'px; width:' + p*47 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.lBottom', 'top:' + p*54 + 'px; left:' + p*0 + 'px; width:' + p*47 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.bLeft', 'top:' + p*47 + 'px; left:' + p*38 + 'px; width:' + p*10 + 'px; height:' + p*47 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.bRight', 'top:' + p*47 + 'px; left:' + p*54 + 'px; width:' + p*10 + 'px; height:' + p*47 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.tLeft', 'top:' + p*0 + 'px; left:' + p*38 + 'px; width:' + p*10 + 'px; height:' + p*46 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.tRight', 'top:' + p*0 + 'px; left:' + p*54 + 'px; width:' + p*10 + 'px; height:' + p*46 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');

  addStyle('.brOuter', 'top:' + p*38 + 'px; left:' + p*38 + 'px; width:' + p*54 + 'px; height:' + p*54 + 'px; border-top:' + p*2 + 'px #888  solid; border-left:' + p*2 + 'px #888 solid; -webkit-border-top-left-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.brInner', 'top:' + p*54 + 'px; left:' + p*54 + 'px; width:' + p*38 + 'px; height:' + p*38 + 'px; border-top:' + p*2 + 'px #888  solid; border-left:' + p*2 + 'px #888  solid; -webkit-border-top-left-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.tlOuter', 'top:' + p*0 + 'px; left:' + p*0 + 'px; width:' + p*54 + 'px; height:' + p*54 + 'px; border-bottom:' + p*2 + 'px #888  solid; border-right:' + p*2 + 'px #888  solid; -webkit-border-bottom-right-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.tlInner', 'top:' + p*0 + 'px; left:' + p*0 + 'px; width:' + p*38 + 'px; height:' + p*38 + 'px; border-bottom:' + p*2 + 'px #888  solid; border-right:' + p*2 + 'px #888  solid; -webkit-border-bottom-right-radius:' + p*100 + 'px; position:absolute;');

  addStyle('.trOuter', 'top:' + p*0 + 'px; left:' + p*38 + 'px; width:' + p*54 + 'px; height:' + p*54 + 'px; border-bottom:' + p*2 + 'px #888  solid; border-left:' + p*2 + 'px #888  solid; -webkit-border-bottom-left-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.trInner', 'top:' + p*0 + 'px; left:' + p*54 + 'px; width:' + p*38 + 'px; height:' + p*38 + 'px; border-bottom:' + p*2 + 'px #888  solid; border-left:' + p*2 + 'px #888  solid; -webkit-border-bottom-left-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.blOuter', 'top:' + p*38 + 'px; left:' + p*0 + 'px; width:' + p*54 + 'px; height:' + p*54 + 'px; border-top:' + p*2 + 'px #888  solid; border-right:' + p*2 + 'px #888  solid; -webkit-border-top-right-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.blInner', 'top:' + p*54 + 'px; left:' + p*0 + 'px; width:' + p*38 + 'px; height:' + p*38 + 'px; border-top:' + p*2 + 'px #888  solid; border-right:' + p*2 + 'px #888  solid; -webkit-border-top-right-radius:' + p*100 + 'px; position:absolute;');


  addStyle('.car', 'width:' + p*96 + 'px; height:' + cellSize + 'px; position:absolute;');
  addStyle('.coupler', 'top:' + p*0  + 'px; left:' + p*46 +'px; width:' + p*10 +'px; height:' + cellSize + 'px; border-left:' + p*4 + 'px #1F1A17 solid; position:absolute;');
  addStyle('.blueTank',   'width:' + p*24 + 'px; height:' + p*80 + 'px; position:absolute; top:' + p*8 + 'px; left:' + p*36 + 'px; -webkit-border-radius:' + p*8 + 'px; background-color:#76C5F0; -webkit-border-radius: ' + p*100 +'px');
  addStyle('.orangeTank', 'width:' + p*24 + 'px; height:' + p*80 + 'px; position:absolute; top:' + p*8 + 'px; left:' + p*36 + 'px; -webkit-border-radius:' + p*8 + 'px; background-color:#F1A334;');
  addStyle('.blackCar',   'width:' + p*16 + 'px; height:' + p*72 + 'px; position:absolute; top:' + p*8 + 'px; left:' + p*36 + 'px; border:' + p*4 + 'px #555 solid; background-color:#000000;');
  addStyle('.greenCar',   'width:' + p*16 + 'px; height:' + p*72 + 'px; position:absolute; top:' + p*8 + 'px; left:' + p*36 + 'px; border:' + p*4 + 'px #3FB3A0 solid; background-color:#3C746B;');

  addStyle('.blueTrainRear',    'width:' + p*28 + 'px; height:' + p*36 + 'px; top:' + p*52 + 'px; left:' + p*34 + 'px;  background-color:#76C5F0; position:absolute; ');
  addStyle('.blueTrainBody',    'width:' + p*24 + 'px; height:' + p*60 + 'px; top:' + p*12 + 'px; left:' + p*36 + 'px; background-color:#76C5F0; position:absolute; ');
  addStyle('.blueTrainTank',    'width:' + p*12 + 'px; height:' + p*60 + 'px; top:' + p*10 + 'px; left:' + p*42 + 'px; background-color:#005BA1; -webkit-border-radius: ' + p*100 +'px; position:absolute; ');
  addStyle('.blueTrainCatcher', 'width:' + p*16 + 'px; height:' + p*16 + 'px; top:' + p*0  + 'px; left:' + p*40 + 'px; background-color:#76C5F0; position:absolute; -webkit-transform: rotate(45deg);');

  addStyle('.orangeTrainRear',    'width:' + p*28 + 'px; height:' + p*36 + 'px; top:' + p*52 + 'px; left:' + p*34 + 'px;  background-color:#F1A334; position:absolute; ');
  addStyle('.orangeTrainBody',    'width:' + p*24 + 'px; height:' + p*60 + 'px; top:' + p*12 + 'px; left:' + p*36 + 'px; background-color:#F1A334; position:absolute; ');
  addStyle('.orangeTrainTank',    'width:' + p*12 + 'px; height:' + p*60 + 'px; top:' + p*10 + 'px; left:' + p*42 + 'px; background-color:#DA251C; -webkit-border-radius: ' + p*100 +'px; position:absolute; ');
  addStyle('.orangeTrainCatcher', 'width:' + p*16 + 'px; height:' + p*16 + 'px; top:' + p*0  + 'px; left:' + p*40 + 'px; background-color:#F1A334; position:absolute; -webkit-transform: rotate(45deg);');

  addStyle('.greenTrainRear',    'width:' + p*28 + 'px; height:' + p*36 + 'px; top:' + p*52 + 'px; left:' + p*34 + 'px; background-color:#3FB3A0; position:absolute; ');
  addStyle('.greenTrainBody',    'width:' + p*24 + 'px; height:' + p*60 + 'px; top:' + p*12 + 'px; left:' + p*36 + 'px; background-color:#3FB3A0; position:absolute; ');
  addStyle('.greenTrainTank',    'width:' + p*12 + 'px; height:' + p*60 + 'px; top:' + p*10 + 'px; left:' + p*42 + 'px; background-color:#3C746B; -webkit-border-radius: ' + p*100 +'px; position:absolute; ');
  addStyle('.greenTrainCatcher', 'width:' + p*16 + 'px; height:' + p*16 + 'px; top:' + p*0  + 'px; left:' + p*40 + 'px; background-color:#3FB3A0; position:absolute; -webkit-transform: rotate(45deg);');

  addStyle('.blackTrainRear',    'width:' + p*28 + 'px; height:' + p*36 + 'px; top:' + p*52 + 'px; left:' + p*34 + 'px; background-color:#555; position:absolute; ');
  addStyle('.blackTrainBody',    'width:' + p*24 + 'px; height:' + p*60 + 'px; top:' + p*12 + 'px; left:' + p*36 + 'px; background-color:#555; position:absolute; ');
  addStyle('.blackTrainTank',    'width:' + p*12 + 'px; height:' + p*60 + 'px; top:' + p*10 + 'px; left:' + p*42 + 'px; background-color:#000; -webkit-border-radius: ' + p*10 +'px; position:absolute; ');
  addStyle('.blackTrainCatcher', 'width:' + p*16 + 'px; height:' + p*16 + 'px; top:' + p*0  + 'px; left:' + p*40 + 'px; background-color:#555; position:absolute; -webkit-transform: rotate(45deg);');

  }
var bgContext;
var trackContext;
function setupGridData(){
  dbuga('setupGridData()');
  tilesByGridXY={};
  for (x=0; x<cellsAcross; x++){
    for (y=0; y<cellsDown; y++){
      var gridXY="grid_"+x+"_"+y;
      var newArray=[];
      tilesByGridXY[gridXY]=newArray;
      }
    }
  trackContext.clearRect(0, 0, boardWidth, boardHeight);
  document.getElementById("trackCanvas").width=boardWidth;
  }
function fillBgCanvas(){
  bgContext.strokeStyle = "rgb(220, 220, 220)";
  radius=20*cellSize/96;
  for (x=0; x<cellsAcross; x++){
    for (y=0; y<cellsDown; y++){
      roundRect(bgContext, x*cellSize, y*cellSize, cellSize, cellSize, radius, false, true);
      }
    }
  //bgContext.fillStyle = "rgba(0,0,255,.5)";
  //bgContext.beginPath();
  //bgContext.arc(boardWidth/2,boardHeight/2, cellSize/2 ,0,6.29,true);
  //bgContext.fill();
  }
function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
  if (typeof stroke == "undefined" ) {
    stroke = true;
  }
  if (typeof radius === "undefined") {
    radius = 5;
  }
  ctx.beginPath();
  ctx.moveTo(x + radius, y);
  ctx.lineTo(x + width - radius, y);
  ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
  ctx.lineTo(x + width, y + height - radius);
  ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
  ctx.lineTo(x + radius, y + height);
  ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
  ctx.lineTo(x, y + radius);
  ctx.quadraticCurveTo(x, y, x + radius, y);
  ctx.closePath();
  if (stroke) {
    ctx.stroke();
  }
  if (fill) {
    ctx.fill();
  }        
}


//createCanvasTrack('lr', 2, 5)

function createCanvasTrack(theType, cellX, cellY){
  var originX=cellX*cellSize;
  var originY=cellY*cellSize;
  var unit=cellSize/12;

  // all ties
  if((menuObject["Scale"]["value"]=="O")||(menuObject["Scale"]["value"]=="HO")||(menuObject["Scale"]["value"]=="N")){    
    trackContext.globalCompositeOperation = "destination-over";
    // N default case
    var start=.05;
    var step=.1;
    if(menuObject["Scale"]["value"]=="N"){      
      trackContext.strokeStyle = "rgb(76,92,81)";
      trackContext.lineWidth = ""+Math.floor(5*unit)/10;
      }
    if(menuObject["Scale"]["value"]=="HO"){      
      trackContext.strokeStyle = "rgb(88,89,57)";
      trackContext.lineWidth = ""+Math.floor(4*unit)/10;
      start=0.05;
      step=.09;
      }
    if(menuObject["Scale"]["value"]=="O"){      
      trackContext.strokeStyle = "rgb(81,83,61)";
      trackContext.lineWidth = ""+Math.floor(8*unit)/10;
      start=.1;
      step=.4;
      }
    trackContext.beginPath();
    if((theType=="ts")||(theType=="td")){
      for (var y=start; y<=.5; y+=step){
        trackContext.moveTo(originX+4.5*unit, originY+y*cellSize);
        trackContext.lineTo(originX+7.5*unit, originY+y*cellSize);
        }
      }
    if((theType=="bs")||(theType=="bd")){
      for (var y=1-start; y>=.5; y-=step){
        trackContext.moveTo(originX+4.5*unit, originY+y*cellSize);
        trackContext.lineTo(originX+7.5*unit, originY+y*cellSize);
        }
      }
    if((theType=="ls")||(theType=="ld")){
      for (var x=start; x<=.5; x+=step){
        trackContext.moveTo(originX+cellSize*x, originY+4.5*unit);
        trackContext.lineTo(originX+cellSize*x, originY+7.5*unit);
        }
      }
    if((theType=="rs")||(theType=="rd")){
      for (var x=1-start; x>=.5; x-=step){
        trackContext.moveTo(originX+cellSize*x, originY+4.5*unit);
        trackContext.lineTo(originX+cellSize*x, originY+7.5*unit);
        }
      }
    if(theType=="lr"){
      for (var x=start; x<=1-start; x+=step){
        trackContext.moveTo(originX+cellSize*x, originY+4.5*unit);
        trackContext.lineTo(originX+cellSize*x, originY+7.5*unit);
        }
      }
    if(theType=="tb"){
      for (var y=start; y<=1-start; y+=step){
        trackContext.moveTo(originX+4.5*unit, originY+y*cellSize);
        trackContext.lineTo(originX+7.5*unit, originY+y*cellSize);
        }
      }
    if(theType=="br"){
      for (var deg=180+90*start; deg<=270-90*start/2; deg+=90*step){ // /2 not sure, floating point error?
        //dbuga(deg);
        trackContext.moveTo(originX+cellSize+4.5*unit*Math.cos(degToRad(deg)), originY+cellSize+4.5*unit*Math.sin(degToRad(deg)));
        trackContext.lineTo(originX+cellSize+7.5*unit*Math.cos(degToRad(deg)), originY+cellSize+7.5*unit*Math.sin(degToRad(deg)));
        }
      }
    if(theType=="bl"){
      for (var deg=270+90*start; deg<=360-90*start/2; deg+=90*step){
        //dbuga(deg);
        trackContext.moveTo(originX+4.5*unit*Math.cos(degToRad(deg)), originY+cellSize+4.5*unit*Math.sin(degToRad(deg)));
        trackContext.lineTo(originX+7.5*unit*Math.cos(degToRad(deg)), originY+cellSize+7.5*unit*Math.sin(degToRad(deg)));
        }
      }
    if(theType=="tl"){
      for (var deg=0+90*start; deg<=90-90*start/2; deg+=90*step){
        //dbuga(deg);
        trackContext.moveTo(originX+4.5*unit*Math.cos(degToRad(deg)), originY+4.5*unit*Math.sin(degToRad(deg)));
        trackContext.lineTo(originX+7.5*unit*Math.cos(degToRad(deg)), originY+7.5*unit*Math.sin(degToRad(deg)));
        }
      }
    if(theType=="tr"){
      for (var deg=90+90*start; deg<=180-90*start/2; deg+=90*step){
        //dbuga(deg);
        trackContext.moveTo(originX+cellSize+4.5*unit*Math.cos(degToRad(deg)), originY+4.5*unit*Math.sin(degToRad(deg)));
        trackContext.lineTo(originX+cellSize+7.5*unit*Math.cos(degToRad(deg)), originY+7.5*unit*Math.sin(degToRad(deg)));
        }
      }

    trackContext.stroke();
    }

  //normal two rails only
    trackContext.globalCompositeOperation = "source-over";

    if(menuObject["Scale"]["value"]=="N"){      
      trackContext.strokeStyle = "rgb(199,185,172)";
      }
    if(menuObject["Scale"]["value"]=="HO"){      
      trackContext.strokeStyle = "rgb(180,154,93)";
      }
    if(menuObject["Scale"]["value"]=="O"){      
      trackContext.strokeStyle = "rgb(113,103,101)";
      }
  trackContext.lineWidth = ""+Math.floor(3*unit)/10;
  trackContext.beginPath();
  if((theType=="ts")||(theType=="td")){
    trackContext.moveTo(originX+5*unit, originY);
    trackContext.lineTo(originX+5*unit, originY+cellSize/2);
    trackContext.moveTo(originX+7*unit, originY);
    trackContext.lineTo(originX+7*unit, originY+cellSize/2);
    if(menuObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+6*unit, originY);
      trackContext.lineTo(originX+6*unit, originY+cellSize/2);
      }
    }
  if((theType=="bs")||(theType=="bd")){
    trackContext.moveTo(originX+5*unit, originY+cellSize/2);
    trackContext.lineTo(originX+5*unit, originY+cellSize);
    trackContext.moveTo(originX+7*unit, originY+cellSize/2);
    trackContext.lineTo(originX+7*unit, originY+cellSize);
    if(menuObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+6*unit, originY+cellSize/2);
      trackContext.lineTo(originX+6*unit, originY+cellSize);
      }
    }
  if((theType=="ls")||(theType=="ld")){
    trackContext.moveTo(originX, originY+5*unit);
    trackContext.lineTo(originX+cellSize/2, originY+5*unit);
    trackContext.moveTo(originX, originY+7*unit);
    trackContext.lineTo(originX+cellSize/2, originY+7*unit);
    if(menuObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX, originY+6*unit);
      trackContext.lineTo(originX+cellSize/2, originY+6*unit);
      }
    }
  if((theType=="rs")||(theType=="rd")){
    trackContext.moveTo(originX+cellSize/2, originY+5*unit);
    trackContext.lineTo(originX+cellSize, originY+5*unit);
    trackContext.moveTo(originX+cellSize/2, originY+7*unit);
    trackContext.lineTo(originX+cellSize, originY+7*unit);
    if(menuObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+cellSize/2, originY+6*unit);
      trackContext.lineTo(originX+cellSize, originY+6*unit);
      }
    }
  if(theType=="lr"){
    trackContext.moveTo(originX, originY+5*unit);
    trackContext.lineTo(originX+cellSize, originY+5*unit);
    trackContext.moveTo(originX, originY+7*unit);
    trackContext.lineTo(originX+cellSize, originY+7*unit);
    if(menuObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX, originY+6*unit); //middle rail
      trackContext.lineTo(originX+cellSize, originY+6*unit);
      }
    }
  if(theType=="tb"){
    trackContext.moveTo(originX+5*unit, originY);
    trackContext.lineTo(originX+5*unit, originY+cellSize);
    trackContext.moveTo(originX+7*unit, originY);
    trackContext.lineTo(originX+7*unit, originY+cellSize);
    if(menuObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+6*unit, originY);  //center rail
      trackContext.lineTo(originX+6*unit, originY+cellSize);
      }
    }
  if(theType=="br"){
    trackContext.arc(originX+cellSize, originY+cellSize, 7*unit, 1 * Math.PI, 1.5 * Math.PI, false);
    trackContext.moveTo(originX+7*unit, originY+cellSize);
    trackContext.arc(originX+cellSize, originY+cellSize, 5*unit, 1 * Math.PI, 1.5 * Math.PI, false);
    if(menuObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+6*unit, originY+cellSize);
      trackContext.arc(originX+cellSize, originY+cellSize, 6*unit, 1 * Math.PI, 1.5 * Math.PI, false);
      }
    }
  if(theType=="bl"){
    trackContext.arc(originX, originY+cellSize, 7*unit, 0, 1.5 * Math.PI, true);
    trackContext.moveTo(originX+5*unit, originY+cellSize);
    trackContext.arc(originX, originY+cellSize, 5*unit, 0, 1.5 * Math.PI, true);
    if(menuObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+6*unit, originY+cellSize);
      trackContext.arc(originX, originY+cellSize, 6*unit, 0, 1.5 * Math.PI, true);
      }
    }
  if(theType=="tl"){
    trackContext.arc(originX, originY, 7*unit, 0, .5 * Math.PI, false);
    trackContext.moveTo(originX+5*unit, originY);
    trackContext.arc(originX, originY, 5*unit, 0, .5 * Math.PI, false);
    if(menuObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+6*unit, originY);
      trackContext.arc(originX, originY, 6*unit, 0, .5 * Math.PI, false);
      }
    }
  if(theType=="tr"){
    trackContext.arc(originX+cellSize, originY, 7*unit, Math.PI, .5 * Math.PI, true);
    trackContext.moveTo(originX+7*unit, originY);
    trackContext.arc(originX+cellSize, originY, 5*unit, Math.PI, .5 * Math.PI, true);
    if(menuObject["Scale"]["value"]=="O"){      
      trackContext.moveTo(originX+6*unit, originY);
      trackContext.arc(originX+cellSize, originY, 6*unit, Math.PI, .5 * Math.PI, true);
      }
    }

  //trackContext.quadraticCurveTo(originX+cellSize, originY, originX, originY);
  trackContext.stroke();
  }
function setupCanvas(){
  dbuga("setupCanvas()");
  htmlBlock="<canvas id=\"backgroundCanvas\" width=\""+boardWidth+"\" height=\""+boardHeight+"\" style=\"position:absolute;\"></canvas>";
  htmlBlock+="<canvas id=\"trackCanvas\" width=\""+boardWidth+"\" height=\""+boardHeight+"\" style=\"position:absolute;\"></canvas>";
  document.getElementById('canvasHolder').innerHTML=htmlBlock;
  bgContext = document.getElementById("backgroundCanvas").getContext("2d");
  trackContext = document.getElementById("trackCanvas").getContext("2d");

  }

function addStyle(styleName, styleCode){
  var style = document.createElement('style');
  style.type = 'text/css';
  style.innerHTML = styleName+' { '+styleCode+' }';
  document.getElementsByTagName('head')[0].appendChild(style);
  }
var screenWidth=100;
var screenHeight=100;
var viewportWidth=100;
var viewportHeight=100;
var screenAspect=screenWidth/screenHeight;
var viewportAspect=viewportWidth/viewportHeight;
var boardHeight=100;
var boardWidth=100;
var topPad=0;
var leftPad=0;
var wrapper;
function changeGeometry(){
  viewportWidth = window.innerWidth;
  viewportHeight = window.innerHeight;
  viewportAspect=viewportWidth/viewportHeight;
  dbuga("changeGeometry "+viewportWidth+" x "+viewportHeight+" viewportAspect:"+viewportAspect);
  changeView("changeGeometry");
  }

function mouseLevel(){
  if(platform=="android"){
    return false;
    }
  resetBoardTimersObjects();
  buildSequence=new Array();
  var fails=0;
  fails+=addColor(3,4);
  fails+=addColor(3,4);
  fails+=addColor(3,4);
  fails+=addColor(3,4);
  if(fails>0){
    //dbuga("retrying from scratch fails "+fails);
    ////mouseLevel();
    }
  }

var blingHeight=0;
var portraitScreenHeight=100;
var landscapeScreenHeight=100;
var totalCells;
var adHeight=0;
var adWidth=480;
function toggleBanner(){
  bannerEnabled=!(bannerEnabled);
  initGeometry();

  changeView("toggleBanner");
  populateModals();
  }
function adGeometry(){
/*
32 - phones in landscape
50 - phones in portrait
90 - tablets in either orientation
More specifically, if the screen height of a device is between 400 and 720, an ad height of 50 is used in both orientations; for screen heights greater than 720, a 90 ad height is used.
*/
  adHeight=0;
  if(bannerEnabled){
    adHeight=32; 
    adWidth=480; 
    if((viewportHeight>=420)&&(viewportHeight<=720)){
      adHeight=50;
      adWidth=320;
      } 
    if(viewportHeight>720){
      adHeight=90;
      adWidth=728;
      }
    document.getElementById('adHolder').style.backgroundImage="url(banners/"+adWidth+"x"+adHeight+".png)";
    }
  document.getElementById('wrapper').style.top=adHeight+"px";
  document.getElementById('adHolder').style.height=adHeight+"px";
  document.getElementById('adHolder').style.width=viewportWidth+"px";

  }

var colorsCanv;
var bannerEnabled=false;
var levelsCanv;
var levelsUp=false;
var menuCanv;
var menuUp=false;
var carsCanv;
var carsUp=false;
var graphicsCanv;
var graphicsUp=false;
var cameraCanv;
function initGeometry(){
  dbuga("initGeometry()");
  levelsCanv=document.getElementById("levelsCanvas");
  menuCanv=document.getElementById("menuCanvas");
  carsCanv=document.getElementById("carsCanvas");
  graphicsCanv=document.getElementById("graphicsCanvas");
  cameraCanv=document.getElementById("cameraCanvas");


  colorsCanv=document.getElementById("colorsCanvas");
  wrapper=document.getElementById("wrapper");
  screenWidth = screen.width;
  screenHeight = screen.height;
  viewportWidth = window.innerWidth;
  viewportHeight = window.innerHeight;

  if(screenWidth>screenHeight){
    screenWidth = screen.height;
    screenHeight = screen.width;
    dbuga('Landrod so swap screen dimensions');
    }// screen width is consistent with iOS now, width < height
  //dbuga("screenWidth="+screenWidth);
  //dbuga("screenHeight="+screenHeight);
  if(viewportWidth>viewportHeight){// landscape
    blingHeight=screenWidth-viewportHeight;
    }
  else{// portrait
    blingHeight=screenHeight-viewportHeight;
    }
  viewportAspect=viewportWidth/viewportHeight;
  portraitScreenHeight=screenHeight-blingHeight;
  landscapeScreenHeight=screenWidth-blingHeight;
  colorsHeight=64;
  if(screenHeight<500){colorsHeight=44;}
  screenAspect=screenWidth/screenHeight;
  if(screen.width==1680){// test iPhone dimension local

    screenWidth=320;
    screenHeight=480;

    screenWidth=414;
    screenHeight=736;
/*
    screenWidth=768;
    screenHeight=1024;

    screenWidth=600;
    screenHeight=1024;
*/
    viewportHeight=screenHeight;
    portraitScreenHeight= screenHeight;
    }
  document.getElementById('debugDiv').style.width=screenWidth+"px";
  
  //dbuga("initGeometry screen: "+screenWidth+" x "+screenHeight+" ");
  //dbuga("initGeometry viewport: "+ viewportWidth+" x "+ viewportHeight+" "+viewportAspect);
  //dbuga("initGeometry blingHeight: "+blingHeight);

  adGeometry();
  boardGeometry();
  }
var cellsByWidth=[
{"width":320, "O":4, "HO":5, "N":6},
{"width":375, "O":4, "HO":5, "N":6},
{"width":414, "O":4, "HO":6, "N":8},
{"width":600, "O":6, "HO":8, "N":10},
{"width":768, "O":6, "HO":9, "N":12},
{"width":1024, "O":8, "HO":12, "N":16}
]
function returnCellsAcross(width, scale){
  var a=3;
  for (var c=0; c<cellsByWidth.length; c++){
    var group=cellsByWidth[c];
    if(width>=group.width){a=group[scale];}
    }
  return a;
  }
var boardPad=0;
var space=0;
function boardGeometry(){
  var scale=menuObject["Scale"]["value"];
  cellsAcross=returnCellsAcross(screenWidth, scale)
  cellSize=Math.floor(10*screenWidth/cellsAcross)/10;
  //dbuga("cellSize="+cellSize);
  cubeSize=cellSize*shrink;
  cellsDown=Math.floor((portraitScreenHeight-44-13-adHeight)/cellSize);
  totalCells=cellsAcross*cellsDown;
  space=(screenHeight-cellsDown*cellSize-44-adHeight);
  boardPad=Math.floor(space/2);
  dbuga("boardGeometry()");
  dbuga(" - cellsAcross="+cellsAcross);
  dbuga(" - cellsDown="+cellsDown);
  dbuga(" - boardPad="+ boardPad);
  //dbuga(" - space="+space);

  boardWidth=screenWidth;
  boardHeight=cellsDown*cellSize;
  
  camera.style.webkitPerspective=boardHeight;
  dbuga(" - boardHeight="+boardHeight +" boardWidth="+boardWidth);

  //wrapperHeight=(cellsDown+1.5)*cellSize;
  wrapper.style.width=boardWidth+"px";
  wrapper.style.height=boardHeight+"px";
  wrapper.style.left=leftPad+"px";
  wrapper.style.top=topPad+"px";

  levelsCanv.width=screenWidth;
  levelsCanv.height=portraitScreenHeight-44-adHeight;
  levelsCanv.style.top=adHeight+"px";
  levelsCanv.style.left=screenWidth+"px";
  levelsCanv.style.backgroundColor="rgba(255,255,255,.75)";

  menuCanv.width=screenWidth;
  menuCanv.height=portraitScreenHeight-44-adHeight;
  menuCanv.style.top=adHeight+"px";
  menuCanv.style.left=screenWidth+"px";
  menuCanv.style.backgroundColor="rgba(255,255,255,.75)";

  carsCanv.width=screenHeight;
  carsCanv.height=landscapeScreenHeight-colorsHeight-adHeight;
  carsCanv.style.top=adHeight+"px";
  carsCanv.style.left=screenHeight+"px";
  carsCanv.style.backgroundColor="rgba(255,255,255,.75)";

  graphicsCanv.width=screenHeight;
  graphicsCanv.height=landscapeScreenHeight-colorsHeight-adHeight;
  graphicsCanv.style.top=adHeight+"px";
  graphicsCanv.style.left=screenHeight+"px";
  graphicsCanv.style.backgroundColor="rgba(255,255,255,.75)";

  colorsCanv.width=screenHeight;
  colorsCanv.height=64;
  colorsCanv.style.top=(landscapeScreenHeight-64)+"px";
  colorsCanv.style.left=0+"px";
  //colorsCanv.style.backgroundColor="rgba(33,33,33,.75)";

/*
  sdiv.style.width=(grid*10)+"px";
  sdiv.style.height=grid*8+"px";
  sdiv.style.fontSize=grid*4+"px";
  sdiv.style.left=(leftPad+boardWidth-grid*20)+"px";
  sdiv.style.top=(topPad+grid*2)+"px";
*/
  cellSizeHalf=cellSize/2;
  centerSize=cellSize/4;
  createInitialBuildSequence();
  setupClasses();
  setupCanvas();// maybe move to resetBoardTimersObjects() 
  fillBgCanvas(); //was makeGrid  
  }
var destMs;
function restartIntervals(){
  dbuga('restartIntervals()');
  minFramesPerSecond=999;
  //window.clearInterval(turnInterval);
  window.clearInterval(sourceInterval);
  window.clearInterval(destInterval);
  turnMs=Math.floor(1000/trainData.length);
  sourceMs=Math.floor(10000/sourceCount);
  destMs=Math.floor(1000/trainData.length);


  if(freezeMode == false){
    //turnInterval=window.setInterval(turnTick, turnMs);
    sourceInterval=window.setInterval(sourceTick, sourceMs);
    destInterval=window.setInterval(destTick, destMs);
    }
  }
var platform="unknown";
var filePath="";
function debugStorage(){
  //dbuga("musicOn:"+localStorage.getItem("musicOn")+" sfxOn:"+localStorage.getItem("sfxOn"));
  }
var atLevel=0;
var levelData=[

    {"fields":[1,1], "space":16, "tank":false},
    {"fields":[2,2], "space":24, "tank":false},
    {"fields":[1,1,1], "space":24, "tank":false},
    {"fields":[2,2,2], "space":36, "tank":false},
    {"fields":[3,3], "space":32, "tank":false},
    {"fields":[1,1,1,1], "space":32, "tank":false},

    {"fields":[2,2,2,2], "space":48, "tank":false},
    {"fields":[3,3,3], "space":48, "tank":false},

    {"fields":[3,3,3,3], "space":72, "tank":false},
    
    {"fields":[4,4,4], "space":80, "tank":false},
    {"fields":[4,4,4,4], "space":80, "tank":false},
    {"fields":[19], "space":80, "tank":true}
  ];


var colorByNum=["orange","black","blue","green"];

// Possible Cell Counts
/*
Small 6 or 8 levels iPhone 4
4   42  48

medium 8 or 10 iphone 5/6
medium 6 or 10 iphone 6+
5   54  60  
6   54  60
6+  48  60
 
large ipad 9 or 12
P   72  80


mp  70  77

42 
48 
54 
60
72 iPad banner
70 
77  
80 iPad

    {"fields":[1,1,1], "space":24, "tank":false},
    {"fields":[5], "space":24, "tank":true},


*/
/* ------------------------------ POPULATE MODALS ---------------------------------- */

var graphicsSelectedColorNum=0;
var graphicsSelectedGraphic=0;
var graphicsEditing=false;
function openGraphics(carButton){
  graphicsSelectedColorNum=carButton.c;
  graphicsSelectedGraphic=carButton.g;
  populateGraphics();
  openModal("graphics");
}
var graphicsButtons=[];
function populateGraphics(){
  dbuga('populateGraphics 0');
  graphicsCanv.width=screenHeight;
  var graphicsCtx=graphicsCanv.getContext('2d');
  graphicsCtx.lineWidth=cellSize/8;
  var graphic=graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic];




  var buttonWidth=cellSize*3;
  var buttonHeight=cellSize*1;
  var radius=cellSize/8;
  var pad=cellSize/10;
  var topPad=(landscapeScreenHeight-colorsHeight-adHeight-buttonHeight*4)/2;
  var leftPad=(screenHeight-buttonWidth*3)/2;
  graphicsButtons=[];

  var t=topPad+buttonHeight*3.25;
  var b=topPad+buttonHeight*4.25;
  if(graphicsEditing==false){
    graphicsButtons.push({"buttonId":"Done", "highlighted":false, "l":leftPad+buttonWidth*0,"r":leftPad+buttonWidth*1, "t":t,"b":b});
    graphicsButtons.push({"buttonId":"Camera", "highlighted":false,"l":leftPad+buttonWidth*1,"r":leftPad+buttonWidth*2, "t":t,"b":b});
    graphicsButtons.push({"buttonId":"Transparent", "highlighted":graphic.blackTrans,"l":leftPad+buttonWidth*2,"r":leftPad+buttonWidth*3, "t":t,"b":b});
    }
  else{
    graphicsButtons.push({"buttonId":"Save", "highlighted":true, "l":leftPad+buttonWidth*0,"r":leftPad+buttonWidth*1, "t":t,"b":b});
    graphicsButtons.push({"buttonId":"Retake", "highlighted":false, "l":leftPad+buttonWidth*1,"r":leftPad+buttonWidth*2, "t":t,"b":b});
    graphicsButtons.push({"buttonId":"Cancel", "highlighted":false, "l":leftPad+buttonWidth*2,"r":leftPad+buttonWidth*3, "t":t,"b":b});
    }
  

  for(var gb=0; gb<graphicsButtons.length; gb++){
    graphicsCtx.strokeStyle="rgba(42,42,42,.25)";
    graphicsCtx.fillStyle="rgba(255,255,255,1)";
    if(graphicsButtons[gb].highlighted){graphicsCtx.fillStyle=highlighted;}
    roundRect(graphicsCtx, graphicsButtons[gb].l+pad, graphicsButtons[gb].t+pad, buttonWidth-pad*2, buttonHeight-pad*2, radius, true, true);
    var cx=graphicsButtons[gb].l/2+graphicsButtons[gb].r/2;
    var cy=graphicsButtons[gb].t/2+graphicsButtons[gb].b/2;
    graphicsCtx.font=Math.floor(buttonHeight/2)+"px akzi";
    graphicsCtx.fillStyle="black";
    graphicsCtx.textAlign="center";
    graphicsCtx.textBaseline="middle";
    graphicsCtx.fillText(graphicsButtons[gb].buttonId, cx,cy);
    }

  var carButton={"buttonId":"car"}
  carButton.c=graphicsSelectedColorNum;
  carButton.g= graphicsSelectedGraphic;
  carButton.l=leftPad;
  carButton.r=leftPad+buttonWidth*3;
  carButton.t=topPad;
  carButton.b=topPad+buttonHeight*3;
  carButton.ref=graphic.ref;
  //graphicsButtons.push(carButton);
  var imageObj = imgRefs["boxside"+colorArray[carButton.c]];
  graphicsCtx.drawImage(imageObj, carButton.l, carButton.t, buttonWidth*3, buttonHeight*3);
  //dbuga('populateGraphics 9');

  graphicsCtx.drawImage(carButton.ref, carButton.l, carButton.t, buttonWidth*3, buttonHeight*3);
  //cameraCanv.style.display="none";
  dbuga('populateGraphics 10');

  }
var carsButtons=[];
function populateCars(){
  dbuga('populateCars()');
  carsButtons=[];
  var buttonWidth=cellSize*3;
  var buttonHeight=cellSize*1;
  var pad=cellSize/2;
  var radius=cellSize/12;

  var topPad=(landscapeScreenHeight-colorsHeight-adHeight-buttonHeight*4)/2;
  var leftPad=(screenHeight-buttonWidth*3)/2;
  //dbuga("topPad="+topPad);
  //dbuga("leftPad="+leftPad);
  var carsCtx=carsCanv.getContext('2d');
  carsCtx.lineWidth=cellSize/16;

//[graphicsSelectedGraphic];
  for (var i=0; i<graphicsByColor[colorArray[focusTrain]].length; i++){
    var graphic=graphicsByColor[colorArray[focusTrain]][i];
    
    var carButton={"buttonId":"car_"+focusTrain+"-"+i};
    //dbuga(carButton.buttonId);
    carButton.c=focusTrain;
    carButton.g=i;
    carButton.l=leftPad+buttonWidth*graphic.x;
    carButton.r=leftPad+buttonWidth*graphic.x+buttonWidth;
    carButton.t=topPad+buttonHeight*graphic.y;
    carButton.b=topPad+buttonHeight*graphic.y+buttonHeight;
    carButton.ref=graphic.ref;
    carsButtons.push(carButton);
    }

/*
  for (var c=0; c<4; c++){
    for (var g=0; g<3; g++){
    //dbuga(b);
      var carButton={"buttonId":"car_"+c+"-"+g};

      carButton.c=c;
      carButton.g=g;
      carButton.l=leftPad+buttonWidth*g;
      carButton.r=leftPad+buttonWidth*g+buttonWidth;
      carButton.t=topPad+buttonHeight*c;
      carButton.b=topPad+buttonHeight*c+buttonHeight;
      carButton.ref=graphicsByColor[colorArray[c]][g].ref;
      carsButtons.push(carButton);
      }
    }
*/
  for (var cb=0; cb<carsButtons.length; cb++){
    var carButton=carsButtons[cb];

    carsCtx.strokeStyle="rgba(42,42,42,.25)";
    carsCtx.fillStyle="rgba(255,255,255,.9)";
    roundRect(carsCtx, carButton.l, carButton.t, buttonWidth, buttonHeight, radius, true, false);
    
   
    var imageObj = imgRefs["boxside"+colorArray[carButton.c]];
    carsCtx.drawImage(imageObj, carButton.l, carButton.t, buttonWidth, buttonHeight);
    

    carsCtx.drawImage(carButton.ref, carButton.l, carButton.t, buttonWidth, buttonHeight);
    
  }
}
var menuButtons=[
{"y":8, "x":-4, "label":"Help", "l":0, "r":0, "t":0, "b":0},
{"y":8, "x":4, "label":"Done", "l":0, "r":0, "t":0, "b":0}
];
function populateMenu(){
  var g=screenWidth/16;
  var buttonWidth=g*6;
  var buttonHeight=g*2;
  var pad=g/2;
  var radius=g/6;
  var cx=8;
  var cy=(screenHeight/2-screenWidth/2)/g+cx;
  //dbuga("cy "+cy);
  var menuCtx=menuCanv.getContext('2d');
  for (var b=0; b<menuButtons.length; b++){
    //dbuga(buttonHeight);
    menuButtons[b].l=(cx+menuButtons[b].x)*g-buttonWidth/2;
    menuButtons[b].r=(cx+menuButtons[b].x)*g+buttonWidth/2;
    menuButtons[b].t=(cy+menuButtons[b].y)*g-buttonHeight/2;
    menuButtons[b].b=(cy+menuButtons[b].y)*g+buttonHeight/2;
    
    menuCtx.strokeStyle="rgba(42,42,42,.75)";
    menuCtx.fillStyle="rgba(225,255,255,.9)";
    menuCtx.lineWidth=g/4;
    roundRect(menuCtx, menuButtons[b].l, menuButtons[b].t, buttonWidth, buttonHeight, radius, true, true);
    var bcx=menuButtons[b].l/2+menuButtons[b].r/2;
    var bcy=menuButtons[b].t/2+menuButtons[b].b/2;
    var menuFont=Math.floor(buttonHeight/2)+"px akzi";
    //dbuga('menuFont='+menuFont);
    menuCtx.font=menuFont;
    menuCtx.lineWidth=g/16;

    menuCtx.strokeStyle="#666";
    menuCtx.fillStyle="#666";
    menuCtx.textAlign="center";
    menuCtx.textBaseline="middle";
    menuCtx.fillText(menuButtons[b].label, bcx,bcy);
    menuCtx.strokeText(menuButtons[b].label, bcx,bcy);
  }
}
var levelButtons=[];
function populateLevels(){
  levelButtons=[];
  dbuga('populateLevels()');
  for (var b=0; b<levelData.length; b++){
    if(levelData[b].space <= totalCells){
      levelButtons.push({"num":b});
      }
    }
  var buttonsAcross=2;
  var buttonSize=cellSize*1.75;
  if(levelButtons.length>8){
    buttonsAcross=3;
    buttonSize=cellSize*2;
    }
  var buttonsDown=levelButtons.length/buttonsAcross;
  var leftPad=(screenWidth-buttonsAcross*buttonSize)/2;
  var topPad=(portraitScreenHeight-adHeight-buttonsDown*buttonSize-cellSize-44)/2;

  for (var b=0; b<levelButtons.length; b++){
    levelButtons[b].l=b%buttonsAcross*buttonSize+leftPad;
    levelButtons[b].r=b%buttonsAcross*buttonSize+leftPad+buttonSize;
    levelButtons[b].t=Math.floor(b/buttonsAcross)*buttonSize+topPad;
    levelButtons[b].b=Math.floor(b/buttonsAcross)*buttonSize+topPad+buttonSize;
    }
  var cancelButton={"num":levelButtons.length, "l":leftPad, "r":screenWidth-leftPad, "t":topPad+buttonsDown*buttonSize, "b":topPad+buttonsDown*buttonSize+cellSize};
  levelButtons.push(cancelButton);
  drawLevels();
  }
var highlighted="rgba(255,255,100,1)";
function drawLevels(){
  var buttonsAcross=2;
  var buttonSize=cellSize*1.75;
  var fieldsAcross=4;
  var offset=1.5;

  if(levelButtons.length>9){
    fieldsAcross=5;
    offset=2;
    buttonsAcross=3;
    buttonSize=cellSize*2;
    }

  var buttonSize=cellSize*2;
  var pad=buttonSize/16;
  var radius=buttonSize/12;
  var fieldRad=buttonSize/16;
  var baseRad=buttonSize/15;
  var fieldSpread=buttonSize/6;
  var levelsCtx=levelsCanv.getContext('2d');
  levelsCtx.lineWidth=cellSize/6;
  for (var b=0; b<levelButtons.length; b++){
    levelsCtx.strokeStyle="rgba(42,42,42,.75)";
    levelsCtx.fillStyle="rgba(225,255,255,.9)";
    if(atLevel==b){
      levelsCtx.fillStyle=highlighted;
      }
    var w=levelButtons[b].r-levelButtons[b].l-pad*2;
    var h=levelButtons[b].b-levelButtons[b].t-pad*2;
    roundRect(levelsCtx, levelButtons[b].l+pad, levelButtons[b].t+pad, w, h, radius, true, true);
    var cx=levelButtons[b].l/2+levelButtons[b].r/2;
    var cy=levelButtons[b].t/2+levelButtons[b].b/2;
    if(b<levelButtons.length-1){
      var req=0;
      for(var c=0;c<levelData[b].fields.length;c++){
        
        var color=rgbArray[c];
        levelsCtx.fillStyle=color;
           
        for(var f=0; f<=levelData[b].fields[c]; f++){
          req++;
          var useF=f%5;
          if(f !=useF){yAdd+=fieldSpread;}
          yAdd=fieldSpread*Math.floor(f/5);
          var x=cx+(useF-offset)*fieldSpread;
          var y=cy+(c-offset)*fieldSpread;
          if(f==0){
            levelsCtx.beginPath();
            levelsCtx.arc(x,y+yAdd,baseRad,0,Math.PI*2,true);
            levelsCtx.fill();
            }
          else{
            roundRect(levelsCtx, x-fieldRad, y+yAdd-fieldRad,fieldRad*2,fieldRad*2, fieldRad/3, true, false);
            }
          }
        }
      req*=4;
      levelsCtx.font=Math.floor(fieldSpread)+"px akzi";
      levelsCtx.fillStyle="black";
      levelsCtx.textAlign="center";
      levelsCtx.textBaseline="middle";
      levelsCtx.fillText(req+" "+levelData[b].space, cx,cy+fieldSpread*2);
      }
    else{
      levelsCtx.font=Math.floor(fieldSpread)+"px akzi";
      levelsCtx.fillStyle="black";
      levelsCtx.textAlign="center";
      levelsCtx.textBaseline="middle";
      levelsCtx.fillText("CANCEL "+atLevel, cx,cy);
      }
    }
  }

var visHeight=100;
function openModal(modal){
  closeModals();
  camera.style.webkitFilter="blur(5px)";
  if(modal=="levels"){
    levelsCanv.style.left=0+"px";
    levelsUp=true;
    }
  if(modal=="menu"){
    menuCanv.style.left=0+"px";
    menuUp=true;
    menuDraw();
    dbuga('openModal menuUp='+menuUp);
    }
  if(modal=="cars"){
    carsCanv.style.left=0+"px";
    carsUp=true;
    //dbuga('openModals() updateColorsCanv')
    updateColorsCanv();
    }
  if(modal=="graphics"){
    //dbuga('openModals() updateColorsCanv')
    graphicsCanv.style.left=0+"px";
    graphicsUp=true;
    updateColorsCanv();
    }
  }
function closeModals(){
  dbuga('closeModals');
  levelsCanv.style.left="-"+screenWidth+"px";
  levelsUp=false;
  menuCanv.style.left="-"+screenWidth+"px";
  menuUp=false;
  carsCanv.style.left="-"+screenHeight+"px";
  carsUp=false;
  graphicsCanv.style.left="-"+screenHeight+"px";
  graphicsUp=false;
  updateColorsCanv();
  graphicsEditing=false;
  camera.style.webkitFilter="none";
  
  dbug('')
  }
function changeView(caller){
  dbuga("changeView in "+caller+" shooting="+shooting);
  if(shooting){return false;}
  closeModals();
  if(viewportAspect>1){
    document.getElementById("navDiv").style.display="none";
    document.getElementById("uiHolder").style.display="none";
    document.getElementById("prerails").style.display="none";
    //dbuga('changeView() updateColorsCanv')
    updateColorsCanv();
    colorsCanv.style.display="block";
    visHeight=viewportHeight-adHeight;
    camera.style.marginTop= 0 +"px";

    }
  else{
    colorsCanv.style.display="none";
    document.getElementById("navDiv").style.display="block";
    document.getElementById("uiHolder").style.display="block";
    document.getElementById("prerails").style.display="block";
    //document.getElementById("highlighter").style.display="block";
    styleNavDiv(); //in nav.js
    visHeight=boardHeight;
    camera.style.marginTop= boardPad +"px";
    }
  document.getElementById("wrapper").style.width= viewportWidth +"px";
  document.getElementById("wrapper").style.height= viewportHeight +"px";
  camera.style.width= viewportWidth +"px";
  camera.style.height= visHeight +"px";
  zoom.style.width= viewportWidth +"px";
  zoom.style.height= visHeight +"px";
  table.style.width= boardWidth +"px";
  table.style.height= boardHeight +"px";
  if(viewportAspect<1){fixCamera();}
  adGeometry();
  }
function init(){
  dbuga('init() '+screen.width);
  if(screen.width==1680){
    //dbuga('local init()');
    initSession();
    }
  }
function onDeviceReady(){
  dbuga('onDeviceReady() so initSession');
  initSession();
  }  
function initStorage(){
  dbuga('initStorage();');
  localStorage.setItem("initialized", "true");
  localStorage.setItem("Music", menuObject["Music"]["value"]);
  localStorage.setItem("Sounds", menuObject["Sounds"]["value"]);
  localStorage.setItem("Scale", menuObject["Scale"]["value"]);
  localStorage.setItem("Detail", menuObject["Detail"]["value"]);
  }
function saveStorage(){
  localStorage.setItem("Music", menuObject["Music"]["value"]);
  localStorage.setItem("Sounds", menuObject["Sounds"]["value"]);
  localStorage.setItem("Scale", menuObject["Scale"]["value"]);
  localStorage.setItem("Detail", menuObject["Detail"]["value"]);
  }
function loadStorage(){
  menuObject["Music"]["value"]=localStorage.getItem("Music");
  menuObject["Sounds"]["value"]=localStorage.getItem("Sounds");
  menuObject["Scale"]["value"]=localStorage.getItem("Scale");
  menuObject["Detail"]["value"]=localStorage.getItem("Detail");
  var keys=Object.keys(menuObject);
  for (var k=0; k<keys.length; k++){
    //dbuga(keys[k]);
    var values=menuObject[keys[k]]['values'];
    for (var v=0; v<values.length; v++){
      if(menuObject[keys[k]].value==values[v]){
        menuObject[keys[k]].pos=v-1;
        }
      }
    }
  }
var menuObject={
  "Music":{"value":"On", "pos":0, "values":["Off", "On", "Classic"], "t":0, "r":0, "b":0, "l":0},
  "Sounds":{"value":"On", "pos":0,  "values":["Off", "On", "Classic"], "t":0, "r":0, "b":0, "l":0},
  "Scale":{"value":"O", "pos":0,  "values":["O", "HO", "N"], "t":0, "r":0, "b":0, "l":0},
  "Detail":{"value":"Med", "pos":0,  "values":["Low", "Med", "High"], "t":0, "r":0, "b":0, "l":0}
};
var detailByValue={"Low":3, "Med":6, "High":9};
function initSession(){
  dbuga('initSession()');
  if (localStorage.getItem("initialized") === null) {
    initStorage();
    }
  loadStorage();
  
  initGraphicsByColor();
  camera=document.getElementById("cameraDiv");
  table=document.getElementById("tableDiv");
  zoom=document.getElementById("zoomDiv");

  //dbuga('init()');
  document.addEventListener("pause", pauseGame, false);
  document.addEventListener("resume", resumeGame, false);
  //debugStorage(); 
  var wLoc=""+window.location+"";
  if(wLoc.indexOf("file:///")==0){
    platform="local";
    if(wLoc.indexOf("file:///var/mobile")==0){platform="dreamfreeze";}
    if(wLoc.indexOf("file:///android_asset")==0){platform="android";}
    }
  if(wLoc.indexOf("http://")==0){platform="web";}
  //should be good for android and iOS
  var path = window.location.pathname;
  path = path.substr( path, path.length - 10 );
  filePath= '' + path+'sounds';
  if(platform=="local"){filePath="sounds";}   
  if(platform=="web"){filePath="sounds";} 
  //dbug(JSON.stringify(localStorage));  
  genericDefault("sfxOn", "true");
  genericDefault("musicOn", "true");
  //debugStorage();

  //dbuga('initSound()');


  ////initSound();

  initGeometry();
  setupNav();
  setupFaceData();

  imgRefs["tanksideblack"]=document.getElementById('tanksideblack');
  imgRefs["tanktopblack"]=document.getElementById('tanktopblack');
  imgRefs["tankendblack"]=document.getElementById('tankendblack');
  var detail=detailByValue[menuObject["Detail"]["value"]];
  var scaleString='scale3d('+1/detail+', '+1/detail+', '+1/detail+')';
  var style = document.createElement('style');
  style.type = 'text/css';
  style.innerHTML = '';
  for(var c=0; c<4; c++){
    var color=colors[c];
    for(var f=0; f<faceData.engine.length; f++){
      style.innerHTML += '.'+color+'engine' + f + '{-webkit-transform: ' + faceData.engine[f].trans + ' '+scaleString+';}';
      }  

    for(var f=0; f<faceData.box.length; f++){
      style.innerHTML += '.'+color+'box' + f + '{-webkit-transform: ' + faceData.box[f].trans + ' '+ scaleString +';}';
      }  
    }  
  for(var f=0; f<faceData.tank.length; f++){
    style.innerHTML += '.blacktank' + f + '{-webkit-backface-visibility:visible; -webkit-transform: ' + faceData.tank[f].trans + ' '+ scaleString +';}';
    }  
  localStorageToImages();
  
  document.getElementsByTagName('head')[0].appendChild(style);

  document.addEventListener('deviceready', function () {
    
    ////window.plugin.CanvasCamera.initialize(cameraCanv);
    }, false);

  dbuga('end of initSession so start preloading');
  window.setTimeout('preloadTick()',10);
  }
function measureLocalStorage(){
  for(var x in localStorage){
    //dbuga(x+"="+((localStorage[x].length * 2)/1024/1024).toFixed(2)+" MB");
    }
  }
function localStorageToImages(){

  if(localStorage.getItem('graphicsByColor') != null){
    graphicsByColor=JSON.parse(localStorage.getItem('graphicsByColor'));
    }
  for (var d=0; d<12; d++){
    if(localStorage.getItem('default'+d)!=null){
      document.getElementById('default'+d).src=localStorage.getItem('default'+d);
      }
    }
  }
function resumeInit(){
  dbuga('resumeInit()');
  changeView("resumeInit");
  resetBoardTimersObjects();
  rebuildSequence();
  document.getElementById('debugDiv').style.width=screenWidth+"px";

  populateModals();
  transmitBgMusicState();
  requestAnimationFrame(rafTick);
  secondInterval=window.setInterval("secondTick()", 1000);
  }
var frames=0;
var secondInterval;
function populateModals(){
  dbuga('populateModals()');
  populateLevels();
  //populateMenu();
  populateCars();
  //populateGraphics();

}
var minFramesPerSecond=999;
function secondTick(){
  //dbug("secondTick frames "+frames);
  if(carData.length>0){
    //dbug(progTransform(carData[0].animCache, trainData[0].prog));
    }
  if(minFramesPerSecond > frames){
    minFramesPerSecond=frames;
    }
  frames=0;
  }
var turnFrames=0;
var camPos={"x":0, "y":0, "d":0};
function rafTick(nowMs){
  turnFrames++;
  var framesPerTurn=turnMs/17;
  if(turnFrames>=framesPerTurn){
    turnFrames=0;
    turnTick();
    //dbuga('turn');
  }
  frames++;
  camPos= returnProgPos(trainData[focusTrain], trainData[focusTrain].prog);
  for(var t=0; t<trainData.length; t++){
    //if((trainData[t].prevX != trainData[t].nextX)||(trainData[t].prevY != trainData[t].nextY)){
    if(trainData[t].moving){
      trainData[t].prog+=1/60;// maybe set proportional to frame ms to maintain sim speed
      var ref=trainData[t].ref;
      ref.style.webkitTransform=returnProgTransform(trainData[t], trainData[t].prog);
    }
  }
  testString="";
  for(var c=0; c<carData.length; c++){
    if(carData[c].attached){
      //if(trainData[carData[c].trainNum].moving){
        var ref=carData[c].ref;
        ref.style.webkitTransform=returnProgTransform(carData[c], trainData[carData[c].trainNum].prog);
      //}
    }
  }
  for(var h=0; h<hideQueue.length; h++){
    hideQueue[h].style.opacity=0;
  }
  for(var s=0; s<showQueue.length; s++){
    showQueue[s].style.opacity=1;
  }
  hideQueue=[];
  showQueue=[];


  //ported 
  if(combinedZoom[focusTrain]>100){
    combinedZoom[focusTrain]=100;
    }
  if(combinedZoom[focusTrain]<0){
    combinedZoom[focusTrain]=0;
    }
  cameraDistancePercent=100-combinedZoom[focusTrain];
  cameraTilt=90*(combinedZoom[focusTrain]/100);

  //cameraXpercent=100-100*trainPos[focusTrain].x;
  //cameraYpercent=100-100*trainPos[focusTrain].y;

  if(viewportAspect>1){
    locateCamera();
    }



  //if(freezeMode==false){window.setTimeout("requestAnimationFrame(rafTick)", 10);}
  if(freezeMode==false){requestAnimationFrame(rafTick);}
}
var hideQueue=[];
var showQueue=[];
var testStr="";
var soundObject={};
function initSound(){
  dbuga('initSound()');
  loopLoad("measure_loop_inst");
  oneShotLoad("laytrack");
  oneShotLoad("carstart");
  oneShotLoad("carstop");
  oneShotLoad("trainstart");
  oneShotLoad("trainpause");
  oneShotLoad("applause");
  }

function setupNav(){
  dbuga('setupNav()');
  var navDivRef=createNavDiv();
  styleNavDiv();
  //document.getElementById('uiHolder').style.top=boardHeight+"px";

  var useWidth=320/4;
  
  //addControl("Music", "Music", "right", useWidth);
  //addControl("Sfx", "Sounds", "right", useWidth);
  addControl("menu", "Menu", "left", useWidth);
  addControl("level", "Level", "left", useWidth);
  addControl("reset", "Reset", "left", useWidth);
  addControl("undo", "Undo", "right", useWidth);

  document.getElementById('undo_label').style.opacity=".5";
  //styleNavDiv();
  }

function resetBoardTimersObjects(){
  dbuga('resetBoardTimersObjects()');
  setupGridData();
  closeHelp();
  collisionData=new Object();
  possibleObject['blue']=0;
  possibleObject['black']=0;
  possibleObject['orange']=0;
  possibleObject['green']=0;
  scoreObject['blue']=0;
  scoreObject['black']=0;
  scoreObject['orange']=0;
  scoreObject['green']=0;
  zeroProgressBar();
  fullCellGlom="";
  //window.clearInterval(turnInterval);
  window.clearInterval(sourceInterval);
  colorCycle=0;
  sourceCount=0;
  destCount=0;
  carData=[];
  trainData=[];
  sourceData=[];
  destData=[];
  checkTrainNum=0;
  checkSourceNum=0;
  document.getElementById('trainHolder').innerHTML="";
  document.getElementById('gridHolder').innerHTML="";
  makeGrid();
  }

//build level functions

function addColor(fields, barrels){
  color=colorList[Math.floor(colorCycle)];
  colorCycle+=1;
  if(colorCycle>=4){
    colorCycle=0;
    } 
  var fails=randomTileGroup(color, fields, barrels);
  return fails;
  }
function createInitialBuildSequence(){
  //dbuga('createInitialBuildSequence() '+cellsAcross);
  var x0=1;
  var y0=0;
  var x1=cellsAcross-2;
  var y1=cellsDown-1;
  buildSequence=[];

  buildSequence.push(new buildObject("train", "orange", "b", x0, y0, 0));

  buildSequence.push(new buildObject("dest", "orange", "b", x0, y0, 0));
  buildSequence.push(new buildObject("track", "", "tl", x0, y0+1, 0));
  buildSequence.push(new buildObject("track", "", "tr", x0, y0+1, 0));

  buildSequence.push(new buildObject("source", "orange", "t", x1, y1, 2));
  buildSequence.push(new buildObject("track", "", "bl", x1, y1-1, 0));
  buildSequence.push(new buildObject("track", "", "br", x1, y1-1, 0));

  buildSequence.push(new buildObject("source", "orange", "t", x0, y1, 2));
  buildSequence.push(new buildObject("track", "", "bl", x0, y1-1, 0));
  buildSequence.push(new buildObject("track", "", "br", x0, y1-1, 0));

  buildSequence.push(new buildObject("track", "", "br", x0-1, y0+1, 0));
  buildSequence.push(new buildObject("track", "", "bl", x1+1, y0+1, 0));

  buildSequence.push(new buildObject("track", "", "tl", x1+1, y1-1, 0));
  buildSequence.push(new buildObject("track", "", "tr", x0-1, y1-1, 0));
  for(var x=x0; x<=x1; x++){
    buildSequence.push(new buildObject("track", "", "lr", x, y0+1, 0));
    buildSequence.push(new buildObject("track", "", "lr", x, y1-1, 0));
    }
  for(var y=y0+2; y<y1-1; y++){
    buildSequence.push(new buildObject("track", "", "tb", x0-1, y, 0));
    buildSequence.push(new buildObject("track", "", "tb", x1+1, y, 0));
    }

  //buildSequence.push(new buildObject("track", "", "bl", 2, 3, 0));
  
  //if(cellsAcross==8){createInitialBuildSequence768();}
  //else{createInitialBuildSequence320();}
  }
function createInitialBuildSequence768(){
  buildSequence=[];
  buildSequence.push(new buildObject("dest", "orange", "t", 2, 4, 0));
  buildSequence.push(new buildObject("train", "orange", "b", 6, 2, 0));
  buildSequence.push(new buildObject("source", "orange", "t", 5, 4, 2));
  //buildSequence.push(new buildObject("source", "orange", "t", 4, 6, 2));

  buildSequence.push(new buildObject("track", "", "bl", 2, 3, 0));
  buildSequence.push(new buildObject("track", "", "br", 2, 3, 0));
  buildSequence.push(new buildObject("track", "", "lr", 2, 3, 0));

  buildSequence.push(new buildObject("track", "", "bl", 5, 3, 0));
  buildSequence.push(new buildObject("track", "", "br", 5, 3, 0));
  buildSequence.push(new buildObject("track", "", "lr", 5, 3, 0));

  buildSequence.push(new buildObject("track", "", "lr", 3, 3, 0));
  buildSequence.push(new buildObject("track", "", "lr", 4, 3, 0));

  buildSequence.push(new buildObject("track", "", "tl", 6, 3, 0));
  buildSequence.push(new buildObject("track", "", "tb", 6, 2, 0));
  buildSequence.push(new buildObject("track", "", "bl", 6, 1, 0));

  buildSequence.push(new buildObject("track", "", "lr", 2, 1, 0));
  buildSequence.push(new buildObject("track", "", "lr", 3, 1, 0));
  buildSequence.push(new buildObject("track", "", "lr", 4, 1, 0));
  buildSequence.push(new buildObject("track", "", "lr", 5, 1, 0));

  buildSequence.push(new buildObject("track", "", "tr", 1, 3, 0));
  buildSequence.push(new buildObject("track", "", "tb", 1, 2, 0));
  buildSequence.push(new buildObject("track", "", "br", 1, 1, 0));
  }
  
function createInitialBuildSequence320(){
  buildSequence=[];
  buildSequence.push(new buildObject("dest", "orange", "t", 1, 4, 0));
  buildSequence.push(new buildObject("train", "orange", "b", 3, 1, 0));
  buildSequence.push(new buildObject("source", "orange", "t", 2, 4, 2));

  buildSequence.push(new buildObject("track", "", "bl", 1, 3, 0));
  buildSequence.push(new buildObject("track", "", "br", 1, 3, 0));
  buildSequence.push(new buildObject("track", "", "lr", 1, 3, 0));

  buildSequence.push(new buildObject("track", "", "bl", 2, 3, 0));
  buildSequence.push(new buildObject("track", "", "br", 2, 3, 0));


  buildSequence.push(new buildObject("track", "", "lr", 2, 3, 0));


  buildSequence.push(new buildObject("track", "", "tl", 3, 3, 0));
  buildSequence.push(new buildObject("track", "", "tb", 3, 2, 0));
  buildSequence.push(new buildObject("track", "", "bl", 3, 1, 0));

  buildSequence.push(new buildObject("track", "", "lr", 1, 1, 0));
  buildSequence.push(new buildObject("track", "", "lr", 2, 1, 0));

  buildSequence.push(new buildObject("track", "", "tr", 0, 3, 0));
  buildSequence.push(new buildObject("track", "", "tb", 0, 2, 0));
  buildSequence.push(new buildObject("track", "", "br", 0, 1, 0));

  }

function buildObject(type,color,dir,x,y, barrels){
  this.type=type;
  this.color=color;
  this.dir=dir;
  this.x=x;
  this.y=y;
  this.barrels=barrels;
  }
function randomTileGroup(color, fields, barrels){
  var fails=0;
  posObject=viableRandomPosition();
  //dbuga(posObject.success+" "+posObject.x+" "+posObject.y);
  if(posObject.success==true){
    var buildItem=new Object();
    buildItem.type="dest";
    buildItem.color=color;
    buildItem.dir= posObject.dir;
    buildItem.x=posObject.x;
    buildItem.y=posObject.y;
    buildSequence.push(buildItem);

    var buildItem=new Object();
    buildItem.type="train";
    buildItem.color=color;
    buildItem.dir= posObject.dir;
    buildItem.x=posObject.x;
    buildItem.y=posObject.y;
    buildSequence.push(buildItem);

    destData.push(destObject(color, posObject.dir, posObject.x, posObject.y));
    var t=trainObject(color, posObject.x, posObject.y, posObject.dir);
    trainData.push(t);
    }
  else{
    fails++;
    }
  for (f=0; f<fields; f++){  
    posObject=viableRandomPosition();
    if(posObject.success==true){
      var buildItem=new Object();
      buildItem.type="source";
      buildItem.color=color;
      buildItem.dir=posObject.dir;
      buildItem.x=posObject.x;
      buildItem.y=posObject.y;
      buildItem.barrels=barrels;
      buildSequence.push(buildItem);
      sourceData.push(sourceObject(color, posObject.dir, posObject.x, posObject.y, barrels));
      displayBarrels("grid_"+posObject.x+"_"+posObject.y, barrels); 
      }
    else{
      fails++;
      }
    }
  return fails;
  }
function displayBarrels(examineCell, howMany){
  //debugString=examineCell+", "+howMany+"<br>";
  var cn=document.getElementById(examineCell).childNodes;
  var cnl=cn.length;  
  for (var n=0; n<cnl; n++){
    var thisClass=cn[n].className;
    if (thisClass.indexOf('tile')>-1){
      //debugString+=thisClass+" - ";
      barrelNodes=cn[n].childNodes;
      for (var b=0; b<barrelNodes.length; b++){
        if(howMany>b){
          barrelNodes[b].style.opacity="1";
          }
        else{
          barrelNodes[b].style.opacity="0";
          }        
        }
      }
    }
  }
function viableRandomPosition(){
  var allow=false;
  var failCount=0;
  var failLimit=50;
  var thisObject=new Object();
  unreservedCells=new Array();
  promotedCells=new Array();
  for (x=0; x<cellsAcross; x++){
    for (y=0; y<cellsDown; y++){
      testCell="grid_"+x+"_"+y;
      if(fullCellGlom.indexOf(testCell)==-1){
        unreservedCells.push(testCell);

        // promote by duplicating cells with less diagonal neighbors
        noDiagonals=true;
        if(isTiled(x-1, y-1)==true){noDiagonals=false;}
        if(isTiled(x+1, y-1)==true){noDiagonals=false;}
        if(isTiled(x-1, y+1)==true){noDiagonals=false;}
        if(isTiled(x+1, y+1)==true){noDiagonals=false;}
        if(noDiagonals==true){promotedCells.push(testCell);}
        }
      }
    }
  //dbug('unreservedCells:'+unreservedCells);

  while((allow == false)&&(failCount <=failLimit)){
    var thisFail=false;
    var dir=dirList[Math.floor(Math.random()*4)];
    if(unreservedCells.length==0){
      //alert("viableRandomPosition error, no unreserved cells");
      x=0;
      y=0;
      }
    else{
      //try promoted cells first if not toomany fails
      if((promotedCells.length>0)&&(failCount<failLimit/2)){
        useCell=promotedCells[Math.floor(Math.random()*promotedCells.length)];
        }
      else{
        useCell=unreservedCells[Math.floor(Math.random()*unreservedCells.length)];
        }
      cellParts=useCell.split("_");
      x=Number(cellParts[1]);
      y=Number(cellParts[2]);
      }

    var nextX=xDeltaByDir[dir]+x;  
    var nextY=yDeltaByDir[dir]+y;  
    var thisCell="grid_"+x+"_"+y;
    var adjCell="grid_"+nextX+"_"+nextY;
    if (fullCellGlom.indexOf(thisCell)>-1){
      thisFail=true;
      }

    //this and next - out of bounds or occupied?
    if((nextX<0)||(nextX>=cellsAcross)){
      thisFail=true;
      }
    if((nextY<0)||(nextY>=cellsDown)){
      thisFail=true;
      }
 
    if((isTiled(nextX, nextY)==true)||(isTiled(x, y)==true)){
      thisFail=true;
      }

    var reserveCellsArray=openAdjacentCellsArray(nextX, nextY, thisCell);

    if (thisFail==false){
      // check next for 2 or 3 untiled neighbors
      if(reserveCellsArray.length<2){
        thisFail=true;
        }
      }

    //// new wall walking test
    if(thisFail==false){
      var passedWalk=false;
      edgesBarredXY=[];
      // setup quad switches 0=right 1=down 2=left 3=up
      for (var tx=0; tx<cellsAcross; tx++){
        var col=[];
        for (var ty=0; ty<cellsDown; ty++){
          var cell=[false,false,false,false];
          if(ty==0){cell[3]=true;}
          else{
            var testId="grid_"+tx+"_"+(ty-1);
            if(tilesByGridXY[testId].length>0){cell[3]=true;}
            }
          if(ty==cellsDown-1){cell[1]=true;}
          else{
            var testId="grid_"+tx+"_"+(ty+1);
            if(tilesByGridXY[testId].length>0){cell[1]=true;}
            }
          if(tx==0){cell[2]=true;}
          else{
            var testId="grid_"+(tx-1)+"_"+ty;
            if(tilesByGridXY[testId].length>0){cell[2]=true;}
            }
          if(tx==cellsAcross-1){cell[0]=true;}
          else{
            var testId="grid_"+(tx+1)+"_"+ty;
            if(tilesByGridXY[testId].length>0){cell[0]=true;}
            }
          col.push(cell);
          }
        edgesBarredXY.push(col);
        }
      // bar self
      //dbug("x:"+x+" y:"+y+" dir:"+dir+"<br>");
      if(x>0){edgesBarredXY[x-1][y][0]=true;}
      if(x<cellsAcross-1){edgesBarredXY[x+1][y][2]=true;}
      if(y>0){edgesBarredXY[x][y-1][1]=true;}
      if(y<cellsDown-1){edgesBarredXY[x][y+1][3]=true;}
      var walkX=x+xDeltaByDir[dir];
      var walkY=y+yDeltaByDir[dir];
      var walkDir=dir;
      edgesBarredXY[walkX][walkY][ordByDir[reverseObject[walkDir]]]=false;
      var goalX=walkX;
      var goalY=walkY;
      var goalDir=reverseObject[dir];
      var walking=true;
      //debugCell(walkDir,walkX,walkY);
      var limit=40;
      while(walking){
        limit--;
        if(limit<0){
          walking=false;
          //dbuga("limit");
          }
        var foundStep=false;
        var testDir="not set";
        //dbuga("<b>"+walkDir+"</b>");


        if(foundStep==false){
          testDir=rightObject[walkDir];
          var ord=ordByDir[testDir];
          //dbuga("_ "+walkX+" "+walkY+" testDir:"+testDir+" ord:"+ord);
          if(edgesBarredXY[walkX][walkY][ord]==false){foundStep=true;}
          }
        if(foundStep==false){
          testDir=walkDir;
          var ord=ordByDir[testDir];
          //dbuga("___ "+walkX+" "+walkY+" test:"+testDir+" "+ord);
          if(edgesBarredXY[walkX][walkY][ord]==false){foundStep=true;}
          }
        if(foundStep==false){
          testDir=leftObject[walkDir];
          var ord=ordByDir[testDir];
          //dbuga("___ "+walkX+" "+walkY+" test:"+testDir+" "+ord);
          if(edgesBarredXY[walkX][walkY][ord]==false){foundStep=true;}
          }
         if(foundStep==false){
          walking=false;
          }
        else{
          //dbuga(" "+testDir);
/*
          trackContext.strokeStyle="rgba(0,0,255,.3)";
          trackContext.lineWidth=5;
          trackContext.beginPath();
          var pxX=walkX*cellSize+cellSize/2+xDeltaByDir[reverseObject[walkDir]]*cellSize/2.5;
          var pxY=walkY*cellSize+cellSize/2+yDeltaByDir[reverseObject[walkDir]]*cellSize/2.5;
          trackContext.moveTo(pxX,pxY);
*/
          if((walkX!=goalX)||(walkY!=goalY)){
            var ord=ordByDir[reverseObject[walkDir]];
            edgesBarredXY[walkX][walkY][ord]=true;
            }
          var ord=ordByDir[testDir];
          edgesBarredXY[walkX][walkY][ord]=true;

          walkDir=testDir;

/*
          var pxX=walkX*cellSize+cellSize/2+xDeltaByDir[walkDir]*cellSize/2.5;
          var pxY=walkY*cellSize+cellSize/2+yDeltaByDir[walkDir]*cellSize/2.5;
          trackContext.lineTo(pxX,pxY);
          trackContext.stroke();
*/
          walkX+=xDeltaByDir[walkDir];
          walkY+=yDeltaByDir[walkDir];
          if((walkX==goalX)&&(walkY==goalY)){
            limit=0;
            passedWalk=true;
            //dbuga(goalX+" "+goalY+" "+goalDir);
            }
          }
        }
      }
    if(passedWalk==false){
      thisFail=true;
      //dbuga(x+" "+y+" failedWalk");
      }
    //// end of wall walk


    if (thisFail==false){allow=true;}
    else{failCount++;}
    }
  if (failCount>failLimit){
    //alert('viableRandomPosition Failed to place tile. failCount='+failCount);
    thisObject.x=0;
    thisObject.y=0;
    thisObject.dir="r";
    thisObject.success=false;
    }
  else{
    thisObject.x=x;
    thisObject.y=y;
    thisObject.dir=dir;
    thisObject.success=true;
    fullCellGlom+=thisCell+adjCell;

    for (r=0; r<reserveCellsArray.length; r++){
      fullCellGlom+=reserveCellsArray[r];
      }
    }
  //debugCell(adjCell,thisObject.x,thisObject.y);
  //dbuga(buildSequence.length);
  return thisObject;
  }
var ordByDir={"r":0, "b":1, "l":2, "t":3};
var edgesBarredXY=[];
var pi=Math.PI;
function debugCell(message, cellX,cellY){
  trackContext.textAlign="center";
  trackContext.font="20px akzi";
  trackContext.fillStyle = "rgb(0, 0, 255)";
  trackContext.strokeStyle = "rgb(255, 255, 255)";
  trackContext.lineWidth= 2;

  pxX=cellX*cellSize+cellSize/2;
  pxY=cellY*cellSize+cellSize/2;
  trackContext.strokeText(message,pxX,pxY);
  trackContext.fillText(message,pxX,pxY);
  }
// destination functions

function destObject(color, dir, x, y){
  var deg=degByDir[dir];
  var d={};
  d.color=color; 
  var carsArray=new Array();
  d.carsArray=carsArray;
  d.barrels=0;
  d.nextX=x;//+xDeltaByDir[dir];
  d.nextY=y;//+yDeltaByDir[dir];
  d.deg=deg;
  d.dir=dir;
  d.x=x;
  d.y=y;
  d.xIntake=x+xDeltaByDir[dir];
  d.yIntake=y+yDeltaByDir[dir];
  d.nextDir=reverseObject[dir];
  d.nextDeg=degByDir[d.nextDir];

  destCount++;
  targetCell="grid_"+x+"_"+y;
  createTrack("tiledest"+color, targetCell);
  createTrack(dir+"d", targetCell);
  createCanvasTrack(dir+"d", x, y);
  return d;
  }

function destTick(){
  
  if((viewportWidth != window.innerWidth)||(viewportHeight != window.innerHeight)){
    changeGeometry();
    }
  }

function zeroProgressBar(){
  for (c=0; c<colorList.length; c++){
    color=colorList[c];
    document.getElementById(color+"ProgressDiv").style.width="0px";
    document.getElementById(color+"ProgressDiv").style.width="0px";
    }
  }
function updateProgressBar(){
  totalCarsNeeded=0;
  totalCarsDocked=0;
  maxWidth=screenWidth;
  colorsInPlay=0;
  for (c=0; c<colorList.length; c++){
    color=colorList[c];
    if(possibleObject[color]>0){
      colorsInPlay++;
      totalCarsNeeded+=possibleObject[color];
      totalCarsDocked+=scoreObject[color];
      }
    }
  colorMaxWidth=maxWidth/colorsInPlay;
  for (c=0; c<colorList.length; c++){
    color=colorList[c];
    if(possibleObject[color]>0){
      progressPercent=scoreObject[color]/possibleObject[color];
      progressPixels=progressPercent*colorMaxWidth;
      document.getElementById(color+"ProgressDiv").style.width=progressPixels+"px";
      }
    }
  //if(totalCarsDocked==totalCarsNeeded){
  //  playSound("applause");
  // }
  }

// source functions

function sourceObject(color, dir, x, y, barrels){
  possibleObject[color]+=barrels;
  deg=degByDir[dir];
  var s=new Object();
  s.barrels=barrels;
  s.color=color; 
  s.occupied=false;
  s.deg=deg;
  s.dir=dir;
  s.x=x;
  s.y=y;
  sourceCount++;
  targetCell="grid_"+x+"_"+y;
  createTrack("tilesource"+color, targetCell);
  createTrack(dir+"s", targetCell);
  createCanvasTrack(dir+"s", x, y);
  return s;
  }
var sourceMs;
var turnMs=1000;

function sourceTick(){
  //return false;////
  sourceAction(checkSourceNum);
  checkSourceNum++;
  if (checkSourceNum>=sourceCount){
    checkSourceNum=0;
    }
  }

function sourceAction(sourceNum){
  //dbuga('sourceAction ' +sourceData[sourceNum].color);
  if ((sourceData[sourceNum].occupied==false)&&(sourceData[sourceNum].barrels>0)){

    //dbuga(' unoccupied with barrels');

    sourceData[sourceNum].occupied=true;
    sourceData[sourceNum].barrels--;
    displayBarrels("grid_"+sourceData[sourceNum].x+"_"+sourceData[sourceNum].y, sourceData[sourceNum].barrels);
    useColor=sourceData[sourceNum].color;
     
    var newCar;
    if(levelData[atLevel].tank){
      newCar=tankObject(useColor, sourceData[sourceNum].dir, sourceData[sourceNum].x, sourceData[sourceNum].y, sourceNum);
      //dbuga(' 1 tankObject tank level');
      }
    else{
      //dbuga(' 2 not tank level');
      if((useColor != "black")||(rnd(10)<7)){
        //dbuga(' 3 carObject before');
        newCar=carObject(useColor, sourceData[sourceNum].dir, sourceData[sourceNum].x, sourceData[sourceNum].y, sourceNum);
        //dbuga(' 3 carObject complete');
        }
      else{
        //dbuga(' # tankObject BEFORE');
        newCar=tankObject(useColor, sourceData[sourceNum].dir, sourceData[sourceNum].x, sourceData[sourceNum].y, sourceNum);
        //dbuga(' # tankObject AFTER');
        }
      }
    carData.push(newCar);
    }
  }

// car functions
function tankObject(color, dir, x, y, oid){
  var detail=detailByValue[menuObject["Detail"]["value"]];
  //dbuga("color:"+color+" dir:"+dir+" x:"+x+" y:"+y+" oid:"+oid);
  deg=degByDir[dir];
  var c={};
  c.color=color;
  c.trainNum=-1;
  c.attached=false;
  //dbuga(" - tankObject 3");
  c.track="";
  c.nextDeg=deg;
  c.prevDeg=deg;
  c.nextDir=dir;
  c.prevDir=dir;
  c.originId=oid;
  //dbuga(" - tankObject 4");
  c.prevX=x+xDeltaByDir[dir];
  c.prevY=y+yDeltaByDir[dir];
  c.nextX=x+xDeltaByDir[dir];
  c.nextY=y+yDeltaByDir[dir];
  //dbuga(" - tankObject 5");
  // create 3d car
  var useTransform=returnProgTransform(c, 0);
  var useCarId="car"+carData.length;

  var htmlString="";
  htmlString+='<div id="'+useCarId+'" class="cube">';
  //dbuga(" - tankObject 6");
  for (var f=0; f<faceData.tank.length; f++){
    htmlString+='<canvas id="carcanvas'+carData.length+'face'+f+'" width='+Math.floor(cubeSize*faceData.tank[f].width*detail)+' height='+Math.floor(cubeSize*faceData.tank[f].height*detail)+'  class="cubeFace '+color+'tank'+f+'"></canvas>'
    }
  htmlString+='</div>';
  //dbuga(" - tankObject 7");

  var newdiv = document.createElement('div');
  newdiv.innerHTML = htmlString;
  document.getElementById('trainHolder').appendChild(newdiv);
  //dbuga(" - tankObject 8");

  for (var f=0; f<faceData.tank.length; f++){
    var canv=document.getElementById('carcanvas'+carData.length+'face'+f);
    var ctx=canv.getContext('2d');
    //ctx.webkitImageSmoothingEnabled = false;
    ctx.imageSmoothingEnabled = false; /// future
    var imageObj = imgRefs[faceData["tank"][f].img+color];
    ctx.drawImage(imageObj, 0, 0, canv.width, canv.height);
    }

  //dbuga(" - tankObject 9");


  var elementRef=document.getElementById(useCarId);
  elementRef.style.webkitTransform=useTransform;
  c.ref=elementRef;
  return c;
  }

function carObject(color, dir, x, y, oid){
  var detail=detailByValue[menuObject["Detail"]["value"]];
  
  //dbuga("color:"+color+" dir:"+dir+" x:"+x+" y:"+y+" oid:"+oid);
  deg=degByDir[dir];
  var c={};
  c.color=color;
  c.trainNum=-1;
  c.attached=false;
  c.track="";
  c.nextDeg=deg;
  c.prevDeg=deg;
  c.nextDir=dir;
  c.prevDir=dir;
  c.originId=oid;
  c.prevX=x+xDeltaByDir[dir];
  c.prevY=y+yDeltaByDir[dir];
  c.nextX=x+xDeltaByDir[dir];
  c.nextY=y+yDeltaByDir[dir];
  // create 3d car
  var useTransform=returnProgTransform(c, 0);
  var useCarId="car"+carData.length;

  var htmlString="";
  htmlString+='<div id="'+useCarId+'" class="cube">';
  for (var f=0; f<faceData.box.length; f++){
    htmlString+='<canvas id="carcanvas'+carData.length+'face'+f+'" width='+Math.floor(cubeSize*faceData.box[f].width*detail)+' height='+Math.floor(cubeSize*faceData.box[f].height*detail)+'  class="cubeFace '+color+'box'+f+'"></canvas>'
    }
  htmlString+='</div>';

  var newdiv = document.createElement('div');
  newdiv.innerHTML = htmlString;
  document.getElementById('trainHolder').appendChild(newdiv);
  var graphicNum=rnd(graphicsByColor[color].length);

  for (var f=0; f<faceData.box.length; f++){
    var canv=document.getElementById('carcanvas'+carData.length+'face'+f);
    var ctx=canv.getContext('2d');
    //ctx.webkitImageSmoothingEnabled = false;
    ctx.imageSmoothingEnabled = false; /// future
    var imageObj = imgRefs[faceData["box"][f].img+color];
    ctx.drawImage(imageObj, 0, 0, canv.width, canv.height);
    //if((faceData.box[f].img=="boxside")&&(rnd(10)<7)){
    if(faceData.box[f].img=="boxside"){
      //dbuga('boxside');
      var graphicRef=graphicsByColor[color][graphicNum].ref; 
      var g=shrink*detail*cellSize/24;
      ctx.drawImage(graphicRef, 0,0, g*24,g*8);
      }
    }



  var elementRef=document.getElementById(useCarId);
  elementRef.style.webkitTransform=useTransform;
  c.ref=elementRef;
  return c;
  }

// train functions

function trainObject(color, x, y, dir){
  var detail=detailByValue[menuObject["Detail"]["value"]];
  
  var deg=degByDir[dir];
  var t={};

  t.prog=0, 
  t.color=color, 
  t.moving=false;
  t.carsArray=new Array();
  //t.transformCache="";
  t.track="";
  t.prevDeg=deg;
  t.prevDir=dir;
  t.nextDeg=deg;
  t.nextDir=dir;
  t.prevX=x;
  t.prevY=y;
  t.nextX=x+xDeltaByDir[dir];//+xDeltaByDir[dir];
  t.nextY=y+yDeltaByDir[dir];//+yDeltaByDir[dir];

  // create 3d train
  var useTransform=returnProgTransform(t, 1);
  var useTrainId="train"+trainData.length;

  var htmlString="";
  htmlString+='<div id="'+useTrainId+'" class="cube">';
  for (var f=0; f<faceData.engine.length; f++){
    //htmlString+='<canvas id="canvas'+trainData.length+'face'+f+'" width='+cubeSize+' height='+cubeSize+'  class="cubeFace '+color+'engine'+f+'"></canvas>'
    htmlString+='<canvas id="canvas'+trainData.length+'face'+f+'" width='+Math.floor(cubeSize*faceData.engine[f].width*detail)+' height='+Math.floor(cubeSize*faceData.engine[f].height*detail)+'  class="cubeFace '+color+'engine'+f+'"></canvas>'
    }
  htmlString+='</div>';

  var newdiv = document.createElement('div');
  newdiv.innerHTML = htmlString;
  document.getElementById('trainHolder').appendChild(newdiv);

  for (var f=0; f<faceData.engine.length; f++){
    var canv=document.getElementById('canvas'+trainData.length+'face'+f);
    var ctx=canv.getContext('2d');
    //ctx.webkitImageSmoothingEnabled = false;
    ctx.imageSmoothingEnabled = false; /// future
    var imageObj = imgRefs[faceData["engine"][f].img+color];
    ctx.drawImage(imageObj, 0, 0, canv.width, canv.height);
    }



  var elementRef=document.getElementById(useTrainId);
  elementRef.style.webkitTransform=useTransform;
  t.ref=elementRef;
  return t;
  }

function turnTick(){
  if((helpUp==false)&&(paused==false)){
    var debugString="turnTick() checkTrainNum="+checkTrainNum;
    for (var t=0; t<trainData.length; t++){
    debugString+="<br>"+t+" prev "+trainData[t].prevX+" "+trainData[t].prevY+" next"+trainData[t].nextX+" "+trainData[t].nextY+" nextDir "+trainData[t].nextDir+" nextDeg "+trainData[t].nextDeg;
      }
    //dbug(debugString);
    trainAction(checkTrainNum);
    checkTrainNum++;
    if (checkTrainNum>=trainData.length){
      checkTrainNum=0;
      }
    }
  }

function trainAction(trainNum){
  if(trainData.length<=trainNum){dbuga('no train '+trainNum); return false;}
  //if(trainNum==0){
    //dbug('');
    //dbuga('trainAction('+trainNum+')');
    //dbugaObject("trainData[trainNum]", trainData[trainNum]);
    //}

  // 1 - look ahead of train to determine valid tracks
  var examineCell="grid_"+trainData[trainNum].nextX+"_"+trainData[trainNum].nextY;
  var cn=tilesByGridXY[examineCell];
  var cnl=cn.length;
  var connectionsArray=new Array();
  var tracksArray=new Array();
  var reverseDir=reverseObject[trainData[trainNum].nextDir];
  var collided=false;
  //for each child node of examineCell
  for (var n=0; n<cnl; n++){
    var collision=false;
    var thisTrack=cn[n];
    if (thisTrack.indexOf(reverseDir)>-1){
      thisConnection=thisTrack.replace(reverseDir, "");
      tX=trainData[trainNum].nextX+xDeltaByDir[thisConnection];
      tY=trainData[trainNum].nextY+yDeltaByDir[thisConnection];

      //test if my destination line is occupied
      if(lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, thisConnection))==true){
        collision=true;
        }

      // maybe it's a double cross...
      if(thisConnection==trainData[trainNum].nextDir){
        //yes, we're testing a straight route. Are both other lines occupied?
        if((trainData[trainNum].nextDir=="r")||(trainData[trainNum].nextDir=="l")){
          //test top and bottom for occupied
          if((lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, "t"))==true)&&(lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, "b"))==true)){collision=true;}
          }
        else{
          //test left and right for occupied
          if((lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, "l"))==true)&&(lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, "r"))==true)){collision=true;}
          }
        }
      if((collision==false)&&(isTiled(tX, tY)==false)){
        tracksArray.push(thisTrack);
        connectionsArray.push(thisConnection);
        }
      if(collision==true){collided=true;}
      }
    }// end of child nodes, have tracksArray
  //if(trainNum==0){dbugaObject("tracksArray", tracksArray);}
  // 2 - detach -
  //check for destination adjacent to train next cell
  if (trainData[trainNum].carsArray.length>0){
    if(trainNum==0){  
     //dbuga("detach? prev "+trainData[trainNum].prevX+" "+trainData[trainNum].prevY+" "+carData[trainData[trainNum].carsArray[0]].nextDir+" "+trainData[trainNum].color);
     }

    foundDest=findDest(trainData[trainNum].prevX, trainData[trainNum].prevY, carData[trainData[trainNum].carsArray[0]].nextDir, trainData[trainNum].color);// changed to next
    //if(trainNum==0){dbuga("foundDest="+foundDest);}
    if (foundDest >-1){
      var tempCarsArray=trainData[trainNum].carsArray;
      destData[foundDest].carsArray=tempCarsArray;
      
      trainData[trainNum].carsArray=[];
      }
    }


  // 3 - check color progress and find dock
  if(possibleObject[trainData[trainNum].color]==scoreObject[trainData[trainNum].color]){
    foundDest=findDest(trainData[trainNum].nextX, trainData[trainNum].nextY, trainData[trainNum].nextDir, trainData[trainNum].color);

    if(foundDest >-1){
      destTrack="";
      destOppDir=reverseObject[destData[foundDest].dir];
      trainOppDir=reverseObject[trainData[trainNum].nextDir];
      tracksInCell=returnTracksInCell(trainData[trainNum].nextX,trainData[trainNum].nextY);
      for(var t=0; t<tracksInCell.length; t++){
        thisTrack=tracksInCell[t];
        if ((thisTrack.indexOf(trainOppDir)>-1)&&(thisTrack.indexOf(destOppDir)>-1)){
          tracksArray=[thisTrack];// remove non winners from list
          thisConnection=thisTrack.replace(trainOppDir, "");          
          connectionsArray=[thisConnection];
          playSound("applause");
          }
        }
      }
    }


  // 3.5 - is moving?
  if((trainData[trainNum].moving==false)&&(tracksArray.length>0)){
    playSound("trainstart");
    }
  if((collided==true)&&(tracksArray.length==0)&&(trainData[trainNum].moving==true)){
    playSound("trainpause");
    }
  if(tracksArray.length==0){
    trainData[trainNum].moving=false;
    }
  else{
    trainData[trainNum].moving=true;
    }

    // 4 - attach to last car ?

    if (trainData[trainNum].carsArray.length>0){
      var cal=trainData[trainNum].carsArray.length;
      carNum=cal-1;
      lastCarId=trainData[trainNum].carsArray[carNum];
      //dbugaObject(carData[lastCarId]);
      foundCar=findCar(carData[lastCarId].prevX, carData[lastCarId].prevY, carData[lastCarId].prevDir, trainData[trainNum].color);
      if(foundCar > -1){
        //dbuga("foundCar:"+foundCar);
        trainData[trainNum].carsArray.push(foundCar);
        carData[foundCar].attached=true;
        carData[foundCar].trainNum=trainNum;
        sourceData[carData[foundCar].originId].occupied=false;
        thisCarDiv="car"+foundCar;
        var thisRef=carData[foundCar].ref;
        showQueue.push(thisRef); 
        playSound("carstart");
        }
      else{
        //dbugaObject(carData);
        //alert('not linked');
        }
      }
    
    // 5 - attach to engine ?
    if (trainData[trainNum].carsArray.length==0){
      foundCar=findCar(trainData[trainNum].prevX, trainData[trainNum].prevY, trainData[trainNum].nextDir, trainData[trainNum].color);
      if (foundCar > -1){
        trainData[trainNum].carsArray.push(foundCar);
        carData[foundCar].attached=true;
        carData[foundCar].trainNum=trainNum;
        sourceData[carData[foundCar].originId].occupied=false;  
        var thisRef=carData[foundCar].ref;
        showQueue.push(thisRef); 
        playSound("carstart");
        }
      }
  if(trainData[trainNum].moving){

    // 6 - follows from last to second, then follow engine
    if (trainData[trainNum].carsArray.length>0){
      var cal=trainData[trainNum].carsArray.length;
      for (carNum=cal-1; carNum>-1; carNum--){
        thisCarId=trainData[trainNum].carsArray[carNum];
        if(carNum==0){
          //follow train
          carData[thisCarId]=followObject(trainData[trainNum], carData[thisCarId]);
          }
        else{
          parentCarId=trainData[trainNum].carsArray[carNum-1];
          carData[thisCarId]=followObject(carData[parentCarId], carData[thisCarId]);
          }
        collisionData['car'+thisCarId]=lineStringFromXYD(carData[thisCarId].prevX, carData[thisCarId].prevY, carData[thisCarId].nextDir);
        } 
      }//end of cars array length>0

    }// end of if moving

    // 6.5 - follows into dest
    if (destData[trainNum].carsArray.length>0){
      var cal=destData[trainNum].carsArray.length;
      for (carNum=cal-1; carNum>-1; carNum--){
        thisCarId=destData[trainNum].carsArray[carNum];
        if(carNum==0){// runs last
          if((carData[thisCarId].nextX==carData[thisCarId].prevX)&&(carData[thisCarId].nextY==carData[thisCarId].prevY)){
            //already docked, kill it
            var deadCar=destData[trainNum].carsArray.shift();
            var thisRef=carData[thisCarId].ref;
            hideQueue.push(thisRef);
            carData[thisCarId].attached=false;
            delete collisionData['car'+thisCarId];
            scoreObject[destData[trainNum].color]++;
            updateProgressBar();
            playSound("carstop");
            }
          else{//follow dest
            carData[thisCarId]=followObject(destData[trainNum], carData[thisCarId]);
            collisionData['car'+thisCarId]=lineStringFromXYD(carData[thisCarId].prevX, carData[thisCarId].prevY, carData[thisCarId].nextDir);            }
          }
        else{// follow car
          //dbuga('follow car '+ parentCarId);
          parentCarId=destData[trainNum].carsArray[carNum-1];
          carData[thisCarId]=followObject(carData[parentCarId], carData[thisCarId]);
          collisionData['car'+thisCarId]=lineStringFromXYD(carData[thisCarId].prevX, carData[thisCarId].prevY, carData[thisCarId].nextDir);
          }
        
        } 
      }//end of cars array length>0


  // 8 - Move Engine
  trainData[trainNum].prevDeg=trainData[trainNum].nextDeg
  trainData[trainNum].prevDir=trainData[trainNum].nextDir
  trainData[trainNum].prevX=trainData[trainNum].nextX;
  trainData[trainNum].prevY=trainData[trainNum].nextY;

  if(trainData[trainNum].moving){
    var selNum=Math.floor(Math.random()*tracksArray.length);
    var selTrack=tracksArray[selNum];
    trainData[trainNum].track=selTrack;
    trainData[trainNum].nextDir=connectionsArray[selNum];

    collisionData['train'+trainNum]=lineStringFromXYD(trainData[trainNum].prevX, trainData[trainNum].prevY, trainData[trainNum].nextDir);


    trainData[trainNum].nextX+=xDeltaByDir[trainData[trainNum].nextDir];
    trainData[trainNum].nextY+=yDeltaByDir[trainData[trainNum].nextDir];
    trainData[trainNum].nextDeg=trainData[trainNum].prevDeg+degDeltaFromDirs(trainData[trainNum].prevDir, trainData[trainNum].nextDir);
    trainData[trainNum].prog=0;
    }// end of if moving


  //dbuga("completed");
  //dbugaObject(trainData[trainNum]);

  }

// done.js

// ------------------- completed var and object declairations

var trainData=[];
//var turnInterval;

var destCount=0;
var destData=[];

var sourceInterval;


var sourceData=[];
var sourceCount=0;
var carData=[];

var checkTrainNum=0;
var checkSourceNum=0;

var collisionData={};

var scoreObject=new Object;
var possibleObject=new Object;
var buildSequence=new Array();

var degByDir=new Object();
degByDir['r']=90;
degByDir['l']=270;
degByDir['t']=0;
degByDir['b']=180;

var xDeltaByDir=new Object();
xDeltaByDir.l=-1;
xDeltaByDir.r=1;
xDeltaByDir.t=0;
xDeltaByDir.b=0;

var yDeltaByDir=new Object();
yDeltaByDir.l=0;
yDeltaByDir.r=0;
yDeltaByDir.t=-1;
yDeltaByDir.b=1;

var reverseObject= new Object();
reverseObject['l']="r";
reverseObject['r']="l";
reverseObject['t']="b";
reverseObject['b']="t";

var rightObject= new Object();
rightObject['l']="t";
rightObject['r']="b";
rightObject['t']="r";
rightObject['b']="l";

var leftObject= new Object();
leftObject['l']="b";
leftObject['r']="t";
leftObject['t']="l";
leftObject['b']="r";

var carHtmlByColor=new Object();
carHtmlByColor['blue']  ="<div id=\"carId\" class=\"notransit\" style><div class=\"coupler\"></div><div class=\"blueTank\"></div></div>";
carHtmlByColor['green'] ="<div id=\"carId\" class=\"notransit\" style><div class=\"coupler\"></div><div class=\"greenCar\"></div></div>";
carHtmlByColor['orange']="<div id=\"carId\" class=\"notransit\" style><div class=\"coupler\"></div><div class=\"orangeTank\"></div></div>";
carHtmlByColor['black'] ="<div id=\"carId\" class=\"notransit\" style><div class=\"coupler\"></div><div class=\"blackCar\"></div></div>";

var trainHtmlByColor=new Object();
trainHtmlByColor['blue']  ="<div id=\"trainId\" class=\"transit\" style><div class=\"coupler\"></div><div class=\"blueTrainBody\"></div><div class=\"blueTrainCatcher\"></div><div class=\"blueTrainTank\"></div><div class=\"blueTrainRear\"></div></div>";
trainHtmlByColor['green'] ="<div id=\"trainId\" class=\"transit\" style><div class=\"coupler\"></div><div class=\"greenTrainBody\"></div><div class=\"greenTrainCatcher\"></div><div class=\"greenTrainTank\"></div><div class=\"greenTrainRear\"></div></div>";
trainHtmlByColor['orange']="<div id=\"trainId\" class=\"transit\" style><div class=\"coupler\"></div><div class=\"orangeTrainBody\"></div><div class=\"orangeTrainCatcher\"></div><div class=\"orangeTrainTank\"></div><div class=\"orangeTrainRear\"></div></div>";
trainHtmlByColor['black'] ="<div id=\"trainId\" class=\"transit\" style><div class=\"coupler\"></div><div class=\"blackTrainBody\"></div><div class=\"blackTrainCatcher\"></div><div class=\"blackTrainTank\"></div><div class=\"blackTrainRear\"></div></div>";

var fullCellGlom=""; //needed for testing the path cells of tiles in viable code
var destInterval;

var freezeMode=false;
var dirList=new Array('t', 'b', 'r', 'l');
var colorList=new Array('black', 'orange', 'blue', 'green');
var colorCycle=0;
var tileList= new Array('trees', 'water', 'houses');


// ------------------- geometry util, display, and game functions

// used maybe for debugging
function returnObjectInfo(theObject){
  dstring=" prev: "+theObject.prevX+" "+theObject.prevY+" next: "+theObject.nextX+" "+theObject.nextY+" "+theObject.nextDir;
  return dstring;
  }
function dbug(theString){
  
  document.getElementById("debugDiv").style.display="block";
  document.getElementById("debugDiv").innerHTML=""+theString+"<br>";
  }
function dbuga(theString){
  document.getElementById("debugDiv").style.display="block";  
  document.getElementById("debugDiv").innerHTML+=theString+"<br>";
  }
function dbugc(theString){
  document.getElementById("debugDiv").innerHTML+=theString+" ";
  }
function dbugaObject(caption, theObject){
  var theString=JSON.stringify(theObject);
  var parts=theString.split(",");
  theString=parts.join(", ");
  parts=theString.split("}");
  theString=parts.join("}<br> ");
  document.getElementById("debugDiv").style.display="block";  
  document.getElementById("debugDiv").innerHTML+=caption+"="+theString+"<br>";
  }

function followObject(leader, follower){
  follower.prevX=follower.nextX;
  follower.prevY=follower.nextY;
  follower.prevDeg=follower.nextDeg;
  follower.prevDir=follower.nextDir;
  follower.nextX=leader.nextX;
  follower.nextY=leader.nextY;
  follower.nextDir=leader.nextDir;
  follower.nextDeg=leader.nextDeg;
  follower.track=leader.track;
  ////follower.transformCache=leader.transformCache;
  follower.animCache=leader.animCache;
  return follower;
  }


function degDeltaFromDirs(dir1, dir2){
  theDelta=0;
  if ((dir1=="r")&&(dir2=="t")){theDelta-=90;}
  if ((dir1=="t")&&(dir2=="l")){theDelta-=90;}
  if ((dir1=="l")&&(dir2=="b")){theDelta-=90;}
  if ((dir1=="b")&&(dir2=="r")){theDelta-=90;}

  if ((dir1=="r")&&(dir2=="b")){theDelta+=90;}
  if ((dir1=="b")&&(dir2=="l")){theDelta+=90;}
  if ((dir1=="l")&&(dir2=="t")){theDelta+=90;}
  if ((dir1=="t")&&(dir2=="r")){theDelta+=90;}
  return theDelta;
  }

function lineStringFromXYD(x, y, dir){
  if((dir=="l")||(dir=="r")){
    axis="v";
    if(dir=="l"){x-=1;}
    }
  if((dir=="t")||(dir=="b")){
    axis="h";
    if(dir=="t"){y-=1;}
    }
  lineString=axis+x+"_"+y;
  return lineString;
  }
function returnProgPos(anim, prog){
  var prevX=anim.prevX+.5;
  var prevY=anim.prevY+.5;
  if (anim.prevDir =="r"){prevX-=.5;}
  if (anim.prevDir =="b"){prevY-=.5;}
  if (anim.prevDir =="l"){prevX+=.5;}
  if (anim.prevDir =="t"){prevY+=.5;}

  var nextX=anim.nextX+.5;
  var nextY=anim.nextY+.5;
  if (anim.nextDir=="r"){nextX-=.5;}
  if (anim.nextDir =="b"){nextY-=.5;}
  if (anim.nextDir =="l"){nextX+=.5;}
  if (anim.nextDir =="t"){nextY+=.5;}
  var sumX=prevX*(1-prog)+(nextX*prog);
  var sumY=prevY*(1-prog)+(nextY*prog);


  if (anim.prevDir=="r"){anim.prevDeg=90;}
  if (anim.prevDir=="b"){anim.prevDeg=180;}
  if (anim.prevDir=="l"){anim.prevDeg=270;}
  if (anim.prevDir=="t"){anim.prevDeg=0;}
  if (anim.nextDir=="r"){anim.nextDeg=90;}
  if (anim.nextDir=="b"){anim.nextDeg=180;}
  if (anim.nextDir=="l"){anim.nextDeg=270;}
  if (anim.nextDir=="t"){anim.nextDeg=0;}
  if(anim.nextDeg-anim.prevDeg>180){anim.prevDeg+=360;}
  if(anim.prevDeg-anim.nextDeg>180){anim.nextDeg+=360;}

  var sumDeg=anim.prevDeg*(1-prog)+(anim.nextDeg*prog);
  //if(anim.prevDir=="t"){dbug(anim.prevDeg+" "+anim.nextDeg+" "+sumDeg);}


  if(anim.prevDir != anim.nextDir){
    // turn!
    //find center point
    var centerX;
    var centerY;
    var rads;
    if(anim.prevDir=="r"){
      centerX=prevX;
      centerY=nextY;
      if(anim.nextDir=="t"){rads=pi*(90-sumDeg-90)/180;}
      if(anim.nextDir=="b"){rads=pi*(90-sumDeg+90)/180;}
      }
    if(anim.prevDir =="l"){
      centerX=prevX;
      centerY=nextY;
      if(anim.nextDir=="t"){rads=pi*(90-sumDeg+90)/180;}
      if(anim.nextDir=="b"){rads=pi*(90-sumDeg-90)/180;}
      }
    if(anim.prevDir =="t"){
      centerX=nextX;
      centerY=prevY;
      if(anim.nextDir=="l"){rads=pi*(90-sumDeg-90)/180;}
      if(anim.nextDir=="r"){rads=pi*(90-sumDeg+90)/180;}
      }
    if(anim.prevDir =="b"){
      centerX=nextX;
      centerY=prevY;
      if(anim.nextDir=="l"){rads=pi*(90-sumDeg+90)/180;}
      if(anim.nextDir=="r"){rads=pi*(90-sumDeg-90)/180;}
      }
 
    sumX=centerX+.5*Math.cos(rads);
    sumY=centerY-.5*Math.sin(rads);
    }

  var transformString=" translate("+sumX+"px, "+sumY+"px) rotate("+sumDeg+"deg)"; 
  //dbuga('progTransform completed ');
    
  var newPos={"x":sumX, "y":sumY, "d":sumDeg};
  return newPos;

  }
function returnProgTransform(anim, prog){
  //dbug('progTransform '+JSON.stringify(anim));
  var prevX=anim.prevX*cellSize+cellSizeHalf;
  var prevY=anim.prevY*cellSize+cellSizeHalf;
  if (anim.prevDir =="r"){prevX-=cellSizeHalf;}
  if (anim.prevDir =="b"){prevY-=cellSizeHalf;}
  if (anim.prevDir =="l"){prevX+=cellSizeHalf;}
  if (anim.prevDir =="t"){prevY+=cellSizeHalf;}

  var nextX=anim.nextX*cellSize+cellSizeHalf;
  var nextY=anim.nextY*cellSize+cellSizeHalf;
  if (anim.nextDir=="r"){nextX-=cellSizeHalf;}
  if (anim.nextDir =="b"){nextY-=cellSizeHalf;}
  if (anim.nextDir =="l"){nextX+=cellSizeHalf;}
  if (anim.nextDir =="t"){nextY+=cellSizeHalf;}
  var sumX=prevX*(1-prog)+(nextX*prog);
  var sumY=prevY*(1-prog)+(nextY*prog);


  if (anim.prevDir=="r"){anim.prevDeg=90;}
  if (anim.prevDir=="b"){anim.prevDeg=180;}
  if (anim.prevDir=="l"){anim.prevDeg=270;}
  if (anim.prevDir=="t"){anim.prevDeg=0;}
  if (anim.nextDir=="r"){anim.nextDeg=90;}
  if (anim.nextDir=="b"){anim.nextDeg=180;}
  if (anim.nextDir=="l"){anim.nextDeg=270;}
  if (anim.nextDir=="t"){anim.nextDeg=0;}
  if(anim.nextDeg-anim.prevDeg>180){anim.prevDeg+=360;}
  if(anim.prevDeg-anim.nextDeg>180){anim.nextDeg+=360;}

  var sumDeg=anim.prevDeg*(1-prog)+(anim.nextDeg*prog);
  //if(anim.prevDir=="t"){dbug(anim.prevDeg+" "+anim.nextDeg+" "+sumDeg);}


  if(anim.prevDir != anim.nextDir){
    // turn!
    //find center point
    var centerX;
    var centerY;
    var rads;
    if(anim.prevDir=="r"){
      centerX=prevX;
      centerY=nextY;
      if(anim.nextDir=="t"){rads=pi*(90-sumDeg-90)/180;}
      if(anim.nextDir=="b"){rads=pi*(90-sumDeg+90)/180;}
      }
    if(anim.prevDir =="l"){
      centerX=prevX;
      centerY=nextY;
      if(anim.nextDir=="t"){rads=pi*(90-sumDeg+90)/180;}
      if(anim.nextDir=="b"){rads=pi*(90-sumDeg-90)/180;}
      }
    if(anim.prevDir =="t"){
      centerX=nextX;
      centerY=prevY;
      if(anim.nextDir=="l"){rads=pi*(90-sumDeg-90)/180;}
      if(anim.nextDir=="r"){rads=pi*(90-sumDeg+90)/180;}
      }
    if(anim.prevDir =="b"){
      centerX=nextX;
      centerY=prevY;
      if(anim.nextDir=="l"){rads=pi*(90-sumDeg+90)/180;}
      if(anim.nextDir=="r"){rads=pi*(90-sumDeg-90)/180;}
      }
 
    //var rads=pi*2*((sumDeg)/360);
    sumX=centerX+cellSizeHalf*Math.cos(rads);
    sumY=centerY-cellSizeHalf*Math.sin(rads);
    //dbuga(Math.floor(sumDeg)+" frac:"+Math.floor((rads/6.28)*100)/100+" cos:"+Math.floor(Math.cos(rads)*100)/100+" sin:"+Math.floor(Math.sin(rads)*-100)/100);
    }

  //var transformString=" translate("+sumX+"px, "+sumY+"px) rotate("+sumDeg+"deg)"; 
  //return transformString;
  //dbuga('progTransform completed ');
    var z=cubeSize/2;
    sumDeg-=90;
      var trans="";
    trans+="translateX("+sumX+"px) ";
    trans+="translateY("+sumY+"px) ";
    trans+=" rotateZ("+sumDeg+"deg) ";
    trans+=" translateZ("+z+"px)";  
  
  return trans;
  }

function makeGrid(){
  // obsolete
  for (x=0; x<cellsAcross; x++){
    for (y=0; y<cellsDown; y++){
      var newdiv = document.createElement('div');
      newdiv.innerHTML = "<div id=\"grid_"+x+"_"+y+"\" class=\"tile L"+x+" T"+y+"\"></div>";
      document.getElementById('gridHolder').appendChild(newdiv);
      }
    }
  }

function returnTracksInCell(x,y){
  var tempArray= new Array();
  var examineCell="grid_"+x+"_"+y;
  //var cn=document.getElementById(examineCell).childNodes;
  var cn=tilesByGridXY[examineCell];
  var cnl=cn.length;  
  for (var n=0; n<cnl; n++){
    var thisClass=cn[n];
    if (thisClass.indexOf('tile')==-1){
      tempArray.push(thisClass);
      }
    }
  return tempArray;
  }
function lineIsOccupied(lineString){
  //debugString="";
  occupied=false;
  for (var k in collisionData){
    //debugString+=" "+collisionData[k];
    if(collisionData[k]==lineString){
      occupied=true;
      }
    }
  return occupied;
  }

function findDest(x, y, dir, color){
  var found=-1;
  carOppDir=reverseObject[dir];
  tracksInCell=returnTracksInCell(x,y);
  for (var d=0; d<destCount; d++){
    if ((destData[d].xIntake==x)&&(destData[d].yIntake==y)&&(destData[d].color==color)){
      destOppDir=reverseObject[destData[d].dir];
      // check for compatable tracks... 
      for(var t=0; t<tracksInCell.length; t++){
        thisTrack=tracksInCell[t];
        if ((thisTrack.indexOf(carOppDir)>-1)&&(thisTrack.indexOf(destOppDir)>-1)){
          found=d;
          }
        }
      }
    }
  return found;
  }

function findCar(x, y, dir, color){
  found=-1;
  for (c=0; c<carData.length; c++){
    carOppDir=reverseObject[carData[c].nextDir];
    tracksInCell=returnTracksInCell(x,y);

    if((carData[c].nextX==x)&&(carData[c].nextY==y)&&(carData[c].attached==false)&&(carData[c].color==color)){
      for(var t=0; t<tracksInCell.length; t++){
        thisTrack=tracksInCell[t];
        if ((thisTrack.indexOf(dir)>-1)&&(thisTrack.indexOf(carOppDir)>-1)){
          found=c;
          }
        }
      }
    }
  //dbuga(found);
  return found;
  }

// ------------------- functions related to touch and creating tracks

var tilesByGridXY={};

function createTrack(cellType, targetCell){
  //new database
  //dbuga(cellType+' '+targetCell);
  tilesByGridXY[targetCell].push(cellType);

  //old div database
  if(cellType.indexOf('tile')>-1){
    var newdiv = document.createElement('div');
    trackHtml=document.getElementById(cellType).innerHTML;
    newdiv.innerHTML = trackHtml;
    newdiv.className=cellType;
    document.getElementById(targetCell).appendChild(newdiv);
    }
  }
function touchCancel(event){
  event.preventDefault(); 
  }
function touchStart(event){
  //dbug("touchStart viewportAspect="+ viewportAspect);
  event.preventDefault(); 

  if(viewportAspect>1){
    handleEventLandscape(event);
    }
  else{
    if ((event.touches[0].pageY-adHeight < boardHeight)&&(helpUp==false)){
      if(levelsUp){
        handleEventLevels(event);
        }
      else if(menuUp){
        handleEventMenu(event);
        }
      else{
        handleEventDraw(event);
        }
      }
    else {
      handleEventUi(event);
      }
    }
  }
function touchMove(event){
  event.preventDefault();
  if(viewportAspect>1){
    handleEventLandscape(event);
    }
  else{
    if(levelsUp){
      }
    else if(menuUp){
      handleEventMenu(event);
      }
    else{
      handleEventDraw(event);
      }
    }
  }
function touchEnd(event){
  event.preventDefault();
  if(viewportAspect>1){
    handleEventLandscape(event);
    }
  else{
    if(levelsUp){
      }
    else if(menuUp){
      handleEventMenu(event);
      }
    else{
      handleEventDraw(event);
      }
    }
  }


// ported code
var camera;
var zoom;
var table;

var cameraXpercent=50;
var cameraYpercent=50;
var cameraDistancePercent=0;
var cameraRotationDegrees=[rnd(360),rnd(360),rnd(360),rnd(360)];
var combinedZoom=[rnd(101),rnd(101),rnd(101),rnd(101)];
var cameraTilt=0;

cameraRotationDegrees=[180,90,270,0];
combinedZoom =[75,25,0,100];


var prevTouchX=0;
var prevTouchY=0;
var focusTrain=0;

var shooting=false;
function graphicsTake(){
  shooting=true;
  //dbuga('graphicsTake gscn'+  graphicsSelectedColorNum+' gsg='+graphicsSelectedGraphic);
  navigator.camera.getPicture(onSuccess, onFail, { quality: 50,
    destinationType: Camera.DestinationType.DATA_URL
    });
  }
function onFail(message) {
  //dbuga('onFail');
  shooting=false;
  graphicsEditing=false;
  populateGraphics();
  }
function onSuccess(imageData) {
    //dbuga('success');

    var image = document.getElementById('cameraImg');
    image.style.display="block";
    image.onload=function(){
      cameraLoaded();
      };
    image.src = "data:image/jpeg;base64," + imageData;
    shooting=false;
    }
    
function cameraLoaded(){
    //dbuga('cameraLoaded()');
    graphicsEditing=true;
    var image = document.getElementById('cameraImg');
    graphicsScale=.9;
    graphicsOffsetX=0;
    graphicsOffsetY=0;
    //dbuga('image.naturalWidth: '+image.naturalWidth +' image.naturalHeight:'+image.naturalHeight);
    populateGraphics();
    previewGraphics();
    postviewGraphics();
    //processGraphic(graphicsSelectedColorNum, graphicsSelectedGraphic); 
    updateColorsCanv();
    }


function postviewGraphics(){
  cameraCanv.width=800;
  cameraCanv.height=200;
  cameraCanv.style.display="none";
  var image = document.getElementById('cameraImg');
  var offsetMultiplier=graphicsScale*image.naturalWidth/400;
  var graphicsCtx=graphicsCanv.getContext('2d');
  graphicsCtx.lineWidth=cellSize/16;
  var graphic=graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic];

  var buttonWidth=cellSize*3;
  var buttonHeight=cellSize*1;
  var radius=cellSize/8;
  var pad=cellSize/10;
  var topPad=(landscapeScreenHeight-colorsHeight-adHeight-buttonHeight*4)/2;
  var leftPad=(screenHeight-buttonWidth*3)/2;  
  var carButton={"buttonId":"car"}

  carButton.sampleWidth=image.naturalWidth*graphicsScale;
  carButton.sampleHeight=carButton.sampleWidth/4;
  carButton.sampleTop=image.naturalHeight/2-carButton.sampleHeight/2+graphicsOffsetY*offsetMultiplier;
  carButton.sampleLeft=image.naturalWidth/2-carButton.sampleWidth/2+graphicsOffsetX*offsetMultiplier;

  carButton.c=graphicsSelectedColorNum;
  carButton.g= graphicsSelectedGraphic;
  carButton.l=leftPad;
  carButton.r=leftPad+buttonWidth*3;
  carButton.t=topPad;
  carButton.b=topPad+buttonHeight*3;
  carButton.ref=image;
  var carGrid=buttonWidth*3/60;
  var cameraCtx=cameraCanv.getContext('2d');
  cameraCtx.drawImage(carButton.ref, carButton.sampleLeft, carButton.sampleTop, carButton.sampleWidth, carButton.sampleHeight, 0,0,800,200);
  //console.log(carButton);
  
  }
function previewGraphics(){
  var image = document.getElementById('cameraImg');
  var offsetMultiplier=graphicsScale*image.naturalWidth/400;
  var graphicsCtx=graphicsCanv.getContext('2d');
  graphicsCtx.lineWidth=cellSize/16;
  var graphic=graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic];

  var buttonWidth=cellSize*3;
  var buttonHeight=cellSize*1;
  var radius=cellSize/8;
  var pad=cellSize/10;
  var topPad=(landscapeScreenHeight-colorsHeight-adHeight-buttonHeight*4)/2;
  var leftPad=(screenHeight-buttonWidth*3)/2;  
  var carButton={"buttonId":"car"}

  carButton.sampleWidth=image.naturalWidth*graphicsScale;
  carButton.sampleHeight=carButton.sampleWidth/4;
  carButton.sampleTop=image.naturalHeight/2-carButton.sampleHeight/2+graphicsOffsetY*offsetMultiplier;
  carButton.sampleLeft=image.naturalWidth/2-carButton.sampleWidth/2+graphicsOffsetX*offsetMultiplier;

  carButton.c=graphicsSelectedColorNum;
  carButton.g= graphicsSelectedGraphic;
  carButton.l=leftPad;
  carButton.r=leftPad+buttonWidth*3;
  carButton.t=topPad;
  carButton.b=topPad+buttonHeight*3;
  carButton.ref=image;
  var carGrid=buttonWidth*3/60;

  var imageObj = imgRefs["boxside"+colorArray[carButton.c]];
  graphicsCtx.drawImage(imageObj, carButton.l, carButton.t, buttonWidth*3, buttonHeight*3);
  graphicsCtx.drawImage(carButton.ref, carButton.sampleLeft, carButton.sampleTop, carButton.sampleWidth, carButton.sampleHeight, carButton.l+carGrid*3, carButton.t+carGrid*3, buttonWidth*3-carGrid*5, buttonHeight*3-carGrid*5);
  //console.log(carButton);
  
  }
function testImageSample(image, scale, offsetX, offsetY){
  if(scale<.1){return false;}
  var offsetMultiplier=scale*image.naturalWidth/400;
  var sampleWidth=image.naturalWidth*scale;
  var sampleHeight=sampleWidth/4; //800 x 200
  var sampleTop=image.naturalHeight/2-sampleHeight/2+offsetY*offsetMultiplier;
  var sampleLeft=image.naturalWidth/2-sampleWidth/2+offsetX*offsetMultiplier;

  if(sampleLeft<0){return false;}
  if(sampleLeft+sampleWidth>=image.naturalWidth){return false;}
  if(sampleTop<0){return false;}
  if(sampleTop+sampleHeight>=image.naturalHeight){return false;}
  return true;
  }


function handleEventLandscape(e){
  //dbug('handleEventLandscape '+e.type);
  //dbuga(''+graphicsUp+' '+graphicsEditing+' '+graphicsTouching);
  if(e.touches.length>0){
    var t=e.touches[0];
    }
  else{
    if(graphicsEditing==false){
      return false;
      }
    }
  if(e.type=="touchstart"){
    if(t.pageY>landscapeScreenHeight-colorsHeight){ // touched in colors menu
      if(colorsUp==false){
        if(t.pageX<colorsHeight){//menu circle
          colorsUp=true;
          updateColorsCanv();
          }
        }
      else{ 
 
        var tryFocus=Math.floor((screenHeight-t.pageX)/colorsHeight);
        //dbuga('tryFocus='+tryFocus);
        if((tryFocus<trainData.length)&&(tryFocus != focusTrain)){
          focusTrain=tryFocus;
          //dbuga('updateColorsCanv tryFocus<trainData.length');
          //closeModals();
          if(graphicsUp){openModal("cars");}
          if(carsUp){populateCars();}


          updateColorsCanv();
          }
        if(t.pageX<colorsHeight){// x circle
          //dbuga('closeModals t.pageX<colorsHeight');
          closeModals();
          colorsUp=false;
          updateColorsCanv();
          }
        if((t.pageX>colorsHeight)&&(t.pageX<colorsHeight*4)){// car button
          if((carsUp)||(graphicsUp)){
            //dbuga('closeModals car button');
            closeModals();
            }
          else{
            openModal("cars");
            }
          }
        }
      }
    else{ // touch start above colors menu
      if(carsUp){
        var found=false;
        for (var cb=0; cb<carsButtons.length; cb++){
          var carButton=carsButtons[cb];
          if((t.pageX>carButton.l)&&(t.pageX<carButton.r)&&(t.pageY-adHeight>carButton.t)&&(t.pageY-adHeight<carButton.b)){
            openGraphics(carButton);
            found=true;
            }
          }
        if(found==false){
          //dbug('closeModals()');
          closeModals();
          }
        }
      else if(graphicsUp){
        var found=false;
        for (var gb=0; gb<graphicsButtons.length; gb++){
          var graphicsButton=graphicsButtons[gb];
          if((t.pageX> graphicsButton.l)&&(t.pageX<graphicsButton.r)&&(t.pageY-adHeight> graphicsButton.t)&&(t.pageY-adHeight<graphicsButton.b)){

            if(graphicsButton.buttonId=="Done"){
              openModal("cars");
              }
            if(graphicsButton.buttonId=="Camera"){
              graphicsTake();              
              }
            if(graphicsButton.buttonId=="Transparent"){
              graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic].blackTrans=!(graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic].blackTrans);
              localStorage.setItem('graphicsByColor', JSON.stringify(graphicsByColor));
              processGraphic(graphicsSelectedColorNum, graphicsSelectedGraphic);
              populateCars();
              }
            if(graphicsButton.buttonId=="Save"){
              graphicsEditing=false;
              // move to storage, image for now
              saveGraphics();
              graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic].blackTrans=false;
              localStorage.setItem('graphicsByColor', JSON.stringify(graphicsByColor));
              }
            if(graphicsButton.buttonId=="Cancel"){
              graphicsEditing=false;
              processGraphic(graphicsSelectedColorNum, graphicsSelectedGraphic);
              populateCars();
              
              }
            if(graphicsButton.buttonId=="Retake"){
              graphicsTake();              
              }
            found=true;
            if(graphicsButton.buttonId=="car"){
              //dbuga('car touchstart');
              found=false;              
              }
            }
          }
        if(found==false){
          //dbuga('closeModals found=false 2');
          if(graphicsEditing==false){
            closeModals(); // tap closed on background touch
            }
          else{            
            graphicsEvent=e;
            graphicsTouching=true;
            startMoveGraphics();
            //dbuga('graphics  touchstart! '+e.touches.length);
            }
          }
        else{populateGraphics();}

        }
      else{// normal landscape start pan zoom
        prevTouchX=t.pageX;
        prevTouchY=t.pageY-adHeight;
        }    
      }
    }
  //end of touchstarts
  if(e.type=="touchmove"){// still in handleEventLandscape
    if(carsUp){
      return false;
      }
    if((graphicsUp==true)&&(graphicsEditing==false)){
      return false;
      }
    if(t.pageY>landscapeScreenHeight-colorsHeight){
      if(colorsUp==true){
        return false;
        }
      }
    if((graphicsUp)&&(graphicsTouching)){
      graphicsEvent=e;
      moveGraphics();
      //dbuga('graphics  touchmove! '+e.touches.length);
      }
    else{
      //normal drag of pan zoom camera on table
      var deltaX=prevTouchX-t.pageX;
      var deltaY=prevTouchY-(t.pageY-adHeight);
      combinedZoom[focusTrain]-=deltaY/5;
      if(t.pageY-adHeight>(boardWidth/2)){cameraRotationDegrees[focusTrain]+=deltaX/2.5;}
      else{cameraRotationDegrees[focusTrain]-=deltaX/15;}
      if(combinedZoom[focusTrain]<0){combinedZoom[focusTrain]=0;}
      if(combinedZoom[focusTrain]>100){combinedZoom[focusTrain]=100;}
      prevTouchX=t.pageX;
      prevTouchY=t.pageY-adHeight;
      }
    }
  if(e.type == "touchend"){
    if((graphicsUp)&&(graphicsTouching)){
      graphicsEvent=e;
      //dbuga('graphics  touchend! '+e.touches.length);
      if(e.touches.length >0){
        startMoveGraphics();
        }
      else{
        graphicsTouching=false;
        postviewGraphics();
        }
      }
    }
  }

function encode(data){
  var str = String.fromCharCode.apply(null,data);
  return btoa(str).replace(/.{76}(?=.)/g,'$&\n');
  }
function saveGraphics(){
  var cameraCtx=cameraCanv.getContext('2d');
  var dataURL = cameraCanv.toDataURL('image/jpeg');
  var imageId= graphicsByColor[colorArray[graphicsSelectedColorNum]][graphicsSelectedGraphic].imageId;
  var image=document.getElementById(imageId);
  image.onload=function (){
    saveComplete();
    };
  image.src = dataURL;
  localStorage.setItem(imageId, dataURL);

  }
function saveComplete(){
  processGraphic(graphicsSelectedColorNum, graphicsSelectedGraphic);
  populateCars();
  populateGraphics();
  updateColorsCanv();
  }

var helpImages=["info0", "info1", "info2", "info3", "info4"];
var atHelp=0;
var helpUp=false;
function closeHelp(){
  document.getElementById('helpCanvas').style.display="none";
  helpUp=false;
  }

var graphicsTouching=false;
var graphicsEvent;

var graphicsStartX;
var graphicsStartY;
var graphicsStartR;
var graphicsAtX;
var graphicsAtY;
var graphicsAtR;

var graphicsStartScale=1;
var graphicsStartOffsetX=0;
var graphicsStartOffsetY=0;
var graphicsScale=1;
var graphicsOffsetX=0;
var graphicsOffsetY=0;

function startMoveGraphics(){
  var sumX=0;
  var sumY=0;
  for (var t=0; t<graphicsEvent.touches.length; t++){
    sumX+=graphicsEvent.touches[t].pageX;
    sumY+=graphicsEvent.touches[t].pageY;
    }
  graphicsAtX=sumX/graphicsEvent.touches.length;
  graphicsAtY=sumY/graphicsEvent.touches.length;
  var sumR=0;
  for (var t=0; t<graphicsEvent.touches.length; t++){
    var deltaX=graphicsEvent.touches[t].pageX-graphicsAtX;
    var deltaY=graphicsEvent.touches[t].pageY-graphicsAtY;
    sumR+=Math.sqrt(deltaX*deltaX+deltaY*deltaY);
    }
  graphicsAtR=sumR/graphicsEvent.touches.length;

  graphicsStartX=graphicsAtX;
  graphicsStartY=graphicsAtY;
  graphicsStartR=graphicsAtR;

  graphicsStartScale=graphicsScale;
  graphicsStartOffsetX=graphicsOffsetX;
  graphicsStartOffsetY=graphicsOffsetY;
  }

function moveGraphics(){
  var sumX=0;
  var sumY=0;
  for (var t=0; t<graphicsEvent.touches.length; t++){
    sumX+=graphicsEvent.touches[t].pageX;
    sumY+=graphicsEvent.touches[t].pageY;
    }
  graphicsAtX=sumX/graphicsEvent.touches.length;
  graphicsAtY=sumY/graphicsEvent.touches.length;
  var sumR=0;
  for (var t=0; t<graphicsEvent.touches.length; t++){
    var deltaX=graphicsEvent.touches[t].pageX-graphicsAtX;
    var deltaY=graphicsEvent.touches[t].pageY-graphicsAtY;
    sumR+=Math.sqrt(deltaX*deltaX+deltaY*deltaY);
    }
  graphicsAtR=sumR/graphicsEvent.touches.length;
  var deltaX=graphicsAtX-graphicsStartX;
  var deltaY=graphicsAtY-graphicsStartY;
  var deltaR=graphicsAtR-graphicsStartR;

  //dbuga('deltaX='+deltaX);
  //dbuga('deltaY='+deltaY);
  //dbuga('deltaR='+deltaR);
  var tryScale=graphicsStartScale-(deltaR/screenWidth);
  var tryX=graphicsStartOffsetX-deltaX;
  var tryY=graphicsStartOffsetY-deltaY;
  var image=document.getElementById('cameraImg');
  var moved=false;
  if(testImageSample(image, tryScale, tryX, tryY)){// priority all
    graphicsScale=tryScale;
    graphicsOffsetX=tryX;
    graphicsOffsetY=tryY;
    moved=true;
    //dbuga('all');
    }
  if(moved==false){
    if(testImageSample(image, graphicsScale, tryX, tryY)){// omit scale
      graphicsOffsetX=tryX;
      graphicsOffsetY=tryY;
      moved=true;

      graphicsStartR=graphicsAtR;
      graphicsStartScale=graphicsScale;

      //dbuga('omit Scale');
      }
    }
  if(moved==false){
    if(testImageSample(image, tryScale, graphicsOffsetX, tryY)){// omit X
      graphicsScale=tryScale;
      graphicsOffsetY=tryY;

      graphicsStartX=graphicsAtX;
      graphicsStartOffsetX=graphicsOffsetX;
      //dbuga('omit X');
      }
    }
  if(moved==false){
    if(testImageSample(image, tryScale, tryX, graphicsOffsetY)){// omit Y
      graphicsScale=tryScale;
      graphicsOffsetX=tryX;
      graphicsStartY=graphicsAtY;
      graphicsStartOffsetY=graphicsOffsetY;      
      moved=true;
      //dbuga('omit Y');
      }
    }
  if(moved==false){
    //dbuga('no move');
    }
  //dbuga('graphicsScale='+graphicsScale);
  //dbuga('graphicsOffsetX='+graphicsOffsetX);
  //dbuga('graphicsOffsetY='+graphicsOffsetY);
  previewGraphics();
  //dbuga('completed moveGraphics');
  }
function fixCamera(){
  transformString='';
  transformString+='rotateX(0deg) ';
  transformString+='rotateZ(0deg)';
  transformString+='translateX('+(boardWidth*0)+'px) ';
  transformString+='translateY('+(boardHeight*0)+'px) ';
  //transformString+='translateX(0) ';
  //transformString+='translateY(0) ';
  //dbug(transformString);
  table.style.webkitTransform=transformString;
  
  
  transformString='translateZ('+((100-100)*boardHeight/100)+'px) translateY('+(0*boardWidth/100)+'px)';
  zoom.style.webkitTransform=transformString;

  }
function locateCamera(){

  cameraXpercent=100-100*camPos.x/cellsAcross;
  cameraYpercent=100-100*camPos.y/cellsDown;

  //dbug("locateCamera");
  //dbuga("screen "+screenWidth+"x"+screenHeight);
  //dbuga("viewport "+viewportWidth+"x"+viewportHeight);
  centerAmount=0;
  if(combinedZoom[focusTrain]<50){
    centerAmount=(100-combinedZoom[focusTrain]*2)/100;
    }
  xDif=cameraXpercent-50;
  yDif=cameraYpercent-50;
  xMod=xDif*centerAmount;
  yMod=yDif*centerAmount;
  var landscapePx=Math.abs(cellsAcross-cellsDown)*cellSize;
  useX=cameraXpercent-xMod;
  useY=cameraYpercent-yMod;
  
  var useDeg=cameraRotationDegrees[focusTrain];
  if(combinedZoom[focusTrain]>95){
    useDeg=cameraRotationDegrees[focusTrain]-camPos.d;
    }
  //dbuga("combinedZoom["+focusTrain+"] "+combinedZoom[focusTrain]);
  //dbuga("camPos.d "+camPos.d);
  //dbuga("useDeg "+useDeg);
  //dbuga("cameraRotationDegrees["+focusTrain+"] "+cameraRotationDegrees[focusTrain]);
  //dbuga("cameraTilt "+ cameraTilt);
  //dbuga("useX "+useX);
  //dbuga("useY "+useY);
  //dbuga("landscapePx "+ landscapePx);

  //table rotates, tilts and moves xy under camera centerline
  transformString='';
  transformString+='translateY(' + (visHeight-boardHeight)/2 + 'px) ';
  transformString+='translateX(' + (viewportWidth-boardWidth)/2 + 'px) ';
  transformString+='rotateX('+cameraTilt+'deg) ';
  transformString+='rotateZ('+useDeg+'deg)';
  transformString+='translateY(' + boardHeight*(useY-50)/100+'px) ';
  transformString+='translateX(' + boardWidth*(useX-50)/100+'px) ';

  table.style.webkitTransform=transformString;
  var uncenter=1-centerAmount;
  var cameraDistancePx=(100-cameraDistancePercent)*boardWidth/100-cameraDistancePercent*adHeight*2/100;
  //dbuga(cameraDistancePercent+" "+cameraDistancePx)
   var cabViewDown=uncenter*cellSize/5;
   var cabViewForward=uncenter*landscapePx+cellSize/7;
  //dbuga("cameraDistancePercent="+cameraDistancePercent);
  //dbuga("cameraDistancePx="+cameraDistancePx);
  //dbuga("cabViewForward:"+ cabViewForward);
  
  transformString='translateZ('+(cameraDistancePx+cabViewForward)+'px) translateY('+cabViewDown+'px) translateX(0px)';
  zoom.style.webkitTransform=transformString;
  //dbuga(transformString);
  }



var lox=.5;
var loy=0;




var lastX=0;
var lastY=0;
var centerSize=24;
function xyOn(x,y, dir, dist){
  var leftPx=x*cellSize;
  var topPx=y*cellSize+boardPad;
  document.getElementById("prerails").style.top=topPx+"px";
  document.getElementById("prerails").style.left=leftPx+"px";
  if((dist>centerSize)&&(x<cellsAcross)){
    if(dir=="l"){leftPx-=cellSizeHalf;}
    if(x<(cellsAcross-1)){
      if(dir=="r"){leftPx+=cellSizeHalf;}
      }
    if(dir=="t"){topPx-=cellSizeHalf;}
    if(dir=="b"){topPx+=cellSizeHalf;}
    }
  document.getElementById("highlighter").style.top=topPx+"px";
  document.getElementById("highlighter").style.left=leftPx+"px";
  document.getElementById("highlighter").style.display="block";
  }
function xyOff(x,y){
  document.getElementById("highlighter").style.display="none";
  }
var cachePageX=0;
var cachePageY=0;

function xydirFromTouch(thisTouch){
  var xydirObject=new Object();
  xydirObject.x=Math.floor((thisTouch.pageX)/cellSize);
  xydirObject.y=Math.floor((thisTouch.pageY-boardPad)/cellSize);

  centerX=cellSizeHalf+(cellSize*xydirObject.x);
  centerY=cellSizeHalf+(cellSize*xydirObject.y);
  if(Math.abs(centerX-thisTouch.pageX)>Math.abs(centerY-(thisTouch.pageY-boardPad))){
    // further on X axis
    if (centerX-thisTouch.pageX > 0){
      xydirObject.dir="l";
      }
    else{
      xydirObject.dir="r";
      }
    }
  else{
    // further on Y axis
    if (centerY-(thisTouch.pageY-boardPad) > 0){
      xydirObject.dir="t";
      }
    else{
      xydirObject.dir="b";
      }
    }
  distX=Math.abs(centerX-thisTouch.pageX);
  distY=Math.abs(centerY-(thisTouch.pageY-boardPad));
  xydirObject.dist=Math.sqrt(distX*distX + distY*distY);
  return xydirObject;

  }
// global vars for touch metrics
var lastSquare="";
var startDir="";
var lastDir="";
var lastDist=0;
var inSquare="";
//These are really global
var squareX=99;
var squareY=99;
var lastLastDir="";
function handleEventLevels(event){
  var typ = event.type;
  if(typ == "touchstart"){
    var x=event.touches[0].pageX;
    var y=event.touches[0].pageY-adHeight;
    //dbug("touchstart "+x+" "+y);
    for (var b=0; b<levelButtons.length; b++){
      if((x>levelButtons[b].l)&&(x<levelButtons[b].r)&&(y>levelButtons[b].t)&&(y<levelButtons[b].b)){
        if(b==levelButtons.length-1){
          
          }
        else{
          atLevel=b;
          drawLevels();
          window.setTimeout("createLevel()",200);
          }
       //dbuga('closeModals handleEventLevels');

        closeModals();
        }
      }
    }
  }
var menuTouchingId="";
function handleEventMenu(event){
  var typ = event.type;
  if(typ == "touchstart"){
    menuTouchingId="";
    var x=event.touches[0].pageX;
    var y=event.touches[0].pageY;
    var keys=Object.keys(menuObject);
    for (var k=0; k<keys.length; k++){
      if((menuObject[keys[k]].t<y)&&(menuObject[keys[k]].r>x)&&(menuObject[keys[k]].b>y)&&(menuObject[keys[k]].l<x)){
        menuTouchingId=keys[k];
        }
      }
    }
  if((typ=="touchstart")||(typ=="touchmove")){
    if(menuTouchingId !=""){
      var x=event.touches[0].pageX;
      var y=event.touches[0].pageY;
      var w=menuObject[menuTouchingId].r-menuObject[menuTouchingId].l;
      var prog=(x-menuObject[menuTouchingId].l)/w;
      if(prog<0){prog=0;}
      if(prog>1){prog=1;}
      //dbug(prog);
      menuObject[menuTouchingId]["pos"]=prog*2-1;
      menuDraw();
      }
    }
  if(typ=="touchend"){
    if(menuTouchingId !=""){
      var pos=menuObject[menuTouchingId].pos; //-1 to 1
      var selection=Math.floor(pos+1+1/3);
      //dbuga("pos:" +pos +" selection:"+selection);
      menuObject[menuTouchingId]["value"]=menuObject[menuTouchingId]["values"][selection];
      menuObject[menuTouchingId]["pos"]=selection-1;
      saveStorage();
      menuTouchingId="";
      menuDraw();
      }
    }
  }
function createLevel(){
          var fails=-1;
          var boost=1;
          while(fails!=0){
            //dbuga("retrying from scratch fails "+fails);
            fails=0;
            resetBoardTimersObjects();
            buildSequence=new Array();
            var thisData=levelData[atLevel].fields;
            //dbuga('levelData['+atLevel+'].fields.length='+levelData[atLevel].fields.length);
            for (var c=0; c<thisData.length; c++){
              fails+=addColor(thisData[c],4);
              }
            }
          restartIntervals();
  updateColorsCanv();
  }
var colorsHeight=64;
function updateColorsCanv(){
  //dbuga('updateColorsCanv()');
  var h=colorsHeight;
  if(screenHeight<500){h=44;}
  colorsCanv.width=screenHeight;
  colorsCanv.height=h;
  colorsCanv.style.top=(landscapeScreenHeight-h)+"px";
  
  var colorsCtx=colorsCanv.getContext("2d");
  if(colorsUp){
    var grad = colorsCtx.createLinearGradient(0, 0, 0, h);
    grad.addColorStop(0, "rgba(225,225,225,.75)");
    grad.addColorStop(0.2, "rgba(225,225,225,.90)");
    grad.addColorStop(0.5, "rgba(255,255,255,.80)");
    grad.addColorStop(0.8, "rgba(255,255,255,.90)");
    grad.addColorStop(1, "rgba(255,255,255,.75)");
    colorsCtx.fillStyle=grad;
    colorsCtx.fillRect(0,0,screenHeight, h);
   
    colorsCtx.lineWidth=h/10;
    colorsCtx.strokeStyle="black";
    colorsCtx.beginPath();
    colorsCtx.arc(h/2, h/2, h/2.5, 0, pi*2, true);
    colorsCtx.moveTo(h/2-h/4, h/2-h/4);
    colorsCtx.lineTo(h/2+h/4, h/2+h/4);
    colorsCtx.moveTo(h/2+h/4, h/2-h/4);
    colorsCtx.lineTo(h/2-h/4, h/2+h/4);
    colorsCtx.stroke(); 

    colorsCtx.strokeStyle="black";
    colorsCtx.fillStyle="rgba(255,255,255,.9)";
    if((carsUp)||(graphicsUp)){
      colorsCtx.fillStyle=highlighted;
      }    
    colorsCtx.lineWidth=h/24;
    roundRect(colorsCtx, h*1+h/20,h/20, h*3-h/10, h-h/10, h/7, true, true);
    colorsCtx.drawImage(imgRefs['boxsidetrans'],h*1+h/8,h/8, h*3-h/4, h-h/4); 

    if(trainData.length>1){
      for (var c=0; c<levelData[atLevel].fields.length; c++){
        colorsCtx.lineWidth=h/10;
        colorsCtx.fillStyle=rgbArray[c];
        colorsCtx.strokeStyle=rgbArray[c];
        colorsCtx.beginPath();
        colorsCtx.arc(screenHeight-h/2-h*c, h/2, h/2.5, 0, pi*2, true);
        if(c==focusTrain){
          colorsCtx.fill();
          }
        colorsCtx.stroke();
        }
      }
    var fontPx=h/2.5;
    colorsCtx.fillStyle="black";
    colorsCtx.font=fontPx+"px akzi";
    colorsCtx.textAlign="center";
    colorsCtx.textBaseline="middle";
    if(carsUp){
      colorsCtx.fillText("Select a car", screenHeight/2,h/4);
      colorsCtx.fillText("to repaint", screenHeight/2,3*h/4);
      }
    else if(graphicsUp){
      if(graphicsEditing){
        colorsCtx.fillText("Pinch to", screenHeight/2,h/4);
        colorsCtx.fillText("Pan and Zoom", screenHeight/2,3*h/4);
        }
      else{
        colorsCtx.fillText("Modify", screenHeight/2,h/4);
        colorsCtx.fillText("Boxcar", screenHeight/2,3*h/4);
        }

      }  
    else{
      colorsCtx.fillText("Drag to zoom", screenHeight/2,h/4);
      colorsCtx.fillText("Rotate to play", screenHeight/2,3*h/4);
      }  
    }
  else{
    colorsCtx.lineWidth=7;
    colorsCtx.strokeStyle="rgba(0,0,0,.2)";
    colorsCtx.beginPath();
    colorsCtx.arc(h/2, h/2, h/2.5, 0, pi*2, true);

    colorsCtx.stroke(); 
    }
  }
function handleEventDraw(e){
  var typ = e.type;

  //dbuga("handleEventDraw:"+typ);
  attemptDraw=false;
  if ((typ == "touchstart")||(typ == "touchmove")){  
    target=e.touches[0].target.id;
    xydir=xydirFromTouch(e.touches[0]);
    }

  if (typ == "touchmove"){
    if (xydir.y>=cellsDown){
      // out of bounds
      typ="outofbounds";
      lastSquare="";
      lastDir="";
      startDir="";
      }
    }
  if (typ == "touchstart"){
    inSquare=xydir.x+" "+xydir.y;
    lastSquare=xydir.x+" "+xydir.y;
    squareX=xydir.x;
    squareY=xydir.y;
    startDir=xydir.dir
    }
  if ((typ == "touchmove")||(typ == "touchstart")){
    xyOn(xydir.x, xydir.y, xydir.dir, xydir.dist);
    }
  if(typ=="touchmove"){
    inSquare=xydir.x+" "+xydir.y;
    if (lastSquare != inSquare){

      //dbuga("<br> inSquare="+inSquare +" != lastSquare="+lastSquare+" ");
      //xyOff(squareX, squareY);
      if(startDir != lastDir){
        //dbuga(" startDir="+startDir +" != lastDir="+lastDir+" ");
        }
      attemptDraw=true;


      }
    else{
      //just moved within square
      lastDir=xydir.dir;
      squareX=xydir.x;
      squareY=xydir.y;
      lastDist=xydir.dist;
      cellType="none";

      hidePretracks();

      if((startDir=="t")&&(lastDir=="b")){cellType="tbPre";}
      if((startDir=="b")&&(lastDir=="t")){cellType="tbPre";}
      if((startDir=="l")&&(lastDir=="r")){cellType="lrPre";}
      if((startDir=="r")&&(lastDir=="l")){cellType="lrPre";}
      if((startDir=="t")&&(lastDir=="l")){cellType="tlPre";}//ccw
      if((startDir=="l")&&(lastDir=="t")){cellType="tlPre";}//cw
      if((startDir=="t")&&(lastDir=="r")){cellType="trPre";}//ccw
      if((startDir=="r")&&(lastDir=="t")){cellType="trPre";}//cw
      if((startDir=="b")&&(lastDir=="l")){cellType="blPre";}//ccw
      if((startDir=="l")&&(lastDir=="b")){cellType="blPre";}//cw
      if((startDir=="b")&&(lastDir=="r")){cellType="brPre";}//ccw
      if((startDir=="r")&&(lastDir=="b")){cellType="brPre";}//cw
      if(lastDist<centerSize){
        if(startDir=="r"){cellType="rPre";}
        if(startDir=="l"){cellType="lPre";}
        if(startDir=="t"){cellType="tPre";}
        if(startDir=="b"){cellType="bPre";}
        }
      if(cellType != "none"){
        document.getElementById(cellType).style.display="block";
        }
      }
    }
  if(typ=="touchend"){
    if(lastDir != startDir){
      // end having moved across square
      if (lastDist>centerSize){
        // but not ending in the center
        attemptDraw=true;
        }
      }
    }



  if(attemptDraw == true){
    attemptDrawTrack();
    }
  if (lastSquare != inSquare){
    if(typ=="touchmove"){
      lastSquare=inSquare;
      startDir=xydir.dir;
      lastDir="";
      }
    }
  if(typ=="touchend"){
    hidePretracks();
    if(squareY<cellsDown){
      xyOff(squareX, squareY);
      }
    lastSquare="";
    startDir="";
    lastDir="";
    inSquare="";
    }
  }

function attemptDrawTrack(){
  // DRAW TRACK!!!!
  targetCell="grid_"+squareX+"_"+squareY;
  //dbuga(" attemptDraw targetCell="+targetCell+" ");
  cellType="error";
  if((startDir=="t")&&(lastDir=="b")){cellType="tb";}
  if((startDir=="b")&&(lastDir=="t")){cellType="tb";}
  if((startDir=="l")&&(lastDir=="r")){cellType="lr";}
  if((startDir=="r")&&(lastDir=="l")){cellType="lr";}
  if((startDir=="t")&&(lastDir=="l")){cellType="tl";}//ccw
  if((startDir=="l")&&(lastDir=="t")){cellType="tl";}//cw
  if((startDir=="t")&&(lastDir=="r")){cellType="tr";}//ccw
  if((startDir=="r")&&(lastDir=="t")){cellType="tr";}//cw
  if((startDir=="b")&&(lastDir=="l")){cellType="bl";}//ccw
  if((startDir=="l")&&(lastDir=="b")){cellType="bl";}//cw
  if((startDir=="b")&&(lastDir=="r")){cellType="br";}//ccw
  if((startDir=="r")&&(lastDir=="b")){cellType="br";}//cw
  
  if (isTiled(squareX, squareY)==true){cellType="error";}// can't track on a tiled cell
//dbug("isTiled("+squareX+", "+squareY+")="+isTiled(squareX, squareY));
  // source hookups pass at this point... 
  if (cellType != "error"){
    passSourceTests=true;
    var dirsArray=cellType.split("");
    for (d=0; d<2; d++){
      thisDir=dirsArray[d];
      tX=Number(squareX)+Number(xDeltaByDir[thisDir]);
      tY=Number(squareY)+Number(yDeltaByDir[thisDir]);
      if ((isSourceInDir(tX, tY, thisDir)==false)&&(isTiled(tX, tY)==true)){
        passSourceTests=false;
        }
      }
    if (passSourceTests == false){
      cellType="error";
      }
    }
   //dbuga(" cellType="+cellType);
  if (cellType != "error"){
    // test cell for extant track
    //var cn=document.getElementById(targetCell).childNodes;
    cn=tilesByGridXY[targetCell];
    cnl=cn.length;
    tracksGlom="|";
    for (n=0; n<cnl; n++){
      //thisClass=cn[n].className;
      thisClass=cn[n];
      tracksGlom+=thisClass+"|";
      }
    if (tracksGlom.indexOf(cellType)==-1){
      fullCellGlom+="grid_"+squareX+"_"+squareY;
      createTrack(cellType, targetCell);
      createCanvasTrack(cellType, squareX, squareY);
      buildSequence.push(new buildObject("track", "", cellType, squareX, squareY, 0));
      //playSound("laytrack");
      lastLastDir=lastDir;
      ////lastDir="";// try to fix pretack
      hidePretracks();
      } 
    }
  }
var pretrackArray=new Array("blPre","brPre","tlPre","trPre","lrPre","tbPre","tPre","bPre","lPre","rPre");
function hidePretracks(){
  for (p=0; p<pretrackArray.length; p++){
    pId=pretrackArray[p];
    document.getElementById(pId).style.display="none";
    }
  }

//functions that examine the board state



function isSourceInDir(xx,yy,d){
  useD=reverseObject[d];
  cellIsSource=false;
  if((xx>-1)&&(xx<cellsAcross)&&(yy>-1)&&(yy<cellsDown)){
    testCell="grid_"+xx+"_"+yy;
    //var cn=document.getElementById(testCell).childNodes;
    var cn=tilesByGridXY[testCell];
    for (n=0; n<cn.length; n++){
      //thisClass=cn[n].className;
      thisClass=cn[n];
      if ((thisClass==useD+"s")||(thisClass==useD+"d")){
        cellIsSource=true;
        }
      }
    }
  return cellIsSource;
  }
function isTiled(x,y){
  tiled=false;
  if((x<0)||(x>=cellsAcross)||(y<0)||(y>=cellsDown)||(isNaN(x))){
    //out of bounds, call it tiled
    //dbuga('<br>out of bounds, call it tiled'+x+" "+y);
 
    tiled=true;
    }
  else{
    testCell2="grid_"+x+"_"+y;
    //var cn=document.getElementById(testCell2).childNodes;
    var cn=tilesByGridXY[testCell2];
    for (n=0; n<cn.length; n++){
      //thisClass=cn[n].className;
      thisClass=cn[n];
      //if ((thisClass.indexOf('source')>-1)||(thisClass.indexOf('dest')>-1)){
      if (thisClass.indexOf('tile')>-1){
        tiled=true;
        }
      }
    }
  return tiled;
  }

function openAdjacentCellsArray(x, y, excludeCell){
  var openArray=new Array();
  var returnArray=new Array();
  xMinus=x-1;
  xPlus=x+1;
  yMinus=y-1;
  yPlus=y+1;

  if (isTiled(xMinus, y)==false){
    if(excludeCell != "grid_"+xMinus+"_"+y){
      openArray.push("grid_"+xMinus+"_"+y);
      }
    }
  if (isTiled(xPlus, y)==false){
    if(excludeCell != "grid_"+xPlus+"_"+y){
      openArray.push("grid_"+xPlus+"_"+y);
      }
    }
  if (isTiled(x, yPlus)==false){
    if(excludeCell != "grid_"+x+"_"+yPlus){
      openArray.push("grid_"+x+"_"+yPlus);
      }
    }
  if (isTiled(x, yMinus)==false){
    if(excludeCell != "grid_"+x+"_"+yMinus){
      openArray.push("grid_"+x+"_"+yMinus);
      }
    }
  if(openArray.length==3){
    excludeNum=Math.floor(Math.random()*3);
    }
  else{
    excludeNum=4;
    }
  for (o=0; o<openArray.length; o++){
    if(o != excludeNum){
      returnArray.push(openArray[o]);
      }
    }
  return returnArray;
  }
function processTransPanel(){
  var c=document.getElementById("myCanvas");
  var ctx=c.getContext("2d");
  var imgData=ctx.createImageData(100,100);
  for (var i=0;i<imgData.data.length;i+=4)
    {
    imgData.data[i+0]=255;
    imgData.data[i+1]=0;
    imgData.data[i+2]=0;
    imgData.data[i+3]=255;
    }
  ctx.putImageData(imgData,10,10);
  }
// done.js

var atImage=0;
var atFolder=0;
var imageIdArray=["boxside","boxtop","boxend", "enginefloor", "engineroof", "enginenose", "enginecab", "enginestarinner", "enginestarouter", "engineportinner", "engineportouter"];
var folderArray=["source","trans","grey","green","blue","orange","black"];
var imgRefs={};
function preloadTick(){
  //dbugc(atImage);
  if(atImage<imageIdArray.length){
    var imageId=imageIdArray[atImage]+folderArray[atFolder];
    imgRefs[imageId]=document.getElementById(imageId);

    atFolder++;
    if(atFolder>=folderArray.length){
      atFolder=0;
      atImage++;
    }
    window.setTimeout('preloadTick()',100);
  }
  else{
    graphicsTick();
  }
}
var colorArray=["black","orange","blue","green"];
var rgbValArray=[[30,30,30],[218,37,28],[0,91,161],[63,179,160]];
var rgbArray=["rgb(30,30,30)","rgb(218,37,28)","rgb(0,91,161)","rgb(63,179,160)"];

var graphicsByColor={};
function initGraphicsByColor(){
  var atDefault=0;
  for (var c=0; c<colorArray.length; c++){
    var color=colorArray[c];
    graphicsByColor[color]=[];
    var x=0; 
    var y=0;
    for (var i=0; i<12; i++){
      var imageObj={
        "imageId":"default"+atDefault,
        "blackTrans":false,
        "x":x,
        "y":y        
        }
      graphicsByColor[color].push(imageObj);
      atDefault++;
      x++;
      if(x>2){
        x=0;
        y++;
        }
      }
    }
  }

/*
var graphicsByColor={
  "black":[{"imageId":"default0", "blackTrans":true},{"imageId":"default1", "blackTrans":true},{"imageId":"default2", "blackTrans":true}],
  "orange":[{"imageId":"default3", "blackTrans":true},{"imageId":"default4", "blackTrans":true},{"imageId":"default5", "blackTrans":true}],
  "blue":[{"imageId":"default6", "blackTrans":true},{"imageId":"default7", "blackTrans":false},{"imageId":"default8", "blackTrans":true}],
  "green":[{"imageId":"default9", "blackTrans":false},{"imageId":"default10", "blackTrans":false},{"imageId":"default11", "blackTrans":true}]
}
*/
var atColor=0;
var atGraphic=0;

function graphicsTick(){
  //dbugc("-");
  var color;
  if(atColor<colorArray.length){
    color=colorArray[atColor];
    processGraphic(atColor, atGraphic);
    atGraphic++;
    if(atGraphic>=graphicsByColor[color].length){
      atGraphic=0;
      atColor++;
      }
    window.setTimeout('graphicsTick()',10);
    }
  else{// finished last color so resume
    resumeInit();
    }
  }
function processGraphic(colorNum, graphicNum){
  var color=colorArray[colorNum];
  
  var imageId= graphicsByColor[color][graphicNum].imageId;
  //dbuga('processGraphic('+colorNum+', '+graphicNum+')'+imageId);
  
  var blackTrans= graphicsByColor[color][graphicNum].blackTrans;
  //dbuga("processGraphic "+colorNum+", "+graphicNum+" blackTrans="+blackTrans);
  var alphaSourceRef=imgRefs['boxsidesource'];
  var alphaRef=returnCanvas(alphaSourceRef.width, alphaSourceRef.height);
  imageCanvas(alphaRef, alphaSourceRef);
  var textureSourceRef=imgRefs['boxsidetrans'];
  var textureRef=returnCanvas(textureSourceRef.width, textureSourceRef.height);
  transifyCanvas(textureRef, textureSourceRef);

  if(blackTrans==false){
    //make flat
    var flatSourceRef=document.getElementById(imageId);
    var flatRef=returnCanvas(textureSourceRef.width, textureSourceRef.height);
    placeWithin(flatRef, flatSourceRef); 
    var flatOutputRef=returnCanvas(textureSourceRef.width, textureSourceRef.height);
    colorizeCanvas(flatOutputRef, textureRef, alphaRef, [127,127,127]);
    overlayCanvas(flatOutputRef, flatRef);
    graphicsByColor[color][graphicNum].ref= flatOutputRef;
    }
  else{
    //make logo source
    var logoSourceRef=document.getElementById(imageId);
    var logoRef=returnCanvas(textureSourceRef.width, textureSourceRef.height);
    //document.body.appendChild(logoRef);
    placeWithin(logoRef, logoSourceRef);
     
    //make texture logo
    var logoTextureRef=returnCanvas(textureSourceRef.width, textureSourceRef.height);
    colorizeCanvas(logoTextureRef, textureRef, alphaRef, [127,127,127]);
    overlayCanvas(logoTextureRef, logoRef);
    trimBox(logoTextureRef);  
    blackToTrans(logoTextureRef);
    graphicsByColor[color][graphicNum].ref= logoTextureRef;
    }
  }


function trimBox(canv){
  var g=Math.floor(canv.width/24);
  var ctx=canv.getContext('2d');
  ctx.clearRect(0,0,g*24,g);
  ctx.clearRect(0,0,g,g*8);
  ctx.clearRect(0,g*7,g*24,g);
  ctx.clearRect(g*23,0,g,g*8);
  //dbuga(g);
  }
function returnCanvas(w,h){
  var canvas=document.createElement("canvas");
  canvas.width = w;
  canvas.height = h;
  return canvas;
  }
function transifyCanvas(transCanvas, sourceRef){
  return false;////

  var transCtx = transCanvas.getContext("2d");

  transCtx.drawImage(sourceRef, 0, 0);
  var image = transCtx.getImageData(0, 0, sourceRef.width, sourceRef.height);
  var imageData = image.data
  var length = imageData.length;
  var mostSatPixel=-1;
  var mostSatFrac=0;
  var mostSatAvg=0;
  var leastSatPixel=-1;
  var leastSatFrac=1;
  var leastSatAvg=0;

  for(var i=0; i < length; i+=4){
    var r=imageData[i];
    var g=imageData[i+1];
    var b=imageData[i+2];
    var a=imageData[i+3];
    var avg=(r+g+b)/3;
    var rg=Math.abs(r-g);
    var gb=Math.abs(g-b);
    var br=Math.abs(b-r);
    var sat=(rg+gb+br)/510; // 0-1
    if(sat>mostSatFrac){
      mostSatPixel=i;
      mostSatFrac=sat;
      mostSatAvg=avg;
    }
    if(sat<leastSatFrac){
      leastSatPixel=i;
      leastSatFrac=sat;
      leastSatAvg=avg;
    }
  }

  for(var i=0; i < length; i+=4){
    var r=imageData[i];
    var g=imageData[i+1];
    var b=imageData[i+2];
    var a=imageData[i+3];
    var avg=(r+g+b)/3;
    var rg=Math.abs(r-g);
    var gb=Math.abs(g-b);
    var br=Math.abs(b-r);
    var sat=(rg+gb+br)/510; // 0-1

    var alpha=a-((sat)*(255));
    if(alpha<0){alpha=0;}
    avg=Math.floor((avg+0)/1);
    imageData[i]=avg;
    imageData[i+1]=avg;
    imageData[i+2]=avg;
    imageData[i+3]=Math.floor(alpha);

  }
  image.data = imageData;
  transCtx.putImageData(image, 0, 0);
}
function blackToTrans(transCanvas){
  var transCtx = transCanvas.getContext("2d");
  var image = transCtx.getImageData(0, 0, transCanvas.width, transCanvas.height);
  var imageData = image.data
  var length = imageData.length;


  var transStart=72;
  var transLimit=64;

  var transRange=transStart-transLimit;
  for(var i=0; i < length; i+=4){
    var r=imageData[i];
    var g=imageData[i+1];
    var b=imageData[i+2];
    var a=imageData[i+3];
    var avg=(r+g+b)/3;

    var rg=Math.abs(r-g);
    var gb=Math.abs(g-b);
    var br=Math.abs(b-r);
    var sat=(rg+gb+br)/510; // 0-1
    var alpha=Math.floor((avg-transLimit)*transRange);
    
    if(alpha<0){alpha=0;}
    if(alpha>255){alpha=255;}
    else{
      imageData[i+3]=Math.floor(alpha);
      }
    }
  image.data = imageData;
  transCtx.putImageData(image, 0, 0);
  }

function colorizeCanvas(colorizedCanvas, transRef, shapeRef, rgb){
  return false;////

  var r=rgb[0];
  var g=rgb[1];
  var b=rgb[2];

  var colorizedCtx=colorizedCanvas.getContext('2d');
  colorizedCtx.drawImage(transRef, 0, 0);

  var transCtx=transRef.getContext('2d');
  var shapeCtx=shapeRef.getContext('2d');
  
  var image = colorizedCtx.getImageData(0, 0, transRef.width, transRef.height);
  var shape = shapeCtx.getImageData(0, 0, transRef.width, transRef.height);
  var shapeData = shape.data
  var imageData = image.data
  var length = imageData.length;

  for(var i=0; i < length; i+=4){
    var a=shapeData[i+3];
    if(a>10){
      imageData[i]=r;
      imageData[i+1]=g;
      imageData[i+2]=b;
      imageData[i+3]=255;
    }
    else{
      imageData[i]=r;
      imageData[i+1]=g;
      imageData[i+2]=b;
      imageData[i+3]=Math.floor(255*a/4);
    }
  }
  image.data = imageData;
  colorizedCtx.putImageData(image, 0, 0);
  colorizedCtx.drawImage(transRef, 0, 0);
}
function imageCanvas(canvasRef, imageRef){
  var ctx=canvasRef.getContext("2d");
  ctx.drawImage(imageRef, 0, 0);
  } 
function overlayCanvas(canvasRef, imageRef){
  var ctx=canvasRef.getContext("2d");
  ctx.globalCompositeOperation = "overlay";
  ctx.drawImage(imageRef, 0, 0);
  } 
function multiplyCanvas(canvasRef, imageRef){
  var ctx=canvasRef.getContext("2d");
  ctx.globalCompositeOperation = "multiply";
  ctx.drawImage(imageRef, 0, 0);
  } 
function placeWithin(canvasRef, imageRef){
  var g= canvasRef.width/24;
  var ctx=canvasRef.getContext("2d");
  ctx.drawImage(imageRef, g,g, g*22,g*6);
  } 




// chromaris switches
//toggleSwitch(4,4,"horizontal",0, ["a","b","c"], "alphabet");
var len=2;
var slot=1.5;
function menuDraw(){
  
  var keys=Object.keys(menuObject);
  var g=screenWidth/18;
  var cx=9;
  var cy=(screenHeight/2-screenWidth/2)/g+cx;
  var canv=document.getElementById('menuCanvas');
  canv.width=canv.width;
  var ctx=canv.getContext('2d');
  for (var k=0; k<keys.length; k++){
    var y=(k-2.5)*5;
    toggleSwitch(0,y,"horizontal",menuObject[keys[k]]['pos'], menuObject[keys[k]]['values'], keys[k]);
    x0=cx;
    y0=cy+y;


    ctx.strokeRect(g*(x0-2.5), g*(y0-2.5),g*5,g*5);
    menuObject[keys[k]]["t"]=g*(y0-2.5);
    menuObject[keys[k]]["r"]=g*(x0+2.5);
    menuObject[keys[k]]["b"]=g*(y0+2.5);
    menuObject[keys[k]]["l"]=g*(x0-2.5);
    }
  populateMenu();
  ctx.font=g/1.5+"px Arial";
  ctx.fillStyle="#666";
  ctx.textAlign="center";
  ctx.fillText("MIN FPS: "+minFramesPerSecond,g*cx,g*(cy+6));
  
  }
     
function toggleSwitch(x0,y0,orient,pos, tics, label){//returns path
  var g=screenWidth/18;
  var cx=9;
  var cy=(screenHeight/2-screenWidth/2)/g+cx;
  x0+=cx;
  y0+=cy;



  var canv=document.getElementById('menuCanvas');
  var ctx=canv.getContext('2d');

  ctx.clearRect(g*(x0-2.5), g*(y0-2.5),g*5,g*5);

  ctx.strokeStyle="#444";
  if(orient=="vertical"){x0--;}


  ctx.fillStyle="#444";
  
  if(orient=="horizontal"){
    var min=(x0-len)*g;
    var max=(x0+len)*g;
    
    var range=max-min;
    var step=range/(tics.length-1);
    ctx.font=g/1.5+"px azki";
    
    ctx.strokeStyle="#444";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
 
    ctx.font=g/1.5+"px Arial";
    for (var t=0; t<tics.length; t++){
      ctx.fillText(tics[t], min+t*step, y0*g+g*1.25);
      }
    if(label.indexOf("VOICE")>-1){
      ctx.lineWidth=1;
      ctx.font=g/1.25+"px Arial";
      ctx.strokeText(label, x0*g,y0*g-g*1.25);
      }
    
    ctx.fillText(label, x0*g,y0*g-g*1.25);
    }
  else{
    var min=(y0-slot)*g;
    var max=(y0+slot)*g;

    var range=max-min;
    var step=range/(tics.length-1);
    ctx.font=g/1.5+"px Arial";
    ctx.strokeStyle="#444";
    ctx.textAlign="left";
    ctx.textBaseline="middle";
 
    ctx.fillText(label, x0*g-g*.5 ,y0*g+g*2);
    for (var t=0; t<tics.length; t++){
      ctx.fillText(tics[t], x0*g+g*1, min+t*step);
      }
    }


  ctx.beginPath();
  var x1;
  var y1;
  if(orient=="horizontal"){
    x1=x0+len*pos;
    y1=y0;
    ctx.arc((x0-slot)*g,(y0)*g, 2+g/2,pi*.5,pi*1.5,false);
    ctx.arc((x0+slot)*g,(y0)*g, 2+g/2,pi*1.5,pi*.5,false);
    }
  else{
    x1=x0;
    y1=y0+len*pos;
    ctx.arc((x0)*g,(y0-slot)*g, 2+g/2,pi*1,pi*0,false);
    ctx.arc((x0)*g,(y0+slot)*g, 2+g/2,pi*0,pi*1,false);
    }
  
  ctx.closePath();
  ctx.fill();

  var x1;
  var y1;
  if(orient=="horizontal"){
    x1=x0+len*pos;
    y1=y0;
    }
  else{
    x1=x0;
    y1=y0+len*pos;
    }
  var x2=x0;
  var y2=y0;  
  if(orient=="horizontal"){
    x2+=len*pos/2;
    }
  else{
    y2+=len*pos/2;
    }


  ctx.lineWidth=2;
  ctx.strokeStyle="#666";

  var p=.01;
  // px py is slight perspective offset
  var px=(cx-x1)*p;
  var py=(cy-y1)*p;
  var dx=(x0-x1+px);
  var dy=(y0-y1+py);
  var dist=Math.sqrt(dx*dx+dy*dy);
  var squeeze=1-dist/(len*2);
  var vec=Math.atan2(-dy, -dx);
  var deg=(360+Math.floor(180*vec/pi))%360;
  var mx1=x0-dx;
  var my1=y0-dy;
  ctx.beginPath();
  //ctx.arc(mx1*g,my1*g,g/2,vec-pi*1.5,vec-pi*.5,true);
  oval(ctx, mx1*g,my1*g,g/2,squeeze*g/2,vec+pi/2,true)
  ctx.arc(x2*g,y2*g,g/2,vec+pi*1.5,vec+pi*.5,true);
  ctx.closePath();
  var bgColor={"r":200, "g":200, "b":200};
  ctx.fillStyle="rgb("+ bgColor.r +","+bgColor.g+","+bgColor.b+")";
  ctx.fill();
  ctx.stroke();
  ctx.beginPath();
  oval(ctx,mx1*g,my1*g,g/2,squeeze*g/2,vec+pi/2,false);
  ctx.stroke();
  
  }
function oval(ctx, x,y,r0,r1,radians,counter){
  
  var x0=x+r0*Math.cos(radians);
  var y0=y+r0*Math.sin(radians);
  var x1=x+r1*Math.cos(radians+pi/2);
  var y1=y+r1*Math.sin(radians+pi/2);
  var x2=x+r0*Math.cos(radians+pi);
  var y2=y+r0*Math.sin(radians+pi);
  var x3=x+r1*Math.cos(radians-pi/2);
  var y3=y+r1*Math.sin(radians-pi/2);
  var cpx1=x2+r1*Math.cos(radians+pi/2);
  var cpy1=y2+r1*Math.sin(radians+pi/2);
  var cpx0=x0+r1*Math.cos(radians+pi/2);
  var cpy0=y0+r1*Math.sin(radians+pi/2);
  var cpx2=x2+r1*Math.cos(radians-pi/2);
  var cpy2=y2+r1*Math.sin(radians-pi/2);
  var cpx3=x0+r1*Math.cos(radians-pi/2);
  var cpy3=y0+r1*Math.sin(radians-pi/2);
  //plot(x0,y0,"black");
  ctx.beginPath();
  if(counter){
    //plot(cpx3,cpy3,"rgba(255,255,0,1)");
    //plot(cpx2,cpy2,"rgba(0,0,255,1)");
    ctx.moveTo(x0,y0);
    ctx.quadraticCurveTo(cpx3,cpy3,x3,y3);
    ctx.quadraticCurveTo(cpx2,cpy2,x2,y2);
    }
  else{
    //plot(cpx1,cpy1,"rgba(255,0,0,1)");
    //plot(cpx0,cpy0,"rgba(0,255,0,1)");
    ctx.moveTo(x0,y0);
    ctx.quadraticCurveTo(cpx0,cpy0,x1,y1);
    ctx.quadraticCurveTo(cpx1,cpy1,x2,y2);
    }
  ctx.stroke();
  //moveTo beginning
  //bez to perp
  //bez to end 
  }

//util.js 
function bez(ctx,x0,y0,deg0,dist0,x1,y1,deg1,dist1){
  var cp0x=x0+dist0*Math.cos(deg0/180 * Math.PI);
  var cp0y=y0+dist0*Math.sin(deg0/180 * Math.PI);
  var cp1x=x1-dist1*Math.cos(deg1/180 * Math.PI);
  var cp1y=y1-dist1*Math.sin(deg1/ 180 * Math.PI);
  ctx.bezierCurveTo(cp0x, cp0y, cp1x,cp1y, x1,y1);
}


function GetOffset (object, offset) {
            if (!object)
                return;
            offset.x += object.offsetLeft;
            offset.y += object.offsetTop;

            GetOffset (object.offsetParent, offset);
        }
function GetScrolled (object, scrolled) {
            if (!object)
                return;
            scrolled.x += object.scrollLeft;
            scrolled.y += object.scrollTop;

    if (object.tagName.toLowerCase () != "html") {
        GetScrolled (object.parentNode, scrolled);
    }
  }
function urlDecode(str) {
  return decodeURIComponent((str+'').replace(/\+/g, '%20'));
  }
function solveAngle(a, b, c) {  // Returns angle C using law of cosines
  var temp = (a * a + b * b - c * c) / (2 * a * b);
  if (temp >= -1 && temp <= 1){return radToDeg(Math.acos(temp));}
  else{return "No solution";}
  }
function degToRad(x) {
	return x / 180 * Math.PI;
}

function radToDeg(x) {
	return x / Math.PI * 180;
}
function rnd(range) {
  return Math.floor(Math.random()*range);
  }


</script>
</head>
<body onload="init()" onmousedown="dbug(''); mouseLevel();" ontouchstart="touchStart(event);" ontouchmove="touchMove(event);" ontouchend="touchEnd(event);" ontouchcancel="touchCancel(event);" style="background-color:#fff; width:100%; height:100%;">
<div id="wrapper" style="display:block; position:absolute; top:0px; left:100px; overflow:hidden; Zbackground-color:white;">
  <div id="highlighter"></div>
  <div id="prerails">
    <div id="blPre" class="bl" style="display:none;"><div class="blInner blueBorder"></div><div class="blOuter blueBorder"></div></div>
    <div id="brPre" class="br" style="display:none;"><div class="brInner blueBorder"></div><div class="brOuter blueBorder"></div></div>
    <div id="tlPre" class="tl" style="display:none;"><div class="tlInner blueBorder"></div><div class="tlOuter blueBorder"></div></div>
    <div id="trPre" class="tr" style="display:none;"><div class="trInner blueBorder"></div><div class="trOuter blueBorder"></div></div>
    <div id="lrPre" class="lr" style="display:none;"><div class="lrTop blueBorder"></div><div class="lrBottom blueBorder"></div></div>
    <div id="tbPre" class="tb" style="display:none;"><div class="tbLeft blueBorder"></div><div class="tbRight blueBorder"></div></div>

    <div id="tPre" class="ts" style="display:none;"><div class="tLeft blueBorder"></div><div class="tRight blueBorder"></div></div>
    <div id="bPre" class="bs" style="display:none;"><div class="bLeft blueBorder"></div><div class="bRight blueBorder"></div></div>
    <div id="lPre" class="ls" style="display:none;"><div class="lTop blueBorder"></div><div class="lBottom blueBorder"></div></div>
    <div id="rPre" class="rs" style="display:none;"><div class="rTop blueBorder"></div><div class="rBottom blueBorder"></div></div>
  </div>

  <div id="cameraDiv">
    <div id="zoomDiv">
      <div id="tableDiv">
<div id="gridHolder"  style="background-color:yellow;"></div>
<div id="canvasHolder" style="background-color:yellow;"	></div>
<div id="trainHolder" ></div>
      </div>
    </div>
  </div>


  <div id="uiHolder" class="">
    <div id="progressDiv" >  
      <div id="orangeProgressDiv" class="darkorange grow" ></div>
      <div id="blackProgressDiv" class="darkblack grow" ></div>
      <div id="blueProgressDiv" class="darkblue grow" ></div>
      <div id="greenProgressDiv" class="darkgreen grow" ></div>
    </div>
  </div>

</div>
<canvas id="colorsCanvas" style="position:absolute;"></canvas>
<canvas id="levelsCanvas" style="position:absolute;"></canvas>
<canvas id="menuCanvas" style="position:absolute;"></canvas>
<canvas id="carsCanvas" style="position:absolute;"></canvas>
<canvas id="graphicsCanvas" style="position:absolute;"></canvas>
<canvas id="cameraCanvas" style="position:absolute;" width="100" height="100"></canvas>
  <canvas id="helpCanvas"></canvas>

<div id="adHolder" style="opacity:.5; Zbackground-size:contain; background-repeat:no-repeat; background-position:50% 50%; position:absolute;"></div>



<div id="debugDiv" style="display:none; position:absolute; top:0px; left:10px; font-size:16px; width:750px; z-index:3;"></div>

<div id="sources" style="display:none;">
  <div id="tiledestblue" class="tiledestblue"></div>
  <div id="tiledestblack" class="tiledestblack"></div>
  <div id="tiledestorange" class="tiledestorange"></div>
  <div id="tiledestgreen" class="tiledestgreen"></div>
  <div id="tilesourceblue" class="tilesourceblue"><div class="dot blue dot1"></div><div class="dot blue dot2"></div><div class="dot blue dot3"></div><div class="dot blue dot4"></div><div class="dot blue dot5"></div></div>
  <div id="tilesourceblack" class="tilesourceblack"><div class="dot black dot1"></div><div class="dot black dot2"></div><div class="dot black dot3"></div><div class="dot black dot4"></div><div class="dot black dot5"></div></div>
  <div id="tilesourceorange" class="tilesourceorange"><div class="dot orange dot1"></div><div class="dot orange dot2"></div><div class="dot orange dot3"></div><div class="dot orange dot4"></div><div class="dot orange dot5"></div></div>
  <div id="tilesourcegreen" class="tilesourcegreen"><div class="dot green dot1"></div><div class="dot green dot2"></div><div class="dot green dot3"></div><div class="dot green dot4"></div><div class="dot green dot5"></div></div>

</div>

  <div id="preload">

<img src="default/default0.jpg" id="cameraImg"   style="display:none;" />
<img src="default/default0.jpg" id="default0"   style="display:none;" />
<img src="default/default1.jpg" id="default1"   style="display:none;" />
<img src="default/default2.jpg" id="default2"   style="display:none;" />
<img src="default/default3.jpg" id="default3"   style="display:none;" />
<img src="default/default4.jpg" id="default4"   style="display:none;" />
<img src="default/default5.jpg" id="default5"   style="display:none;" />
<img src="default/default0.jpg" id="default6"   style="display:none;" />
<img src="default/default7.jpg" id="default7"   style="display:none;" />
<img src="default/default8.jpg" id="default8"   style="display:none;" />
<img src="default/default9.jpg" id="default9"   style="display:none;" />
<img src="default/default10.jpg" id="default10"   style="display:none;" />
<img src="default/default11.jpg" id="default11"   style="display:none;" />
<img src="default/default12.jpg" id="default12"   style="display:none;" />
<img src="default/default13.jpg" id="default13"   style="display:none;" />
<img src="default/default14.jpg" id="default14"   style="display:none;" />
<img src="default/default15.jpg" id="default15"   style="display:none;" />
<img src="default/default16.jpg" id="default16"   style="display:none;" />
<img src="default/default17.jpg" id="default17"   style="display:none;" />
<img src="default/default18.jpg" id="default18"   style="display:none;" />
<img src="default/default19.jpg" id="default19"   style="display:none;" />
<img src="default/default20.jpg" id="default20"   style="display:none;" />
<img src="default/default21.jpg" id="default21"   style="display:none;" />
<img src="default/default22.jpg" id="default22"   style="display:none;" />
<img src="default/default23.jpg" id="default23"   style="display:none;" />
<img src="default/default24.jpg" id="default24"   style="display:none;" />
<img src="default/default25.jpg" id="default25"   style="display:none;" />
<img src="default/default26.jpg" id="default26"   style="display:none;" />
<img src="default/default27.jpg" id="default27"   style="display:none;" />
<img src="default/default28.jpg" id="default28"   style="display:none;" />
<img src="default/default29.jpg" id="default29"   style="display:none;" />
<img src="default/default30.jpg" id="default30"   style="display:none;" />
<img src="default/default31.jpg" id="default31"   style="display:none;" />
<img src="default/default32.jpg" id="default32"   style="display:none;" />
<img src="default/default33.jpg" id="default33"   style="display:none;" />
<img src="default/default34.jpg" id="default34"   style="display:none;" />
<img src="default/default35.jpg" id="default35"   style="display:none;" />
<img src="default/default36.jpg" id="default36"   style="display:none;" />
<img src="default/default37.jpg" id="default37"   style="display:none;" />
<img src="default/default38.jpg" id="default38"   style="display:none;" />
<img src="default/default39.jpg" id="default39"   style="display:none;" />
<img src="default/default40.jpg" id="default40"   style="display:none;" />
<img src="default/default41.jpg" id="default41"   style="display:none;" />
<img src="default/default42.jpg" id="default42"   style="display:none;" />
<img src="default/default43.jpg" id="default43"   style="display:none;" />
<img src="default/default44.jpg" id="default44"   style="display:none;" />
<img src="default/default45.jpg" id="default45"   style="display:none;" />
<img src="default/default46.jpg" id="default46"   style="display:none;" />
<img src="default/default47.jpg" id="default47"   style="display:none;" />

<img src="sprites/tank/tankside.png" id="tanksideblack"  style="display:none;" />
<img src="sprites/tank/tankend.png" id="tankendblack"  style="display:none;" />
<img src="sprites/tank/tanktop.png" id="tanktopblack" style="display:none;" />

<img src="sprites/trans/boxside.png" id="boxsidetrans"  style="display:none;" />
<img src="sprites/source/boxside.png" id="boxsidesource"  style="display:none;" />
<!--
<img src="sprites/trans/boxend.png" id="boxendtrans"  style="display:none;" />
<img src="sprites/trans/boxtop.png" id="boxtoptrans" style="display:none;" />
<img src="sprites/trans/engineportinner.png" id="engineportinnertrans" style="display:none;" />
<img src="sprites/trans/engineportouter.png" id="engineportoutertrans" style="display:none;" />
<img src="sprites/trans/enginestarinner.png" id="enginestarinnertrans" style="display:none;" />
<img src="sprites/trans/enginestarouter.png" id="enginestaroutertrans" style="display:none;" />
<img src="sprites/trans/enginefloor.png" id="enginefloortrans" style="display:none;" />
<img src="sprites/trans/engineroof.png" id="enginerooftrans" style="display:none;" />
<img src="sprites/trans/enginenose.png" id="enginenosetrans" style="display:none;" />
<img src="sprites/trans/enginecab.png" id="enginecabtrans" style="display:none;" />

<img src="sprites/source/boxend.png" id="boxendsource"  style="display:none;" />
<img src="sprites/source/boxtop.png" id="boxtopsource" style="display:none;" />
<img src="sprites/source/engineportinner.png" id="engineportinnersource" style="display:none;" />
<img src="sprites/source/engineportouter.png" id="engineportoutersource" style="display:none;" />
<img src="sprites/source/enginestarinner.png" id="enginestarinnersource" style="display:none;" />
<img src="sprites/source/enginestarouter.png" id="enginestaroutersource" style="display:none;" />
<img src="sprites/source/enginefloor.png" id="enginefloorsource" style="display:none;" />
<img src="sprites/source/engineroof.png" id="engineroofsource" style="display:none;" />
<img src="sprites/source/enginenose.png" id="enginenosesource" style="display:none;" />
<img src="sprites/source/enginecab.png" id="enginecabsource" style="display:none;" />
-->
<img src="sprites/green/boxside.png" id="boxsidegreen"  style="display:none;" />
<img src="sprites/green/boxend.png" id="boxendgreen"  style="display:none;" />
<img src="sprites/green/boxtop.png" id="boxtopgreen" style="display:none;" />
<img src="sprites/green/engineportinner.png" id="engineportinnergreen" style="display:none;" />
<img src="sprites/green/engineportouter.png" id="engineportoutergreen" style="display:none;" />
<img src="sprites/green/enginestarinner.png" id="enginestarinnergreen" style="display:none;" />
<img src="sprites/green/enginestarouter.png" id="enginestaroutergreen" style="display:none;" />
<img src="sprites/green/enginefloor.png" id="enginefloorgreen" style="display:none;" />
<img src="sprites/green/engineroof.png" id="engineroofgreen" style="display:none;" />
<img src="sprites/green/enginenose.png" id="enginenosegreen" style="display:none;" />
<img src="sprites/green/enginecab.png" id="enginecabgreen" style="display:none;" />

<img src="sprites/blue/boxside.png" id="boxsideblue"  style="display:none;" />
<img src="sprites/blue/boxend.png" id="boxendblue"  style="display:none;" />
<img src="sprites/blue/boxtop.png" id="boxtopblue" style="display:none;" />
<img src="sprites/blue/engineportinner.png" id="engineportinnerblue" style="display:none;" />
<img src="sprites/blue/engineportouter.png" id="engineportouterblue" style="display:none;" />
<img src="sprites/blue/enginestarinner.png" id="enginestarinnerblue" style="display:none;" />
<img src="sprites/blue/enginestarouter.png" id="enginestarouterblue" style="display:none;" />
<img src="sprites/blue/enginefloor.png" id="enginefloorblue" style="display:none;" />
<img src="sprites/blue/engineroof.png" id="engineroofblue" style="display:none;" />
<img src="sprites/blue/enginenose.png" id="enginenoseblue" style="display:none;" />
<img src="sprites/blue/enginecab.png" id="enginecabblue" style="display:none;" />

<img src="sprites/orange/boxside.png" id="boxsideorange"  style="display:none;" />
<img src="sprites/orange/boxend.png" id="boxendorange"  style="display:none;" />
<img src="sprites/orange/boxtop.png" id="boxtoporange" style="display:none;" />
<img src="sprites/orange/engineportinner.png" id="engineportinnerorange" style="display:none;" />
<img src="sprites/orange/engineportouter.png" id="engineportouterorange" style="display:none;" />
<img src="sprites/orange/enginestarinner.png" id="enginestarinnerorange" style="display:none;" />
<img src="sprites/orange/enginestarouter.png" id="enginestarouterorange" style="display:none;" />
<img src="sprites/orange/enginefloor.png" id="enginefloororange" style="display:none;" />
<img src="sprites/orange/engineroof.png" id="enginerooforange" style="display:none;" />
<img src="sprites/orange/enginenose.png" id="enginenoseorange" style="display:none;" />
<img src="sprites/orange/enginecab.png" id="enginecaborange" style="display:none;" />

<img src="sprites/black/boxside.png" id="boxsideblack"  style="display:none;" />
<img src="sprites/black/boxend.png" id="boxendblack"  style="display:none;" />
<img src="sprites/black/boxtop.png" id="boxtopblack" style="display:none;" />
<img src="sprites/black/engineportinner.png" id="engineportinnerblack" style="display:none;" />
<img src="sprites/black/engineportouter.png" id="engineportouterblack" style="display:none;" />
<img src="sprites/black/enginestarinner.png" id="enginestarinnerblack" style="display:none;" />
<img src="sprites/black/enginestarouter.png" id="enginestarouterblack" style="display:none;" />
<img src="sprites/black/enginefloor.png" id="enginefloorblack" style="display:none;" />
<img src="sprites/black/engineroof.png" id="engineroofblack" style="display:none;" />
<img src="sprites/black/enginenose.png" id="enginenoseblack" style="display:none;" />
<img src="sprites/black/enginecab.png" id="enginecabblack" style="display:none;" />

<img src="sprites/grey/boxside.png" id="boxsidegrey"  style="display:none;" />
<img src="sprites/grey/boxend.png" id="boxendgrey"  style="display:none;" />
<img src="sprites/grey/boxtop.png" id="boxtopgrey" style="display:none;" />
<img src="sprites/grey/engineportinner.png" id="engineportinnergrey" style="display:none;" />
<img src="sprites/grey/engineportouter.png" id="engineportoutergrey" style="display:none;" />
<img src="sprites/grey/enginestarinner.png" id="enginestarinnergrey" style="display:none;" />
<img src="sprites/grey/enginestarouter.png" id="enginestaroutergrey" style="display:none;" />
<img src="sprites/grey/enginefloor.png" id="enginefloorgrey" style="display:none;" />
<img src="sprites/grey/engineroof.png" id="engineroofgrey" style="display:none;" />
<img src="sprites/grey/enginenose.png" id="enginenosegrey" style="display:none;" />
<img src="sprites/grey/enginecab.png" id="enginecabgrey" style="display:none;" />






  </div>

</body>
</html>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1">
<meta name = "apple-mobile-web-app-capable" content = "yes">
<script type="text/javascript" src="done.js?18"></script>
<link rel="stylesheet" type="text/css" href="reset-min.css">
<link rel="stylesheet" type="text/css" href="interface.css?1">
<link rel="stylesheet" type="text/css" href="nav.css">
<script src="phonegap.js"></script>
<script src="nav.js"></script>

<script type="text/javascript" src="howler.min.js"></script>
<script type="text/javascript" charset="utf-8">
var comQueue=new Array();

var cellSize=96;
var cellSizeHalf=48;
var cellsAcross=8;
var cellsDown=8;


var infoUp=false;
////var musicOn=true;
////var sfxOn=true;
function comTick(){
  return false;
  if(comQueue.length >0){
    thisCom=comQueue.join('&');
    comQueue=new Array();
    pea=rnd(10000);
    window.location.hash="#"+thisCom+"&unique="+pea;
    displCom=thisCom.replace(/\&/g, "<br>");
    }
  comGlom="";
  comQueue=new Array();
  }

function genericDefault(itemName, defaultValue){
  if(platform=="android"){
    if (localStorage.getItem(itemName) === null) {
      localStorage.setItem(itemName, defaultValue);
      }
    }
  }
function genericSet(itemName, newValue){
  if(platform=="android"){
    localStorage.setItem(itemName, newValue);
    }
  }
function genericGet(itemName){
  var value="notSet";
  if(platform=="android"){
    value=localStorage.getItem(itemName);
    }
  return value;
  }


function rnd(range){
  return Math.floor(Math.random()*range);
  }
var paused=false;
function pauseGame(){
  dbuga("pauseGame()");
  paused=true;
  loopStop("measure_loop_inst");
  // called by shell
  return true;
  }
function resumeGame(){
  // called by shell
  //requestPersistenceData();
  dbuga("resumeGame()");
  paused=false;
  transmitBgMusicState();
  return true;
  }

function closeInfo(){
  document.getElementById('Info_label').style.opacity=".5";
  document.getElementById('infoHolder').style.display="none";
  document.getElementById('infoHolder1').style.display="none";
  document.getElementById('infoHolder2').style.display="none";
  document.getElementById('infoHolder3').style.display="none";
  document.getElementById('infoHolder4').style.display="none";
  infoUp=false;
  }
function transmitBgMusicState(){
  dbuga("transmitBgMusicState()");
  debugStorage();
  if(genericGet("musicOn") == "true"){
    loopStart("measure_loop_inst");
    }
  else{
    loopStop("measure_loop_inst");
    }
  
  
  }
var soundCount=0;
var soundRefByName={};
function oneShot(soundName){
  //dbuga("oneShot("+soundName+")");
  if(persistenceObject.music=="on"){
    if(platform=="android"){
      if(soundRefByName.hasOwnProperty(soundName)){
        //dbuga(' - extant '+soundName);
        //soundRefByName[soundName].stop();
        soundRefByName[soundName].play();
        //dbuga(' - played');
        }
      else{
        var newSound = new Media(filePath+"/"+soundName+".mp3");
        soundRefByName[soundName]=newSound;
        //dbuga('new Media '+soundName);
        }
      }
    if((platform=="web")||(platform=="local")){
      if(soundRefByName.hasOwnProperty(soundName)){
        //dbuga(' - extant '+soundName);
        //soundRefByName[soundName].stop();
        soundRefByName[soundName].play();
        //dbuga(' - played');
        }
      else{
        var newSound = new Howl({
          urls: [filePath+"/"+soundName+".mp3"],
          autoplay: true,
          loop: false,
          volume: 0.5,
          onend: function() {
            //alert('Finished!');
            }
          });
        soundRefByName[soundName]=newSound;
        //dbuga('new howl '+soundName);
 
        }  
      }  
    if(platform=="dreamfreeze"){
      if(soundRefByName.hasOwnProperty(soundName)){
        var soundChannel=soundRefByName[soundName];
        comQueue.push("action=manageSound|channel="+soundChannel+"|mode=play");
        comTick();
        }
      }
    }  
  }
function loopStart(soundName){
  //dbuga("loopStart("+soundName+") "+platform);
  if(persistenceObject.music=="on"){
    if(platform=="android"){
      //dbuga('BOOYA!');
      if(soundRefByName.hasOwnProperty(soundName)){
        soundRefByName[soundName].play();
        }
      }
    if((platform=="web")||(platform=="local")){
      if(soundRefByName.hasOwnProperty(soundName)){
        //dbuga('openedWithStupidLoop: '+ openedWithStupidLoop);
        if(openedWithStupidLoop==false){
          //dbuga(' - extant '+soundName);
          soundRefByName[soundName].stop();
          soundRefByName[soundName].play();
          //dbuga(' - played');
          }
        }
      else{
        var newSound = new Howl({
          urls: [filePath+"/"+soundName+".mp3"],
          autoplay: true,
          loop: true,
          volume: 0.5,
          onend: function() {
            //alert('Finished!');
            }
          });
        soundRefByName[soundName]=newSound;
        //dbuga('new howl '+soundName);
 
        }  
      }  
    if(platform=="dreamfreeze"){
      if(soundRefByName.hasOwnProperty(soundName)){
        var soundChannel=soundRefByName[soundName];
        //dbuga("loopStart() "+soundChannel+" : "+soundName);
        
        comQueue.push("action=manageSound|channel="+soundChannel+"|loop=true|starttime=0|mode=play");
        comTick();
        }
      }
    }  
  }

function statusCallback(theStatus){
  var statusArray=['MEDIA_NONE', 'MEDIA_STARTING', 'MEDIA_RUNNING', 'MEDIA_PAUSED', 'MEDIA_STOPPED'];
  //dbuga('media status '+statusArray[theStatus]);
  if(soundRefByName.hasOwnProperty("musicloop")){
    var loopRef=soundRefByName["musicloop"];
    loopRef.getCurrentPosition(
        // success callback
        function (position) {
            if (position > -1) {
                //dbuga((position) + " sec");
            if((ladCount>0)&&(theStatus==4)&&(position<.01)){loopStart("musicloop");}//loop hack for bullshit media
            }
        },
        // error callback
        function (e) {
            //dbuga("Error getting pos=" + e);
        }
    );
    }
  }
function errorCallback(er){
  //dbuga("media error "+JSON.stringify(er))
  }
function successCallback(evt){
  //dbuga("HEY ": + JSON.stringify(evt));
  //singMedia.play();
  }


function oneShotLoad(soundName){
  if(platform=="android"){
    var newSound = new Media(filePath+"/"+soundName+".mp3");
    soundRefByName[soundName]=newSound;
    //dbuga('new Media '+soundName);
    }
  if((platform=="web")||(platform=="local")){
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga('extant');
      }
    else{
      //dbuga('new howl');
      var newSound = new Howl({
        urls: [filePath+"/"+soundName+".mp3"],
        autoplay: false,
        loop: false,
        volume: 0.5,
        onend: function() {
          //alert('Finished!');
          }
        });
      soundRefByName[soundName]=newSound;
      }  
    }  
  if(platform=="dreamfreeze"){
    if(soundRefByName.hasOwnProperty(soundName)){
      }
    else{
      var soundChannel=soundCount;
      var soundFile="sounds/"+soundName+".mp3";
      comQueue.push("action=manageSound|file="+soundFile+"|channel="+soundChannel+"|mode=prepare");
      soundRefByName[soundName]=soundChannel;
      //dbuga("soundChannel: "+soundChannel+" soundName:"+soundName);
      soundCount++;
      }  
    comTick();
    }
  }
function loopStop(soundName){
  if(platform=="android"){
    //dbuga('ANDROID loopStop');
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga('extant '+soundName);
      //dbuga('stop andriod');
      soundRefByName[soundName].stop();
      }  
    }
  if((platform=="web")||(platform=="local")){
    openedWithStupidLoop=false;
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga('extant '+soundName);
      //dbuga('stop howl');
      soundRefByName[soundName].stop();
      }  
    else{
      //dbuga('non-extant '+soundName);
      }
    }  
  if(platform=="dreamfreeze"){
    if(soundRefByName.hasOwnProperty(soundName)){
      var soundChannel=soundRefByName[soundName];
      comQueue.push("action=manageSound|channel="+soundChannel+"|mode=pause");
      comTick();
      }
    }

  }
var persistenceObject={"music":"on", "sfx":"on"};
function loopLoad(soundName){
  if(platform=="android"){
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga(' - extant '+soundName);
      //soundRefByName[soundName].stop();
      soundRefByName[soundName].play();
      //dbuga(' - played');
      }
    else{
      var newSound = new Media(filePath+"/"+soundName+".mp3", successCallback, errorCallback, statusCallback);
      soundRefByName[soundName]=newSound;
      //dbuga('new Media '+soundName);
      }
    }
  if((platform=="web")||(platform=="local")){
    if(soundRefByName.hasOwnProperty(soundName)){
      //dbuga(' - extant: '+ soundName);
      }
    else{
      var shallAutoplay=false;
      if(persistenceObject.music=="on"){
        shallAutoplay=true;
        openedWithStupidLoop=true;
        }
      //dbuga(' - new Howl: '+ soundName);
      var newSound = new Howl({
        urls: [filePath+"/"+soundName+".mp3"],
        autoplay: shallAutoplay,
        loop: true,
        volume: 0.5,
        onend: function() {
          //alert('Finished!');
          }
        });
      soundRefByName[soundName]=newSound;
      }  
    }  
  if(platform=="dreamfreeze"){
    if(soundRefByName.hasOwnProperty(soundName)){
      }
    else{
      var soundChannel=soundCount;
      var soundFile="sounds/"+soundName+".mp3";
      comQueue.push("action=manageSound|file="+soundFile+"|channel="+soundChannel+"|mode=prepare|loop=true");
      soundRefByName[soundName]=soundChannel;
      //dbuga("soundChannel: "+soundChannel+" soundName:"+soundName);
      soundCount++;
      }  
    comTick();
    }  
  }


function playSound(theSound){
  //dbug(sfxOn);
  if((genericGet("sfxOn") == "true")&&(paused==false)){
    oneShot(theSound);
    }
  }
function resetUndoLabel(){
  document.getElementById('Undo_label').style.opacity=".5";
  }
function undo(){
  lastItemType=buildSequence[buildSequence.length-1].type;
  if((lastItemType != "source")&&(lastItemType != "dest")&&(lastItemType != "train")){
    trash=buildSequence.pop();
    }
  //dbugBuildSequence();
  //resetBoardTimersObjects();
  rebuildTracks();
  }

function handleUiEvent(e){
  target=e.touches[0].target.id;
  if(target == "Music_touch"){
    if(genericGet("musicOn") == "true"){
      genericSet("musicOn", "false");
      document.getElementById('Music_label').style.opacity=".5";
      }
    else{
      genericSet("musicOn", "true");
      document.getElementById('Music_label').style.opacity="1";
      }
    transmitBgMusicState();
    }
  if (target == "Sfx_touch"){
    if(genericGet("sfxOn") == "true"){
      genericSet("sfxOn","false");
      document.getElementById('Sfx_label').style.opacity=".5";
      }
    else{
      genericSet("sfxOn","true");
      document.getElementById('Sfx_label').style.opacity="1";
      oneShot("trainstart");
      }
    }

  if (target == "Info_touch"){
    if(infoUp==true){
      closeInfo();
      }
    else{
      document.getElementById('Info_label').style.opacity="1";
      if(tablet==false){
        document.getElementById('infoHolder1').style.display="block";
        }
      else{
        document.getElementById('infoHolder').style.display="block";
        }
      infoUp=true;
      }
    }
  if (target == "Undo_touch"){
    undo();
    document.getElementById('Undo_label').style.opacity="1";
    window.setTimeout('resetUndoLabel()', 400);
    }

  if (target == "infoImage"){
    closeInfo();
    }
  if (target == "infoImage1"){
    document.getElementById('infoHolder1').style.display="none";
    document.getElementById('infoHolder2').style.display="block";
    }
  if (target == "infoImage2"){
    document.getElementById('infoHolder2').style.display="none";
    document.getElementById('infoHolder3').style.display="block";
    }
  if (target == "infoImage3"){
    document.getElementById('infoHolder3').style.display="none";
    document.getElementById('infoHolder4').style.display="block";
    }
  if (target == "infoImage4"){
    closeInfo();
    }
  if(target.indexOf("level")==0){
    //dbug('target '+target);
    var fails=-1;
    var boost=0;
    if(cellsDown>cellsAcross){
      boost=1;//cellsDown-cellsAcross;
      }
    while(fails!=0){
      dbuga("retrying from scratch fails "+fails);
      fails=0;
      
      resetBoardTimersObjects();
      buildSequence=new Array();
      var thisData=[];
      if (target == "level1Button"){thisData=levelData[0];}
      if (target == "level2Button"){thisData=levelData[1];}
      if (target == "level3Button"){thisData=levelData[2];}
      if (target == "level4Button"){thisData=levelData[3];}
      if (target == "level5Button"){thisData=levelData[4];}
      if (target == "level6Button"){thisData=levelData[5];}
      if (target == "level7Button"){thisData=levelData[6];}
      for (var c=0; c<thisData.length; c++){
        fails+=addColor(thisData[c],4);
        }
      }
    }
  if (target == "retryButton"){
    //dbug('');
    resetBoardTimersObjects();
    removeAllTracks();
    rebuildSequence();
    }
  }

function removeAllTracks(){
  //dbug('');
  var tempSequence=buildSequence;
  buildSequence=new Array();
  for (var i in tempSequence){
    if(tempSequence[i].type!="track"){
      buildSequence.push(tempSequence[i]);
      }
    }
  }
function dbugBuildSequence(){
  //dbug('');
  for (var i in buildSequence){
    item=buildSequence[i];
    //dbuga("x="+item.x+" y="+item.y+" type="+item.type+"<br>");
    }
  }
function rebuildSequence(){
  for (var i in buildSequence){
    item=buildSequence[i];
    type=item.type;
    if(type=="dest"){
      destData[destCount]=destObject(destCount, item.color, item.dir, item.x, item.y);
      }
    if(type=="train"){
      trainData[trainCount]=trainObject(trainCount, item.color, item.x, item.y, item.dir);
      }
    if(type=="source"){
      sourceData[sourceCount]=sourceObject(sourceCount, item.color, item.dir, item.x, item.y, item.barrels);
      displayBarrels("grid_"+item.x+"_"+item.y, item.barrels); 
      }
    if(type=="track"){
      createTrack(item.dir, "grid_"+item.x+"_"+item.y);
      createCanvasTrack(item.dir, item.x, item.y);
      }
    }
  sourceTick();
  }

function rebuildTracks(){
  trackContext.clearRect(0, 0, boardWidth, boardHeight)
  document.getElementById("trackCanvas").width=boardWidth;
  //eraseGridData
  tilesByGridXY=new Array();
  for (x=0; x<cellsAcross; x++){
    for (y=0; y<cellsDown; y++){
      gridXY="grid_"+x+"_"+y;
      tilesByGridXY[gridXY]=new Array();
      }
    }
  for (var i in buildSequence){
    item=buildSequence[i];
    type=item.type;
    if(type=="dest"){
      targetCell="grid_"+item.x+"_"+item.y;
      createTrack(item.dir+"d", targetCell);
      tilesByGridXY[targetCell].push("tiledest"+item.color);
      createCanvasTrack(item.dir+"d", item.x, item.y);
      }
    if(type=="source"){
      targetCell="grid_"+item.x+"_"+item.y;
      createTrack(item.dir+"s", targetCell);
      tilesByGridXY[targetCell].push("tilesource"+item.color);
      createCanvasTrack(item.dir+"s", item.x, item.y);
      }
    if(type=="track"){
      createTrack(item.dir, "grid_"+item.x+"_"+item.y);
      createCanvasTrack(item.dir, item.x, item.y);
      }
    }
  }


function setupClasses(){
  var p=cellSize/96

  var buttonsTop=30*p;
  var buttonsLeft=0*p;
  var maskDivTop=10*p;
  var maskDivLeft=0;
  var maskDivHeight=10*p;
  var maskDivWidth=cellsAcross*cellSize-12*p;
  var maskBorder=6*p;

  var progDivTop=10*p;
  var progDivLeft=6*p;
  var progDivHeight=12*p;
  var progDivWidth=cellsAcross*cellSize-12*p;

  var childrenSize=82*p;
  var childrenPad=4*p;



  if(tablet){
    document.getElementById('buttonHolder7').style.display="block";
    document.getElementById('buttonHolder8').style.display="block";
    }

  var uiTop=cellsDown*cellSize;
  var uiHeight=2*cellSize;

  addStyle('#arrowCircle', 'position:absolute; left:' + p*12 + 'px; top:' + p*12 + 'px; border-color:#DA251C;  border-style:solid; border-width:' + p*12 + 'px;  width:' + p*40 + 'px;  height:' + p*40 + 'px; -webkit-border-radius:' + p*48 + 'px;');
  addStyle('#arrowPoint', 'position:absolute; left:' + p*36 + 'px; top:' + p*5 + 'px; border-color:#fff #DA251C #fff  #fff ;  border-style:solid ;  border-width:' + p*15 + 'px ' + p*15 + 'px ' + p*15 + 'px 0px ;  width:0;  height:0;');
  addStyle('#uiHolder', 'position:absolute; top:' + uiTop + 'px; left:0; width:' + p*768 + 'px; height:' + uiHeight + 'px;');
  addStyle('#progressDiv', 'position:absolute; display:block; overflow:hidden; width:' + progDivWidth + 'px; height:' + progDivHeight + 'px; position:absolute; top:' + progDivTop + 'px; left:' + progDivLeft + 'px; background-color:#fff;');
  addStyle('#progressMask', 'display:block; width:' + maskDivWidth + 'px; height:' + maskDivHeight + 'px; position:absolute; top:' + p*5 + 'px; left:' + maskDivLeft + 'px; border:' + maskBorder  + 'px solid #3FB3A0; -webkit-border-radius:' + p*12 + 'px;');
  addStyle('.grow', '  height:' + p*15 + 'px; width:' + p*100 + 'px; float:left;  -webkit-transition: width 1s ease;  ');
  addStyle('#infoHolder', 'position:absolute; top:0; left:0; width:' + p*768 + 'px; height:' + p*768 + 'px;');
  addStyle('#buttons', 'position:absolute; top:' + buttonsTop + 'px; left:' + buttonsLeft + 'px; width:' + p*750 + 'px; height:' + p*100 + 'px;');
  addStyle('#buttonHolder1', 'position:absolute; top:0; left:' + p*0 + 'px;');
  addStyle('#buttonHolder2', 'position:absolute; top:0; left:' + p*96 + 'px;');
  addStyle('#buttonHolder3', 'position:absolute; top:0; left:' + p*192 + 'px;');
  addStyle('#buttonHolder4', 'position:absolute; top:0; left:' + p*288 + 'px;');
  addStyle('#buttonHolder5', 'position:absolute; top:0; left:' + p*384 + 'px;');
  addStyle('#buttonHolder6', 'position:absolute; top:0; left:' + p*480 + 'px;');
  addStyle('#buttonHolder7', 'position:absolute; top:0; left:' + p*576 + 'px;');
  addStyle('#buttonHolder8', 'position:absolute; top:0; left:' + p*672 + 'px;');

  addStyle('.buttonChildren', 'position:absolute; width:' + childrenSize + 'px; height:' + childrenSize+ 'px; margin-left:' + p*4 + 'px; padding-left:' + childrenPad + 'px; padding-top:' + childrenPad + 'px;');
  addStyle('.buttonBackground', 'position:absolute; width:' + p*84 + 'px; height:' + p*84 + 'px; border:' + p*1 + 'px #666666 solid; -webkit-border-radius:' + p*8 + 'px; background-color:#ffffff');
  addStyle('.tiny', 'width:' + p*16 + 'px; height:' + p*16 + 'px; float:left; margin:' + p*2 + 'px;-webkit-border-radius:' + p*3 + 'px; ');



  addStyle('#highlighter', 'width:' + p*94 + 'px; height:' + p*94 + 'px; position:absolute;    -webkit-border-radius:' + p*20 + 'px;    background-color:#FFFF00;    opacity:1;    display:none;');
  addStyle('.tile', 'width:' + p*94 + 'px; height:' + p*94 + 'px; position:absolute;    border:0px #0000ee solid;    -webkit-border-radius:' + p*20 + 'px;    ');
  addStyle('.tiledestgreen', 'margin:' + p*14 + 'px; width:' + p*66 + 'px; height:' + p*66 + 'px; position:absolute;    background-color:#3C746B;    -webkit-border-radius:' + p*48 + 'px;    ');
  addStyle('.tiledestblue', 'margin:' + p*14 + 'px; width:' + p*66 + 'px; height:' + p*66 + 'px; position:absolute;    background-color:#005BA1;    -webkit-border-radius:' + p*48 + 'px;    ');
  addStyle('.tiledestblack', 'margin:' + p*14 + 'px; width:' + p*66 + 'px; height:' + p*66 + 'px; position:absolute;    background-color:#000000;    -webkit-border-radius:' + p*48 + 'px;    ');
  addStyle('.tiledestorange', 'margin:' + p*14 + 'px; width:' + p*66 + 'px; height:' + p*66 + 'px; position:absolute;    background-color:#DA251C;    -webkit-border-radius:' + p*48 + 'px;    ');
  addStyle('.tilesourcegreen', 'margin:' + p*4 + 'px; width:' + p*86 + 'px; height:' + p*86 + 'px; position:absolute;    background-color:#3C746B;    -webkit-border-radius:' + p*16 + 'px;    ');
  addStyle('.tilesourceblue', 'margin:' + p*4 + 'px; width:' + p*86 + 'px; height:' + p*86 + 'px; position:absolute;    background-color:#005BA1;    -webkit-border-radius:' + p*16 + 'px;    ');
  addStyle('.tilesourceblack', 'margin:' + p*4 + 'px; width:' + p*86 + 'px; height:' + p*86 + 'px; position:absolute;    background-color:#000000;    -webkit-border-radius:' + p*16 + 'px;    ');
  addStyle('.tilesourceorange', 'margin:' + p*4 + 'px; width:' + p*86 + 'px; height:' + p*86 + 'px; position:absolute;    background-color:#DA251C;    -webkit-border-radius:' + p*16 + 'px;    ');

  addStyle('.dot', '-webkit-border-radius:' + p*8 + 'px; position:absolute; width:' + p*24 + 'px; height:' + p*12 + 'px; opacity:0;');
  addStyle('.dot1', 'left:' + p*7 + 'px; top:' + p*13 + 'px;');
  addStyle('.dot2', 'left:' + p*55 + 'px; top:' + p*13 + 'px;');
  addStyle('.dot3', 'left:' + p*7 + 'px; top:' + p*61 + 'px;');
  addStyle('.dot4', 'left:' + p*55 + 'px; top:' + p*61 + 'px;');

  addStyle('.L0', 'left:' + p*0 + 'px;');
  addStyle('.T0', 'top:' + p*0 + 'px;');
  addStyle('.L1', 'left:' + p*96 + 'px;');
  addStyle('.T1', 'top:' + p*96 + 'px;');
  addStyle('.L2', 'left:' + p*192 + 'px;');
  addStyle('.T2', 'top:' + p*192 + 'px;');
  addStyle('.L3', 'left:' + p*288 + 'px;');
  addStyle('.T3', 'top:' + p*288 + 'px;');
  addStyle('.L4', 'left:' + p*384 + 'px;');
  addStyle('.T4', 'top:' + p*384 + 'px;');
  addStyle('.L5', 'left:' + p*480 + 'px;');
  addStyle('.T5', 'top:' + p*480 + 'px;');
  addStyle('.L6', 'left:' + p*576 + 'px;');
  addStyle('.T6', 'top:' + p*576 + 'px;');
  addStyle('.L7', 'left:' + p*672 + 'px;');
  addStyle('.T7', 'top:' + p*672 + 'px;');
  addStyle('.T8', 'top:' + p*768 + 'px;');
  addStyle('.T9', 'top:' + p*864 + 'px;');
  addStyle('.T10', 'top:' + p*960 + 'px;');
  addStyle('.T11', 'top:' + p*1056 + 'px;');
  addStyle('.T12', 'top:' + p*1152 + 'px;');


  addStyle('.tbLeft', 'top:' + p*0 + 'px; left:' + p*38 + 'px; width:' + p*10 + 'px; height:' + p*94 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.tbRight', 'top:' + p*0 + 'px; left:' + p*54 + 'px; width:' + p*10 + 'px; height:' + p*94 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.lrTop', 'top:' + p*38 + 'px; left:' + p*0 + 'px; width:' + p*94 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.lrBottom', 'top:' + p*54 + 'px; left:' + p*0 + 'px; width:' + p*94 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');

  addStyle('.rTop', 'top:' + p*38 + 'px; left:' + p*47 + 'px; width:' + p*47 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.rBottom', 'top:' + p*54 + 'px; left:' + p*47 + 'px; width:' + p*47 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.lTop', 'top:' + p*38 + 'px; left:' + p*0 + 'px; width:' + p*47 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.lBottom', 'top:' + p*54 + 'px; left:' + p*0 + 'px; width:' + p*47 + 'px; height:' + p*10 + 'px; border-top:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.bLeft', 'top:' + p*47 + 'px; left:' + p*38 + 'px; width:' + p*10 + 'px; height:' + p*47 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.bRight', 'top:' + p*47 + 'px; left:' + p*54 + 'px; width:' + p*10 + 'px; height:' + p*47 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.tLeft', 'top:' + p*0 + 'px; left:' + p*38 + 'px; width:' + p*10 + 'px; height:' + p*46 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');
  addStyle('.tRight', 'top:' + p*0 + 'px; left:' + p*54 + 'px; width:' + p*10 + 'px; height:' + p*46 + 'px; border-left:' + p*2 + 'px #888  solid; position:absolute;');

  addStyle('.brOuter', 'top:' + p*38 + 'px; left:' + p*38 + 'px; width:' + p*54 + 'px; height:' + p*54 + 'px; border-top:' + p*2 + 'px #888  solid; border-left:' + p*2 + 'px #888 solid; -webkit-border-top-left-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.brInner', 'top:' + p*54 + 'px; left:' + p*54 + 'px; width:' + p*38 + 'px; height:' + p*38 + 'px; border-top:' + p*2 + 'px #888  solid; border-left:' + p*2 + 'px #888  solid; -webkit-border-top-left-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.tlOuter', 'top:' + p*0 + 'px; left:' + p*0 + 'px; width:' + p*54 + 'px; height:' + p*54 + 'px; border-bottom:' + p*2 + 'px #888  solid; border-right:' + p*2 + 'px #888  solid; -webkit-border-bottom-right-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.tlInner', 'top:' + p*0 + 'px; left:' + p*0 + 'px; width:' + p*38 + 'px; height:' + p*38 + 'px; border-bottom:' + p*2 + 'px #888  solid; border-right:' + p*2 + 'px #888  solid; -webkit-border-bottom-right-radius:' + p*100 + 'px; position:absolute;');

  addStyle('.trOuter', 'top:' + p*0 + 'px; left:' + p*38 + 'px; width:' + p*54 + 'px; height:' + p*54 + 'px; border-bottom:' + p*2 + 'px #888  solid; border-left:' + p*2 + 'px #888  solid; -webkit-border-bottom-left-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.trInner', 'top:' + p*0 + 'px; left:' + p*54 + 'px; width:' + p*38 + 'px; height:' + p*38 + 'px; border-bottom:' + p*2 + 'px #888  solid; border-left:' + p*2 + 'px #888  solid; -webkit-border-bottom-left-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.blOuter', 'top:' + p*38 + 'px; left:' + p*0 + 'px; width:' + p*54 + 'px; height:' + p*54 + 'px; border-top:' + p*2 + 'px #888  solid; border-right:' + p*2 + 'px #888  solid; -webkit-border-top-right-radius:' + p*100 + 'px; position:absolute;');
  addStyle('.blInner', 'top:' + p*54 + 'px; left:' + p*0 + 'px; width:' + p*38 + 'px; height:' + p*38 + 'px; border-top:' + p*2 + 'px #888  solid; border-right:' + p*2 + 'px #888  solid; -webkit-border-top-right-radius:' + p*100 + 'px; position:absolute;');


  addStyle('.car', 'width:' + p*96 + 'px; height:' + cellSize + 'px; position:absolute;');
  addStyle('.coupler', 'top:' + p*0  + 'px; left:' + p*46 +'px; width:' + p*10 +'px; height:' + cellSize + 'px; border-left:' + p*4 + 'px #1F1A17 solid; position:absolute;');
  addStyle('.blueTank',   'width:' + p*24 + 'px; height:' + p*80 + 'px; position:absolute; top:' + p*8 + 'px; left:' + p*36 + 'px; -webkit-border-radius:' + p*8 + 'px; background-color:#76C5F0; -webkit-border-radius: ' + p*100 +'px');
  addStyle('.orangeTank', 'width:' + p*24 + 'px; height:' + p*80 + 'px; position:absolute; top:' + p*8 + 'px; left:' + p*36 + 'px; -webkit-border-radius:' + p*8 + 'px; background-color:#F1A334;');
  addStyle('.blackCar',   'width:' + p*16 + 'px; height:' + p*72 + 'px; position:absolute; top:' + p*8 + 'px; left:' + p*36 + 'px; border:' + p*4 + 'px #555 solid; background-color:#000000;');
  addStyle('.greenCar',   'width:' + p*16 + 'px; height:' + p*72 + 'px; position:absolute; top:' + p*8 + 'px; left:' + p*36 + 'px; border:' + p*4 + 'px #3FB3A0 solid; background-color:#3C746B;');

  addStyle('.blueTrainRear',    'width:' + p*28 + 'px; height:' + p*36 + 'px; top:' + p*52 + 'px; left:' + p*34 + 'px;  background-color:#76C5F0; position:absolute; ');
  addStyle('.blueTrainBody',    'width:' + p*24 + 'px; height:' + p*60 + 'px; top:' + p*12 + 'px; left:' + p*36 + 'px; background-color:#76C5F0; position:absolute; ');
  addStyle('.blueTrainTank',    'width:' + p*12 + 'px; height:' + p*60 + 'px; top:' + p*10 + 'px; left:' + p*42 + 'px; background-color:#005BA1; -webkit-border-radius: ' + p*100 +'px; position:absolute; ');
  addStyle('.blueTrainCatcher', 'width:' + p*16 + 'px; height:' + p*16 + 'px; top:' + p*0  + 'px; left:' + p*40 + 'px; background-color:#76C5F0; position:absolute; -webkit-transform: rotate(45deg);');

  addStyle('.orangeTrainRear',    'width:' + p*28 + 'px; height:' + p*36 + 'px; top:' + p*52 + 'px; left:' + p*34 + 'px;  background-color:#F1A334; position:absolute; ');
  addStyle('.orangeTrainBody',    'width:' + p*24 + 'px; height:' + p*60 + 'px; top:' + p*12 + 'px; left:' + p*36 + 'px; background-color:#F1A334; position:absolute; ');
  addStyle('.orangeTrainTank',    'width:' + p*12 + 'px; height:' + p*60 + 'px; top:' + p*10 + 'px; left:' + p*42 + 'px; background-color:#DA251C; -webkit-border-radius: ' + p*100 +'px; position:absolute; ');
  addStyle('.orangeTrainCatcher', 'width:' + p*16 + 'px; height:' + p*16 + 'px; top:' + p*0  + 'px; left:' + p*40 + 'px; background-color:#F1A334; position:absolute; -webkit-transform: rotate(45deg);');

  addStyle('.greenTrainRear',    'width:' + p*28 + 'px; height:' + p*36 + 'px; top:' + p*52 + 'px; left:' + p*34 + 'px; background-color:#3FB3A0; position:absolute; ');
  addStyle('.greenTrainBody',    'width:' + p*24 + 'px; height:' + p*60 + 'px; top:' + p*12 + 'px; left:' + p*36 + 'px; background-color:#3FB3A0; position:absolute; ');
  addStyle('.greenTrainTank',    'width:' + p*12 + 'px; height:' + p*60 + 'px; top:' + p*10 + 'px; left:' + p*42 + 'px; background-color:#3C746B; -webkit-border-radius: ' + p*100 +'px; position:absolute; ');
  addStyle('.greenTrainCatcher', 'width:' + p*16 + 'px; height:' + p*16 + 'px; top:' + p*0  + 'px; left:' + p*40 + 'px; background-color:#3FB3A0; position:absolute; -webkit-transform: rotate(45deg);');

  addStyle('.blackTrainRear',    'width:' + p*28 + 'px; height:' + p*36 + 'px; top:' + p*52 + 'px; left:' + p*34 + 'px; background-color:#555; position:absolute; ');
  addStyle('.blackTrainBody',    'width:' + p*24 + 'px; height:' + p*60 + 'px; top:' + p*12 + 'px; left:' + p*36 + 'px; background-color:#555; position:absolute; ');
  addStyle('.blackTrainTank',    'width:' + p*12 + 'px; height:' + p*60 + 'px; top:' + p*10 + 'px; left:' + p*42 + 'px; background-color:#000; -webkit-border-radius: ' + p*10 +'px; position:absolute; ');
  addStyle('.blackTrainCatcher', 'width:' + p*16 + 'px; height:' + p*16 + 'px; top:' + p*0  + 'px; left:' + p*40 + 'px; background-color:#555; position:absolute; -webkit-transform: rotate(45deg);');

  var infoWidth=cellSize*cellsAcross;
  document.getElementById('infoHolder').innerHTML='<img id="infoImage" src="images/info.png" width="' + infoWidth + '" height="' + infoWidth + '" />';
  document.getElementById('infoHolder1').innerHTML='<img id="infoImage1" src="images/info1.png" width="' + infoWidth + '" height="' + infoWidth + '" />';
  document.getElementById('infoHolder2').innerHTML='<img id="infoImage2" src="images/info2.png" width="' + infoWidth + '" height="' + infoWidth + '" />';
  document.getElementById('infoHolder3').innerHTML='<img id="infoImage3" src="images/info3.png" width="' + infoWidth + '" height="' + infoWidth + '" />';
  document.getElementById('infoHolder4').innerHTML='<img id="infoImage4" src="images/info4.png" width="' + infoWidth + '" height="' + infoWidth + '" />';
  }
var bgContext;
var trackContext;
function setupGridData(){
  //alert('setupGridData()');
  tilesByGridXY=new Array();
  for (x=0; x<cellsAcross; x++){
    for (y=0; y<cellsDown; y++){
      gridXY="grid_"+x+"_"+y;
      tilesByGridXY[gridXY]=new Array();
      }
    }
  trackContext.clearRect(0, 0, boardWidth, boardHeight);
  document.getElementById("trackCanvas").width=boardWidth;
  }
function fillBgCanvas(){
  bgContext.strokeStyle = "rgb(220, 220, 220)";
  radius=20*cellSize/96;
  for (x=0; x<cellsAcross; x++){
    for (y=0; y<cellsDown; y++){
      roundRect(bgContext, x*cellSize, y*cellSize, cellSize, cellSize, radius, false, true);
      }
    }
  }
function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
  if (typeof stroke == "undefined" ) {
    stroke = true;
  }
  if (typeof radius === "undefined") {
    radius = 5;
  }
  ctx.beginPath();
  ctx.moveTo(x + radius, y);
  ctx.lineTo(x + width - radius, y);
  ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
  ctx.lineTo(x + width, y + height - radius);
  ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
  ctx.lineTo(x + radius, y + height);
  ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
  ctx.lineTo(x, y + radius);
  ctx.quadraticCurveTo(x, y, x + radius, y);
  ctx.closePath();
  if (stroke) {
    ctx.stroke();
  }
  if (fill) {
    ctx.fill();
  }        
}
//createCanvasTrack('lr', 2, 5)
function createCanvasTrack(theType, cellX, cellY){
  trackContext.strokeStyle = "rgb(128, 128, 128)";
  trackContext.lineWidth = "2";
  originX=cellX*cellSize
  originY=cellY*cellSize
  unit=cellSize/12;
  trackContext.beginPath();
  if((theType=="ts")||(theType=="td")){
    trackContext.moveTo(originX+5*unit, originY);
    trackContext.lineTo(originX+5*unit, originY+cellSize/2);
    //trackContext.moveTo(originX+6*unit, originY);
    //trackContext.lineTo(originX+6*unit, originY+cellSize/2);
    trackContext.moveTo(originX+7*unit, originY);
    trackContext.lineTo(originX+7*unit, originY+cellSize/2);
    }
  if((theType=="bs")||(theType=="bd")){
    trackContext.moveTo(originX+5*unit, originY+cellSize/2);
    trackContext.lineTo(originX+5*unit, originY+cellSize);
    //trackContext.moveTo(originX+6*unit, originY+cellSize/2);
    //trackContext.lineTo(originX+6*unit, originY+cellSize);
    trackContext.moveTo(originX+7*unit, originY+cellSize/2);
    trackContext.lineTo(originX+7*unit, originY+cellSize);
    }
  if((theType=="ls")||(theType=="ld")){
    trackContext.moveTo(originX, originY+5*unit);
    trackContext.lineTo(originX+cellSize/2, originY+5*unit);
    //trackContext.moveTo(originX, originY+6*unit);
    //trackContext.lineTo(originX+cellSize/2, originY+6*unit);
    trackContext.moveTo(originX, originY+7*unit);
    trackContext.lineTo(originX+cellSize/2, originY+7*unit);
    }
  if((theType=="rs")||(theType=="rd")){
    trackContext.moveTo(originX+cellSize/2, originY+5*unit);
    trackContext.lineTo(originX+cellSize, originY+5*unit);
    //trackContext.moveTo(originX+cellSize/2, originY+6*unit);
    //trackContext.lineTo(originX+cellSize, originY+6*unit);
    trackContext.moveTo(originX+cellSize/2, originY+7*unit);
    trackContext.lineTo(originX+cellSize, originY+7*unit);
    }
  if(theType=="lr"){
    trackContext.moveTo(originX, originY+5*unit);
    trackContext.lineTo(originX+cellSize, originY+5*unit);
    //trackContext.moveTo(originX, originY+6*unit);
    //trackContext.lineTo(originX+cellSize, originY+6*unit);
    trackContext.moveTo(originX, originY+7*unit);
    trackContext.lineTo(originX+cellSize, originY+7*unit);
    }
  if(theType=="tb"){
    trackContext.moveTo(originX+5*unit, originY);
    trackContext.lineTo(originX+5*unit, originY+cellSize);
    //trackContext.moveTo(originX+6*unit, originY);
    //trackContext.lineTo(originX+6*unit, originY+cellSize);
    trackContext.moveTo(originX+7*unit, originY);
    trackContext.lineTo(originX+7*unit, originY+cellSize);
    }
  if(theType=="br"){
    trackContext.arc(originX+cellSize, originY+cellSize, 7*unit, 1 * Math.PI, 1.5 * Math.PI, false);
    trackContext.moveTo(originX+7*unit, originY+cellSize);
    trackContext.arc(originX+cellSize, originY+cellSize, 5*unit, 1 * Math.PI, 1.5 * Math.PI, false);
    //trackContext.moveTo(originX+6*unit, originY+cellSize);
    //trackContext.arc(originX+cellSize, originY+cellSize, 6*unit, 1 * Math.PI, 1.5 * Math.PI, false);
    }
  if(theType=="bl"){
    trackContext.arc(originX, originY+cellSize, 7*unit, 0, 1.5 * Math.PI, true);
    trackContext.moveTo(originX+5*unit, originY+cellSize);
    trackContext.arc(originX, originY+cellSize, 5*unit, 0, 1.5 * Math.PI, true);
    //trackContext.moveTo(originX+6*unit, originY+cellSize);
    //trackContext.arc(originX, originY+cellSize, 6*unit, 0, 1.5 * Math.PI, true);
    }
  if(theType=="tl"){
    trackContext.arc(originX, originY, 7*unit, 0, .5 * Math.PI, false);
    trackContext.moveTo(originX+5*unit, originY);
    trackContext.arc(originX, originY, 5*unit, 0, .5 * Math.PI, false);
    //trackContext.moveTo(originX+6*unit, originY);
    //trackContext.arc(originX, originY, 6*unit, 0, .5 * Math.PI, false);
    }
  if(theType=="tr"){
    trackContext.arc(originX+cellSize, originY, 7*unit, Math.PI, .5 * Math.PI, true);
    trackContext.moveTo(originX+7*unit, originY);
    trackContext.arc(originX+cellSize, originY, 5*unit, Math.PI, .5 * Math.PI, true);
    //trackContext.moveTo(originX+6*unit, originY);
    //trackContext.arc(originX+cellSize, originY, 6*unit, Math.PI, .5 * Math.PI, true);
    }

  //trackContext.quadraticCurveTo(originX+cellSize, originY, originX, originY);
  trackContext.stroke();
  }
function setupCanvas(){
  htmlBlock="<canvas id=\"backgroundCanvas\" width=\""+boardWidth+"\" height=\""+boardHeight+"\" style=\"position:absolute; \"></canvas>";
  htmlBlock+="<canvas id=\"trackCanvas\" width=\""+boardWidth+"\" height=\""+boardHeight+"\" style=\"position:absolute;\"></canvas>";
  document.getElementById('canvasHolder').innerHTML=htmlBlock;
  bgContext = document.getElementById("backgroundCanvas").getContext("2d");
  trackContext = document.getElementById("trackCanvas").getContext("2d");

  }

function addStyle(styleName, styleCode){
  var style = document.createElement('style');
  style.type = 'text/css';
  style.innerHTML = styleName+' { '+styleCode+' }';
  document.getElementsByTagName('head')[0].appendChild(style);
  }
var screenWidth=100;
var screenHeight=100;
var boardHeight=100;
var boardWidth=100;
var topPad=0;
var leftPad=0;
var tablet=false;
var wrapper;
function setGeometry(){
  wrapper=document.getElementById("wrapper");
  screenWidth = window.innerWidth;
  screenHeight = window.innerHeight;

  var screenAspect=screenWidth/screenHeight;
  if(screenWidth<=540){
    tablet=false;
    cellsAcross=6;
    }
  else{
    tablet=true;
    cellsAcross=8;  
    }
  cellSize=Math.floor(10*screenWidth/cellsAcross)/10;
  cellsDown=Math.floor((screenHeight-44-cellSize/6)/cellSize)-1;
  boardWidth=screenWidth;
  boardHeight=cellsDown*cellSize;
  wrapperHeight=(cellsDown+1.5)*cellSize;
  //dbug(cellsDown);
  wrapper.style.width=boardWidth+"px";
  wrapper.style.height=wrapperHeight+"px";
  wrapper.style.left=leftPad+"px";
  wrapper.style.top=topPad+"px";

/*
  sdiv.style.width=(grid*10)+"px";
  sdiv.style.height=grid*8+"px";
  sdiv.style.fontSize=grid*4+"px";
  sdiv.style.left=(leftPad+boardWidth-grid*20)+"px";
  sdiv.style.top=(topPad+grid*2)+"px";
*/
  cellSizeHalf=cellSize/2;
  centerSize=cellSize/4;
  if(tablet){createInitialBuildSequence768();}
  else{createInitialBuildSequence320();}
  setupClasses();
  setupCanvas();// maybe move to resetBoardTimersObjects() 
  fillBgCanvas(); //was makeGrid
  resetBoardTimersObjects();
  rebuildSequence();
  }
var platform="unknown";
var filePath="";
function debugStorage(){
  //dbuga("musicOn:"+localStorage.getItem("musicOn")+" sfxOn:"+localStorage.getItem("sfxOn"));
  }
var levelData=[];
var colorByNum=["orange","black","blue","green"];
function populateButtons(){
  levelData=[[1,1],[1,1,1],[3,3],[2,2,2],[1,1,1,1],[2,2,2,2],[3,3,3,3]];
  if(cellsDown>cellsAcross){
    levelData=[[1,1],[1,1,1],[3,3],[3,3,3],[2,2,2,2],[2,2,2,2],[3,3,3,3]];
    }

  for (var b=0;b<cellsAcross-1; b++){
    var bString='<div class="buttonBackground buttonChildren"></div><div class="buttonChildren">';
    for(var c=0;c<levelData[b].length;c++){
      var color=colorByNum[c];
      for(var t=0; t<=levelData[b][c]; t++){
        bString+='<div class="dark'+color+' tiny"></div>';
        }
      for(var t=levelData[b][c]; t<3; t++){
        bString+='<div class="tiny"></div>';
        }
      }
    bString+='</div><div class="buttonChildren" id="level'+(b+1)+'Button" ></div>';

    document.getElementById("buttonHolder"+(b+2)).innerHTML=bString;
    }
  }

function init(){
  document.addEventListener("pause", pauseGame, false);
  document.addEventListener("resume", resumeGame, false);
  debugStorage(); 
  var wLoc=""+window.location+"";
  if(wLoc.indexOf("file:///")==0){
    platform="local";
    if(wLoc.indexOf("file:///var/mobile")==0){platform="dreamfreeze";}
    if(wLoc.indexOf("file:///android_asset")==0){platform="android";}
    }
  if(wLoc.indexOf("http://")==0){platform="web";}
  //should be good for android and iOS
  var path = window.location.pathname;
  path = path.substr( path, path.length - 10 );
  filePath= '' + path+'sounds';
  if(platform=="local"){filePath="sounds";}   
  if(platform=="web"){filePath="sounds";} 
  //dbug(JSON.stringify(localStorage));  
  genericDefault("sfxOn", "true");
  genericDefault("musicOn", "true");
  debugStorage();



  initSound();
  setupNav();

  if(genericGet("musicOn") == "true"){
    document.getElementById('Music_label').style.opacity="1";
    }
  else{
    document.getElementById('Music_label').style.opacity=".5";
    }
  if(genericGet("sfxOn") == "true"){
    document.getElementById('Sfx_label').style.opacity="1";
    }
  else{
    document.getElementById('Sfx_label').style.opacity=".5";
    }
 
  setGeometry();
  populateButtons();
/*
  comQueue.push("action=manageSound|channel=0|mode=prepare|file=sounds/measure_loop_inst.mp3|loop=true");
  comQueue.push("action=manageSound|channel=1|mode=prepare|file=sounds/laytrack.wav|loop=false");
  comQueue.push("action=manageSound|channel=2|mode=prepare|file=sounds/carstart.wav|loop=false");
  comQueue.push("action=manageSound|channel=3|mode=prepare|file=sounds/carstop.wav|loop=false");
  comQueue.push("action=manageSound|channel=4|mode=prepare|file=sounds/trainstart.wav|loop=false");
  comQueue.push("action=manageSound|channel=5|mode=prepare|file=sounds/trainpause.wav|loop=false");
  comQueue.push("action=manageSound|channel=6|mode=prepare|file=sounds/applause.wav|loop=false");
  comTick();
*/
  transmitBgMusicState();
  destTimer=window.setInterval(destTick, "1000");
  }
var soundObject={};
function initSound(){
  //dbuga('initSound()');
  loopLoad("measure_loop_inst");
  oneShotLoad("laytrack");
  oneShotLoad("carstart");
  oneShotLoad("carstop");
  oneShotLoad("trainstart");
  oneShotLoad("trainpause");
  oneShotLoad("applause");
  }

function setupNav(){
  var navDivRef=createNavDiv();
  screenLayout(navDivRef);
  //document.getElementById('uiHolder').style.top=canvasHeight+"px";

  useWidth=76;
  
  addControl("Music", "Music", "left", useWidth);
  addControl("Sfx", "Sounds", "left", useWidth);
  addControl("Info", "Info", "left", useWidth);
  addControl("Undo", "Undo", "left", useWidth);
//  addControl("Pause", "<img src=\"nav/pause.png?7\" width=\"44\" height=\"44\" />", "left", useWidth);
//  document.getElementById('Info_label').style.opacity=".5";
  document.getElementById('Undo_label').style.opacity=".5";
  }

function resetBoardTimersObjects(){
  setupGridData();
  closeInfo();
  collisionData=new Object();
  possibleObject['blue']=0;
  possibleObject['black']=0;
  possibleObject['orange']=0;
  possibleObject['green']=0;
  scoreObject['blue']=0;
  scoreObject['black']=0;
  scoreObject['orange']=0;
  scoreObject['green']=0;
  zeroProgressBar();
  fullCellGlom="";
  window.clearInterval(turnTimer);
  window.clearInterval(sourceTimer);
  colorCycle=0;
  trainCount=0;
  sourceCount=0;
  destCount=0;
  carCount=0;
  carData=new Object();
  carList=new Array();
  trainData=new Object();
  sourceData=new Object();
  checkTrainNum=0;
  checkSourceNum=0;
  document.getElementById('trainHolder').innerHTML="";
  document.getElementById('gridHolder').innerHTML="";
  makeGrid();
  }

//build level functions

function addColor(fields, barrels){
  color=colorList[Math.floor(colorCycle)];
  colorCycle+=1;
  if(colorCycle>=4){
    colorCycle=0;
    } 
  var fails=randomTileGroup(color, fields, barrels);
  return fails;
  }
function createInitialBuildSequence768(){
  buildSequence=[];
  buildSequence.push(new buildObject("dest", "orange", "t", 2, 4, 0));
  buildSequence.push(new buildObject("train", "orange", "b", 6, 2, 0));
  buildSequence.push(new buildObject("source", "orange", "t", 5, 4, 2));
  //buildSequence.push(new buildObject("source", "orange", "t", 4, 6, 2));

  buildSequence.push(new buildObject("track", "", "bl", 2, 3, 0));
  buildSequence.push(new buildObject("track", "", "br", 2, 3, 0));
  buildSequence.push(new buildObject("track", "", "lr", 2, 3, 0));

  buildSequence.push(new buildObject("track", "", "bl", 5, 3, 0));
  buildSequence.push(new buildObject("track", "", "br", 5, 3, 0));
  buildSequence.push(new buildObject("track", "", "lr", 5, 3, 0));

  buildSequence.push(new buildObject("track", "", "lr", 3, 3, 0));
  buildSequence.push(new buildObject("track", "", "lr", 4, 3, 0));

  buildSequence.push(new buildObject("track", "", "tl", 6, 3, 0));
  buildSequence.push(new buildObject("track", "", "tb", 6, 2, 0));
  buildSequence.push(new buildObject("track", "", "bl", 6, 1, 0));

  buildSequence.push(new buildObject("track", "", "lr", 2, 1, 0));
  buildSequence.push(new buildObject("track", "", "lr", 3, 1, 0));
  buildSequence.push(new buildObject("track", "", "lr", 4, 1, 0));
  buildSequence.push(new buildObject("track", "", "lr", 5, 1, 0));

  buildSequence.push(new buildObject("track", "", "tr", 1, 3, 0));
  buildSequence.push(new buildObject("track", "", "tb", 1, 2, 0));
  buildSequence.push(new buildObject("track", "", "br", 1, 1, 0));
  }
  
function createInitialBuildSequence320(){
  buildSequence=[];
  buildSequence.push(new buildObject("dest", "orange", "t", 1, 4, 0));
  buildSequence.push(new buildObject("train", "orange", "b", 5, 1, 0));
  buildSequence.push(new buildObject("source", "orange", "t", 4, 4, 2));

  buildSequence.push(new buildObject("track", "", "bl", 1, 3, 0));
  buildSequence.push(new buildObject("track", "", "br", 1, 3, 0));
  buildSequence.push(new buildObject("track", "", "lr", 1, 3, 0));

  buildSequence.push(new buildObject("track", "", "bl", 4, 3, 0));
  buildSequence.push(new buildObject("track", "", "br", 4, 3, 0));
  buildSequence.push(new buildObject("track", "", "lr", 4, 3, 0));


  buildSequence.push(new buildObject("track", "", "lr", 2, 3, 0));
  buildSequence.push(new buildObject("track", "", "lr", 3, 3, 0));


  buildSequence.push(new buildObject("track", "", "tl", 5, 3, 0));
  buildSequence.push(new buildObject("track", "", "tb", 5, 2, 0));
  buildSequence.push(new buildObject("track", "", "bl", 5, 1, 0));

  buildSequence.push(new buildObject("track", "", "lr", 1, 1, 0));
  buildSequence.push(new buildObject("track", "", "lr", 2, 1, 0));
  buildSequence.push(new buildObject("track", "", "lr", 3, 1, 0));
  buildSequence.push(new buildObject("track", "", "lr", 4, 1, 0));

  buildSequence.push(new buildObject("track", "", "tr", 0, 3, 0));
  buildSequence.push(new buildObject("track", "", "tb", 0, 2, 0));
  buildSequence.push(new buildObject("track", "", "br", 0, 1, 0));

  }

function buildObject(type,color,dir,x,y, barrels){
  this.type=type;
  this.color=color;
  this.dir=dir;
  this.x=x;
  this.y=y;
  this.barrels=barrels;
  }
function randomTileGroup(color, fields, barrels){
  var fails=0;
  posObject=viableRandomPosition();
  //dbuga(posObject.success+" "+posObject.x+" "+posObject.y);
  if(posObject.success==true){
    var buildItem=new Object();
    buildItem.type="dest";
    buildItem.color=color;
    buildItem.dir= posObject.dir;
    buildItem.x=posObject.x;
    buildItem.y=posObject.y;
    buildSequence.push(buildItem);

    var buildItem=new Object();
    buildItem.type="train";
    buildItem.color=color;
    buildItem.dir= posObject.dir;
    buildItem.x=posObject.x;
    buildItem.y=posObject.y;
    buildSequence.push(buildItem);

    destData[destCount]=destObject(destCount, color, posObject.dir, posObject.x, posObject.y);
    trainData[trainCount]=trainObject(trainCount, color, posObject.x, posObject.y, posObject.dir);
    }
  else{
    fails++;
    }
  for (f=0; f<fields; f++){  
    posObject=viableRandomPosition();
    if(posObject.success==true){
      var buildItem=new Object();
      buildItem.type="source";
      buildItem.color=color;
      buildItem.dir=posObject.dir;
      buildItem.x=posObject.x;
      buildItem.y=posObject.y;
      buildItem.barrels=barrels;
      buildSequence.push(buildItem);
      sourceData[sourceCount]=sourceObject(sourceCount, color, posObject.dir, posObject.x, posObject.y, barrels);
      displayBarrels("grid_"+posObject.x+"_"+posObject.y, barrels); 
      }
    else{
      fails++;
      }
    }
  return fails;
  }
function displayBarrels(examineCell, howMany){
  //debugString=examineCell+", "+howMany+"<br>";
  var cn=document.getElementById(examineCell).childNodes;
  var cnl=cn.length;  
  for (var n=0; n<cnl; n++){
    var thisClass=cn[n].className;
    if (thisClass.indexOf('tile')>-1){
      //debugString+=thisClass+" - ";
      barrelNodes=cn[n].childNodes;
      for (var b=0; b<barrelNodes.length; b++){
        if(howMany>b){
          barrelNodes[b].style.opacity="1";
          }
        else{
          barrelNodes[b].style.opacity="0";
          }        
        }
      }
    }
  }

function viableRandomPosition(){
  
  var allow=false;
  var failCount=0;
  var failLimit=50;
  var thisObject=new Object();
  unreservedCells=new Array();
  promotedCells=new Array();
  for (x=0; x<cellsAcross; x++){
    for (y=0; y<cellsDown; y++){
      testCell="grid_"+x+"_"+y;
      if(fullCellGlom.indexOf(testCell)==-1){
        unreservedCells.push(testCell);

        // promote by duplicating cells with less diagonal neighbors
        noDiagonals=true;
        if(isTiled(x-1, y-1)==true){noDiagonals=false;}
        if(isTiled(x+1, y-1)==true){noDiagonals=false;}
        if(isTiled(x-1, y+1)==true){noDiagonals=false;}
        if(isTiled(x+1, y+1)==true){noDiagonals=false;}
        if(noDiagonals==true){promotedCells.push(testCell);}
        }
      }
    }
  //dbug('unreservedCells:'+unreservedCells);

  while((allow == false)&&(failCount <=failLimit)){
    var thisFail=false;
    var dir=dirList[Math.floor(Math.random()*4)];
    if(unreservedCells.length==0){
      //alert("viableRandomPosition error, no unreserved cells");
      x=0;
      y=0;
      }
    else{
      //try promoted cells first if not toomany fails
      if((promotedCells.length>0)&&(failCount<failLimit/2)){
        useCell=promotedCells[Math.floor(Math.random()*promotedCells.length)];
        }
      else{
        useCell=unreservedCells[Math.floor(Math.random()*unreservedCells.length)];
        }
      cellParts=useCell.split("_");
      x=Number(cellParts[1]);
      y=Number(cellParts[2]);
      }

    var nextX=xDeltaByDir[dir]+x;  
    var nextY=yDeltaByDir[dir]+y;  
    var thisCell="grid_"+x+"_"+y;
    var adjCell="grid_"+nextX+"_"+nextY;
    if (fullCellGlom.indexOf(thisCell)>-1){
      thisFail=true;
      }

    //this and next - out of bounds or occupied?
    if((nextX<0)||(nextX>=cellsAcross)){
      thisFail=true;
      }
    if((nextY<0)||(nextY>=cellsDown)){
      thisFail=true;
      }
 
    if((isTiled(nextX, nextY)==true)||(isTiled(x, y)==true)){
      thisFail=true;
      }

    var reserveCellsArray=openAdjacentCellsArray(nextX, nextY, thisCell);

    if (thisFail==false){
      // check next for 2 or 3 untiled neighbors
      if(reserveCellsArray.length<2){
        thisFail=true;
        }
      }

    //// new wall walking test
    if(thisFail==false){
      var passedWalk=false;
      edgesBarredXY=[];
      // setup quad switches 0=right 1=down 2=left 3=up
      for (var tx=0; tx<cellsAcross; tx++){
        var col=[];
        for (var ty=0; ty<cellsDown; ty++){
          var cell=[false,false,false,false];
          if(ty==0){cell[3]=true;}
          else{
            var testId="grid_"+tx+"_"+(ty-1);
            if(tilesByGridXY[testId].length>0){cell[3]=true;}
            }
          if(ty==cellsDown-1){cell[1]=true;}
          else{
            var testId="grid_"+tx+"_"+(ty+1);
            if(tilesByGridXY[testId].length>0){cell[1]=true;}
            }
          if(tx==0){cell[2]=true;}
          else{
            var testId="grid_"+(tx-1)+"_"+ty;
            if(tilesByGridXY[testId].length>0){cell[2]=true;}
            }
          if(tx==cellsAcross-1){cell[0]=true;}
          else{
            var testId="grid_"+(tx+1)+"_"+ty;
            if(tilesByGridXY[testId].length>0){cell[0]=true;}
            }
          col.push(cell);
          }
        edgesBarredXY.push(col);
        }
      // bar self
      //dbug("x:"+x+" y:"+y+" dir:"+dir+"<br>");
      if(x>0){edgesBarredXY[x-1][y][0]=true;}
      if(x<cellsAcross-1){edgesBarredXY[x+1][y][2]=true;}
      if(y>0){edgesBarredXY[x][y-1][1]=true;}
      if(y<cellsDown-1){edgesBarredXY[x][y+1][3]=true;}
      var walkX=x+xDeltaByDir[dir];
      var walkY=y+yDeltaByDir[dir];
      var walkDir=dir;
      edgesBarredXY[walkX][walkY][ordByDir[reverseObject[walkDir]]]=false;
      var goalX=walkX;
      var goalY=walkY;
      var goalDir=reverseObject[dir];
      var walking=true;
      //debugCell(walkDir,walkX,walkY);
      var limit=40;
      while(walking){
        limit--;
        if(limit<0){
          walking=false;
          //dbuga("limit");
          }
        var foundStep=false;
        var testDir="not set";
        //dbuga("<b>"+walkDir+"</b>");


        if(foundStep==false){
          testDir=rightObject[walkDir];
          var ord=ordByDir[testDir];
          //dbuga("_ "+walkX+" "+walkY+" testDir:"+testDir+" ord:"+ord);
          if(edgesBarredXY[walkX][walkY][ord]==false){foundStep=true;}
          }
        if(foundStep==false){
          testDir=walkDir;
          var ord=ordByDir[testDir];
          //dbuga("___ "+walkX+" "+walkY+" test:"+testDir+" "+ord);
          if(edgesBarredXY[walkX][walkY][ord]==false){foundStep=true;}
          }
        if(foundStep==false){
          testDir=leftObject[walkDir];
          var ord=ordByDir[testDir];
          //dbuga("___ "+walkX+" "+walkY+" test:"+testDir+" "+ord);
          if(edgesBarredXY[walkX][walkY][ord]==false){foundStep=true;}
          }
         if(foundStep==false){
          walking=false;
          }
        else{
          //dbuga(" "+testDir);
/*
          trackContext.strokeStyle="rgba(0,0,255,.3)";
          trackContext.lineWidth=5;
          trackContext.beginPath();
          var pxX=walkX*cellSize+cellSize/2+xDeltaByDir[reverseObject[walkDir]]*cellSize/2.5;
          var pxY=walkY*cellSize+cellSize/2+yDeltaByDir[reverseObject[walkDir]]*cellSize/2.5;
          trackContext.moveTo(pxX,pxY);
*/
          if((walkX!=goalX)||(walkY!=goalY)){
            var ord=ordByDir[reverseObject[walkDir]];
            edgesBarredXY[walkX][walkY][ord]=true;
            }
          var ord=ordByDir[testDir];
          edgesBarredXY[walkX][walkY][ord]=true;

          walkDir=testDir;

/*
          var pxX=walkX*cellSize+cellSize/2+xDeltaByDir[walkDir]*cellSize/2.5;
          var pxY=walkY*cellSize+cellSize/2+yDeltaByDir[walkDir]*cellSize/2.5;
          trackContext.lineTo(pxX,pxY);
          trackContext.stroke();
*/
          walkX+=xDeltaByDir[walkDir];
          walkY+=yDeltaByDir[walkDir];
          if((walkX==goalX)&&(walkY==goalY)){
            limit=0;
            passedWalk=true;
            //dbuga(goalX+" "+goalY+" "+goalDir);
            }
          }
        }
      }
    if(passedWalk==false){
      thisFail=true;
      //dbuga(x+" "+y+" failedWalk");
      }
    //// end of wall walk


    if (thisFail==false){allow=true;}
    else{failCount++;}
    }
  if (failCount>failLimit){
    //alert('viableRandomPosition Failed to place tile. failCount='+failCount);
    thisObject.x=0;
    thisObject.y=0;
    thisObject.dir="r";
    thisObject.success=false;
    }
  else{
    thisObject.x=x;
    thisObject.y=y;
    thisObject.dir=dir;
    thisObject.success=true;
    fullCellGlom+=thisCell+adjCell;

    for (r=0; r<reserveCellsArray.length; r++){
      fullCellGlom+=reserveCellsArray[r];
      }
    }
  //debugCell(adjCell,thisObject.x,thisObject.y);
  //dbuga(buildSequence.length);
  return thisObject;
  }
var ordByDir={"r":0, "b":1, "l":2, "t":3};
var edgesBarredXY=[];
var pi=Math.PI;
function debugCell(message, cellX,cellY){
  trackContext.textAlign="center";
  trackContext.font="20px Arial Bold";
  trackContext.fillStyle = "rgb(0, 0, 255)";
  trackContext.strokeStyle = "rgb(255, 255, 255)";
  trackContext.lineWidth= 2;

  pxX=cellX*cellSize+cellSize/2;
  pxY=cellY*cellSize+cellSize/2;
  trackContext.strokeText(message,pxX,pxY);
  trackContext.fillText(message,pxX,pxY);
  }
// destination functions

function destObject(n, color, dir, x, y){
  deg=degByDir[dir];
  var d=new Object();
  d.color=color; 
  var carsArray=new Array();
  d.carsArray=carsArray;
  d.barrels=0;
  d.deg=deg;
  d.dir=dir;
  d.x=x;
  d.y=y;
  d.xIntake=x+xDeltaByDir[dir];
  d.yIntake=y+yDeltaByDir[dir];

  destCount++;
  targetCell="grid_"+x+"_"+y;
  createTrack("tiledest"+color, targetCell);
  createTrack(dir+"d", targetCell);
  createCanvasTrack(dir+"d", x, y);
  return d;
  }

function destTick(){
  if((screenWidth != window.innerWidth)||(screenHeight != window.innerHeight)){
    setGeometry();
    }

  if(infoUp==false){
    for (d=0; d<destCount; d++){
      thisCarsArray=destData[d].carsArray;
   
      // move cars
      var cal=thisCarsArray.length;
      for (var carNum=cal-1; carNum>-1; carNum--){
        thisCarId=thisCarsArray[carNum];
        if(carNum>0){
          // follow Prev Car
          tempDir=carData[thisCarId].dir;
          parentCarId=thisCarsArray[carNum-1];
          parentTransform=carData[parentCarId].transformCache;
          carData[thisCarId]=followObject(carData[parentCarId], carData[thisCarId]);
          collisionData['car'+thisCarId]=lineStringFromXYD(carData[thisCarId].prevX, carData[thisCarId].prevY, carData[thisCarId].dir);
          }
        else{
          //follow into dest dock
          delta=degDeltaFromDirs(reverseObject[carData[thisCarId].dir], reverseObject[destData[d].dir]);
          destDeg=carData[thisCarId].deg-delta;
          parentTransform=getTransformString(destData[d].x, destData[d].y, destDeg, destData[d].dir);
          document.getElementById('car'+thisCarId).style.opacity=0;
          delete collisionData['car'+thisCarId];
          scoreObject[destData[d].color]++;
          updateProgressBar();
          playSound("carstop");
          }
        carData[thisCarId].transformCache=parentTransform;
        document.getElementById('car'+thisCarId).style.webkitTransform=parentTransform;
        }
      deadCar=destData[d].carsArray.shift();
      } // end of each dest loop
    }
  }

function zeroProgressBar(){
  for (c=0; c<colorList.length; c++){
    color=colorList[c];
    document.getElementById(color+"ProgressDiv").style.width="0px";
    }
  }
function updateProgressBar(){
  totalCarsNeeded=0;
  totalCarsDocked=0;
  maxWidth=boardWidth-10;
  colorsInPlay=0;
  for (c=0; c<colorList.length; c++){
    color=colorList[c];
    if(possibleObject[color]>0){
      colorsInPlay++;
      totalCarsNeeded+=possibleObject[color];
      totalCarsDocked+=scoreObject[color];
      }
    }
  colorMaxWidth=maxWidth/colorsInPlay;
  for (c=0; c<colorList.length; c++){
    color=colorList[c];
    if(possibleObject[color]>0){
      progressPercent=scoreObject[color]/possibleObject[color];
      progressPixels=Math.floor(progressPercent*colorMaxWidth*1000)/1000;
      document.getElementById(color+"ProgressDiv").style.width=progressPixels+"px";
      }
    }
  //if(totalCarsDocked==totalCarsNeeded){
  //  playSound("applause");
  // }
  }

// source functions

function sourceObject(n, color, dir, x, y, barrels){
  possibleObject[color]+=barrels;
  deg=degByDir[dir];
  var s=new Object();
  s.barrels=barrels;
  s.color=color; 
  s.occupied=false;
  s.deg=deg;
  s.dir=dir;
  s.x=x;
  s.y=y;
  sourceCount++;
  targetCell="grid_"+x+"_"+y;
  createTrack("tilesource"+color, targetCell);
  createTrack(dir+"s", targetCell);
  createCanvasTrack(dir+"s", x, y);
  window.clearInterval(sourceTimer);
  turnMs=Math.floor(10000/sourceCount);
  if(freezeMode == false){
    sourceTimer=window.setInterval(sourceTick, turnMs);
    }
  return s;
  }

function sourceTick(){
  sourceAction(checkSourceNum);
  checkSourceNum++;
  if (checkSourceNum>=sourceCount){
    checkSourceNum=0;
    }
  }

function sourceAction(sourceNum){
  if ((sourceData[sourceNum].occupied==false)&&(sourceData[sourceNum].barrels>0)){
    sourceData[sourceNum].occupied=true;
    sourceData[sourceNum].barrels--;
    displayBarrels("grid_"+sourceData[sourceNum].x+"_"+sourceData[sourceNum].y, sourceData[sourceNum].barrels);
    useColor=sourceData[sourceNum].color;
    carData[carCount]=carObject(carCount, useColor, sourceData[sourceNum].dir, sourceData[sourceNum].x, sourceData[sourceNum].y, sourceNum);
    }
  }

// car functions

function carObject(n, color, dir, x, y, oid){
  deg=degByDir[dir];
  var c=new Object();
  c.color=color;
  c.attached=false;
  c.track="";
  c.deg=deg;
  c.dir=dir;
  c.originId=oid;
  c.prevX=x;
  c.prevY=y;
  c.nextX=x+xDeltaByDir[dir];
  c.nextY=y+yDeltaByDir[dir];
  carList.push(n);
  carCount++;
  useTransform=getTransformString(x,y,deg,dir);
  c.transformCache=useTransform;

  useInnerHTML=carHtmlByColor[color];
  useStyle="style=\"width:" + cellSize + "px; height:" + cellSize + "px; opacity:.5; position:absolute; margin-left:-" + cellSizeHalf + "px; margin-top:-" + cellSizeHalf + "px; -webkit-transform: "+useTransform+" ;\"";
  useCarId="car"+n;
  useInnerHTML=useInnerHTML.replace('style', useStyle);
  useInnerHTML=useInnerHTML.replace('carId', useCarId);
  var newdiv = document.createElement('div');
  newdiv.innerHTML = useInnerHTML;
  document.getElementById('trainHolder').appendChild(newdiv);
  return c;
  }

// train functions

function trainObject(n, color, x, y, dir){
  deg=degByDir[dir];
  var t=new Object();
  t.color=color, 
  t.moving=false;
  t.carsArray=new Array();
  t.transformCache="";
  t.track="";
  t.deg=deg;
  t.dir=dir;
  t.prevX=x;
  t.prevY=y;
  t.nextX=x+xDeltaByDir[dir];
  t.nextY=y+yDeltaByDir[dir];
  trainCount++;
  useTransform=getTransformString(x,y,deg,dir);
  useInnerHTML=trainHtmlByColor[color];
  useStyle='style="width:' + cellSize + 'px; height:' + cellSize + 'px; position:absolute; margin-left:-' + cellSizeHalf + 'px; margin-top:-' + cellSizeHalf + 'px; -webkit-transform: '+useTransform+';"';
  useTrainId="train"+n;
  useInnerHTML=useInnerHTML.replace('style', useStyle);
  //dbug('trainObject '+useStyle);
  useInnerHTML=useInnerHTML.replace('trainId', useTrainId);
  var newdiv = document.createElement('div');
  newdiv.innerHTML = useInnerHTML;
  document.getElementById('trainHolder').appendChild(newdiv);
  window.clearInterval(turnTimer);
  turnMs=Math.floor(1000/trainCount);
  if(freezeMode == false){
    turnTimer=window.setInterval(trainTick, turnMs);
    }
  return t;
  }

function trainTick(){
  if((infoUp==false)&&(paused==false)){
    //var debugString="trainTick() checkTrainNum="+checkTrainNum;
    //for (var t=0; t<trainCount; t++){
    //debugString+="<br>"+t+" prev "+trainData[t].prevX+" "+trainData[t].prevY+" next"+trainData[t].nextX+" "+trainData[t].nextY+" dir "+trainData[t].dir+" deg "+trainData[t].deg;
    //  }
    //dbug(debugString);
    trainAction(checkTrainNum);
    checkTrainNum++;
    if (checkTrainNum>=trainCount){
      checkTrainNum=0;
      }
    }
  }

function trainAction(trainNum){
  var debugString="";
  // look ahead of train to determine valid tracks
  var examineCell="grid_"+trainData[trainNum].nextX+"_"+trainData[trainNum].nextY;
  //var cn=document.getElementById(examineCell).childNodes;
  var cn=tilesByGridXY[examineCell];
  var cnl=cn.length;
  var connectionsArray=new Array();
  var tracksArray=new Array();
  var reverseDir=reverseObject[trainData[trainNum].dir];
  var collided=false;
  //for each child node of examineCell
  for (var n=0; n<cnl; n++){
    var collision=false;
    //var thisTrack=cn[n].className;
    var thisTrack=cn[n];
    if (thisTrack.indexOf(reverseDir)>-1){
      thisConnection=thisTrack.replace(reverseDir, "");
      tX=trainData[trainNum].nextX+xDeltaByDir[thisConnection];
      tY=trainData[trainNum].nextY+yDeltaByDir[thisConnection];

      //test if my destination line is occupied
      if(lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, thisConnection))==true){
        collision=true;
        }

      // maybe it's a double cross...
      if(thisConnection==trainData[trainNum].dir){
        //yes, we're testing a straight route. Are both other lines occupied?
        if((trainData[trainNum].dir=="r")||(trainData[trainNum].dir=="l")){
          //test top and bottom for occupied
          if((lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, "t"))==true)&&(lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, "b"))==true)){collision=true;}
          }
        else{
          //test left and right for occupied
          if((lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, "l"))==true)&&(lineIsOccupied(lineStringFromXYD(trainData[trainNum].nextX, trainData[trainNum].nextY, "r"))==true)){collision=true;}
          }
        }
      if((collision==false)&&(isTiled(tX, tY)==false)){
        tracksArray.push(thisTrack);
        connectionsArray.push(thisConnection);
        }
      if(collision==true){collided=true;}
      }
    }

  // check color progress and find dock
  if(possibleObject[trainData[trainNum].color]==scoreObject[trainData[trainNum].color]){
    foundDest=findDest(trainData[trainNum].nextX, trainData[trainNum].nextY, trainData[trainNum].dir, trainData[trainNum].color);
    if(foundDest != "none"){
      destTrack="";
      destOppDir=reverseObject[destData[foundDest].dir];
      trainOppDir=reverseObject[trainData[trainNum].dir];
      tracksInCell=returnTracksInCell(trainData[trainNum].nextX,trainData[trainNum].nextY);
      for(var t=0; t<tracksInCell.length; t++){
        thisTrack=tracksInCell[t];
        if ((thisTrack.indexOf(trainOppDir)>-1)&&(thisTrack.indexOf(destOppDir)>-1)){
          tracksArray=new Array(thisTrack);
          thisConnection=thisTrack.replace(trainOppDir, "");          
          connectionsArray=new Array(thisConnection);
          playSound("applause");
          }
        }
      }
    }


  var tal=tracksArray.length;

  if((trainData[trainNum].moving==false)&&(tal>0)){
    playSound("trainstart");
    }
  if((collided==true)&&(tal==0)&&(trainData[trainNum].moving==true)){
    playSound("trainpause");
    }

  if(tal==0){trainData[trainNum].moving=false;}
  if (tal>0){
    trainData[trainNum].moving=true;
    tempDir=trainData[trainNum].dir;
    var selNum=Math.floor(Math.random()*tal);
    var selTrack=tracksArray[selNum];
    var selDir=connectionsArray[selNum];
    trainData[trainNum].track=selTrack;
    //debugString+="trainData[trainNum].track="+trainData[trainNum].track+"<br>";

    // check for destination adjacent to train next cell////
    if (trainData[trainNum].carsArray.length>0){
      foundDest=findDest(trainData[trainNum].prevX, trainData[trainNum].prevY, carData[trainData[trainNum].carsArray[0]].dir, trainData[trainNum].color);
      if (foundDest != "none"){
        var tempCarsArray=trainData[trainNum].carsArray;
        destData[foundDest].carsArray=tempCarsArray;
        trainData[trainNum].carsArray=new Array();
        }
      }

    if (trainData[trainNum].carsArray.length==0){
      //try to attach an adjacent car to train
      foundCar=findCar(trainData[trainNum].prevX, trainData[trainNum].prevY, tempDir, trainData[trainNum].color);
      if (foundCar != "none"){
        trainData[trainNum].carsArray.push(foundCar);
        carData[foundCar].attached=true;
        sourceData[carData[foundCar].originId].occupied=false;
        carData[foundCar].transformCache=trainData[trainNum].transformCache;      
        delta=degDeltaFromDirs(carData[foundCar].dir, trainData[trainNum].dir);
        useDeg=trainData[trainNum].deg-delta;
        carData[foundCar].deg=useDeg;
        useTransform=getTransformString(carData[foundCar].prevX, carData[foundCar].prevY, useDeg, carData[foundCar].dir);
        thisCarDiv="car"+foundCar;
        document.getElementById(thisCarDiv).style.webkitTransform=useTransform;
        document.getElementById(thisCarDiv).style.display="none";
        var redrawFix = document.getElementById(thisCarDiv).offsetHeight;
        document.getElementById(thisCarDiv).style.display="block"; 
        document.getElementById(thisCarDiv).setAttribute("class", "transit");
        document.getElementById(thisCarDiv).style.opacity="1"; 
        playSound("carstart");
        }
      }

    if (trainData[trainNum].carsArray.length>0){
      // see if we need to attach a car to the last car
      cal=trainData[trainNum].carsArray.length;
      if(cal>0){
        carNum=cal-1;
        lastCarId=trainData[trainNum].carsArray[carNum];
        foundCar=findCar(carData[lastCarId].prevX, carData[lastCarId].prevY, carData[lastCarId].dir, trainData[trainNum].color);
        if (foundCar != "none"){
          trainData[trainNum].carsArray.push(foundCar);
          carData[foundCar].attached=true;
          sourceData[carData[foundCar].originId].occupied=false;
          carData[foundCar].transformCache=carData[lastCarId].transformCache;
          persistDeg="carData[lastCarId].deg="+carData[lastCarId].deg+" ("+carData[foundCar].dir+", "+carData[lastCarId].dir+")=";
          delta=degDeltaFromDirs(carData[foundCar].dir, carData[lastCarId].dir); 
          persistDeg+=" delta= "+delta+"<br>";
          persistDeg+="WAS "+carData[foundCar].deg;
          useDeg=carData[lastCarId].deg-delta;
          carData[foundCar].deg=useDeg;
          persistDeg+=" IS "+useDeg;
          useTransform=getTransformString(carData[foundCar].prevX, carData[foundCar].prevY, useDeg, carData[foundCar].dir);
          thisCarDiv="car"+foundCar;
          document.getElementById(thisCarDiv).style.webkitTransform=useTransform;
          document.getElementById(thisCarDiv).style.display="none";
          var redrawFix = document.getElementById(thisCarDiv).offsetHeight;
          document.getElementById(thisCarDiv).style.display="block"; 
          document.getElementById(thisCarDiv).setAttribute("class", "transit");
          document.getElementById(thisCarDiv).style.opacity="1"; 
          playSound("carstart");
          }
        }

      cal=trainData[trainNum].carsArray.length;
      for (carNum=cal-1; carNum>-1; carNum--){
        thisCarId=trainData[trainNum].carsArray[carNum];
        if(carNum==0){
          //follow train
          tempDir=carData[thisCarId].dir;
          carData[thisCarId]=followObject(trainData[trainNum], carData[thisCarId]);
          }
        else{
          tempDir=carData[thisCarId].dir;
          parentCarId=trainData[trainNum].carsArray[carNum-1];
          carData[thisCarId]=followObject(carData[parentCarId], carData[thisCarId]);
          }
        collisionData['car'+thisCarId]=lineStringFromXYD(carData[thisCarId].prevX, carData[thisCarId].prevY, carData[thisCarId].dir);
        window.setTimeout(transformLater, 2, thisCarId);
        }
      }

    trainData[trainNum].prevX=trainData[trainNum].nextX;
    trainData[trainNum].prevY=trainData[trainNum].nextY;
    trainData[trainNum].nextX+=xDeltaByDir[selDir];
    trainData[trainNum].nextY+=yDeltaByDir[selDir];
    trainData[trainNum].deg+=degDeltaFromDirs(trainData[trainNum].dir, selDir);
    trainData[trainNum].dir=selDir; // do not reorder
    transformString=getTransformString(trainData[trainNum].prevX, trainData[trainNum].prevY, trainData[trainNum].deg, trainData[trainNum].dir);
    document.getElementById('train'+trainNum).style.webkitTransform=transformString;
    trainData[trainNum].transformCache=transformString;

    collisionData['train'+trainNum]=lineStringFromXYD(trainData[trainNum].prevX, trainData[trainNum].prevY, selDir);
    }
  }

function transformLater(laterCarId){
  document.getElementById("car"+laterCarId).setAttribute("class", "transit");
  document.getElementById("car"+laterCarId).style.webkitTransform=carData[laterCarId].transformCache;
  }
function mouseLevel(){
  if(platform=="android"){
    return false;
    }
  resetBoardTimersObjects();
  buildSequence=new Array();
  var fails=0;
  fails+=addColor(3,4);
  fails+=addColor(3,4);
  fails+=addColor(3,4);
  if(fails>0){
    dbuga("retrying from scratch fails "+fails);
    mouseLevel();
    }
/*
      // test edges barred
      trackContext.fillStyle="red";
      for (var tx=0; tx<cellsAcross; tx++){
        for (var ty=0; ty<cellsDown; ty++){
          for(var td=0; td<4; td++){
            if(edgesBarredXY[tx][ty][td]){
              var tdeg=td*90;
              var trads=tdeg/360*(2*pi);
              var pxX=tx*cellSize+cellSize/2+Math.cos(trads)*cellSize/2.5;
              var pxY=ty*cellSize+cellSize/2+Math.sin(trads)*cellSize/2.5;
              trackContext.beginPath();
              trackContext.arc(pxX,pxY,cellSize/12,0,pi*2,true);
              trackContext.fill();
              }
            }
          }
        }
*/
  }
</script>
</head>
<body onload="init();" onmousedown="dbug(''); mouseLevel();" ontouchstart="touchStart(event);" ontouchmove="touchMove(event);" ontouchend="touchEnd(event);" ontouchcancel="touchCancel(event);" style="background-color:#3FB3A0; width:100%; height:100%;">
<div id="wrapper" style="display:block; position:absolute; top:0px; left:100px; overflow:hidden; background-color:white;">

<div id="sources" style="display:none;">
  <div id="tiledestblue" class="tiledestblue"></div>
  <div id="tiledestblack" class="tiledestblack"></div>
  <div id="tiledestorange" class="tiledestorange"></div>
  <div id="tiledestgreen" class="tiledestgreen"></div>
  <div id="tilesourceblue" class="tilesourceblue"><div class="dot blue dot1"></div><div class="dot blue dot2"></div><div class="dot blue dot3"></div><div class="dot blue dot4"></div><div class="dot blue dot5"></div></div>
  <div id="tilesourceblack" class="tilesourceblack"><div class="dot black dot1"></div><div class="dot black dot2"></div><div class="dot black dot3"></div><div class="dot black dot4"></div><div class="dot black dot5"></div></div>
  <div id="tilesourceorange" class="tilesourceorange"><div class="dot orange dot1"></div><div class="dot orange dot2"></div><div class="dot orange dot3"></div><div class="dot orange dot4"></div><div class="dot orange dot5"></div></div>
  <div id="tilesourcegreen" class="tilesourcegreen"><div class="dot green dot1"></div><div class="dot green dot2"></div><div class="dot green dot3"></div><div class="dot green dot4"></div><div class="dot green dot5"></div></div>
<!--
  <div id="bl" class="bl"><div class="blInner"></div><div class="blOuter"></div></div>
  <div id="br" class="br"><div class="brInner"></div><div class="brOuter"></div></div>
  <div id="tl" class="tl"><div class="tlInner"></div><div class="tlOuter"></div></div>
  <div id="tr" class="tr"><div class="trInner"></div><div class="trOuter"></div></div>
  <div id="lr" class="lr"><div class="lrTop"></div><div class="lrBottom"></div></div>
  <div id="tb" class="tb"><div class="tbLeft"></div><div class="tbRight"></div></div>

  <div id="ts" class="ts"><div class="tLeft"></div><div class="tRight"></div></div>
  <div id="bs" class="bs"><div class="bLeft"></div><div class="bRight"></div></div>
  <div id="ls" class="ls"><div class="lTop"></div><div class="lBottom"></div></div>
  <div id="rs" class="rs"><div class="rTop"></div><div class="rBottom"></div></div>
  <div id="td" class="td"><div class="tLeft"></div><div class="tRight"></div></div>
  <div id="bd" class="bd"><div class="bLeft"></div><div class="bRight"></div></div>
  <div id="ld" class="ld"><div class="lTop"></div><div class="lBottom"></div></div>
  <div id="rd" class="rd"><div class="rTop"></div><div class="rBottom"></div></div>
-->
</div>

<div id="highlighter"></div>
<div id="prerails">
  <div id="blPre" class="bl" style="display:none;"><div class="blInner blueBorder"></div><div class="blOuter blueBorder"></div></div>
  <div id="brPre" class="br" style="display:none;"><div class="brInner blueBorder"></div><div class="brOuter blueBorder"></div></div>
  <div id="tlPre" class="tl" style="display:none;"><div class="tlInner blueBorder"></div><div class="tlOuter blueBorder"></div></div>
  <div id="trPre" class="tr" style="display:none;"><div class="trInner blueBorder"></div><div class="trOuter blueBorder"></div></div>
  <div id="lrPre" class="lr" style="display:none;"><div class="lrTop blueBorder"></div><div class="lrBottom blueBorder"></div></div>
  <div id="tbPre" class="tb" style="display:none;"><div class="tbLeft blueBorder"></div><div class="tbRight blueBorder"></div></div>

  <div id="tPre" class="ts" style="display:none;"><div class="tLeft blueBorder"></div><div class="tRight blueBorder"></div></div>
  <div id="bPre" class="bs" style="display:none;"><div class="bLeft blueBorder"></div><div class="bRight blueBorder"></div></div>
  <div id="lPre" class="ls" style="display:none;"><div class="lTop blueBorder"></div><div class="lBottom blueBorder"></div></div>
  <div id="rPre" class="rs" style="display:none;"><div class="rTop blueBorder"></div><div class="rBottom blueBorder"></div></div>
</div>


<div id="gridHolder"  style="background-color:yellow;"></div>
<div id="canvasHolder" style="background-color:yellow;"	></div>
<div id="trainHolder" ></div>

<div id="infoHolder"></div>
<div id="infoHolder1" style="position:absolute; z-index:1;"></div>
<div id="infoHolder2" style="position:absolute; z-index:2;"></div>
<div id="infoHolder3" style="position:absolute; z-index:3;"></div>
<div id="infoHolder4" style="position:absolute; z-index:4;"></div>

<div id="uiHolder" class="green">
  <div id="progressDiv" >  
    <div id="orangeProgressDiv" class="darkorange grow" ></div>
    <div id="blackProgressDiv" class="darkblack grow" ></div>
    <div id="blueProgressDiv" class="darkblue grow" ></div>
    <div id="greenProgressDiv" class="darkgreen grow" ></div>
  </div>
  <div id="progressMask" style=""></div>
  <div id="buttons" >
    <div id="buttonHolder1">
      <div class="buttonBackground buttonChildren"></div>
      <div class="buttonChildren" style="">
        <div id="arrowCircle" style="margin-left:2px; margin-top:2px;"></div>
        <div id="arrowPoint" style="margin-left:2px; margin-top:2px;"></div>
      </div>
      <div class="buttonChildren" id="retryButton"></div>
    </div>

    <div id="buttonHolder2">
    </div>

    <div id="buttonHolder3">
    </div>

    <div id="buttonHolder4">
    </div>
    <div id="buttonHolder5">
    </div>

    <div id="buttonHolder6">
    </div>

    <div id="buttonHolder7" style="display:none;">
    </div>
    <div id="buttonHolder8" style="display:none;">
    </div>
  </div>
</div>

</div>
  <div id="debugDiv" style="display:none; position:absolute; top:0px; left:100px; font-size:16px;"></div>
</body>
</html>